<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Drools Expert User Guide</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL-NS Stylesheets V1.74.0"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="book" lang="en-US"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d0e1"/>Drools Expert User Guide</h1></div><div><div xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="authorgroup"><div class="authors">by <span xmlns="http://www.w3.org/1999/xhtml" class="orgname"><a class="link" href="http://www.jboss.org/drools/team.html" target="">The JBoss Drools team</a></span></div><div class="editors"/><div class="others"/></div></div><div><p class="releaseinfo">Version 5.4.0.Beta1</p></div></div><hr/></div><div class="toc"><dl><dt><span class="preface"><a href="#d0e19"/></span></dt><dt><span class="chapter"><a href="#d0e23">1. The Rule Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e26">1.1. What is a Rule Engine?</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e29">1.1.1. Introduction and Background</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e117">1.2. Why use a Rule Engine?</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e138">1.2.1. Advantages of a Rule Engine</a></span></dt><dt><span class="section"><a href="#d0e181">1.2.2. When should you use a Rule Engine?</a></span></dt><dt><span class="section"><a href="#d0e218">1.2.3. When not to use a Rule Engine</a></span></dt><dt><span class="section"><a href="#d0e230">1.2.4. Scripting or Process Engines</a></span></dt><dt><span class="section"><a href="#d0e243">1.2.5. Strong and Loose Coupling</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d0e248">2. Quick Start</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e251">2.1. The Basics</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e254">2.1.1. Stateless Knowledge Session</a></span></dt><dt><span class="section"><a href="#d0e401">2.1.2. Stateful Knowledge Session</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e573">2.2. A Little Theory</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e576">2.2.1. Methods versus Rules</a></span></dt><dt><span class="section"><a href="#d0e608">2.2.2. Cross Products</a></span></dt><dt><span class="section"><a href="#d0e633">2.2.3. Activations, Agenda and Conflict Sets.</a></span></dt><dt><span class="section"><a href="#d0e795">2.2.4. Inference</a></span></dt><dt><span class="section"><a href="#d0e864">2.2.5. Inference and TruthMaintenance</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e887">2.3. More on building and deploying</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e890">2.3.1. Knowledge Base by Configuration Using Changesets</a></span></dt><dt><span class="section"><a href="#d0e918">2.3.2. Knowledge Agent</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d0e983">3. Advanced Concepts and Theory</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e986">3.1. Truth Maintenance with  Logical Objects</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1060">3.1.1. Example Scenario</a></span></dt><dt><span class="section"><a href="#d0e1074">3.1.2. Lazy Truth Maintenance</a></span></dt><dt><span class="section"><a href="#d0e1079">3.1.3. Important note: Equality for Java objects</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1092">3.2. Rete Algorithm</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d0e1161">4. User Guide</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1164">4.1. Building</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1173">4.1.1. Building using Code</a></span></dt><dt><span class="section"><a href="#d0e1254">4.1.2. Building using Configuration and the ChangeSet XML</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1310">4.2. Deploying</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1313">4.2.1. KnowledgePackage and Knowledge Definitions</a></span></dt><dt><span class="section"><a href="#d0e1326">4.2.2. KnowledgeBase</a></span></dt><dt><span class="section"><a href="#d0e1376">4.2.3. In-Process Building and Deployment</a></span></dt><dt><span class="section"><a href="#d0e1391">4.2.4. Building and Deployment in Separate Processes</a></span></dt><dt><span class="section"><a href="#d0e1430">4.2.5. StatefulknowledgeSessions and KnowledgeBase Modifications</a></span></dt><dt><span class="section"><a href="#d0e1444">4.2.6. KnowledgeAgent</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1569">4.3. Running</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1573">4.3.1. KnowledgeBase</a></span></dt><dt><span class="section"><a href="#d0e1592">4.3.2. StatefulKnowledgeSession</a></span></dt><dt><span class="section"><a href="#d0e1614">4.3.3. KnowledgeRuntime</a></span></dt><dt><span class="section"><a href="#d0e1898">4.3.4. Agenda</a></span></dt><dt><span class="section"><a href="#d0e2003">4.3.5. Event Model</a></span></dt><dt><span class="section"><a href="#d0e2118">4.3.6. KnowledgeRuntimeLogger</a></span></dt><dt><span class="section"><a href="#d0e2134">4.3.7. StatelessKnowledgeSession</a></span></dt><dt><span class="section"><a href="#d0e2329">4.3.8. Commands and the CommandExecutor</a></span></dt><dt><span class="section"><a href="#d0e2627">4.3.9. Marshalling</a></span></dt><dt><span class="section"><a href="#d0e2702">4.3.10. Persistence and Transactions</a></span></dt><dt><span class="section"><a href="#d0e2746">4.3.11. Drools Clips</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d0e2774">5. The Rule Language</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2777">5.1. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2785">5.1.1. A rule file</a></span></dt><dt><span class="section"><a href="#d0e2818">5.1.2. What makes a rule</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e2854">5.2. Keywords</a></span></dt><dt><span class="section"><a href="#d0e3049">5.3. Comments</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3054">5.3.1. Single line comment</a></span></dt><dt><span class="section"><a href="#d0e3067">5.3.2. Multi-line comment</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3080">5.4. Error Messages</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3085">5.4.1. Message format</a></span></dt><dt><span class="section"><a href="#d0e3116">5.4.2. Error Messages Description</a></span></dt><dt><span class="section"><a href="#d0e3271">5.4.3. Other Messages</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3276">5.5. Package</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3299">5.5.1. import</a></span></dt><dt><span class="section"><a href="#d0e3313">5.5.2. global</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3356">5.6. Function</a></span></dt><dt><span class="section"><a href="#d0e3390">5.7. Type Declaration</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3418">5.7.1. Declaring New Types</a></span></dt><dt><span class="section"><a href="#d0e3524">5.7.2. Declaring Metadata</a></span></dt><dt><span class="section"><a href="#d0e3689">5.7.3. Declaring Metadata for Existing Types</a></span></dt><dt><span class="section"><a href="#d0e3732">5.7.4. Parameterized constructors for declared types</a></span></dt><dt><span class="section"><a href="#d0e3745">5.7.5. Non Typesafe Classes</a></span></dt><dt><span class="section"><a href="#d0e3750">5.7.6. Accessing Declared Types from the Application Code</a></span></dt><dt><span class="section"><a href="#d0e3799">5.7.7. Type Declaration 'extends'</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3808">5.8. Rule</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3850">5.8.1. Rule Attributes</a></span></dt><dt><span class="section"><a href="#d0e4010">5.8.2. Timers and Calendars</a></span></dt><dt><span class="section"><a href="#d0e4051">5.8.3. Left Hand Side (when) syntax</a></span></dt><dt><span class="section"><a href="#d0e5989">5.8.4. The Right Hand Side (then)</a></span></dt><dt><span class="section"><a href="#d0e6228">5.8.5. A Note on Auto-boxing and Primitive Types</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6233">5.9. Query</a></span></dt><dt><span class="section"><a href="#d0e6300">5.10. Domain Specific Languages</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6310">5.10.1. When to Use a DSL</a></span></dt><dt><span class="section"><a href="#d0e6317">5.10.2. DSL Basics</a></span></dt><dt><span class="section"><a href="#d0e6387">5.10.3. Adding Constraints to Facts</a></span></dt><dt><span class="section"><a href="#d0e6432">5.10.4. Developing a DSL</a></span></dt><dt><span class="section"><a href="#d0e6445">5.10.5. DSL and DSLR Reference</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6648">5.11. XML Rule Language</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6657">5.11.1. When to use XML</a></span></dt><dt><span class="section"><a href="#d0e6668">5.11.2. The XML format</a></span></dt><dt><span class="section"><a href="#d0e6714">5.11.3. Legacy Drools 2.x XML rule format</a></span></dt><dt><span class="section"><a href="#d0e6719">5.11.4. Automatic transforming between formats (XML and DRL)</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d0e6731">6. Authoring</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6734">6.1. Decision Tables in Spreadsheets</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6746">6.1.1. When to Use Decision Tables</a></span></dt><dt><span class="section"><a href="#d0e6764">6.1.2. Overview</a></span></dt><dt><span class="section"><a href="#d0e6802">6.1.3. How Decision Tables Work</a></span></dt><dt><span class="section"><a href="#d0e6875">6.1.4. Spreadsheet Syntax</a></span></dt><dt><span class="section"><a href="#d0e7349">6.1.5. Creating and integrating Spreadsheet based Decision Tables</a></span></dt><dt><span class="section"><a href="#d0e7368">6.1.6. Managing Business Rules in Decision Tables</a></span></dt><dt><span class="section"><a href="#d0e7413">6.1.7. Rule Templates</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e7501">6.2. Templates</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7514">6.2.1. The Rule Template File</a></span></dt><dt><span class="section"><a href="#d0e7610">6.2.2. Expanding a Template</a></span></dt><dt><span class="section"><a href="#d0e7666">6.2.3. Example</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d0e7737">7. The Java Rule Engine API</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7740">7.1. Introduction</a></span></dt><dt><span class="section"><a href="#d0e7755">7.2. How To Use</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7760">7.2.1. Building and Registering RuleExecutionSets</a></span></dt><dt><span class="section"><a href="#d0e7793">7.2.2. Using Stateful and Stateless RuleSessions</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e7828">7.3. References</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d0e7874">8. The Rule IDE (Eclipse)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7892">8.1. Features Outline</a></span></dt><dt><span class="section"><a href="#d0e7948">8.2. Drools Runtimes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7953">8.2.1. Defining a Drools Runtime</a></span></dt><dt><span class="section"><a href="#d0e7990">8.2.2. Selecting a runtime for your Drools project</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8005">8.3. Creating a Rule Project</a></span></dt><dt><span class="section"><a href="#d0e8028">8.4. Creating a New Rule and Wizards</a></span></dt><dt><span class="section"><a href="#d0e8049">8.5. Textual Rule Editor</a></span></dt><dt><span class="section"><a href="#d0e8072">8.6. Drools Views</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8089">8.6.1. The Working Memory View</a></span></dt><dt><span class="section"><a href="#d0e8103">8.6.2. The Agenda View</a></span></dt><dt><span class="section"><a href="#d0e8117">8.6.3. The Global Data View</a></span></dt><dt><span class="section"><a href="#d0e8131">8.6.4. The Audit View</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8215">8.7. Domain Specific Languages</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8222">8.7.1. Editing languages</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8245">8.8. The Rete View</a></span></dt><dt><span class="section"><a href="#d0e8261">8.9. Large DRL Files</a></span></dt><dt><span class="section"><a href="#d0e8277">8.10. Debugging Rules</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8288">8.10.1. Creating Breakpoints</a></span></dt><dt><span class="section"><a href="#d0e8302">8.10.2. Debugging Rules</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d0e8340">9. Examples</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8343">9.1. Getting the Examples</a></span></dt><dt><span class="section"><a href="#d0e8350">9.2. Hello World</a></span></dt><dt><span class="section"><a href="#d0e8618">9.3. State Example</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8623">9.3.1. Understanding the State Example</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8904">9.4. Fibonacci Example</a></span></dt><dt><span class="section"><a href="#d0e9110">9.5. Banking Tutorial</a></span></dt><dt><span class="section"><a href="#d0e9437">9.6. Pricing Rule Decision Table Example</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9461">9.6.1. Executing the example</a></span></dt><dt><span class="section"><a href="#d0e9503">9.6.2. The decision table</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e9568">9.7. Pet Store Example</a></span></dt><dt><span class="section"><a href="#d0e10130">9.8. Honest Politician Example</a></span></dt><dt><span class="section"><a href="#d0e10259">9.9. Sudoku Example</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10280">9.9.1. Sudoku Overview</a></span></dt><dt><span class="section"><a href="#d0e10294">9.9.2. Running the Example</a></span></dt><dt><span class="section"><a href="#d0e10361">9.9.3. Java Source and Rules Overview</a></span></dt><dt><span class="section"><a href="#d0e10491">9.9.4. Sudoku Validator Rules (validate.drl)</a></span></dt><dt><span class="section"><a href="#d0e10500">9.9.5. Sudoku Solving Rules (sudoku.drl)</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e10536">9.10. Number Guess</a></span></dt><dt><span class="section"><a href="#d0e10827">9.11. Miss Manners and Benchmarking</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10849">9.11.1. Introduction</a></span></dt><dt><span class="section"><a href="#d0e10935">9.11.2. Indepth Discussion</a></span></dt><dt><span class="section"><a href="#d0e11145">9.11.3. Output Summary</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e11200">9.12. Conway's Game Of Life</a></span></dt></dl></dd><dt><span class="index"><a href="#d0e11349">Index</a></span></dt></dl></div><div class="preface" lang="en-US"><div class="titlepage"/><div class="mediaobject"><img src="images/droolsExpertLogo.png"/></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e23"/>Chapter 1. The Rule Engine</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e26">1.1. What is a Rule Engine?</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e29">1.1.1. Introduction and Background</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e117">1.2. Why use a Rule Engine?</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e138">1.2.1. Advantages of a Rule Engine</a></span></dt><dt><span class="section"><a href="#d0e181">1.2.2. When should you use a Rule Engine?</a></span></dt><dt><span class="section"><a href="#d0e218">1.2.3. When not to use a Rule Engine</a></span></dt><dt><span class="section"><a href="#d0e230">1.2.4. Scripting or Process Engines</a></span></dt><dt><span class="section"><a href="#d0e243">1.2.5. Strong and Loose Coupling</a></span></dt></dl></dd></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e26"/>1.1. What is a Rule Engine?</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e29"/>1.1.1. Introduction and Background</h3></div></div></div><p>Artificial Intelligence (A.I.) is a very broad research area that
    focuses on "Making computers think like people" and includes disciplines
    such as Neural Networks, Genetic Algorithms, Decision Trees, Frame Systems
    and Expert Systems. Knowledge representation is the area of A.I. concerned
    with how knowledge is represented and manipulated. Expert Systems use
    Knowledge representation to facilitate the codification of knowledge into
    a knowledge base which can be used for reasoning, i.e., we can process
    data with this knowledge base to infer conclusions. Expert Systems are
    also known as Knowledge-based Systems and Knowledge-based Expert Systems
    and are considered to be "applied artificial intelligence". The process of
    developing with an Expert System is Knowledge Engineering. EMYCIN was one
    of the first "shells" for an Expert System, which was created from the
    MYCIN medical diagnosis Expert System. Whereas early Expert Systems had
    their logic hard-coded, "shells" separated the logic from the system,
    providing an easy to use environment for user input. Drools is a Rule
    Engine that uses the rule-based approach to implement an Expert System and
    is more correctly classified as a Production Rule System.</p><p>The term "Production Rule" originates from formal grammars where it
    is described as "an abstract structure that describes a formal language
    precisely, i.e., a set of rules that mathematically delineates a (usually
    infinite) set of finite-length strings over a (usually finite) alphabet"
    (<em class="citetitle"><a class="link" href="http://en.wikipedia.org/wiki/Formal_grammar" target="">Wikipedia</a></em>).</p><p>Business Rule Management Systems build additional value on top of a
    general purpose Rule Engine by providing business user focused systems for
    rule creation, management, deployment, collaboration, analysis and end
    user tools. Further adding to this value is the fast evolving and popular
    methodology "Business Rules Approach", which is a helping to formalize the
    role of Rule Engines in the enterprise.</p><p>The term Rule Engine is quite ambiguous in that it can be any system
    that uses rules, in any form, that can be applied to data to produce
    outcomes. This includes simple systems like form validation and dynamic
    expression engines. The book "How to Build a Business Rules Engine (2004)"
    by Malcolm Chisholm exemplifies this ambiguity. The book is actually about
    how to build and alter a database schema to hold validation rules. The
    book then shows how to generate VB code from those validation rules to
    validate data entry. This, while a very valid and useful topic for some,
    caused quite a surprise to this author, unaware at the time in the
    subtleties of Rules Engines' differences, who was hoping to find some
    hidden secrets to help improve the Drools engine. JBoss jBPM uses
    expressions and delegates in its Decision nodes which control the
    transitions in a Workflow. At each node it evaluates ther is a rule set
    that dictates the transition to undertake, and so this is also a Rule
    Engine. While a Production Rule System is a kind of Rule Engine and also
    an Expert System, the validation and expression evaluation Rule Engines
    mentioned previously are not Expert Systems.</p><p>A Production Rule System is Turing complete, with a focus on
    knowledge representation to express propositional and first order logic in
    a concise, non-ambiguous and declarative manner. The brain of a Production
    Rules System is an Inference Engine that is able to scale to a large
    number of rules and facts. The Inference Engine matches facts and data
    against Production Rules - also called Productions or just Rules - to
    infer conclusions which result in actions. A Production Rule is a two-part
    structure using First Order Logic for reasoning over knowledge
    representation.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">when</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">conditions</span><span class="java_operator">&gt;</span>
<!--  --><br/><span class="java_plain">then</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">actions</span><span class="java_operator">&gt;</span><span class="java_separator">;</span></pre><p>The process of matching the new or existing facts against Production
    Rules is called <a id="d0e50" class="indexterm"/> Pattern Matching, which is performed by the <a id="d0e54" class="indexterm"/> Inference Engine. There are a number of algorithms used for
    Pattern Matching by Inference Engines including:</p><div class="itemizedlist"><ul><li><p>Linear</p></li><li><p>Rete</p></li><li><p>Treat</p></li><li><p>Leaps</p></li></ul></div><p>Drools implements and extends the <a id="d0e73" class="indexterm"/> Rete algorithm;<a id="d0e77" class="indexterm"/> Leaps used to be provided but was retired as it became
    unmaintained. The Drools <a id="d0e81" class="indexterm"/> Rete implementation is called ReteOO, signifying that
    Drools has an enhanced and optimized implementation of the Rete algorithm
    for object oriented systems. Other Rete based engines also have marketing
    terms for their proprietary enhancements to Rete, like RetePlus and Rete
    III. The most common enhancements are covered in "Production Matching for
    Large Learning Systems (Rete/UL)" (1995) by Robert B. Doorenbos.</p><p>The Rules are stored in the <a id="d0e87" class="indexterm"/> Production Memory and the facts that the Inference Engine
    matches against are kept in the <a id="d0e91" class="indexterm"/> Working Memory. Facts are asserted into the Working Memory
    where they may then be modified or retracted. A system with a large number
    of rules and facts may result in many rules being true for the same fact
    assertion; these rules are said to be in conflict. The Agenda manages the
    execution order of these conflicting rules using a Conflict Resolution
    strategy.</p><div class="figure"><a id="d0e95"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/rule-engine-inkscape.png" align="middle" alt="High-level View of a Rule Engine"/></div></div><p class="title"><b>Figure 1.1. High-level View of a Rule Engine</b></p></div><br class="figure-break"/><p>There are two methods of execution for a rule system: Forward
    Chaining and Backward Chaining; systems that implement both are called
    Hybrid Chaining Systems. As of Drools 5.2 Drools provides seamless hybrid
    chaining, both forward and backwards. Understanding these two modes of
    operation is the key to understanding why a Production Rule System is
    different and how to get the best from it. Forward chaining is
    "data-driven" and thus reactionary, with facts being asserted into working
    memory, which results in one or more rules being concurrently true and
    scheduled for execution by the Agenda. In short, we start with a fact, it
    propagates and we end in a conclusion.</p><div class="figure"><a id="d0e103"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Forward_Chaining.png" align="middle" alt="Forward Chaining"/></div></div><p class="title"><b>Figure 1.2. Forward Chaining</b></p></div><br class="figure-break"/><p>Backward chaining is "goal-driven", meaning that we start with a
    conclusion which the engine tries to satisfy. If it can't it then searches
    for conclusions that it can satisfy; these are known as subgoals, that
    will help satisfy some unknown part of the current goal. It continues this
    process until either the initial conclusion is proven or there are no more
    subgoals. Prolog is an example of a Backward Chaining engine. Drools can
    also do backward chaining, which we refer to as derivation queries.</p><div class="figure"><a id="d0e111"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Backward_Chaining.png" align="middle" alt="Backward Chaining"/></div></div><p class="title"><b>Figure 1.3. Backward Chaining</b></p></div><br class="figure-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e117"/>1.2. Why use a Rule Engine?</h2></div></div></div><p>Some frequently asked questions:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>When should you use a rule engine?</p></li><li><p>What advantage does a rule engine have over hand coded
      "if...then" approaches?</p></li><li><p>Why should you use a rule engine instead of a scripting framework,
      like <a id="d0e132" class="indexterm"/> BeanShell?</p></li></ol></div><p>We will attempt to address these questions below.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e138"/>1.2.1. Advantages of a Rule Engine</h3></div></div></div><div class="itemizedlist"><ul><li><p>Declarative Programming</p><p>Rule engines allow you to say "What to do", not "How to do
        it".</p><p>The key advantage of this point is that using rules can make it
        easy to express solutions to difficult problems and consequently have
        those solutions verified. Rules are much easier to read than
        code.</p><p>Rule systems are capable of solving very, very hard problems,
        providing an explanation of how the solution was arrived at and why
        each "decision" along the way was made (not so easy with other of AI
        systems like neural networks or the human brain - I have no idea why I
        scratched the side of the car).</p></li><li><p>Logic and Data Separation</p><p>Your data is in your domain objects, the logic is in the rules.
        This is fundamentally breaking the OO coupling of data and logic,
        which can be an advantage or a disadvantage depending on your point of
        view. The upshot is that the logic can be much easier to maintain as
        there are changes in the future, as the logic is all laid out in
        rules. This can be especially true if the logic is cross-domain or
        multi-domain logic. Instead of the logic being spread across many
        domain objects or controllers, it can all be organized in one or more
        very distinct rules files.</p></li><li><p>Speed and Scalability</p><p>The Rete algorithm,the Leaps algorithm, and their descendants such as
        Drools' ReteOO, provide very efficient ways of matching
        rule patterns to your domain object data. These are especially
        efficient when you have datasets that change in small portions as the
        rule engine can remember past matches. These algorithms are battle
        proven.</p></li><li><p>Centralization of Knowledge</p><p>By using rules, you create a repository of knowledge (a
        knowledge base) which is executable. This means it's a single point of
        truth, for business policy, for instance. Ideally rules are so
        readable that they can also serve as documentation.</p></li><li><p>Tool Integration</p><p>Tools such as Eclipse (and in future, Web based user interfaces)
        provide
        ways to edit and manage rules and get immediate feedback, validation
        and content assistance. Auditing and debugging tools are also
        available.</p></li><li><p>Explanation Facility</p><p>Rule systems effectively provide an "explanation facility" by
        being able to log the decisions made by the rule engine along with why
        the decisions were made.</p></li><li><p>Understandable Rules</p><p>By creating object models and, optionally, Domain Specific
        Languages that model your problem domain you can set yourself up to
        write rules that are very close to natural language. They lend
        themselves to logic that is understandable to, possibly nontechnical,
        domain experts as they are expressed in their language, with all the
        program plumbing, the technical know-how being hidden
        away in the usual code.</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e181"/>1.2.2. When should you use a Rule Engine?</h3></div></div></div><p>The shortest answer to this is "when there is no satisfactory
    traditional programming approach to solve the problem.". Given that short
    answer, some more explanation is required. The reason why there is no
    "traditional" approach is possibly one of the following: </p><div class="itemizedlist"><ul><li><p>The problem is just too fiddle for traditional code.</p><p>The problem may not be complex, but you can't see a
          non-fragile way of building a solution for it.</p></li><li><p>The problem is beyond any obvious algorithmic
          solution.</p><p>It is a complex problem to solve, there are no obvious
          traditional solutions, or basically the problem isn't fully
          understood.</p></li><li><p>The logic changes often</p><p>The logic itself may even be simple but
          the rules change quite often. In many organizations software
          releases are few and far between and pluggable rules can help provide the
          "agility" that is needed and expected in a reasonably safe
          way.</p></li><li><p>Domain experts (or business analysts) are readily available,
          but are nontechnical.</p><p>Domain experts often possess a wealth of knowledge about business
          rules and processes. They typically are nontechnical, but can be
          very logical. Rules can allow them to express the logic in their own
          terms. Of course, they still have to think critically and be capable
          of logical thinking. Many people in nontechnical positions do
          not have training in formal logic, so be careful and work with them,
          as by codifying business knowledge in rules, you will often expose
          holes in the way the business rules and processes are currently
          understood.</p></li></ul></div><p>If rules are a new technology for your project teams, the overhead
    in getting going must be factored in. It is not a trivial technology, but
    this document tries to make it easier to understand.</p><p>Typically in a modern OO application you would use a rule engine to
    contain key parts of your business logic, 
    <span class="emphasis"><em>especially the really messy parts</em></span>. This is
    an inversion of the OO concept of encapsulating all the logic inside your
    objects. This is not to say that you throw out OO practices, on the
    contrary in any real world application, business logic is just one part of
    the application. If you ever notice lots of conditional statements
    such as "if" and "switch", an
    overabundance of strategy patterns and other messy logic in your code
    that just doesn't feel right: that would be a place for rules.
    If there is some such logic and you keep coming back to fix it, either
    because you got it wrong, or the logic or your understanding changes: think
    about using rules. If you are faced with tough problems for which there are
    no algorithms or patterns: consider using rules.</p><p>Rules could be used embedded in your application or perhaps as a
    service. Often a rule engine works best as "stateful" component, being
    an integral part of an application. However, there have been
    successful cases of creating reusable rule services which are
    stateless.</p><p>For your organization it is important to decide about the process you
    will use for updating rules in systems that are in production. The options
    are many, but different organizations have different requirements.
    Frequently, rules maintenance is out of the control of the application
    vendors or project developers.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e218"/>1.2.3. When not to use a Rule Engine</h3></div></div></div><p>To quote a Drools mailing list regular: </p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>It seems to me
    that in the excitement of working with rules engines, that people forget
    that a rules engine is only one piece of a complex application or
    solution. Rules engines are not really intended to handle workflow or
    process executions nor are workflow engines or process management tools
    designed to do rules. Use the right tool for the job. Sure, a pair of
    pliers can be used as a hammering tool in a pinch, but that's not what
    it's designed for.</p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">Dave Hamu</span></td></tr></table></div><p>As rule engines are dynamic (dynamic in the sense that the rules can
    be stored and managed and updated as data), they are often looked at as a
    solution to the problem of deploying software. (Most IT departments seem to
    exist for the purpose of preventing software being rolled out.) If this is
    the reason you wish to use a rule engine, be aware that rule engines work
    best when you are able to write declarative rules. As an alternative, you
    can consider data-driven designs (lookup tables), or script processing
    engines where the scripts are managed in a database and are able to be
    updated on the fly.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e230"/>1.2.4. Scripting or Process Engines</h3></div></div></div><p>Hopefully the preceding sections have explained when you may want to
    use a rule engine.</p><p>Alternatives are script-based engines that provide the drive
    for "changes on the fly", and there are many such solutions.</p><p>Alternatively Process Engines (also capable of workflow) such as
    jBPM allow you to graphically (or programmatically) describe steps in a
    process. Those steps can also involve decision points which are in
    themselves a simple rule. Process engines and rules often can work nicely
    together, so they are not mutually exclusive.</p><p>One key point to note with rule engines is that some rule engines
    are really scripting engines. The downside of scripting engines is that
    you are tightly coupling your application to the scripts. If they are
    rules, you are effectively calling rules directly and this may cause more
    difficulty in future maintenance, as they tend to grow in complexity over
    time. The upside of scripting engines is that they can be easier to
    implement initially, producing results quickly, and are conceptually
    simpler for imperative programmers.</p><p>Many people have also implemented data-driven systems successfully
    in the past (where there are control tables that store meta-data that
    changes your applications behavior) - these can work well when the
    control can remain very limited. However, they can quickly grow out of
    control if extended too much (such that only the original creators can
    change the applications behavior) or they cause the application to
    stagnate as they are too inflexible.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e243"/>1.2.5. Strong and Loose Coupling</h3></div></div></div><p>No doubt you have heard terms like "tight coupling" and "loose
    coupling" in systems design. Generally people assert that "loose" or
    "weak" coupling is preferable in design terms, due to the added
    flexibility it affords. Similarly, you can have "strongly coupled" and
    "weakly coupled" rules. Strongly coupled in this sense means that one rule
    "firing" will clearly result in another rule firing, and so on; in other
    words,
    there is a clear (probably obvious) chain of logic. If your rules are all
    strongly coupled, the chances are that the will turn out to be inflexible,
    and, more significantly, that a rule engine is an overkill. A clear chain
    can be hard coded, or implemented using a Decision Tree. This is not to
    say that strong
    coupling is inherently bad, but it is a point to keep in mind when
    considering a rule engine and the way you capture the rules. "Loosely"
    coupled rules should result in a system that allows rules to be changed,
    removed and added without requiring changes to other, unrelated
    rules.</p></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e248"/>Chapter 2. Quick Start</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e251">2.1. The Basics</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e254">2.1.1. Stateless Knowledge Session</a></span></dt><dt><span class="section"><a href="#d0e401">2.1.2. Stateful Knowledge Session</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e573">2.2. A Little Theory</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e576">2.2.1. Methods versus Rules</a></span></dt><dt><span class="section"><a href="#d0e608">2.2.2. Cross Products</a></span></dt><dt><span class="section"><a href="#d0e633">2.2.3. Activations, Agenda and Conflict Sets.</a></span></dt><dt><span class="section"><a href="#d0e795">2.2.4. Inference</a></span></dt><dt><span class="section"><a href="#d0e864">2.2.5. Inference and TruthMaintenance</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e887">2.3. More on building and deploying</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e890">2.3.1. Knowledge Base by Configuration Using Changesets</a></span></dt><dt><span class="section"><a href="#d0e918">2.3.2. Knowledge Agent</a></span></dt></dl></dd></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e251"/>2.1. The Basics</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e254"/>2.1.1. Stateless Knowledge Session</h3></div></div></div><p>So where do we get started, there are so many use cases and so much
    functionality in a rule engine such as Drools that it becomes beguiling.
    Have no fear my intrepid adventurer, the complexity is layered and you can
    ease yourself into with simple use cases.</p><p>Stateless session, not utilising inference, forms the simplest use
    case. A stateless session can be called like a function passing it some
    data and then receiving some results back. Some common use cases for
    stateless sessions are, but not limited to:</p><div class="itemizedlist"><ul><li><p>Validation</p><div class="itemizedlist"><ul><li><p>Is this person eligible for a mortgage?</p></li></ul></div></li><li><p>Calculation</p><div class="itemizedlist"><ul><li><p>Compute a mortgage premium.</p></li></ul></div></li><li><p>Routing and Filtering</p><div class="itemizedlist"><ul><li><p>Filter incoming messages, such as emails, into
            folders.</p></li><li><p>Send incoming messages to a destination.</p></li></ul></div></li></ul></div><p>So let's start with a very simple example using a driving license
    application.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Applicant</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;age</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;valid</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
</pre><p>Now that we have our data model we can write our first rule. We
    assume that the application uses rules to refute invalid applications. As
    this is a simple validation use case we will add a single rule to
    disqualify any applicant younger than 18.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">package com.company.license

rule "Is of valid age"
when
    $a : Applicant( age &lt; 18 )
then
    $a.setValid( false );
end</pre><p>To make the engine aware of data, so it can be processed against the
    rules, we have to <span class="emphasis"><em>insert</em></span> the data, much like with a
    database. When the Applicant instance is inserted into the engine it is
    evaluated against the constraints of the rules, in this case just two
    constraints for one rule. We say <span class="emphasis"><em>two</em></span> because the type
    Applicant is the first object type constraint, and <code class="code">age &lt;
    18</code> is the second field constraint. An object type constraint plus
    its zero or more field constraints is referred to as a pattern. When an
    inserted instance satisfies both the object type constraint and all the
    field constraints, it is said to be matched. The <code class="code">$a</code> is a
    binding variable which permits us to reference the matched object in the
    consequence. There its properties can be updated. The dollar character
    ('$') is optional, but it helps to differentiate variable names from field
    names. The process of matching patterns against the inserted data is, not
    surprisingly, often referred to as <span class="emphasis"><em>pattern
    matching</em></span>.</p><p>Let's assume that the rules are in the same folder as the classes,
    so we can use the classpath resource loader to build our first
    <code class="code">KnowledgeBase</code>. A Knowledge Base is what we call our
    collection of compiled definitions, such as rules and processes, which are
    compiled using the <code class="code">KnowledgeBuilder</code>. Both the
    KnowledgeBuilder and KnowledgeBase can be created from the factories
    KnowledeBuilderFactory and KnowledgeBaseFactory.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;licenseApplication.drl&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;getClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">err</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">().</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span></pre><p>The above code snippet looks on the classpath for the
    <code class="filename">licenseApplication.drl</code> file, using the method
    <code class="code">newClassPathResource()</code>. The resource type is DRL, short for
    "Drools Rule Language". Once the DRL file has been added we can check the
    Knowledge Builder object for any errors. If there are no errors, we can
    add the resulting packages to our Knowledge Base. Now we are ready to
    build our session and execute against some data:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatelessKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatelessKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Applicant</span><span class="java_plain">&nbsp;applicant&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Applicant</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Smith&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">16</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">assertTrue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;applicant</span><span class="java_separator">.</span><span class="java_plain">isValid</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;applicant&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">assertFalse</span><span class="java_separator">(</span><span class="java_plain">&nbsp;applicant</span><span class="java_separator">.</span><span class="java_plain">isValid</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</pre><p>The preceding code executes the data against the rules. Since the
    applicant is under the age of 18, the application is marked as
    invalid.</p><p>So far we've only used a single instance, but what if we want to use
    more than one? We can execute against any object implementing Iterable,
    such as a collection. Let's add another class called
    <code class="code">Application</code>, which has the date of the application, and we'll
    also move the boolean valid field to the <code class="code">Application</code>
    class.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Applicant</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;age</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Application</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;dateApplied</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;valid</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>We can also add another rule to validate that the application was
    made within a period of time.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">package com.company.license

rule "Is of valid age"
when
    Applicant( age &lt; 18 )
    $a : Application()     
then
    $a.setValid( false );
end

rule "Application was made this year"
when
    $a : Application( dateApplied &gt; "01-jan-2009" )     
then
    $a.setValid( false );
end
</pre><p>Unfortunately a Java array does not implement the
    <code class="code">Iterable</code> interface, so we have to use the JDK converter
    method <code class="code">Arrays.asList(...)</code>. The code shown below executes
    against an iterable list, where all collection elements are inserted
    before any matched rules are fired.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatelessKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatelessKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Applicant</span><span class="java_plain">&nbsp;applicant&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Applicant</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Smith&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">16</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Application</span><span class="java_plain">&nbsp;application&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Application</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">assertTrue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;application</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Arrays</span><span class="java_separator">.</span><span class="java_plain">asList</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;application</span><span class="java_separator">,</span><span class="java_plain">&nbsp;applicant&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">assertFalse</span><span class="java_separator">(</span><span class="java_plain">&nbsp;application</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</pre><p>The two execute methods <code class="code">execute(Object object)</code> and
    <code class="code">execute(Iterable objects)</code> are actually convenience methods
    for the interface <code class="code">BatchExecutor</code>'s method
    <code class="code">execute(Command command)</code>.</p><p>A <code class="code">CommandFactory</code> is used to create commands, so that
    the following is equivalent to <code class="code">execute(Iterable it)</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">execute</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">CommandFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newInsertIterable</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_separator">[]</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span><!-- <br/> --><span class="java_plain">&nbsp;application</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;applicant&nbsp;</span><!-- <br/> --><span class="java_separator">}</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
</pre><p>Batch Executor and Command Factory are particularly useful when
    working with multiple Commands and with output identifiers for obtaining
    results.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">List</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Command</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;cmds&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ArrayList</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Command</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Smith&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;mrSmith&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Doe&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;mrDoe&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">BatchExecutionResults</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newBatchExecution</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cmds&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">assertEquals</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Mr&nbsp;John&nbsp;Smith&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;results</span><span class="java_separator">.</span><span class="java_plain">getValue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;mrSmith&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</pre><p><code class="code">CommandFactory</code> supports many other Commands that can be
    used in the <code class="code">BatchExecutor</code> like <code class="code">StartProcess</code>,
    <code class="code">Query</code>, and <code class="code">SetGlobal</code>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e401"/>2.1.2. Stateful Knowledge Session</h3></div></div></div><p>Stateful Sessions are longer lived and allow iterative changes over
    time. Some common use cases for Stateful Sessions are, but not limited
    to:</p><div class="itemizedlist"><ul><li><p>Monitoring</p><div class="itemizedlist"><ul><li><p>Stock market monitoring and analysis for semi-automatic
            buying.</p></li></ul></div></li><li><p>Diagnostics</p><div class="itemizedlist"><ul><li><p>Fault finding, medical diagnostics</p></li></ul></div></li><li><p>Logistics</p><div class="itemizedlist"><ul><li><p>Parcel tracking and delivery provisioning</p></li></ul></div></li><li><p>Compliance</p><div class="itemizedlist"><ul><li><p>Validation of legality for market trades.</p></li></ul></div></li></ul></div><p>In contrast to a Stateless Session, the <code class="code">dispose()</code>
    method must be called afterwards to ensure there are no memory leaks, as
    the Knowledge Base contains references to Stateful Knowledge Sessions when
    they are created. <code class="code">StatefulKnowledgeSession</code> also supports the
    <code class="code">BatchExecutor</code> interface, like
    <code class="code">StatelessKnowledgeSession</code>, the only difference being that the
    <code class="code">FireAllRules</code> command is not automatically called at the end
    for a Stateful Session.</p><p>We illustrate the monitoring use case with an example for raising a
    fire alarm. Using just four classes, we represent rooms in a house, each
    of which has one sprinkler. If a fire starts in a room, we represent that
    with a single <code class="code">Fire</code> instance.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Room</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;classs&nbsp;</span><span class="java_type">Sprinkler</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Room</span><span class="java_plain">&nbsp;room</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;on</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Fire</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Room</span><span class="java_plain">&nbsp;room</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Alarm</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_separator">}</span>
</pre><p>In the previous section on Stateless Sessions the concepts of
    inserting and matching against data was introduced. That example assumed
    that only a single instance of each object type was ever inserted and thus
    only used literal constraints. However, a house has many rooms, so rules
    must express relationships between objects, such as a sprinkler being in a
    certain room. This is best done by using a binding variable as a
    constraint in a pattern. This "join" process results in what is called
    cross products, which are covered in the next section.</p><p>When a fire occurs an instance of the <code class="code">Fire</code> class is
    created, for that room, and inserted into the session. The rule uses a
    binding on the <code class="code">room</code> field of the <code class="code">Fire</code> object to
    constrain matching to the sprinkler for that room, which is currently off.
    When this rule fires and the consequence is executed the sprinkler is
    turned on.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "When there is a fire turn on the sprinkler"
when
    Fire($room : room)
    $sprinkler : Sprinkler( room == $room, on == false )
then
    modify( $sprinkler ) { setOn( true ) };
    System.out.println( "Turn on the sprinkler for room " + $room.getName() );
end</pre><p>Whereas the Stateless Session uses standard Java syntax to modify a
    field, in the above rule we use the <code class="literal">modify</code> statement,
    which acts as a sort of "with" statement. It may contain a series of comma
    separated Java expressions, i.e., calls to setters of the object selected
    by the <code class="literal">modify</code> statement's control expression. This
    modifies the data, and makes the engine aware of those changes so it can
    reason over them once more. This process is called inference, and it's
    essential for the working of a Stateful Session. Stateless Sessions
    typically do not use inference, so the engine does not need to be aware of
    changes to data. Inference can also be turned off explicitly by using the
    <span class="emphasis"><em>sequential mode</em></span>.</p><p>So far we have rules that tell us when matching data exists, but
    what about when it does <span class="emphasis"><em>not</em></span> exist? How do we
    determine that a fire has been extinguished, i.e., that there isn't a
    <code class="code">Fire</code> object any more? Previously the constraints have been
    sentences according to Propositional Logic, where the engine is
    constraining against individual intances. Drools also has support for
    First Order Logic that allows you to look at sets of data. A pattern under
    the keyword <code class="literal">not</code> matches when something does not exist.
    The rule given below turns the sprinkler off as soon as the fire in that
    room has disappeared.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "When the fire is gone turn off the sprinkler"
when
    $room : Room( )
    $sprinkler : Sprinkler( room == $room, on == true )
    not Fire( room == $room )
then
    modify( $sprinkler ) { setOn( false ) };
    System.out.println( "Turn off the sprinkler for room " + $room.getName() );
end</pre><p>While there is one sprinkler per room, there is just a single alarm
    for the building. An <code class="code">Alarm</code> object is created when a fire
    occurs, but only one <code class="code">Alarm</code> is needed for the entire building,
    no matter how many fires occur. Previously <code class="literal">not</code> was
    introduced to match the absence of a fact; now we use its complement
    <code class="literal">exists</code> which matches for one or more instances of some
    category.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Raise the alarm when we have one or more fires"
when
    exists Fire()
then
    insert( new Alarm() );
    System.out.println( "Raise the alarm" );
end</pre><p>Likewise, when there are no fires we want to remove the alarm, so
    the <code class="literal">not</code> keyword can be used again.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Cancel the alarm when all the fires have gone"
when
    not Fire()
    $alarm : Alarm()
then
    retract( $alarm );
    System.out.println( "Cancel the alarm" );
end

</pre><p>Finally there is a general health status message that is printed
    when the application first starts and after the alarm is removed and all
    sprinklers have been turned off.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Status output when things are ok"
when
    not Alarm()
    not Sprinkler( on == true ) 
then
    System.out.println( "Everything is ok" );
end</pre><p>The above rules should be placed in a single DRL file and saved to
    some directory on the classpath and using the file name
    <code class="filename">fireAlarm.drl</code>, as in the Stateless Session example.
    We can then build a Knowledge Base, as before, just using the new name
    <code class="filename">fireAlarm.drl</code>. The difference is that this time we
    create a Stateful Session from the Knowledge Base, whereas before we
    created a Stateless Session.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;fireAlarm.drl&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;getClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">err</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">().</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">StatefulKnowledgeSession</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">.</span><span class="java_plain">newStatefulKnowledgeSession</span><span class="java_separator">();</span></pre><p>With the session created it is now possible to iteratvely work with
    it over time. Four <code class="code">Room</code> objects are created and inserted, as
    well as one <code class="code">Sprinkler</code> object for each room. At this point the
    engine has done all of its matching, but no rules have fired yet. Calling
    <code class="code">ksession.fireAllRules()</code> allows the matched rules to fire, but
    without a fire that will just produce the health message.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_separator">[]</span><!-- <br/> --><span class="java_plain">&nbsp;names&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_separator">[]{</span><!-- <br/> --><span class="java_literal">&quot;kitchen&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;bedroom&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;office&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;livingroom&quot;</span><!-- <br/> --><span class="java_separator">};</span>
<!--  --><br/><span class="java_type">Map</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_type">Room</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;name2room&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">HashMap</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_type">Room</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_keyword">for</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_operator">:</span><span class="java_plain">&nbsp;names&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Room</span><span class="java_plain">&nbsp;room&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Room</span><span class="java_separator">(</span><span class="java_plain">&nbsp;name&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;name2room</span><span class="java_separator">.</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;name</span><span class="java_separator">,</span><span class="java_plain">&nbsp;room&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;room&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Sprinkler</span><span class="java_plain">&nbsp;sprinkler&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Sprinkler</span><span class="java_separator">(</span><span class="java_plain">&nbsp;room&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sprinkler&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">()</span>
</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&gt; Everything is ok</pre><p>We now create two fires and insert them; this time a reference is
    kept for the returned <code class="code">FactHandle</code>. A Fact Handle is an
    internal engine reference to the inserted instance and allows instances to
    be retracted or modified at a later point in time. With the fires now in
    the engine, once <code class="code">fireAllRules()</code> is called, the alarm is
    raised and the respective sprinklers are turned on.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Fire</span><!-- <br/> --><span class="java_plain">&nbsp;kitchenFire&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Fire</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;name2room</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">get</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;kitchen&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Fire</span><span class="java_plain">&nbsp;officeFire&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Fire</span><span class="java_separator">(</span><span class="java_plain">&nbsp;name2room</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;office&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">FactHandle</span><span class="java_plain">&nbsp;kitchenFireHandle&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kitchenFire&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">FactHandle</span><span class="java_plain">&nbsp;officeFireHandle&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;officeFire&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span></pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&gt; Raise the alarm
&gt; Turn on the sprinkler for room kitchen
&gt; Turn on the sprinkler for room office</pre><p>After a while the fires will be put out and the <code class="code">Fire</code>
    instances are retracted. This results in the sprinklers being turned off,
    the alarm being cancelled, and eventually the health message is printed
    again.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">retract</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;kitchenFireHandle&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">retract</span><span class="java_separator">(</span><span class="java_plain">&nbsp;officeFireHandle&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span></pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&gt; Turn on the sprinkler for room office
&gt; Turn on the sprinkler for room kitchen
&gt; Cancel the alarm
&gt; Everything is ok</pre><p>Everyone still with me? That wasn't so hard and already I'm hoping
    you can start to see the value and power of a declarative rule
    system.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e573"/>2.2. A Little Theory</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e576"/>2.2.1. Methods versus Rules</h3></div></div></div><p>People often confuse methods and rules, and new rule users regular
    ask, "How do I call a rule?" After the last section, you are now feeling
    like a rule expert and the answer to that is obvious, but let's summarize
    the differences nonetheless.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">void</span><!-- <br/> --><span class="java_plain">&nbsp;helloWorld</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_plain">&nbsp;person</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;person</span><span class="java_separator">.</span><span class="java_plain">getName</span><span class="java_separator">().</span><span class="java_plain">equals</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Chuck&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Hello&nbsp;Chuck&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><div class="itemizedlist"><ul><li><p>Methods are called directly.</p></li><li><p>Specific instances are passed.</p></li><li><p>One call results in a single execution.</p></li></ul></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Hello World"
    when
        Person( name == "Chuck" )
    then
        System.out.println( "Hello Chuck" );
        end</pre><div class="itemizedlist"><ul><li><p>Rules execute by matching against any data as long it is
        inserted into the engine.</p></li><li><p>Rules can never be called directly.</p></li><li><p>Specific instances cannot be passed to a rule.</p></li><li><p>Depending on the matches, a rule may fire once or several times,
        or not at all.</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e608"/>2.2.2. Cross Products</h3></div></div></div><p>Earlier the term "cross product" was mentioned, which is the result
    of a join. Imagine for a moment that the data from the fire alarm example
    were used in combination with the following rule where there ar no field
    constraints:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule
when
    $room : Room()
    $sprinkler : Sprinkler()
then
    System.out.println( "room:" + $room.getName() +
                        " sprinkler:" + $sprinkler.getRoom().getName() );
end</pre><p>In SQL terms this would be like doing <code class="code">select * from Room,
    Sprinkler</code> and every row in the Room table would be joined with
    every row in the Sprinkler table resulting in the following output:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">room:office sprinker:office
room:office sprinkler:kitchen
room:office sprinkler:livingroom
room:office sprinkler:bedroom
room:kitchen sprinkler:office
room:kitchen sprinkler:kitchen
room:kitchen sprinkler:livingroom
room:kitchen sprinkler:bedroom
room:livingroom sprinkler:office
room:livingroom sprinkler:kitchen
room:livingroom sprinkler:livingroom
room:livingroom sprinkler:bedroom
room:bedroom sprinkler:office
room:bedroom sprinkler:kitchen
room:bedroom sprinkler:livingroom
room:bedroom sprinkler:bedroom</pre><p>These cross products can obviously become huge, and they may very
    well contain spurious data. The size of cross products is often the source
    of performance problems for new rule authors. From this it can be seen
    that it's always desirable to constrain the cross products, which is done
    with the variable constraint.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule
when
    $room : Room()
    $sprinkler : Sprinkler( room == $room )
then
    System.out.println( "room:" + $room.getName() +
                        " sprinkler:" + $sprinkler.getRoom().getName() );
end</pre><p>This results in just four rows of data, with the correct Sprinkler
    for each Room. In SQL (actually HQL) the corresponding query would be
    <code class="code">select * from Room, Sprinkler where Room ==
    Sprinkler.room</code>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">room:office sprinkler:office
room:kitchen sprinkler:kitchen
room:livingroom sprinkler:livingroom
room:bedroom sprinkler:bedroom</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e633"/>2.2.3. Activations, Agenda and Conflict Sets.</h3></div></div></div><p>So far the data and the matching process has been simple and small.
    To mix things up a bit a new example will be explored that handles
    cashflow calculations over date periods. The state of the engine will be
    illustratively shown at key stages to help get a better understanding of
    what is actually going on under the hood. Three classes will be used, as
    shown below.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">CashFlow</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;&nbsp;&nbsp;date</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;amount</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;type</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">long</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accountNo</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">long</span><span class="java_plain">&nbsp;&nbsp;&nbsp;accountNo</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;balance</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">AccountPeriod</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;start</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;end</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getter&nbsp;and&nbsp;setter&nbsp;methods&nbsp;here</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>By now you already know how to create Knowledge Bases and how to
    instantiate facts to populate the <code class="code">StatefulKnowledgeSession</code>,
    so tables will be used to show the state of the inserted data, as it makes
    things clearer for illustration purposes. The tables below show that a
    single fact was inserted for the <code class="code">Account</code>. Also inserted are a
    series of debits and credits as <code class="code">CashFlow</code> objects for that
    account, extending over two quarters.</p><div class="figure"><a id="d0e651"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Quick_Start/tables1.png" alt="CashFlows and Account"/></div></div><p class="title"><b>Figure 2.1. CashFlows and Account</b></p></div><br class="figure-break"/><p>Two rules can be used to determine the debit and credit for that
    quarter and update the Account balance. The two rules below constrain the
    cashflows for an account for a given time period. Notice the "&amp;&amp;"
    which use short cut syntax to avoid repeating the field name twice.</p><table frame="void"><tbody><tr>
          <td align="left" valign="top"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "increase balance for credits"
when
  ap : AccountPeriod()
  acc : Account( $accountNo : accountNo )
  CashFlow( type == CREDIT,
            accountNo == $accountNo,
            date &gt;= ap.start &amp;&amp; &lt;= ap.end,
            $amount : amount )
then
  acc.balance  += $amount;
end</pre></td>

          <td align="left" valign="top"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "decrease balance for debits" 
when 
  ap : AccountPeriod() 
  acc : Account( $accountNo : accountNo ) 
  CashFlow( type == DEBIT, 
            accountNo == $accountNo,
            date &gt;= ap.start &amp;&amp; &lt;= ap.end, 
            $amount : amount ) 
then 
  acc.balance -= $amount; 
end</pre></td>
        </tr></tbody></table><p>If the <code class="code">AccountPeriod</code> is set to the first quarter we
    constrain the rule "increase balance for credits" to fire on two rows of
    data and "decrease balance for debits" to act on one row of data.</p><div class="figure"><a id="d0e676"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Quick_Start/tables2.png" alt="AccountingPeriod, CashFlows and Account"/></div></div><p class="title"><b>Figure 2.2. AccountingPeriod, CashFlows and Account</b></p></div><br class="figure-break"/><p>The two cashflow tables above represent the matched data for the two
    rules. The data is matched during the insertion stage and, as you
    discovered in the previous chapter, does not fire straight away, but only
    after <code class="code">fireAllRules()</code> is called. Meanwhile, the rule plus its
    matched data is placed on the Agenda and referred to as an Activation. The
    Agenda is a table of Activations that are able to fire and have their
    consequences executed, as soon as fireAllRules() is called. Activations on
    the Agenda are executed in turn. Notice that the order of execution so far
    is considered arbitrary.</p><div class="figure"><a id="d0e687"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Quick_Start/tables7.png" alt="CashFlows and Account"/></div></div><p class="title"><b>Figure 2.3. CashFlows and Account</b></p></div><br class="figure-break"/><p>After all of the above activations are fired, the account has a
    balance of -25.</p><div class="figure"><a id="d0e695"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Quick_Start/tables3.png" alt="CashFlows and Account"/></div></div><p class="title"><b>Figure 2.4. CashFlows and Account</b></p></div><br class="figure-break"/><p>If the <code class="code">AccountPeriod</code> is updated to the second quarter,
    we have just a single matched row of data, and thus just a single
    Activation on the Agenda.</p><div class="figure"><a id="d0e706"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Quick_Start/tables4.png" alt="CashFlows and Account"/></div></div><p class="title"><b>Figure 2.5. CashFlows and Account</b></p></div><br class="figure-break"/><p>The firing of that Activation results in a balance of 25.</p><div class="figure"><a id="d0e714"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Quick_Start/tables5.png" alt="CashFlows and Account"/></div></div><p class="title"><b>Figure 2.6. CashFlows and Account</b></p></div><br class="figure-break"/><p>What if you don't want the order of Activation execution to be
    arbitrary? When there is one or more Activations on the Agenda they are
    said to be in conflict, and a conflict resolver strategy is used to
    determine the order of execution. At the simplest level the default
    strategy uses salience to determine rule priority. Each rule has a default
    value of 0, the higher the value the higher the priority. To illustrate
    this we add a rule to print the account balance, where we want this rule
    to be executed after all the debits and credits have been applied for all
    accounts. We achieve this by assigning a negative salience to this rule so
    that it fires after all rules with the default salience 0.</p><table border="0" id="d0e722"><tbody><tr>
          <td>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Print balance for AccountPeriod"
        salience -50
    when
        ap : AccountPeriod()
        acc : Account()        
    then
        System.out.println( acc.accountNo + " : " + acc.balance );    
end</pre>
          </td>
        </tr></tbody></table><p>The table below depicts the resulting Agenda. The three debit and
    credit rules are shown to be in arbitrary order, while the print rule is
    ranked last, to execute afterwards.</p><div class="figure"><a id="d0e734"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Quick_Start/tables6.png" alt="CashFlows and Account"/></div></div><p class="title"><b>Figure 2.7. CashFlows and Account</b></p></div><br class="figure-break"/><p>Earlier we showed how rules would equate to SQL, which can often
    help people with an SQL background to understand rules. The two rules
    above can be represented with two views and a trigger for each view, as
    below:</p><table border="0" id="d0e742"><tbody><tr>
          <td align="left" valign="top">
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select * from Account acc,
              Cashflow cf,
              AccountPeriod ap      
where acc.accountNo == cf.accountNo and 
      cf.type == CREDIT and
      cf.date &gt;= ap.start and 
      cf.date &lt;= ap.end</pre>
          </td>

          <td align="left" valign="top">
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select * from Account acc, 
              Cashflow cf,
              AccountPeriod ap 
where acc.accountNo == cf.accountNo and 
      cf.type == DEBIT and
      cf.date &gt;= ap.start and 
      cf.date &lt;= ap.end</pre>
          </td>
        </tr><tr>
          <td align="left" valign="top">
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">trigger : acc.balance += cf.amount</pre>
          </td>

          <td align="left" valign="top">
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">trigger : acc.balance -= cf.amount</pre>
          </td>
        </tr></tbody></table><p>Drools also features ruleflow-group attributes which allows workflow
    diagrams to declaratively specify when rules are allowed to fire. The
    screenshot below is taken from Eclipse using the Drools plugin. It has two
    ruleflow-group nodes which ensures that the calculation rules are executed
    before the reporting rules.</p><div class="mediaobject"><img src="images/Chapter-Quick_Start/ruleflow.png"/></div><p>The use of the ruleflow-group attribute in a rule is shown
    below.</p><table border="0" id="d0e779"><tbody><tr>
          <td align="left" valign="top">
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "increase balance for credits"
  ruleflow-group "calculation"
when
  ap : AccountPeriod()
  acc : Account( $accountNo : accountNo )
  CashFlow( type == CREDIT,
            accountNo == $accountNo,
            date &gt;= ap.start &amp;&amp; &lt;= ap.end,
            $amount : amount )
then
  acc.balance  += $amount;
end</pre>
          </td>

          <td align="left" valign="top">
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Print balance for AccountPeriod"
  ruleflow-group "report"
when
  ap : AccountPeriod()
  acc : Account()
then
  System.out.println( acc.accountNo +
                      " : " + acc.balance );    
end</pre>
          </td>
        </tr></tbody></table></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e795"/>2.2.4. Inference</h3></div></div></div><p>Inference has a bad names these days, as something not relevant to
    business use cases and just too complicated to be useful. It is true that
    contrived and complicated examples occur with inference, but that should
    not detract from the fact that simple and useful ones exist too. But more
    than this, correct use of inference can crate more agile and less error
    prone businesses with easier to maintain software.</p><p>So what is inference? Something is inferred when we gain knowledge
    of something from using previous knowledge. For example given a Person
    fact with an age field and a rule that provides age policy control, we can
    infer whether a Person is an adult or a child and act on this.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Infer Adult"
when
  $p : Person( age &gt;= 18 )
then
  insert( new IsAdult( $p ) )
end</pre><p>So in the above every Person who is 18 or over will have an instance
    of IsAdult inserted for them. This fact is special in that it is known as
    a relation. We can use this inferred relation in any rule:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">$p : Person()
IsAdult( person == $p )</pre><p>So now we know what inference is, and have a basic example, how does
    this facilitate good rule design and maintenance?</p><p>Let's take a government department that are responsible for issuing
    ID cards when children become adults, hence forth referred to as ID
    department. They might have a decision table that includes logic like
    this, which says when an adult living in london is 18 or over, issue the
    card:</p><div class="mediaobject"><img src="images/Chapter-Quick_Start/monolithic.png"/></div><p>However the ID department does not set the policy on who an adult
    is. That's done at a central government level. If the central government
    where to change that age to 21 there is a change management process.
    Someone has to liaise with the ID department and make sure their systems
    are updated, in time for the law going live.</p><p>This change management process and communication between departments
    is not ideal for an agile environment and change become costly and error
    prone. Also the card department is managing more information than it needs
    to be aware of with its "monolothic" approach to rules management which is
    "leaking" information better placed else where. By this I mean that it
    doesn't care what explicit "age &gt;= 18" information determines whether
    someone is an adult, only that they are an adult.</p><p>Instead what if we were to split (de-couple) the authoring
    responsibility, so the central government maintains its rules and the ID
    department maintains its.</p><p>So its the central governments job to determine who is an adult and
    if they change the law they just update their central repository with the
    new rules, which others use:</p><div class="mediaobject"><img src="images/Chapter-Quick_Start/InferIsAdult.png"/></div><p>The IsAdult fact, as discussed previously, is inferred from the
    policy rules. It encapsulates the seemingly arbitrary piece of logic "age
    &gt;= 18" and provides semantic abstractions for it's meaning. Now if
    anyone uses the above rules, they no longer need to be aware of explicit
    information that determines whether someone is an adult or not. They can
    just use the inferred fact:</p><div class="mediaobject"><img src="images/Chapter-Quick_Start/IssueIdCard.png"/></div><p>While the example is very minimal and trivial it illustrates some
    important points. We started with a monolithic and leaky approach to our
    knowledge engineering. We create a single decision table that had all
    possible information in it that leaks information from central government
    that the ID department did not care about and did not want to
    manage.</p><p>We first de-coupled the knowledge process so each department was
    responsible for only what it needed to know. We then encapsulated this
    leaky knowledge using an inferred fact IsAdult. The use of the term
    IsAdult also gave a semantic abstraction to the previously arbitrary logic
    "age &gt;= 18".</p><p>So a general rule or thumb when doing your knowledge engineering
    is:</p><p/><div class="itemizedlist"><ul><li><p><span class="bold"><strong>Bad</strong></span></p><div class="itemizedlist"><ul><li><p>Monolithic</p></li><li><p>Leaky</p></li></ul></div></li><li><p><span class="bold"><strong>Good</strong></span></p><div class="itemizedlist"><ul><li><p>De-couple knowledge responsibilities</p></li><li><p>Encapsulate knowledge</p></li><li><p>Provide semantic abstractions for those
            encapsulations</p></li></ul></div></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e864"/>2.2.5. Inference and TruthMaintenance</h3></div></div></div><p>The previous example was issuing ID cards to over 18s, in this
    example we now issue bus passes, either a child or adult pass.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Issue Child Bus Pass" when
  $p : Person( age &lt; 16 )
then
  insert(new ChildBusPass( $p ) );
end
 
rule "Issue Adult Bus Pass" when
  $p : Person( age &gt;= 16 )
then
  insert(new AdultBusPass( $p ) );
end</pre><p>As before the above example is considered monolithic, leaky and
    providing poor separation of concerns.</p><p>As before we can provide a more robust application with a separation
    of concerns using inference. Notice this time we don't just insert the
    inferred object, we use "logicalInsert":</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Infer Child" when
  $p : Person( age &lt; 16 )
then
    logicalInsert( new IsChild( $p ) )
end
rule "Infer Adult" when
  $p : Person( age &gt;= 16 )
then
    logicalInsert( new IsAdult( $p ) )
end</pre><p>A "logicalInsert" is part of the Drools Truth Maintenance System
    (TMS). Here the fact is logically inserted, this fact is dependant on the
    truth of the "when" clause. It means that when the rule becomes false the
    fact is automatically retracted. This works particularly well as the two
    rules are mutually exclusive. So in the above rules if the person is under
    16 it inserts an IsChild fact, once the person is 16 or over the IsChild
    fact is automatically retracted and the IsAdult fact inserted.</p><p>We can now bring back in the code to issue the passes, these two can
    also be logically inserted, as the TMS supports chaining of logical
    insertions for a cascading set of retracts.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Issue Child Bus Pass" when
  $p : Person( )
       IsChild( person == $p )
then
  logicalInsert(new ChildBusPass( $p ) );
end
 
rule "Issue Adult Bus Pass" when
  $p : Person( age &gt;= 16 )
       IsAdult( person =$p )
then
  logicalInsert(new AdultBusPass( $p ) );
end</pre><p>Now when the person changes from being 15 to 16, not only is the
    IsChild fact automatically retracted, so is the person's ChildBusPass
    fact. For bonus points we can combine this with the 'not' conditional
    element to handle notifications, in this situation a request for the
    returning of the pass. So when the TMS automatically retracts the
    ChildBusPass object, this rule triggers and sends a request to the
    person:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Return ChildBusPass Request "when
  $p : Person( )
       not( ChildBusPass( person == $p ) )
then
    requestChildBusPass( $p );
end</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e887"/>2.3. More on building and deploying</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e890"/>2.3.1. Knowledge Base by Configuration Using Changesets</h3></div></div></div><p>So far, the programmatic API has been used to build a Knowledge
    Base. Quite often it's more desirable to do this via configuration. To
    facilitate this, Drools supports the "Changeset" feature. The file
    <code class="filename">changeset.xml</code> contains a list of resources, and it
    may also point recursively to another changeset XML file. Currently there is 
    no XML schema for the changeset XML, but we hope to add one soon.
    A few examples will be shown to give you the gist of things. A resource
    approach is employed that uses a prefix to indicate the protocol. All the
    protocols provided by <code class="code">java.net.URL</code>, such as "file" and "http",
    are supported, as well as an additional "classpath".
    Currently the type attribute must always be specified for a resource, as
    it is not inferred from the file name extension. Here is a simple example
    that points to a http location for some rules.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set&nbsp;http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http:org/domain/myrules.drl'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'DRL'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>To use the above XML, the code is almost identical as before, except
    we change the resource type to <code class="code">CHANGE_SET</code>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClasspathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;myChangeSet.xml&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;getClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">CHANGE_SET&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">err</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">().</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Changesets can include any number of resources, and they even
    support additional configuration information, which currently is only
    needed for decision tables. The example below is expanded to load the
    rules from a http URL location, and an Excel decision table from the
    classpath.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set.xsd&nbsp;http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http:org/domain/myrules.drl'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'DRL'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'classpath:data/IntegrationExampleTest.xls'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DTABLE&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">decisiontable-conf</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">input-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;XLS&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">worksheet-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Tables_2&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">resource</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>It is also possible to specify a directory, to add the contents of
    that directory. It is expected that all the files are of the specified
    type, since type is not yet inferred from the file name extensions.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set.xsd&nbsp;http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'file://myfolder/'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'DRL'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e918"/>2.3.2. Knowledge Agent</h3></div></div></div><p>The Knowlege Agent provides automatic loading, caching and
    re-loading of resources and is configured from a properties files. The
    Knowledge Agent can update or rebuild this Knowlege Base as the resources
    it uses are changed. The strategy for this is determined by the
    configuration given to the factory, but it is typically pull-based using
    regular polling. We hope to add push-based updates and rebuilds in future
    versions.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeAgent</span><!-- <br/> --><span class="java_plain">&nbsp;kagent&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeAgentFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeAgent</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;MyAgent&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">kagent</span><span class="java_separator">.</span><span class="java_plain">applyChangeSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newUrlResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;url&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kagent</span><span class="java_separator">.</span><span class="java_plain">getKnowledgeBase</span><span class="java_separator">();</span></pre><p>A <code class="code">KnowledgeAgent</code> object will continuously scan all the
    added resources, using a default polling interval of 60 seconds and, when
    some last modification date is updated, it will applied the changes into the
    cached Knowledge Base using the new resources. Note that the previous
    <code class="code">KnowledgeBase</code> reference will still exist and you'll have to
    call <code class="code">getKnowledgeBase()</code> to access the newly built
    <code class="code">KnowledgeBase</code>. If a directory is specified as part of the
    change set, the entire contents of that directory will be scanned for
    changes. The way modifications are applied depends on
    <code class="code">drools.agent.newInstance</code> property present in the
    KnowledgeAgentConfiguration object passed to the agent.
    </p><p>For polling to occur, the polling and notifier services must be started:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">ResourceFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getResourceChangeNotifierService</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">start</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">getResourceChangeScannerService</span><span class="java_separator">().</span><span class="java_plain">start</span><span class="java_separator">();</span></pre><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e946"/>2.3.2.1. Knowledge Agent and Custom ClassLoaders</h4></div></div></div><p>Because Knowledge Agent could scan and process remote resources, it
      could ends up failing when compiling or executing rules, queries, functions,
      etc. that use classes outside the agent's classloader.
      If this is your case, you could take 2 approach: use a custom classloader
      for agent's kbuilder or force the agent to use the same classloader that
      its kbase has.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e951"/>2.3.2.1.1. Custom ClassLoaders for KnowledgeBuilder</h5></div></div></div><p>Knowledge Agent uses KnowledgeBuilder internally in order to
        compile managed resources. If you need to pass custom configuration to
        these compilers you could pass a KnowledgeBuilderConfiguration object
        to KnowledgeAgentFactory.newKnowledgeAgent(). This object will be used
        in every builder the agent creates. Using a KnowledgeBuilderConfiguration
        you can specify a custom classloader.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e956"/>2.3.2.1.2. Reuse KnowledgeBase ClassLoader</h5></div></div></div><p>Most of the times, the classloader you wan't to use in the
        compilation process of remote resources is the same needed in the
        agent's kbase, so the rules could be executed. If you want to use this
        approach, you will need to setup the desired ClassLoader to the
        agen't kbase and use the "drools.agent.useKBaseClassLoaderForCompiling"
        property of KnowledgeAgentConfiguration object.</p><p>This approach lets you modify agent's kbuilder classloader in
        runtime by modifying the classloader the agent's kbase uses. This will
        serve also when not using incremental change set processing (see the
        section below). When the kbase is recreated its configuration is
        reused, so the classloader is maintained.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBaseConfiguration</span><!-- <br/> --><span class="java_plain">&nbsp;kbaseConfig&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBaseConfiguration</span><span class="java_separator">(</span><span class="java_literal">null</span><span class="java_separator">,</span><span class="java_plain">&nbsp;customClassLoader</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">(</span><span class="java_plain">kbaseConfig</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">kbase&nbsp;with&nbsp;custom&nbsp;classloader</span>
<!--  --><br/><span class="java_type">KnowledgeAgentConfiguration</span><span class="java_plain">&nbsp;aconf&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeAgentFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeAgentConfiguration</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">aconf</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;drools.agent.newInstance&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;false&quot;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">incremental&nbsp;change&nbsp;set&nbsp;processing&nbsp;enabled</span>
<!--  --><br/><span class="java_plain">aconf</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;drools.agent.useKBaseClassLoaderForCompiling&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;true&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeAgent</span><span class="java_plain">&nbsp;kagent&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeAgentFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeAgent</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;test&nbsp;agent&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">,</span><span class="java_plain">&nbsp;aconf</span><span class="java_separator">);</span></pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e965"/>2.3.2.2. Incremental Change Set Processing</h4></div></div></div><p>
            Knowledge Agent can process change sets in two different ways:
            recreating the knowledge base every time a new change set is
            processed or applying the change set in the cached knowledge base
            without destroying it.
            This behavior is controlled by the "newInstance" property of the
            KnowledgeAgentConfiguration object passed to the Agent's constructor.
        </p><p>
            When "newInstace" is set to true (the default value), the agent
            will destroy the cached Knowledge Base it contains and populate a
            new one containing the change set modifications. When "newInstance"
            is set to "false" change sets are applied directly to the cached
            Knowledge Base. The rule that were not modified in the change sets'
            resources are not replaced in the Knowledge Base, the modified or
            deleted rules are modified or deleted from the cached Knowledge Base.
            Functions, Queries and Definition Types are always replaced in the
            cached Knowledge Base whether they are modified or not.
        </p><p>
            The following code snippet creates a new Knowledge Agent with its
            "newInstace" property set to false
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeAgentConfiguration</span><!-- <br/> --><span class="java_plain">&nbsp;aconf&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeAgentFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeAgentConfiguration</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">aconf</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;drools.agent.newInstance&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;false&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeAgent</span><span class="java_plain">&nbsp;kagent&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeAgentFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeAgent</span><span class="java_separator">(</span><span class="java_literal">&quot;test&nbsp;agent&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span><span class="java_plain">&nbsp;aconf</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e976"/>2.3.2.3. Remote HTTP resource caching</h4></div></div></div><p>A note on remote HTTP Url Resources: if your knowledge agent is
    "pulling" resources from a http(s) URL, then you might rightly be
    concerned if that resource (remote web server) suddenly disappears. To
    survive a restart when a resource is no longer available remotely (eg the
    remote server is being restarted) then you can set a System Property:
    drools.resource.urlcache to a directory that has write permissions for the
    application: the Knowledge Agent will cache copies of the remote resources
    in that local directory. </p><p>For example, using the java command line:
    -Ddrools.resource.urlcache=/users/someone/KnowledgeCache - will keep local
    copies of the resources (rules, packages etc) in that directory, for the
    agent to use should it be restarted (when a remote resource becomes
    available, and is updated, it will automatically update the local cache
    copy). </p></div></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e983"/>Chapter 3. Advanced Concepts and Theory</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e986">3.1. Truth Maintenance with  Logical Objects</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1060">3.1.1. Example Scenario</a></span></dt><dt><span class="section"><a href="#d0e1074">3.1.2. Lazy Truth Maintenance</a></span></dt><dt><span class="section"><a href="#d0e1079">3.1.3. Important note: Equality for Java objects</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1092">3.2. Rete Algorithm</a></span></dt></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e986"/>3.1. Truth Maintenance with <a id="d0e989" class="indexterm"/> Logical Objects</h2></div></div></div><p>After regular inserts you have to retract facts explicitly. With
    <span class="emphasis"><em>logical</em></span> assertions, the fact that was asserted will
    be automatically retracted when the conditions that asserted it in the
    first place are no longer true. Actually, it's even cleverer then that,
    because it will be retracted only if there isn't any single condition that
    supports the logical assertion.</p><p>Normal insertions are said to be <span class="emphasis"><em>stated</em></span>, i.e.,
    just like the intuitive meaning of "stating a fact" implies. Using a
    <code class="code">HashMap</code> and a counter, we track how many times a particular
    equality is <span class="emphasis"><em>stated</em></span>; this means we count how many
    different instances are equal.</p><p>When we <span class="emphasis"><em>logically</em></span> insert an object during a RHS
    execution we are said to <span class="emphasis"><em>justify</em></span> it, and it is
    considered to be justified by the firing rule. For each logical insertion
    there can only be one equal object, and each subsequent equal logical
    insertion increases the justification counter for this logical assertion.
    A justification is removed by the LHS of the creating rule becoming
    untrue, and the counter is decreased accordingly. As soon as we have no
    more justifications the logical object is automatically retracted.</p><p>If we try to <span class="emphasis"><em>logically</em></span> insert an object when
    there is an equal <span class="emphasis"><em>stated</em></span> object, this will fail and
    return null. If we <span class="emphasis"><em>state</em></span> an object that has an
    existing equal object that is <span class="emphasis"><em>justified</em></span> we override
    the Fact; how this override works depends on the configuration setting
    <code class="code">WM_BEHAVIOR_PRESERVE</code>. When the property is set to discard we
    use the existing handle and replace the existing instance with the new
    Object, which is the default behavior; otherwise we override it to
    <span class="emphasis"><em>stated</em></span> but we create an new
    <code class="code">FactHandle</code>.</p><p>This can be confusing on a first read, so hopefully the flow charts
    below help. When it says that it returns a new <code class="code">FactHandle</code>,
    this also indicates the <code class="code">Object</code> was propagated through the
    network.</p><div class="figure"><a id="d0e1048"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Stated_Assertion.png" align="middle" alt="Stated Insertion"/></div></div><p class="title"><b>Figure 3.1. Stated Insertion</b></p></div><br class="figure-break"/><div class="figure"><a id="d0e1054"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Logical_Assertion.png" align="middle" alt="Logical Insertion"/></div></div><p class="title"><b>Figure 3.2. Logical Insertion</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1060"/>3.1.1. Example Scenario</h3></div></div></div><p>An example may make things clearer. Imagine a credit card
      processing application, processing transactions for a given account and
      we have a working memory accumulating knowledge about a single account
      transaction. The rule engine is doing its best to decide whether
      transactions are possibly fraudulent or not. Imagine that this rule base
      basically has rules that kick in when there is "reason to be suspicious"
      and when "everything is normal".</p><p>Of course there are many rules that operate no matter what,
      performing standard calculations, etc. Now there are possibly many
      reasons as to what could trigger a "reason to be suspicious": someone
      notifying the bank, a sequence of large transactions, transactions for
      geographically disparate locations, or even reports of credit card
      theft. Rather then smattering all the little conditions in lots of
      rules, imagine there is a fact class called "SuspiciousAccount".</p><p>Then there can be a series of rules whose job is to look for
      things that may raise suspicion, and if they fire, they
      <span class="emphasis"><em>logically</em></span> insert a new SuspiciousAccount()
      instance. All the other rules just have conditions like "not
      SuspiciousAccount()" or "SuspiciousAccount()" depending on their needs.
      Note that this has the advantage of allowing there to be many rules
      around raising suspicion, without touching the other rules. After all
      the facts causing the SuspiciousAccount() insertion are removed, the
      account handling reverts to a normal mode of operation where, for
      instance, a rule with "not SuspiciousAccount()" may kick in, which
      flushes through any blocked transactions.</p><p>If you have followed this far, you will note that truth
      maintenance, like logical assertions, allows rules to behave a little
      like a human would, and can certainly make the rules more
      manageable.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1074"/>3.1.2. Lazy Truth Maintenance</h3></div></div></div><p>You no longer need to enable or disable truth maintenance, via the
      kbase configuration. It is now handled automatically and turned on only
      when needed. This was done along with the code changes so that all entry
      points use the same code, previous to this the default entry point and
      named entry points used different code, to avoid TMS overhead for event
      processing.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1079"/>3.1.3. Important note: Equality for Java objects</h3></div></div></div><p>It is important to note that for Truth Maintenance (and logical
      assertions) to work at all, your Fact objects (which may be JavaBeans)
      must override equals and hashCode methods (from java.lang.Object)
      correctly. As the truth maintenance system needs to know when two
      different physical objects are equal in value, <span class="emphasis"><em>both</em></span>
      equals and hashCode must be overridden correctly, as per the Java
      standard.</p><p>Two objects are equal if and only if their equals methods return
      true for each other and if their hashCode methods return the same
      values. See the Java API for more details (but do keep in mind you
      <span class="emphasis"><em>MUST</em></span> override both equals and hashCode).</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1092"/>3.2. Rete Algorithm</h2></div></div></div><p>The <span class="emphasis"><em>Rete</em></span> algorithm was invented by Dr. Charles
    Forgy and documented in his PhD thesis in 1978-79. A simplified version of
    the paper was published in 1982 (<a class="ulink" href="http://citeseer.ist.psu.edu/context/505087/0">http://citeseer.ist.psu.edu/context/505087/0</a>).
    The latin word "rete" means "net" or "network". The Rete algorithm can be
    broken into 2 parts: rule compilation and runtime execution.</p><p>The compilation algorithm describes how the Rules in the Production
    Memory are processed to generate an efficient discrimination network. In
    non-technical terms, a discrimination network is used to filter data as it
    propagates through the network. The nodes at the top of the network would
    have many matches, and as we go down the network, there would be fewer
    matches. At the very bottom of the network are the terminal nodes. In Dr.
    Forgy's 1982 paper, he described 4 basic nodes: root, 1-input, 2-input and
    terminal.</p><div class="figure"><a id="d0e1105"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Rete_Nodes.png" align="middle" alt="Rete Nodes"/></div></div><p class="title"><b>Figure 3.3. Rete Nodes</b></p></div><br class="figure-break"/><p>The root node is where all objects enter the network. From there, it
    immediately goes to the ObjectTypeNode. The purpose of the ObjectTypeNode
    is to make sure the engine doesn't do more work than it needs to. For
    example, say we have 2 objects: Account and Order. If the rule engine
    tried to evaluate every single node against every object, it would waste a
    lot of cycles. To make things efficient, the engine should only pass the
    object to the nodes that match the object type. The easiest way to do this
    is to create an ObjectTypeNode and have all 1-input and 2-input nodes
    descend from it. This way, if an application asserts a new Account, it
    won't propagate to the nodes for the Order object. In Drools when an
    object is asserted it retrieves a list of valid ObjectTypesNodes via a
    lookup in a HashMap from the object's Class; if this list doesn't exist it
    scans all the ObjectTypeNodes finding valid matches which it caches in the
    list. This enables Drools to match against any Class type that matches
    with an <code class="literal">instanceof</code> check.</p><div class="figure"><a id="d0e1116"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Object_Type_Nodes.png" align="middle" alt="ObjectTypeNodes"/></div></div><p class="title"><b>Figure 3.4. ObjectTypeNodes</b></p></div><br class="figure-break"/><p>ObjectTypeNodes can propagate to AlphaNodes, LeftInputAdapterNodes
    and BetaNodes. AlphaNodes are used to evaluate literal conditions.
    Although the 1982 paper only covers equality conditions, many RETE
    implementations support other operations. For example, <code class="code">Account.name
    == "Mr Trout"</code> is a literal condition. When a rule has multiple
    literal conditions for a single object type, they are linked together.
    This means that if an application asserts an Account object, it must first
    satisfy the first literal condition before it can proceed to the next
    AlphaNode. In Dr. Forgy's paper, he refers to these as IntraElement
    conditions. The following diagram shows the AlphaNode combinations for
    Cheese( name == "cheddar", strength == "strong" ):</p><div class="figure"><a id="d0e1127"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Alpha_Nodes.png" align="middle" alt="AlphaNodes"/></div></div><p class="title"><b>Figure 3.5. AlphaNodes</b></p></div><br class="figure-break"/><p>Drools extends Rete by optimizing the propagation from
    ObjectTypeNode to AlphaNode using hashing. Each time an AlphaNode is added
    to an ObjectTypeNode it adds the literal value as a key to the HashMap
    with the AlphaNode as the value. When a new instance enters the ObjectType
    node, rather than propagating to each AlphaNode, it can instead retrieve
    the correct AlphaNode from the HashMap,thereby avoiding unnecessary
    literal checks.</p><p>There are two two-input nodes, JoinNode and NotNode, and both are
    types of BetaNodes. BetaNodes are used to compare 2 objects, and their
    fields, to each other. The objects may be the same or different types. By
    convention we refer to the two inputs as left and right. The left input
    for a BetaNode is generally a list of objects; in Drools this is a Tuple.
    The right input is a single object. Two Nodes can be used to implement
    'exists' checks. BetaNodes also have memory. The left input is called the
    Beta Memory and remembers all incoming tuples. The right input is called
    the Alpha Memory and remembers all incoming objects. Drools extends Rete
    by performing indexing on the BetaNodes. For instance, if we know that a
    BetaNode is performing a check on a String field, as each object enters we
    can do a hash lookup on that String value. This means when facts enter
    from the opposite side, instead of iterating over all the facts to find
    valid joins, we do a lookup returning potentially valid candidates. At any
    point a valid join is found the Tuple is joined with the Object; which is
    referred to as a partial match; and then propagated to the next
    node.</p><div class="figure"><a id="d0e1137"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Join_Node.png" align="middle" alt="JoinNode"/></div></div><p class="title"><b>Figure 3.6. JoinNode</b></p></div><br class="figure-break"/><p>To enable the first Object, in the above case Cheese, to enter the
    network we use a LeftInputNodeAdapter - this takes an Object as an input
    and propagates a single Object Tuple.</p><p>Terminal nodes are used to indicate a single rule having matched all
    its conditions; at this point we say the rule has a full match. A rule
    with an 'or' conditional disjunctive connective results in subrule
    generation for each possible logically branch; thus one rule can have
    multiple terminal nodes.</p><p>Drools also performs node sharing. Many rules repeat the same
    patterns, and node sharing allows us to collapse those patterns so that
    they don't have to be re-evaluated for every single instance. The
    following two rules share the first pattern, but not the last:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    
    rule
    when
        Cheese( $chedddar : name == "cheddar" )
        $person : Person( favouriteCheese == $cheddar )
    then
        System.out.println( $person.getName() + " likes cheddar" );
    end
    
   </pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    
    rule
    when
        Cheese( $chedddar : name == "cheddar" )
        $person : Person( favouriteCheese != $cheddar )
    then
        System.out.println( $person.getName() + " does not like cheddar" );
    end
    
  </pre><p>As you can see below, the compiled Rete network shows that the alpha
    node is shared, but the beta nodes are not. Each beta node has its own
    TerminalNode. Had the second pattern been the same it would have also been
    shared.</p><div class="figure"><a id="d0e1155"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Node_Sharing.png" align="middle" alt="Node Sharing"/></div></div><p class="title"><b>Figure 3.7. Node Sharing</b></p></div><br class="figure-break"/></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1161"/>Chapter 4. User Guide</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e1164">4.1. Building</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1173">4.1.1. Building using Code</a></span></dt><dt><span class="section"><a href="#d0e1254">4.1.2. Building using Configuration and the ChangeSet XML</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1310">4.2. Deploying</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1313">4.2.1. KnowledgePackage and Knowledge Definitions</a></span></dt><dt><span class="section"><a href="#d0e1326">4.2.2. KnowledgeBase</a></span></dt><dt><span class="section"><a href="#d0e1376">4.2.3. In-Process Building and Deployment</a></span></dt><dt><span class="section"><a href="#d0e1391">4.2.4. Building and Deployment in Separate Processes</a></span></dt><dt><span class="section"><a href="#d0e1430">4.2.5. StatefulknowledgeSessions and KnowledgeBase Modifications</a></span></dt><dt><span class="section"><a href="#d0e1444">4.2.6. KnowledgeAgent</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1569">4.3. Running</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1573">4.3.1. KnowledgeBase</a></span></dt><dt><span class="section"><a href="#d0e1592">4.3.2. StatefulKnowledgeSession</a></span></dt><dt><span class="section"><a href="#d0e1614">4.3.3. KnowledgeRuntime</a></span></dt><dt><span class="section"><a href="#d0e1898">4.3.4. Agenda</a></span></dt><dt><span class="section"><a href="#d0e2003">4.3.5. Event Model</a></span></dt><dt><span class="section"><a href="#d0e2118">4.3.6. KnowledgeRuntimeLogger</a></span></dt><dt><span class="section"><a href="#d0e2134">4.3.7. StatelessKnowledgeSession</a></span></dt><dt><span class="section"><a href="#d0e2329">4.3.8. Commands and the CommandExecutor</a></span></dt><dt><span class="section"><a href="#d0e2627">4.3.9. Marshalling</a></span></dt><dt><span class="section"><a href="#d0e2702">4.3.10. Persistence and Transactions</a></span></dt><dt><span class="section"><a href="#d0e2746">4.3.11. Drools Clips</a></span></dt></dl></dd></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1164"/>4.1. Building</h2></div></div></div><div class="figure"><a id="d0e1167"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/builder.png" alt="org.drools.builder"/></div></div><p class="title"><b>Figure 4.1. org.drools.builder</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1173"/>4.1.1. Building using Code</h3></div></div></div><p>The KnowledgeBuilder is responsible for taking source files, such as
    a DRL file or an Excel file, and turning them into a Knowledge Package of
    rule and process definitions which a Knowledge Base can consume. An object
    of the class <code class="code">ResourceType</code> indicates the type of resource it is being
    asked to build.</p><p>The <code class="code">ResourceFactory</code> provides capabilities to load resources from a
    number of sources, such as Reader, ClassPath, URL, File, or ByteArray.
    Binaries, such as decision tables (Excel .xls files), should not use a Reader based
    resource handler, which is only suitable for text based resources.</p><div class="figure"><a id="d0e1186"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeBuilder.png" alt="KnowledgeBuilder"/></div></div><p class="title"><b>Figure 4.2. KnowledgeBuilder</b></p></div><br class="figure-break"/><p>The KnowlegeBuilder is created using the
    KnowledgeBuilderFactory.</p><div class="figure"><a id="d0e1194"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeBuilderFactory.png" alt="KnowledgeBuilderFactory"/></div></div><p class="title"><b>Figure 4.3. KnowledgeBuilderFactory</b></p></div><br class="figure-break"/><p>A KnowledgeBuilder can be created using the default
    configuration.</p><div class="example"><a id="d0e1202"/><p class="title"><b>Example 4.1. Creating a new KnowledgeBuilder</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>A configuration can be created using the <code class="code">KnowledgeBuilderFactory</code>.
    This allows the behavior of the Knowledge Builder to be modified. The most
    common usage is to provide a custom class loader so that the <code class="code">KnowledgeBuilder</code>
    object can resolve classes that are not in the default classpath. The first parameter
    is for properties and is optional, i.e., it may be left null, in which case the
    default options will be used. The options parameter can be used for things
    like changing the dialect or registering new accumulator functions.</p><div class="example"><a id="d0e1215"/><p class="title"><b>Example 4.2. Creating a new KnowledgeBuilder with a custom ClassLoader</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilderConfiguration</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilderConf&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilderConfiguration</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">null</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;classLoader&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kbuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">(</span><span class="java_plain">kbuilderConf</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>Resources of any type can be added iteratively. Below, a DRL file is
    added. Unlike Drools 4.0 Package Builder, the Knowledge Builder can now
    handle multiple namespaces, so you can just keep adding resources
    regardless of namespace.</p><div class="example"><a id="d0e1222"/><p class="title"><b>Example 4.3. Adding DRL Resources</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">kbuilder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">add</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ResourceFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newFileResource</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;/project/myrules.drl&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>It is best practice to always check the <code class="code">hasErrors()</code> method after an
    addition. You should not add more resources or retrieve the Knowledge Packages
    if there are errors. <code class="code">getKnowledgePackages()</code> returns an empty list if
    there are errors.</p><div class="example"><a id="d0e1235"/><p class="title"><b>Example 4.4. Validating</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">if</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">hasErrors</span><!-- <br/> --><span class="java_separator">()</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span>
</pre></div></div><br class="example-break"/><p>When all the resources have been added and there are no errors the
    collection of Knowledge Packages can be retrieved. It is a Collection because
    there is one Knowledge Package per package namespace. These
    Knowledge Packages are serializable and often used as a unit of
    deployment.</p><div class="example"><a id="d0e1242"/><p class="title"><b>Example 4.5. Getting the KnowledgePackages</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Collection</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">KnowledgePackage</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;kpkgs&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getKnowledgePackages</span><!-- <br/> --><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>The final example puts it all together.</p><div class="example"><a id="d0e1249"/><p class="title"><b>Example 4.6. Putting it all together</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kbuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newFileResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;/project/myrules1.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newFileResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;/project/myrules2.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">KnowledgePackage</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;kpkgs&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1254"/>4.1.2. Building using Configuration and the ChangeSet XML</h3></div></div></div><p>Instead of adding the resources to create definitions
    programmatically it is also possible to do it by configuration, via the
    ChangeSet XML. The simple XML file supports
    three elements: add, remove, and modify, each of which has a sequence
    of &lt;resource&gt; subelements defining a configuration entity. The
    following XML schema is <span class="emphasis"><em>not</em></span> normative and
    intended for illustration only.</p><div class="example"><a id="d0e1262"/><p class="title"><b>Example 4.7. XML Schema for ChangeSet XML (not normative)</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:schema</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.w3.org/2001/XMLSchema&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://drools.org/drools-5.0/change-set&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">targetNamespace</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://drools.org/drools-5.0/change-set&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:element</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;change-set&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ChangeSet&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:complexType</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ChangeSet&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:choice</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">maxOccurs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;unbounded&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:element</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;add&quot;</span><span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Operation&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:element</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;remove&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Operation&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:element</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;modify&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Operation&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:choice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:complexType</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:complexType</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Operation&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:sequence</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:element</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;resource&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Resource&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">maxOccurs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;unbounded&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:sequence</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:complexType</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:complexType</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Resource&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:sequence</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:element</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;decisiontable-conf&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DecTabConf&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">minOccurs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;0&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:sequence</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;source&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;xs:string&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;type&quot;</span><span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ResourceType&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:complexType</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:complexType</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DecTabConf&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;input-type&quot;</span><span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DecTabInpType&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;worksheet-name&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;xs:string&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">use</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;optional&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:complexType</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><br />
<!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:simpleType</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ResourceType&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">base</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;xs:string&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DRL&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;XDRL&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DSL&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DSLR&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DRF&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DTABLE&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;PKG&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;BRL&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;CHANGE_SET&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:restriction</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:simpleType</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><br />
<!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:simpleType</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DecTabInpType&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">base</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;xs:string&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;XLS&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">xs:enumeration</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;CSV&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:restriction</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:simpleType</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">xs:schema</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>Currently only the add element is supported, but the others will be implemented to
    support iterative changes. The following example loads a single DRL file.</p><div class="example"><a id="d0e1277"/><p class="title"><b>Example 4.8. Simple ChangeSet XML</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set.xsd&nbsp;http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'file:/project/myrules.drl'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'DRL'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>Notice the <code class="code">file:</code> prefix, which signifies the protocol for the
    resource. The Change Set supports all the protocols provided by
    java.net.URL, such as "file" and "http", as well as an additional
    "classpath". Currently the type attribute must always be specified for a
    resource, as it is not inferred from the file name extension. Using the
    ClassPath resource loader in Java allows you to specify the Class Loader to
    be used to locate the resource but this is not possible from XML. Instead,
    the Class Loader will default to the one used by the Knowledge Builder
    unless the ChangeSet XML is itself loaded by the ClassPath resource, in
    which case it will use the Class Loader specified for that resource.</p><p>Currently you still need to use the API to load that ChangeSet, but
    we will add support for containers such as Spring in the future, so that the
    process of creating a Knowledge Base can be done completely by XML configuration.
    Loading resources using an XML file couldn't be simpler, as it's just another
    resource type.</p><div class="example"><a id="d0e1289"/><p class="title"><b>Example 4.9. Loading the ChangeSet XML</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">kbuilder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">add</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ResourceFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newUrlResource</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;url&nbsp;</span><!-- <br/> --><span class="java_separator">),</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ResourceType</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">CHANGE_SET&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>ChangeSets can include any number of resources, and they even support
    additional configuration information, which currently is only needed for
    decision tables. Below, the example is expanded to load rules from a
    http URL location, and an Excel decision table from the classpath.</p><div class="example"><a id="d0e1296"/><p class="title"><b>Example 4.10. ChangeSet XML with resource configuration</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set.xsd&nbsp;http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http:org/domain/myrules.drl'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'DRL'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'classpath:data/IntegrationExampleTest.xls'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;DTABLE&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">decisiontable-conf</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">input-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;XLS&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">worksheet-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Tables_2&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">resource</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>The ChangeSet is especially useful when working with a Knowledge Agent,
    as it allows for change notification and automatic rebuilding of the
    Knowledge Base, which is covered in more detail in the section on the
    Knowledge Agent, under Deploying.</p><p>Directories can also be specified, to add all resources
    in that folder. Currently it is expected that all resources in
    that folder are of the same type. If you use the Knowledge Agent it will
    provide a continous scanning for added, modified or removed resources and
    rebuild the cached Knowledge Base. The KnowledgeAgent provides more
    information on this.</p><div class="example"><a id="d0e1305"/><p class="title"><b>Example 4.11. ChangeSet XML which adds a directory's contents</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set.xsd&nbsp;http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'file:/projects/myproject/myrules'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'DRL'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1310"/>4.2. Deploying</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1313"/>4.2.1. KnowledgePackage and Knowledge Definitions</h3></div></div></div><p>A Knowledge Package is a collection of Knowledge Definitions, such
    as rules and processes. It is created by the Knowledge Builder, as
    described in the chapter "Building". Knowledge Packages are self-contained and
    serializable, and they currently form the basic deployment unit.</p><div class="figure"><a id="d0e1318"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgePackage.png" alt="KnowledgePackage"/></div></div><p class="title"><b>Figure 4.4. KnowledgePackage</b></p></div><br class="figure-break"/><p>Knowledge Packages are added to the Knowledge Base. However, a
    Knowledge Package instance cannot be reused once it's added to the
    Knowledge Base. If you need to add it to another Knowledge Base, try
    serializing it first and using the "cloned" result. We hope to fix this
    limitation in future versions of Drools.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1326"/>4.2.2. KnowledgeBase</h3></div></div></div><p>The Knowlege Base is a repository of all the application's knowledge
    definitions. It may contain rules, processes, functions, and type models.
    The Knowledge Base itself does not contain instance data, known as facts;
    instead, sessions are created from the Knowledge Base into which data can be
    inserted and where process instances may be started. Creating the
    Knowlege Base can be
    heavy, whereas session creation is very light, so it is recommended that
    Knowledge Bases be cached where possible to allow for repeated session
    creation.</p><div class="figure"><a id="d0e1331"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeBase.png" alt="KnowledgeBase"/></div></div><p class="title"><b>Figure 4.5. KnowledgeBase</b></p></div><br class="figure-break"/><p>A <code class="code">KnowledgeBase</code> object is also serializable, and some people
    may prefer to build and then store a <code class="code">KnowledgeBase</code>, treating it also 
    as a unit of deployment, instead of the Knowledge Packages.</p><p>The KnowlegeBase is created using the KnowledgeBaseFactory.</p><div class="figure"><a id="d0e1347"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeBaseFactory.png" alt="KnowledgeBaseFactory"/></div></div><p class="title"><b>Figure 4.6. KnowledgeBaseFactory</b></p></div><br class="figure-break"/><p>A KnowledgeBase can be created using the default
    configuration.</p><div class="example"><a id="d0e1355"/><p class="title"><b>Example 4.12. Creating a new KnowledgeBase</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBase</span><!-- <br/> --><span class="java_plain">&nbsp;kbase&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBaseFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBase</span><!-- <br/> --><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>If a custom class loader was used with the <code class="code">KnowledgeBuilder</code> to
    resolve types not in the default class loader, then that must also be set
    on the <code class="code">KnowledgeBase</code>. The technique for this is the same as with the
    <code class="code">KnowledgeBuilder</code>.</p><div class="example"><a id="d0e1371"/><p class="title"><b>Example 4.13. Creating a new KnowledgeBase with a custom ClassLoader</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBaseConfiguration</span><!-- <br/> --><span class="java_plain">&nbsp;kbaseConf&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">createKnowledgeBaseConfiguration</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span><span class="java_plain">&nbsp;cl&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbaseConf&nbsp;</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1376"/>4.2.3. In-Process Building and Deployment</h3></div></div></div><p>This is the simplest form of deployment. It compiles the
    knowledge definitions and adds them to the Knowledge Base in the same JVM.
    This approach requires drools-core.jar and drools-compiler.jar to be on
    the classpath.</p><div class="example"><a id="d0e1381"/><p class="title"><b>Example 4.14. Add KnowledgePackages to a KnowledgeBase</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Collection</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">KnowledgePackage</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;kpkgs&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getKnowledgePackages</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kpkgs&nbsp;</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/><p>Note that the <code class="code">addKnowledgePackages(kpkgs)</code> method can be called
    iteratively to add additional knowledge.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1391"/>4.2.4. Building and Deployment in Separate Processes</h3></div></div></div><p>Both the <code class="code">KnowledgeBase</code> and the <code class="code">KnowledgePackage</code>
    are units of
    deployment and serializable. This means you can have one machine do any
    necessary building, requiring <code class="filename">drools-compiler.jar</code>, and
    have another machine deploy and execute everything, needing only
    <code class="filename">drools-core.jar</code>.</p><p>Although serialization is standard Java, we present an example of
    how one  machine might write out the deployment unit and how another 
    machine might read in and use that deployment unit.</p><div class="example"><a id="d0e1410"/><p class="title"><b>Example 4.15. Writing the KnowledgePackage to an OutputStream</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">ObjectOutputStream</span><!-- <br/> --><span class="java_plain">&nbsp;out&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ObjectOutputStream</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">FileOutputStream</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;fileName&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">writeObject</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kpkgs&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><div class="example"><a id="d0e1415"/><p class="title"><b>Example 4.16. Reading the KnowledgePackage from an InputStream</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">ObjectInputStream</span><!-- <br/> --><span class="java_plain">&nbsp;in&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ObjectInputStream</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">FileInputStream</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;fileName&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;input&nbsp;stream&nbsp;might&nbsp;contain&nbsp;an&nbsp;individual</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_keyword">package</span><span class="java_plain">&nbsp;or&nbsp;a&nbsp;collection</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SuppressWarnings</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;unchecked&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">KnowledgePackage</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;kpkgs&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">()</span><span class="java_plain">in</span><span class="java_separator">.</span><span class="java_plain">readObject</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">KnowledgePackage</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">in</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kpkgs&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>The <code class="code">KnowledgeBase</code> is also serializable and some people may prefer
      to build and then store the <code class="code">KnowledgeBase</code> itself, instead of the
      Knowledge Packages.</p><p>Drools Guvnor, our server side management system, uses this
      deployment approach. After Guvnor has compiled and published serialized
      Knowledge Packages on a URL, Drools can use the URL resource type
      to load them.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1430"/>4.2.5. StatefulknowledgeSessions and KnowledgeBase Modifications</h3></div></div></div><p>Stateful Knowledge Sessions will be discussed in more detail in
    section "Running". The <code class="code">KnowledgeBase</code> creates and returns
    <code class="code">StatefulKnowledgeSession</code> objects, and it may optionally
    keep references to those.
    When <code class="code">KnowledgeBase</code> modifications occur those modifications are applied
    against the data in the sessions. This reference is a weak reference and it
    is also optional, which is controlled by a boolean flag.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1444"/>4.2.6. KnowledgeAgent</h3></div></div></div><p>The <code class="code">KnowlegeAgent</code> provides automatic loading, caching and
    re-loading of resources and is configured from a properties files. The
    Knowledge Agent can update or rebuild this Knowlege Base as the
    resources it uses are changed. The strategy for this is determined by the configuration
    given to the factory, but it is typically pull-based using regular
    polling. We hope to add push-based updates and rebuilds in future
    versions. The Knowledge Agent will continuously scan all the added
    resources, using a default polling interval of 60 seconds. If their 
    date of the last modification is updated it will rebuild the cached
    Knowledge Base using the new resources.</p><div class="figure"><a id="d0e1452"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeAgent.png" alt="KnowledgeAgent"/></div></div><p class="title"><b>Figure 4.7. KnowledgeAgent</b></p></div><br class="figure-break"/><p>The <code class="code">KnowlegeBuilder</code> is created using a
    <code class="code">KnowledgeBuilderFactory</code> object.
    The agent must specify a name, which is used in the log files to associate
    a log entry with the corresponding agent.</p><div class="example"><a id="d0e1466"/><p class="title"><b>Example 4.17. Creating the KnowledgeAgent</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeAgent</span><!-- <br/> --><span class="java_plain">&nbsp;kagent&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeAgentFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeAgent</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;MyAgent&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><div class="figure"><a id="d0e1471"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeAgentFactory.png" alt="KnowledgeAgentFactory"/></div></div><p class="title"><b>Figure 4.8. KnowledgeAgentFactory</b></p></div><br class="figure-break"/><p>The following example constructs an agent that will build a new
    KnowledgeBase from the specified ChangeSet. (See section "Building" for
    more details on the ChangeSet format.) Note that the method can be called
    iteratively to add new resources over time. 
    The Knowledge Agent polls the resources added from the ChangeSet 
    every 60 seconds, the default interval, to see if they are updated.
    Whenever changes are found it will construct a new Knowledge Base or apply
    the modifications to the existing Knowledge Base according to its
    configuration.
    If the change set specifies a resource that
    is a directory its contents will be scanned for changes, too.</p><div class="example"><a id="d0e1479"/><p class="title"><b>Example 4.18. Writing the KnowledgePackage to an OutputStream</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeAgent</span><!-- <br/> --><span class="java_plain">&nbsp;kagent&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeAgentFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeAgent</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;MyAgent&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">kagent</span><span class="java_separator">.</span><span class="java_plain">applyChangeSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newUrlResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;url&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kagent</span><span class="java_separator">.</span><span class="java_plain">getKnowledgeBase</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>Resource scanning is not on by default, it's a service and must be
    started, and the same is true for notification. Both can be done via the
    ResourceFactory.</p><div class="example"><a id="d0e1486"/><p class="title"><b>Example 4.19. Starting the Scanning and Notification Services</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">ResourceFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getResourceChangeNotifierService</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">start</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">getResourceChangeScannerService</span><span class="java_separator">().</span><span class="java_plain">start</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>The default resource scanning period may be changed via the
    <code class="code">ResourceChangeScannerService</code>. A suitably updated 
    <code class="code">ResourceChangeScannerConfiguration</code> object is passed to the service's
    <code class="code">configure()</code> method, which allows for the service to be reconfigured on
    demand.</p><div class="example"><a id="d0e1502"/><p class="title"><b>Example 4.20. Changing the Scanning Intervals</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">ResourceChangeScannerConfiguration</span><!-- <br/> --><span class="java_plain">&nbsp;sconf&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">getResourceChangeScannerService</span><span class="java_separator">().</span><span class="java_plain">newResourceChangeScannerConfiguration</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_plain">&nbsp;the&nbsp;disk&nbsp;scanning&nbsp;interval&nbsp;to&nbsp;</span><span class="java_literal">30</span><span class="java_plain">s</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">default</span><span class="java_plain">&nbsp;is&nbsp;</span><span class="java_literal">60</span><span class="java_plain">s</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">sconf</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;drools.resource.scanner.interval&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;30&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">getResourceChangeScannerService</span><span class="java_separator">().</span><span class="java_plain">configure</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sconf&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>Knowledge Agents can take an empty Knowledge Base or a populated one.
    If a populated Knowledge Base is provided, the Knowledge Agent will
    run an iterator from Knowledge Base and subscribe to the resources that
    it finds. While it is
    possible for the Knowledge Builder to build all resources found in a
    directory, that information is lost by the Knowledge Builder so that those
    directories will not be continuously scanned. Only directories specified
    as part of the <code class="code">applyChangeSet(Resource)</code> method are monitored.</p><p>One of the advantages of providing <code class="code">KnowledgeBase</code> as the starting
    point is that you can provide it with a <code class="code">KnowledgeBaseConfiguration</code>. When
    resource changes are detected and a new <code class="code">KnowledgeBase</code> object is
    instantiated, it will use the <code class="code">KnowledgeBaseConfiguration</code> of the previous
    <code class="code">KnowledgeBase</code> object.</p><div class="example"><a id="d0e1529"/><p class="title"><b>Example 4.21. Using an existing KnowledgeBase</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBaseConfiguration</span><!-- <br/> --><span class="java_plain">&nbsp;kbaseConf&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">createKnowledgeBaseConfiguration</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span><span class="java_plain">&nbsp;cl&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbaseConf&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Populate</span><span class="java_plain">&nbsp;kbase&nbsp;with&nbsp;resources&nbsp;here</span><span class="java_separator">.</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeAgent</span><span class="java_plain">&nbsp;kagent&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeAgentFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeAgent</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;MyAgent&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kagent</span><span class="java_separator">.</span><span class="java_plain">getKnowledgeBase</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>In the above example <code class="code">getKnowledgeBase()</code> will return the same
    provided kbase instance until resource changes are detected and a new
    Knowledge Base is built. When the new Knowledge Base is built, it will be
    done with the <code class="code">KnowledgeBaseConfiguration</code> that was provided to 
    the previous <code class="code">KnowledgeBase</code>.</p><p>As mentioned previously, a ChangeSet XML can specify a directory and
    all of its contents will be added. If this ChangeSet XML is used with the
    <code class="code">applyChangeSet()</code> method it will also add any directories to the scanning
    process. When the directory scan detects an additional file, it will be 
    added to the Knowledge Base; any removed file is removed from the
    Knowledge Base, and modified files will be removed from the Knowledge Base.
    </p><div class="example"><a id="d0e1550"/><p class="title"><b>Example 4.22. ChangeSet XML which adds a directories contents</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">change-set</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://www.w3.org/2001/XMLSchema-instance'</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'http://drools.org/drools-5.0/change-set.xsd'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'file:/projects/myproject/myrules'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'PKG'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">add</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">change-set</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>Note that for the resource type PKG the drools-compiler dependency is
    not needed as the Knowledge Agent is able to handle those with just
    drools-core.</p><p>The <code class="code">KnowledgeAgentConfiguration</code> can be used to modify a
    Knowledge Agent's default behavior. You could use this to load
    the resources from a directory, while inhibiting the continuous scan
    for changes of that directory.</p><div class="example"><a id="d0e1562"/><p class="title"><b>Example 4.23. Change the Scanning Behavior</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBase</span><!-- <br/> --><span class="java_plain">&nbsp;kbase&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBaseFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBase</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeAgentConfiguration</span><span class="java_plain">&nbsp;kaconf&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeAgentFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeAgentConfiguation</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Do</span><span class="java_plain">&nbsp;not&nbsp;scan&nbsp;directories</span><span class="java_separator">,</span><span class="java_plain">&nbsp;just&nbsp;files</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">kaconf</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;drools.agent.scanDirectories&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;false&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeAgent</span><span class="java_plain">&nbsp;kagent&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeAgentFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeAgent</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;test&nbsp;agent&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;kaconf&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>Previously we mentioned Drools Guvnor and how it can build and
    publish serialized Knowledge Packages on a URL, and that the
    ChangeSet XML can handle URLs and Packages. Taken together, this forms
    an importanty deployment scenario for the Knowledge Agent.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1569"/>4.3. Running</h2></div></div></div><p/><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1573"/>4.3.1. KnowledgeBase</h3></div></div></div><p>The <code class="code">KnowlegeBase</code> is a repository of all the
    application's knowledge definitions. It will contain rules, processes,
    functions, and type models. The Knowledge Base itself does not contain
    data; instead, sessions are created from the <code class="code">KnowledgeBase</code>
    into which data can be inserted and from which process instances may be
    started. Creating the <code class="code">KnowlegeBase</code> can be heavy, whereas
    session creation is very light, so it is recommended that Knowle Bases be
    cached where possible to allow for repeated session creation.</p><div class="example"><a id="d0e1587"/><p class="title"><b>Example 4.24. Creating a new KnowledgeBase</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBase</span><!-- <br/> --><span class="java_plain">&nbsp;kbase&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBaseFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBase</span><!-- <br/> --><span class="java_separator">();</span></pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1592"/>4.3.2. StatefulKnowledgeSession</h3></div></div></div><p>The <code class="code">StatefulKnowledgeSession</code> stores and executes on the
    runtime data. It is created from the <code class="code">KnowledgeBase</code>.</p><div class="figure"><a id="d0e1603"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/StatefulKnowledgeSession.png" alt="StatefulKnowledgeSession"/></div></div><p class="title"><b>Figure 4.9. StatefulKnowledgeSession</b></p></div><br class="figure-break"/><div class="example"><a id="d0e1609"/><p class="title"><b>Example 4.25. Create a StatefulKnowledgeSession from a KnowledgeBase</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatefulKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatefulKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1614"/>4.3.3. KnowledgeRuntime</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1617"/>4.3.3.1. WorkingMemoryEntryPoint</h4></div></div></div><p>The <code class="code">WorkingMemoryEntryPoint</code> provides the methods
      around inserting, updating and retrieving facts. The term "entry point"
      is related to the fact that we have multiple partitions in a Working
      Memory and you can choose which one you are inserting into, although
      this use case is aimed at event processing and covered in more detail in
      the Fusion manual. Most rule based applications will work with the
      default entry point alone.</p><p>The <code class="code">KnowledgeRuntime</code> interface provides the main
      interaction with the engine. It is available in rule consequences and
      process actions. In this manual the focus is on the methods and
      interfaces related to rules, and the methods pertaining to processes
      will be ignored for now. But you'll notice that the
      <code class="code">KnowledgeRuntime</code> inherits methods from both the
      <code class="code">WorkingMemory</code> and the <code class="code">ProcessRuntime</code>, thereby
      providing a unified API to work with processes and rules. When working
      with rules, three interfaces form the <code class="code">KnowledgeRuntime</code>:
      <code class="code">WorkingMemoryEntryPoint</code>, <code class="code">WorkingMemory</code> and the
      <code class="code">KnowledgeRuntime</code> itself.</p><div class="figure"><a id="d0e1651"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/WorkingMemoryEntryPoint.png" alt="WorkingMemoryEntryPoint"/></div></div><p class="title"><b>Figure 4.10. WorkingMemoryEntryPoint</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1657"/>4.3.3.1.1. Insertion</h5></div></div></div><p>Insertion is the act of telling the <code class="code">WorkingMemory</code>
        about a fact, which you do by
        <code class="code">ksession.insert(yourObject)</code>, for example. When you insert
        a fact, it is examined for matches against the rules. This means
        <span class="emphasis"><em>all</em></span> of the work for deciding about firing or not
        firing a rule is done during insertion; no rule, however, is executed
        until you call <code class="code">fireAllRules()</code>, which you call after you
        have finished inserting your facts. It is a common misunderstanding
        for people to think the condition evaluation happens when you call
        <code class="code">fireAllRules()</code>. Expert systems typically use the term
        <span class="emphasis"><em>assert</em></span> or <span class="emphasis"><em>assertion</em></span> to refer
        to facts made available to the system. However, due to "assert" being
        a keyword in most languages, we have decided to use the
        <code class="literal">insert</code> keyword; so expect to hear the two used
        interchangeably.</p><p>When an Object is inserted it returns a <code class="code">FactHandle</code>.
        This <code class="code">FactHandle</code> is the token used to represent your
        inserted object within the <code class="code">WorkingMemory</code>. It is also used
        for interactions with the <code class="code">WorkingMemory</code> when you wish to
        retract or modify an object.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Cheese</span><!-- <br/> --><span class="java_plain">&nbsp;stilton&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Cheese</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;stilton&quot;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">FactHandle</span><span class="java_plain">&nbsp;stiltonHandle&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;stilton&nbsp;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre><p>As mentioned in the Knowledge Base section, a Working Memory may
        operate in two assertion modes, i.e., equality or identity, with
        identity being the default.</p><p><span class="emphasis"><em>Identity</em></span> means that the Working Memory uses
        an <code class="code">IdentityHashMap</code> to store all asserted objects. New
        instance assertions always result in the return of a new
        <code class="code">FactHandle</code>, but if an instance is asserted again then it
        returns the original fact handle, i.e., it ignores repeated insertions
        for the same fact.</p><p><span class="emphasis"><em>Equality</em></span> means that the Working Memory uses
        a <code class="code">HashMap</code> to store all asserted Objects. New instance
        assertions will only return a new <code class="code">FactHandle</code> if no equal
        objects have been asserted.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1725"/>4.3.3.1.2. Retraction</h5></div></div></div><p>Retraction is the removal of a fact from Working Memory, which
        means that it will no longer track and match that fact, and any rules
        that are activated and dependent on that fact will be cancelled. Note
        that it is possible to have rules that depend on the nonexistence of a
        fact, in which case retracting a fact may cause a rule to activate.
        (See the <code class="code">not</code> and <code class="code">exist</code> keywords.) Retraction
        is done using the <code class="code">FactHandle</code> that was returned by the
        insert call.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Cheese</span><!-- <br/> --><span class="java_plain">&nbsp;stilton&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Cheese</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;stilton&quot;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">FactHandle</span><span class="java_plain">&nbsp;stiltonHandle&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;stilton&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">....</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">retract</span><span class="java_separator">(</span><span class="java_plain">&nbsp;stiltonHandle&nbsp;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1741"/>4.3.3.1.3. Update</h5></div></div></div><p>The Rule Engine must be notified of modified facts, so that they
        can be reprocessed. Internally, modification is actually a retract
        followed by an insert; the Rule Engine removes the fact from the
        <code class="code">WorkingMemory</code> and inserts it again. You must use the
        <code class="code">update()</code> method to notify the <code class="code">WorkingMemory</code>
        of changed objects for those objects that are not able to notify the
        <code class="code">WorkingMemory</code> themselves. Notice that
        <code class="code">update()</code> always takes the modified object as a second
        parameter, which allows you to specify new instances for immutable
        objects. The <code class="code">update()</code> method can only be used with
        objects that have shadow proxies turned on. The update method is only
        available within Java code. On the right hand side of a rule, also the
        <code class="literal">modify</code> statement is supported, providing simplified
        calls to the object's setters.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Cheese</span><!-- <br/> --><span class="java_plain">&nbsp;stilton&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Cheese</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;stilton&quot;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">FactHandle</span><span class="java_plain">&nbsp;stiltonHandle&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;workingMemory</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;stilton&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">stilton</span><span class="java_separator">.</span><span class="java_plain">setPrice</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">100</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">workingMemory</span><span class="java_separator">.</span><span class="java_plain">update</span><span class="java_separator">(</span><span class="java_plain">&nbsp;stiltonHandle</span><span class="java_separator">,</span><span class="java_plain">&nbsp;stilton&nbsp;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1769"/>4.3.3.2. WorkingMemory</h4></div></div></div><p>The WorkingMemory provides access to the Agenda, permits query
      executions, and lets you access named Enty Points.</p><div class="figure"><a id="d0e1774"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/WorkingMemory.png" alt="WorkingMemory"/></div></div><p class="title"><b>Figure 4.11. WorkingMemory</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1780"/>4.3.3.2.1. Query</h5></div></div></div><p>Queries are used to retrieve fact sets based on patterns, as
        they are used in rules. Patterns may make use of optional parameters.
        Queries can be defined in the Knowlege Base, from where they are
        called up to return the matching results. While iterating over the
        result collection, any bound identifier in the query can be accessed
        using the get(String identifier) method and any FactHandle for that
        identifier can be retrieved using getFactHandle(String
        identifier).</p><div class="figure"><a id="d0e1785"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/QueryResults.png" alt="QueryResults"/></div></div><p class="title"><b>Figure 4.12. QueryResults</b></p></div><br class="figure-break"/><div class="figure"><a id="d0e1791"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/QueryResultsRow.png" alt="QueryResultsRow"/></div></div><p class="title"><b>Figure 4.13. QueryResultsRow</b></p></div><br class="figure-break"/><div class="example"><a id="d0e1797"/><p class="title"><b>Example 4.26. Simple Query Example</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">QueryResults</span><!-- <br/> --><span class="java_plain">&nbsp;results&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">getQueryResults</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;my&nbsp;query&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;string&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">for</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">QueryResultsRow</span><span class="java_plain">&nbsp;row&nbsp;</span><span class="java_operator">:</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;row</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;varName&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1802"/>4.3.3.2.2. Live Querries</h5></div></div></div><p>Drools has always had query support, but the result was returned
        as an iterable set; this makes it hard to monitor changes over
        time.</p><p>We have now complimented this with Live Querries, which has a
        listener attached instead of returning an iterable result set. These
        live querries stay open creating a view and publish change events for
        the contents of this view. So now you can execute your query, with
        parameters and listen to changes in the resulting view.</p><div class="example"><a id="d0e1809"/><p class="title"><b>Example 4.27. Implementing ViewChangedEventListener</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">final</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">List</span><!-- <br/> --><span class="java_plain">&nbsp;updated&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ArrayList</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">List</span><span class="java_plain">&nbsp;removed&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">List</span><span class="java_plain">&nbsp;added&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_type">ViewChangedEventListener</span><span class="java_plain">&nbsp;listener&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ViewChangedEventListener</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;rowUpdated</span><span class="java_separator">(</span><span class="java_type">Row</span><span class="java_plain">&nbsp;row</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;updated</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;row</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;$price&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;rowRemoved</span><span class="java_separator">(</span><span class="java_type">Row</span><span class="java_plain">&nbsp;row</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;removed</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;row</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;$price&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;rowAdded</span><span class="java_separator">(</span><span class="java_type">Row</span><span class="java_plain">&nbsp;row</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;added</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;row</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;$price&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">};</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Open</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">LiveQuery</span>
<!--  --><br/><span class="java_type">LiveQuery</span><span class="java_plain">&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">openLiveQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;cheeses&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;cheddar&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;stilton&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">},</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;listener&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">dispose</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;make&nbsp;sure&nbsp;you&nbsp;call&nbsp;dispose&nbsp;when&nbsp;you&nbsp;want&nbsp;the&nbsp;query&nbsp;to&nbsp;close</span></pre></div></div><br class="example-break"/><p>A Drools blog article contains an example of Glazed Lists
        integration for live queries,</p><p><a class="link" href="http://blog.athico.com/2010/07/glazed-lists-examples-for-drools-live.html" target="">http://blog.athico.com/2010/07/glazed-lists-examples-for-drools-live.html</a></p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1819"/>4.3.3.3. KnowledgeRuntime</h4></div></div></div><p>The <code class="code">KnowledgeRuntime</code> provides further methods that
      are applicable to both rules and processes, such as setting globals and
      registering <code class="code">Channels</code> (previously exit points, some
      references may remain in docs for a while).</p><div class="figure"><a id="d0e1830"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeRuntime.png" alt="KnowledgeRuntime"/></div></div><p class="title"><b>Figure 4.14. KnowledgeRuntime</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1836"/>4.3.3.3.1. Globals</h5></div></div></div><p>Globals are named objects that can be passed to the rule engine,
        without needing to insert them. Most often these are used for static
        information, or for services that are used in the RHS of a rule, or
        perhaps as a means to return objects from the rule engine. If you use
        a global on the LHS of a rule, make sure it is immutable. A global
        must first be declared in a rules file before it can be set on the
        session.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">global java.util.List list</pre><p>With the Knowledge Base now aware of the global identifier and
        its type, it is now possible to call <code class="code">ksession.setGlobal()</code>
        for any session. Failure to declare the global type and identifier
        first will result in an exception being thrown. To set the global on
        the session use <code class="code">ksession.setGlobal(identifier,
        value)</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">List</span><!-- <br/> --><span class="java_plain">&nbsp;list&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ArrayList</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">setGlobal</span><span class="java_separator">(</span><span class="java_literal">&quot;list&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;list</span><span class="java_separator">);</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre><p>If a rule evaluates on a global before you set it you will get a
        <code class="code">NullPointerException</code>.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1858"/>4.3.3.4. StatefulRuleSession</h4></div></div></div><p>The <code class="code">StatefulRuleSession</code> is inherited by the
      <code class="code">StatefulKnowledgeSession</code> and provides the rule related
      methods that are relevant from outside of the engine.</p><div class="figure"><a id="d0e1869"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/StatefulRuleSession.png" alt="StatefulRuleSession"/></div></div><p class="title"><b>Figure 4.15. StatefulRuleSession</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1875"/>4.3.3.4.1. Agenda Filters</h5></div></div></div><div class="figure"><a id="d0e1878"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-User_Guide/AgendaFilter.png" align="middle" alt="AgendaFilters"/></div></div><p class="title"><b>Figure 4.16. AgendaFilters</b></p></div><br class="figure-break"/><p><code class="code">AgendaFilter</code> objects are optional implementations
        of the filter interface which are used to allow or deny the firing of
        an activation. What you filter on is entirely up to the
        implementation. Drools 4.0 used to supply some out of the box filters,
        which have not be exposed in drools 5.0 knowledge-api, but they are
        simple to implement and the Drools 4.0 code base can be referred
        to.</p><p>To use a filter specify it while calling
        <code class="code">fireAllRules()</code>. The following example permits only rules
        ending in the string <code class="code">"Test"</code>. All others will be filtered
        out.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">fireAllRules</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">RuleNameEndsWithAgendaFilter</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;Test&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span></pre></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1898"/>4.3.4. Agenda</h3></div></div></div><p>The Agenda is a <span class="emphasis"><em>Rete</em></span> feature. During actions on
    the <code class="code">WorkingMemory</code>, rules may become fully matched and
    eligible for execution; a single Working Memory Action can result in
    multiple eligible rules. When a rule is fully matched an Activation is
    created, referencing the rule and the matched facts, and placed onto the
    Agenda. The Agenda controls the execution order of these Activations using
    a Conflict Resolution strategy.</p><p>The engine cycles repeatedly through two phases:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Working Memory Actions. This is where most of the work takes
        place, either in the Consequence (the RHS itself) or the main Java
        application process. Once the Consequence has finished or the main
        Java application process calls <code class="code">fireAllRules()</code> the engine
        switches to the Agenda Evaluation phase.</p></li><li><p>Agenda Evaluation. This attempts to select a rule to fire. If no
        rule is found it exits, otherwise it fires the found rule, switching
        the phase back to Working Memory Actions.</p></li></ol></div><div class="figure"><a id="d0e1921"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Engine/Two_Phase.png" align="middle" alt="Two Phase Execution"/></div></div><p class="title"><b>Figure 4.17. Two Phase Execution</b></p></div><br class="figure-break"/><p>The process repeats until the agenda is clear, in which case control
    returns to the calling application. When Working Memory Actions are taking
    place, no rules are being fired.</p><div class="figure"><a id="d0e1929"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/Agenda.png" alt="Agenda"/></div></div><p class="title"><b>Figure 4.18. Agenda</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1935"/>4.3.4.1. Conflict Resolution</h4></div></div></div><p>Conflict resolution is required when there are multiple rules on
      the agenda. (The basics to this are covered in chapter "Quick Start".)
      As firing a rule may have side effects on the working memory, the rule
      engine needs to know in what order the rules should fire (for instance,
      firing ruleA may cause ruleB to be removed from the agenda).</p><p>The default conflict resolution strategies employed by Drools are:
      Salience and LIFO (last in, first out).</p><p>The most visible one is <span class="emphasis"><em>salience</em></span> (or
      priority), in which case a user can specify that a certain rule has a
      higher priority (by giving it a higher number) than other rules. In that
      case, the rule with higher salience will be preferred. LIFO priorities
      are based on the assigned Working Memory Action counter value, with all
      rules created during the same action receiving the same value. The
      execution order of a set of firings with the same priority value is
      arbitrary.</p><p>As a general rule, it is a good idea not to count on rules firing
      in any particular order, and to author the rules without worrying about
      a "flow". However when a flow is needed a number of possibilities exist,
      including but not limited to: agenda groups, rule flow groups,
      activation groups, control/semaphore facts. These are discussed in later
      sections.</p><p>Drools 4.0 supported custom conflict resolution strategies; while
      this capability still exists in Drools it has not yet been exposed to
      the end user via knowledge-api in Drools 5.0.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1951"/>4.3.4.2. AgendaGroup</h4></div></div></div><div class="figure"><a id="d0e1954"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/AgendaGroup.png" alt="AgendaGroup"/></div></div><p class="title"><b>Figure 4.19. AgendaGroup</b></p></div><br class="figure-break"/><p>Agenda groups are a way to partition rules (activations, actually)
      on the agenda. At any one time, only one group has "focus" which means
      that activations for rules in that group only will take effect. You can
      also have rules with "auto focus" which means that the focus is taken
      for its agenda group when that rule's conditions are true.</p><p>Agenda groups are known as "modules" in CLIPS terminology. While
      it best to design rules that do not need control flow, this is not
      always possible. Agenda groups provide a handy way to create a "flow"
      between grouped rules. You can switch the group which has focus either
      from within the rule engine, or via the API. If your rules have a clear
      need for multiple "phases" or "sequences" of processing, consider using
      agenda-groups for this purpose.</p><p>Each time <code class="code">setFocus()</code> is called it pushes that Agenda
      Group onto a stack. When the focus group is empty it is popped from the
      stack and the focus group that is now on top evaluates. An Agenda Group
      can appear in multiple locations on the stack. The default Agenda Group
      is "MAIN", with all rules which do not specify an Agenda Group being in
      this group. It is also always the first group on the stack, given focus
      initially, by default.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getAgenda</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">getAgendaGroup</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;Group&nbsp;A&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">).</span><!-- <br/> --><span class="java_plain">setFocus</span><!-- <br/> --><span class="java_separator">();</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1971"/>4.3.4.3. ActivationGroup</h4></div></div></div><div class="figure"><a id="d0e1974"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/ActivationGroup.png" alt="ActivationGroup"/></div></div><p class="title"><b>Figure 4.20. ActivationGroup</b></p></div><br class="figure-break"/><p>An activation group is a set of rules bound together by the same
      "activation-group" rule attribute. In this group only one rule can fire,
      and after that rule has fired all the other rules are cancelled from the
      agenda. The <code class="code">clear()</code> method can be called at any time, which
      cancels all of the activations before one has had a chance to
      fire.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getAgenda</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">getActivationGroup</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;Group&nbsp;B&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">).</span><!-- <br/> --><span class="java_plain">clear</span><!-- <br/> --><span class="java_separator">();</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1987"/>4.3.4.4. RuleFlowGroup</h4></div></div></div><div class="figure"><a id="d0e1990"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/RuleFlowGroup.png" alt="RuleFlowGroup"/></div></div><p class="title"><b>Figure 4.21. RuleFlowGroup</b></p></div><br class="figure-break"/><p>A rule flow group is a group of rules associated by the
      "ruleflow-group" rule attribute. These rules can only fire when the
      group is activate. The group itself can only become active when the
      elaboration of the ruleflow diagram reaches the node representing the
      group. Here too, the <code class="code">clear()</code> method can be called at any
      time to cancels all activations still remaining on the Agenda.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getAgenda</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">getRuleFlowGroup</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;Group&nbsp;C&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">).</span><!-- <br/> --><span class="java_plain">clear</span><!-- <br/> --><span class="java_separator">();</span></pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2003"/>4.3.5. Event Model</h3></div></div></div><p>The event package provides means to be notified of rule engine
    events, including rules firing, objects being asserted, etc. This allows
    you, for instance, to separate logging and auditing activities from the
    main part of your application (and the rules).</p><p>The <code class="code">KnowlegeRuntimeEventManager</code> interface is
    implemented by the <code class="code">KnowledgeRuntime</code> which provides two
    interfaces, <code class="code">WorkingMemoryEventManager</code> and
    <code class="code">ProcessEventManager</code>. We will only cover the
    <code class="code">WorkingMemoryEventManager</code> here.</p><div class="figure"><a id="d0e2025"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeRuntimeEventManager.png" alt="KnowledgeRuntimeEventManager"/></div></div><p class="title"><b>Figure 4.22. KnowledgeRuntimeEventManager</b></p></div><br class="figure-break"/><p>The <code class="code">WorkingMemoryEventManager</code> allows for listeners to
    be added and removed, so that events for the working memory and the agenda
    can be listened to.</p><div class="figure"><a id="d0e2036"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/WorkingMemoryEventManager.png" alt="WorkingMemoryEventManager"/></div></div><p class="title"><b>Figure 4.23. WorkingMemoryEventManager</b></p></div><br class="figure-break"/><p>The following code snippet shows how a simple agenda listener is
    declared and attached to a session. It will print activations after they
    have fired.</p><div class="example"><a id="d0e2044"/><p class="title"><b>Example 4.28. Adding an AgendaEventListener</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">addEventListener</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DefaultAgendaEventListener</span><!-- <br/> --><span class="java_separator">()</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;afterActivationFired</span><span class="java_separator">(</span><span class="java_type">AfterActivationFiredEvent</span><span class="java_plain">&nbsp;event</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">.</span><span class="java_plain">afterActivationFired</span><span class="java_separator">(</span><span class="java_plain">&nbsp;event&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;event&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">});</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre></div></div><br class="example-break"/><p>Drools also provides <code class="code">DebugWorkingMemoryEventListener</code>
    and <code class="code">DebugAgendaEventListener</code> which implement each method with
    a debug print statement. To print all Working Memory events, you add a
    listener like this:</p><div class="example"><a id="d0e2057"/><p class="title"><b>Example 4.29. Creating a new KnowledgeBuilder</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">addEventListener</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DebugWorkingMemoryEventListener</span><!-- <br/> --><span class="java_separator">()</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span><!-- <br/> --><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre></div></div><br class="example-break"/><p>All emitted events implement the <code class="code">KnowlegeRuntimeEvent</code>
    interface which can be used to retrieve the actual
    <code class="code">KnowlegeRuntime</code> the event originated from.</p><div class="figure"><a id="d0e2070"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeRuntimeEvent.png" alt="KnowlegeRuntimeEvent"/></div></div><p class="title"><b>Figure 4.24. KnowlegeRuntimeEvent</b></p></div><br class="figure-break"/><p>The events currently supported are:</p><div class="itemizedlist"><ul><li><p>ActivationCreatedEvent</p></li><li><p>ActivationCancelledEvent</p></li><li><p>BeforeActivationFiredEvent</p></li><li><p>AfterActivationFiredEvent</p></li><li><p>AgendaGroupPushedEvent</p></li><li><p>AgendaGroupPoppedEvent</p></li><li><p>ObjectInsertEvent</p></li><li><p>ObjectRetractedEvent</p></li><li><p>ObjectUpdatedEvent</p></li><li><p>ProcessCompletedEvent</p></li><li><p>ProcessNodeLeftEvent</p></li><li><p>ProcessNodeTriggeredEvent</p></li><li><p>ProcessStartEvent</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2118"/>4.3.6. KnowledgeRuntimeLogger</h3></div></div></div><p>The KnowledgeRuntimeLogger uses the comprehensive event system in
    Drools to create an audit log that can be used to log the execution of an
    application for later inspection, using tools such as the Eclipse audit
    viewer.</p><div class="figure"><a id="d0e2123"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/KnowledgeRuntimeLoggerFactory.png" alt="KnowledgeRuntimeLoggerFactory"/></div></div><p class="title"><b>Figure 4.25. KnowledgeRuntimeLoggerFactory</b></p></div><br class="figure-break"/><div class="example"><a id="d0e2129"/><p class="title"><b>Example 4.30. FileLogger</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeRuntimeLogger</span><!-- <br/> --><span class="java_plain">&nbsp;logger&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">KnowledgeRuntimeLoggerFactory</span><span class="java_separator">.</span><span class="java_plain">newFileLogger</span><span class="java_separator">(</span><span class="java_plain">ksession</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;logdir/mylogfile&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">logger</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2134"/>4.3.7. StatelessKnowledgeSession</h3></div></div></div><p>The <code class="code">StatelessKnowledgeSession</code> wraps the
    <code class="code">StatefulKnowledgeSession</code>, instead of extending it. Its main
    focus is on decision service type scenarios. It avoids the need to call
    <code class="code">dispose()</code>. Stateless sessions do not support iterative
    insertions and the method call <code class="code">fireAllRules()</code> from Java code;
    the act of calling <code class="code">execute()</code> is a single-shot method that
    will internally instantiate a <code class="code">StatefulKnowledgeSession</code>, add
    all the user data and execute user commands, call
    <code class="code">fireAllRules()</code>, and then call <code class="code">dispose()</code>. While
    the main way to work with this class is via the
    <code class="code">BatchExecution</code> (a subinterface of <code class="code">Command</code>) as
    supported by the <code class="code">CommandExecutor</code> interface, two convenience
    methods are provided for when simple object insertion is all that's
    required. The <code class="code">CommandExecutor</code> and <code class="code">BatchExecution</code>
    are talked about in detail in their own section.</p><div class="figure"><a id="d0e2178"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/StatelessKnowledgeSession.png" alt="StatelessKnowledgeSession"/></div></div><p class="title"><b>Figure 4.26. StatelessKnowledgeSession</b></p></div><br class="figure-break"/><p>Our simple example shows a stateless session executing a given
    collection of Java objects using the convenience API. It will iterate the
    collection, inserting each element in turn.</p><div class="example"><a id="d0e2186"/><p class="title"><b>Example 4.31. Simple StatelessKnowledgeSession execution with a
      Collection</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newFileSystemResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;fileName&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">StatelessKnowledgeSession</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">.</span><span class="java_plain">newStatelessKnowledgeSession</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;collection&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>If this was done as a single Command it would be as follows:</p><div class="example"><a id="d0e2193"/><p class="title"><b>Example 4.32. Simple StatelessKnowledgeSession execution with InsertElements
      Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">execute</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">CommandFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newInsertElements</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;collection&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span><!-- <br/> --><span class="java_plain">&nbsp;&nbsp;</span></pre></div></div><br class="example-break"/><p>If you wanted to insert the collection itself, and the collection's
    individual elements, then
    <code class="code">CommandFactory.newInsert(collection)</code> would do the job.</p><p>Methods of the <code class="code">CommandFactory</code> create the supported
    commands, all of which can be marshalled using XStream and the
    <code class="code">BatchExecutionHelper</code>. <code class="code">BatchExecutionHelper</code>
    provides details on the XML format as well as how to use Drools Pipeline
    to automate the marshalling of <code class="code">BatchExecution</code> and
    <code class="code">ExecutionResults</code>.</p><p><code class="code">StatelessKnowledgeSession</code> supports globals, scoped in a
    number of ways. I'll cover the non-command way first, as commands are
    scoped to a specific execution call. Globals can be resolved in three
    ways.</p><div class="itemizedlist"><ul><li><p>The Stateless Knowledge Session method <code class="code">getGlobals()</code>
        returns a Globals instance which provides access to the session's
        globals. These are shared for <span class="emphasis"><em>all</em></span> execution
        calls. Exercise caution regarding mutable globals because execution
        calls can be executing simultaneously in different threads.</p><div class="example"><a id="d0e2234"/><p class="title"><b>Example 4.33. Session scoped global</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatelessKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatelessKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_plain">&nbsp;a&nbsp;global&nbsp;hbnSession</span><span class="java_separator">,</span><span class="java_plain">&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;DB&nbsp;interactions&nbsp;in&nbsp;the&nbsp;rules</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">setGlobal</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;hbnSession&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;hibernateSession&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Execute</span><span class="java_plain">&nbsp;</span><span class="java_keyword">while</span><span class="java_plain">&nbsp;being&nbsp;able&nbsp;to&nbsp;resolve&nbsp;the&nbsp;</span><span class="java_literal">&quot;hbnSession&quot;</span><span class="java_plain">&nbsp;identifier</span><span class="java_separator">.</span><span class="java_plain">&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;collection&nbsp;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span></pre></div></div><br class="example-break"/></li><li><p>Using a delegate is another way of global resolution. Assigning
        a value to a global (with <code class="code">setGlobal(String, Object)</code>)
        results in the value being stored in an internal collection mapping
        identifiers to values. Identifiers in this internal collection will
        have priority over any supplied delegate. Only if an identifier cannot
        be found in this internal collection, the delegate global (if any)
        will be used.</p></li><li><p>The third way of resolving globals is to have execution scoped
        globals. Here, a <code class="code">Command</code> to set a global is passed to the
        <code class="code">CommandExecutor</code>.</p></li></ul></div><p>The <code class="code">CommandExecutor</code> interface also offers the ability
    to export data via "out" parameters. Inserted facts, globals and query
    results can all be returned.</p><div class="example"><a id="d0e2259"/><p class="title"><b>Example 4.34. Out identifiers</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Set</span><!-- <br/> --><span class="java_plain">&nbsp;up&nbsp;a&nbsp;list&nbsp;of&nbsp;commands</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;cmds&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newSetGlobal</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;list1&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_separator">(),</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;jon&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">102</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;person&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Get&nbsp;People&quot;</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;getPeople&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Execute</span><span class="java_plain">&nbsp;the&nbsp;list</span>
<!--  --><br/><span class="java_type">ExecutionResults</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newBatchExecution</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cmds&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Retrieve</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">ArrayList</span>
<!--  --><br/><span class="java_plain">results</span><span class="java_separator">.</span><span class="java_plain">getValue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;list1&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Retrieve</span><span class="java_plain">&nbsp;the&nbsp;inserted&nbsp;</span><span class="java_type">Person</span><span class="java_plain">&nbsp;fact</span>
<!--  --><br/><span class="java_plain">results</span><span class="java_separator">.</span><span class="java_plain">getValue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;person&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Retrieve</span><span class="java_plain">&nbsp;the&nbsp;query&nbsp;as&nbsp;a&nbsp;</span><span class="java_type">QueryResults</span><span class="java_plain">&nbsp;instance</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">results</span><span class="java_separator">.</span><span class="java_plain">getValue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Get&nbsp;People&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2264"/>4.3.7.1. Sequential Mode</h4></div></div></div><p>With Rete you have a stateful session where objects can be
      asserted and modified over time, and where rules can also be added and
      removed. Now what happens if we assume a stateless session, where after
      the initial data set no more data can be asserted or modified and rules
      cannot be added or removed? Certainly it won't be necessary to
      re-evaluate rules, and the engine will be able to operate in a
      simplified way.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Order the Rules by salience and position in the ruleset (by
          setting a sequence attribute on the rule terminal node).</p></li><li><p>Create an array, one element for each possible rule
          activation; element position indicates firing order.</p></li><li><p>Turn off all node memories, except the right-input Object
          memory.</p></li><li><p>Disconnect the Left Input Adapter Node propagation, and let
          the Object plus the Node be referenced in a Command object, which is
          added to a list on the Working Memory for later execution.</p></li><li><p>Assert all objects, and, when all assertions are finished and
          thus right-input node memories are populated, check the Command list
          and execute each in turn.</p></li><li><p>All resulting Activations should be placed in the array, based
          upon the determined sequence number of the Rule. Record the first
          and last populated elements, to reduce the iteration range.</p></li><li><p>Iterate the array of Activations, executing populated element
          in turn.</p></li><li><p>If we have a maximum number of allowed rule executions, we can
          exit our network evaluations early to fire all the rules in the
          array.</p></li></ol></div><p>The <code class="code">LeftInputAdapterNode</code> no longer creates a Tuple,
      adding the Object, and then propagate the Tuple – instead a Command
      object is created and added to a list in the Working Memory. This
      Command object holds a reference to the
      <code class="code">LeftInputAdapterNode</code> and the propagated object. This stops
      any left-input propagations at insertion time, so that we know that a
      right-input propagation will never need to attempt a join with the
      left-inputs (removing the need for left-input memory). All nodes have
      their memory turned off, including the left-input Tuple memory but
      excluding the right-input object memory, which means that the only node
      remembering an insertion propagation is the right-input object memory.
      Once all the assertions are finished and all right-input memories
      populated, we can then iterate the list of
      <code class="code">LeftInputAdatperNode</code> Command objects calling each in turn.
      They will propagate down the network attempting to join with the
      right-input objects, but they won't be remembered in the left input as
      we know there will be no further object assertions and thus propagations
      into the right-input memory.</p><p>There is no longer an Agenda, with a priority queue to schedule
      the Tuples; instead, there is simply an array for the number of rules.
      The sequence number of the <code class="code">RuleTerminalNode</code> indicates the
      element within the array where to place the Activation. Once all Command
      objects have finished we can iterate our array, checking each element in
      turn, and firing the Activations if they exist. To improve performance,
      we remember the first and the last populated cell in the array. The
      network is constructed, with each <code class="code">RuleTerminalNode</code> being
      given a sequence number based on a salience number and its order of
      being added to the network.</p><p>Typically the right-input node memories are Hash Maps, for fast
      object retraction; here, as we know there will be no object retractions,
      we can use a list when the values of the object are not indexed. For
      larger numbers of objects indexed Hash Maps provide a performance
      increase; if we know an object type has only a few instances, indexing
      is probably not advantageous, and a list can be used.</p><p>Sequential mode can only be used with a Stateless Session and is
      off by default. To turn it on, either call
      <code class="code">RuleBaseConfiguration.setSequential(true)</code>, or set the
      rulebase configuration property <code class="code">drools.sequential</code> to true.
      Sequential mode can fall back to a dynamic agenda by calling
      <code class="code">setSequentialAgenda</code> with
      <code class="code">SequentialAgenda.DYNAMIC</code>. You may also set the
      "drools.sequential.agenda" property to "sequential" or "dynamic".</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2329"/>4.3.8. Commands and the CommandExecutor</h3></div></div></div><p>Drools has the concept of stateful or stateless sessions. We've
    already covered stateful sessions, which use the standard working memory
    that can be worked with iteratively over time. Stateless is a one-off
    execution of a working memory with a provided data set. It may return some
    results, with the session being disposed at the end, prohibiting further
    iterative interactions. You can think of stateless as treating a rule
    engine like a function call with optional return results.</p><p>In Drools 4 we supported these two paradigms but the way the user
    interacted with them was different. StatelessSession used an execute(...)
    method which would insert a collection of objects as facts.
    StatefulSession didn't have this method, and insert used the more
    traditional <code class="code">insert(...)</code> method. The other issue was that the
    StatelessSession did not return any results, so that users themselves had
    to map globals to get results, and it wasn't possible to do anything
    besides inserting objects; users could not start processes or execute
    queries.</p><p>Drools 5.0 addresses all of these issues and more. The foundation
    for this is the <code class="code">CommandExecutor</code> interface, which both the
    stateful and stateless interfaces extend, creating consistency and
    <code class="code">ExecutionResults</code>:</p><div class="figure"><a id="d0e2347"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/CommandExecutor.png" alt="CommandExecutor"/></div></div><p class="title"><b>Figure 4.27. CommandExecutor</b></p></div><br class="figure-break"/><div class="figure"><a id="d0e2353"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/ExecutionResults.png" alt="ExecutionResults"/></div></div><p class="title"><b>Figure 4.28. ExecutionResults</b></p></div><br class="figure-break"/><p>The <code class="code">CommandFactory</code> allows for commands to be executed
    on those sessions, the only difference being that the Stateless Knowledge
    Session executes <code class="code">fireAllRules()</code> at the end before disposing
    the session. The currently supported commands are:</p><div class="itemizedlist"><ul><li><p>FireAllRules</p></li><li><p>GetGlobal</p></li><li><p>SetGlobal</p></li><li><p>InsertObject</p></li><li><p>InsertElements</p></li><li><p>Query</p></li><li><p>StartProcess</p></li><li><p>BatchExecution</p></li></ul></div><p><code class="code">InsertObject</code> will insert a single object, with an
    optional "out" identifier. <code class="code">InsertElements</code> will iterate an
    Iterable, inserting each of the elements. What this means is that a
    Stateless Knowledge Session is no longer limited to just inserting
    objects, it can now start processes or execute queries, and do this in any
    order.</p><div class="example"><a id="d0e2399"/><p class="title"><b>Example 4.35. Insert Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatelessKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatelessKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">ExecutionResults</span><span class="java_plain">&nbsp;bresults&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cheese</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;stilton&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;stilton_id&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Stilton</span><span class="java_plain">&nbsp;stilton&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;bresults</span><span class="java_separator">.</span><span class="java_plain">getValue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;stilton_id&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>The execute method always returns an <code class="code">ExecutionResults</code>
    instance, which allows access to any command results if they specify an
    out identifier such as the "stilton_id" above.</p><div class="example"><a id="d0e2409"/><p class="title"><b>Example 4.36. InsertElements Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatelessKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatelessKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Command</span><span class="java_plain">&nbsp;cmd&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newInsertElements</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Arrays</span><span class="java_separator">.</span><span class="java_plain">asList</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cheese</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;stilton&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cheese</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;brie&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cheese</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;cheddar&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">});</span>
<!--  --><br/><span class="java_type">ExecutionResults</span><span class="java_plain">&nbsp;bresults&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cmd&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>The execute method only allows for a single command. That's where
    <code class="code">BatchExecution</code> comes in, which represents a composite
    command, created from a list of commands. Now, execute will iterate over
    the list and execute each command in turn. This means you can insert some
    objects, start a process, call fireAllRules and execute a query, all in a
    single <code class="code">execute(...)</code> call, which is quite powerful.</p><p>As mentioned previosly, the Stateless Knowledge Session will execute
    <code class="code">fireAllRules()</code> automatically at the end. However the
    keen-eyed reader probably has already noticed the
    <code class="code">FireAllRules</code> command and wondered how that works with a
    StatelessKnowledgeSession. The <code class="code">FireAllRules</code> command is
    allowed, and using it will disable the automatic execution at the end;
    think of using it as a sort of manual override function.</p><p>Commands support out identifiers. Any command that has an out
    identifier set on it will add its results to the returned ExecutionResults
    instance. Let's look at a simple example to see how this works.</p><div class="example"><a id="d0e2435"/><p class="title"><b>Example 4.37. BatchExecution Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatelessKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatelessKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;cmds&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_separator">();</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newInsertObject</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cheese</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;stilton&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">1</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;stilton&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newStartProcess</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;process&nbsp;cheeses&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cmds</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;cheeses&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">ExecutionResults</span><span class="java_plain">&nbsp;bresults&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CommandFactory</span><span class="java_separator">.</span><span class="java_plain">newBatchExecution</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cmds&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Cheese</span><span class="java_plain">&nbsp;stilton&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Cheese</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;bresults</span><span class="java_separator">.</span><span class="java_plain">getValue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;stilton&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">QueryResults</span><span class="java_plain">&nbsp;qresults&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">QueryResults</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;bresults</span><span class="java_separator">.</span><span class="java_plain">getValue</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;cheeses&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>In the above example multiple commands are executed, two of which
    populate the <code class="code">ExecutionResults</code>. The query command defaults to
    use the same identifier as the query name, but it can also be mapped to a
    different identifier.</p><p>A custom XStream marshaller can be used with the Drools Pipeline to
    achieve XML scripting, which is perfect for services. Here are two simple
    XML samples, one for the BatchExecution and one for the
    <code class="code">ExecutionResults</code>.</p><div class="example"><a id="d0e2450"/><p class="title"><b>Example 4.38. Simple BatchExecution XML</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">insert</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">out-identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'outStilton'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">stilton</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">25</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">0</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">insert</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><div class="example"><a id="d0e2455"/><p class="title"><b>Example 4.39. Simple ExecutionResults XML</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">execution-results</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">result</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'outStilton'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">stilton</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">25</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">30</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">result</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">execution-results</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>Spring and Camel, covered in the integrations book, facilitate
    declarative services.</p><div class="example"><a id="d0e2462"/><p class="title"><b>Example 4.40. BatchExecution Marshalled to XML</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">insert</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">out-identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;stilton&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">stilton</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">1</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">0</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">insert</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">query</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">out-identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'cheeses2'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'cheesesWithParams'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">stilton</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">cheddar</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">query</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>The <code class="code">CommandExecutor</code> returns an
    <code class="code">ExecutionResults</code>, and this is handled by the pipeline code
    snippet as well. A similar output for the &lt;batch-execution&gt; XML
    sample above would be:</p><div class="example"><a id="d0e2475"/><p class="title"><b>Example 4.41. ExecutionResults Marshalled to XML</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">execution-results</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">result</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;stilton&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">stilton</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">2</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">result</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">result</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'cheeses2'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">query-results</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">identifiers</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">identifier</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">cheese</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">identifier</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">identifiers</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">row</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">cheddar</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">2</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">0</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">row</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">row</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">cheddar</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">type</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">1</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">price</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">0</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">oldPrice</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.drools.Cheese</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">row</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">query-results</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">result</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">execution-results</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>The <code class="code">BatchExecutionHelper</code> provides a configured XStream
    instance to support the marshalling of Batch Executions, where the
    resulting XML can be used as a message format, as shown above. Configured
    converters only exist for the commands supported via the Command Factory.
    The user may add other converters for their user objects. This is very
    useful for scripting stateless or stateful knowledge sessions, especially
    when services are involved.</p><p>There is currently no XML schema to support schema validation. The
    basic format is outlined here, and the drools-pipeline module has an
    illustrative unit test in the <code class="code">XStreamBatchExecutionTest</code> unit
    test. The root element is &lt;batch-execution&gt; and it can contain zero
    or more commands elements.</p><div class="example"><a id="d0e2490"/><p class="title"><b>Example 4.42. Root XML element</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">...</span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>This contains a list of elements that represent commands, the
    supported commands is limited to those Commands provided by the Command
    Factory. The most basic of these is the &lt;insert&gt; element, which
    inserts objects. The contents of the insert element is the user object, as
    dictated by XStream.</p><div class="example"><a id="d0e2497"/><p class="title"><b>Example 4.43. Insert</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">insert</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="xml_comment">&lt;!--&nbsp;any&nbsp;user&nbsp;object&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">insert</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>The insert element features an "out-identifier" attribute, demanding
    that the inserted object will also be returned as part of the result
    payload.</p><div class="example"><a id="d0e2504"/><p class="title"><b>Example 4.44. Insert with Out Identifier Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">insert</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">out-identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'userVar'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">insert</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>It's also possible to insert a collection of objects using the
    &lt;insert-elements&gt; element. This command does not support an
    out-identifier. The <code class="code">org.domain.UserClass</code> is just an
    illustrative user object that XStream would serialize.</p><div class="example"><a id="d0e2514"/><p class="title"><b>Example 4.45. Insert Elements command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">insert-elements</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">insert-elements</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>Next, there is the <code class="code">&lt;set-global&gt;</code> element, which
    sets a global for the session.</p><div class="example"><a id="d0e2524"/><p class="title"><b>Example 4.46. Insert Elements command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">set-global</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'userVar'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">set-global</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p><code class="code">&lt;set-global&gt;</code> also supports two other optional
    attributes, <code class="literal">out</code> and <code class="literal">out-identifier</code>.
    A true value for the boolean <code class="literal">out</code> will add the global to
    the <code class="code">&lt;batch-execution-results&gt;</code> payload, using the name
    from the <code class="literal">identifier</code> attribute.
    <code class="literal">out-identifier</code> works like <code class="literal">out</code> but
    additionally allows you to override the identifier used in the
    <code class="code">&lt;batch-execution-results&gt;</code> payload.</p><div class="example"><a id="d0e2557"/><p class="title"><b>Example 4.47. Set Global Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">set-global</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'userVar1'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">out</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'true'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">set-global</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">set-global</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'userVar2'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">out-identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'alternativeUserVar2'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.domain.UserClass</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">set-global</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>There is also a <code class="code">&lt;get-global&gt;</code> element, without
    contents, with just an <code class="literal">out-identifier</code> attribute. (There
    is no need for an <code class="literal">out</code> attribute because retrieving the
    value is the sole purpose of a <code class="code">&lt;get-global&gt;</code>
    element.</p><div class="example"><a id="d0e2576"/><p class="title"><b>Example 4.48. Get Global Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">get-global</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'userVar1'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">get-global</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'userVar2'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">out-identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'alternativeUserVar2'</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>While the <code class="literal">out</code> attribute is useful in returning
    specific instances as a result payload, we often wish to run actual
    queries. Both parameter and parameterless queries are supported. The
    <code class="literal">name</code> attribute is the name of the query to be called,
    and the <code class="literal">out-identifier</code> is the identifier to be used for
    the query results in the <code class="code">&lt;execution-results&gt;</code>
    payload.</p><div class="example"><a id="d0e2595"/><p class="title"><b>Example 4.49. Query Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">query</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">out-identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'cheeses'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'cheeses'</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">query</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">out-identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'cheeses2'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'cheesesWithParams'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">stilton</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">cheddar</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">query</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>The <code class="code">&lt;start-process&gt;</code> command accepts optional
    parameters. Other process related methods will be added later, like
    interacting with work items.</p><div class="example"><a id="d0e2605"/><p class="title"><b>Example 4.50. Start Process Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">batch-execution</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">startProcess</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">processId</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'org.drools.actions'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">parameter</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'person'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">org.drools.TestVariable</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">name</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">John&nbsp;Doe</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">name</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">org.drools.TestVariable</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">parameter</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">startProcess</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">batch-execution</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><div class="example"><a id="d0e2610"/><p class="title"><b>Example 4.51. Signal Event Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">signal-event</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">process-instance-id</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'1'</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">event-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'MyEvent'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">MyValue</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">signal-event</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><div class="example"><a id="d0e2615"/><p class="title"><b>Example 4.52. Complete Work Item Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">complete-work-item</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">id</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'&quot;&nbsp;+&nbsp;workItem.getId()&nbsp;+&nbsp;&quot;'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">result</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'Result'</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">SomeOtherString</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">string</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">result</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">complete-work-item</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><div class="example"><a id="d0e2620"/><p class="title"><b>Example 4.53. Abort Work Item Command</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">abort-work-item</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">id</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">'21'</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>Support for more commands will be added over time.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2627"/>4.3.9. Marshalling</h3></div></div></div><p>The <code class="code">MarshallerFactory</code> is used to marshal and unmarshal
    Stateful Knowledge Sessions.</p><div class="figure"><a id="d0e2635"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-User_Guide/MarshallerFactory.png" alt="MarshallerFactory"/></div></div><p class="title"><b>Figure 4.29. MarshallerFactory</b></p></div><br class="figure-break"/><p>At the simplest the <code class="code">MarshallerFactory</code> can be used as
    follows:</p><div class="example"><a id="d0e2646"/><p class="title"><b>Example 4.54. Simple Marshaller Example</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;is&nbsp;the&nbsp;</span><!-- <br/> --><span class="java_type">StatefulKnowledgeSession</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;kbase&nbsp;is&nbsp;the&nbsp;</span><span class="java_type">KnowledgeBase</span>
<!--  --><br/><span class="java_type">ByteArrayOutputStream</span><span class="java_plain">&nbsp;baos&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ByteArrayOutputStream</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Marshaller</span><span class="java_plain">&nbsp;marshaller&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">MarshallerFactory</span><span class="java_separator">.</span><span class="java_plain">newMarshaller</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">marshaller</span><span class="java_separator">.</span><span class="java_plain">marshall</span><span class="java_separator">(</span><span class="java_plain">&nbsp;baos</span><span class="java_separator">,</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">baos</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>However, with marshalling you need more flexibility when dealing
    with referenced user data. To achieve this we have the
    <code class="code">ObjectMarshallingStrategy</code> interface. Two implementations are
    provided, but users can implement their own. The two supplied strategies
    are <code class="code">IdentityMarshallingStrategy</code> and
    <code class="code">SerializeMarshallingStrategy</code>.
    <code class="code">SerializeMarshallingStrategy</code> is the default, as used in the
    example above, and it just calls the <code class="code">Serializable</code> or
    <code class="code">Externalizable</code> methods on a user instance.
    <code class="code">IdentityMarshallingStrategy</code> instead creates an integer id for
    each user object and stores them in a Map, while the id is written to the
    stream. When unmarshalling it accesses the
    <code class="code">IdentityMarshallingStrategy</code> map to retrieve the instance.
    This means that if you use the <code class="code">IdentityMarshallingStrategy</code>,
    it is stateful for the life of the Marshaller instance and will create ids
    and keep references to all objects that it attempts to marshal. Below is
    he code to use an Identity Marshalling Strategy.</p><div class="example"><a id="d0e2680"/><p class="title"><b>Example 4.55. IdentityMarshallingStrategy</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">ByteArrayOutputStream</span><!-- <br/> --><span class="java_plain">&nbsp;baos&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ByteArrayOutputStream</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">ObjectMarshallingStrategy</span><span class="java_plain">&nbsp;oms&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">MarshallerFactory</span><span class="java_separator">.</span><span class="java_plain">newIdentityMarshallingStrategy</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_type">Marshaller</span><span class="java_plain">&nbsp;marshaller&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">MarshallerFactory</span><span class="java_separator">.</span><span class="java_plain">newMarshaller</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ObjectMarshallingStrategy</span><span class="java_separator">[]{</span><span class="java_plain">&nbsp;oms&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">marshaller</span><span class="java_separator">.</span><span class="java_plain">marshall</span><span class="java_separator">(</span><span class="java_plain">&nbsp;baos</span><span class="java_separator">,</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">baos</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>For added flexability we can't assume that a single strategy is
    suitable. Therefore we have added the
    <code class="code">ObjectMarshallingStrategyAcceptor</code> interface that each Object
    Marshalling Strategy contains. The Marshaller has a chain of strategies,
    and when it attempts to read or write a user object it iterates the
    strategies asking if they accept responsability for marshalling the user
    object. One of the provided implementations is
    <code class="code">ClassFilterAcceptor</code>. This allows strings and wild cards to be
    used to match class names. The default is "*.*", so in the above example
    the Identity Marshalling Strategy is used which has a default "*.*"
    acceptor.</p><p>Assuming that we want to serialize all classes except for one given
    package, where we will use identity lookup, we could do the
    following:</p><div class="example"><a id="d0e2695"/><p class="title"><b>Example 4.56. IdentityMarshallingStrategy with Acceptor</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">ByteArrayOutputStream</span><!-- <br/> --><span class="java_plain">&nbsp;baos&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ByteArrayOutputStream</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">ObjectMarshallingStrategyAcceptor</span><span class="java_plain">&nbsp;identityAcceptor&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">MarshallerFactory</span><span class="java_separator">.</span><span class="java_plain">newClassFilterAcceptor</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;org.domain.pkg1.*&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">ObjectMarshallingStrategy</span><span class="java_plain">&nbsp;identityStrategy&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">MarshallerFactory</span><span class="java_separator">.</span><span class="java_plain">newIdentityMarshallingStrategy</span><span class="java_separator">(</span><span class="java_plain">&nbsp;identityAcceptor&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">ObjectMarshallingStrategy</span><span class="java_plain">&nbsp;sms&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">MarshallerFactory</span><span class="java_separator">.</span><span class="java_plain">newSerializeMarshallingStrategy</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Marshaller</span><span class="java_plain">&nbsp;marshaller&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">MarshallerFactory</span><span class="java_separator">.</span><span class="java_plain">newMarshaller</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ObjectMarshallingStrategy</span><span class="java_separator">[]{</span><span class="java_plain">&nbsp;identityStrategy</span><span class="java_separator">,</span><span class="java_plain">&nbsp;sms&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">marshaller</span><span class="java_separator">.</span><span class="java_plain">marshall</span><span class="java_separator">(</span><span class="java_plain">&nbsp;baos</span><span class="java_separator">,</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">baos</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>Note that the acceptance checking order is in the natural order of
    the supplied array.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2702"/>4.3.10. Persistence and Transactions</h3></div></div></div><p>Longterm out of the box persistence with Java Persistence API (JPA)
    is possible with Drools. You will need to have some implementation of the
    Java Transaction API (JTA) installed. For development purposes we
    recommend the Bitronix Transaction Manager, as it's simple to set up and
    works embedded, but for production use JBoss Transactions is
    recommended.</p><div class="example"><a id="d0e2707"/><p class="title"><b>Example 4.57. Simple example using transactions</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Environment</span><!-- <br/> --><span class="java_plain">&nbsp;env&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBaseFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newEnvironment</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">env</span><span class="java_separator">.</span><span class="java_plain">set</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">EnvironmentName</span><span class="java_separator">.</span><span class="java_plain">ENTITY_MANAGER_FACTORY</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Persistence</span><span class="java_separator">.</span><span class="java_plain">createEntityManagerFactory</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;emf-name&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">env</span><span class="java_separator">.</span><span class="java_plain">set</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">EnvironmentName</span><span class="java_separator">.</span><span class="java_plain">TRANSACTION_MANAGER</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TransactionManagerServices</span><span class="java_separator">.</span><span class="java_plain">getTransactionManager</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeSessionConfiguration</span><span class="java_plain">&nbsp;may&nbsp;be&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span><span class="java_plain">&nbsp;and&nbsp;a&nbsp;</span><span class="java_keyword">default</span><span class="java_plain">&nbsp;will&nbsp;be&nbsp;used</span>
<!--  --><br/><span class="java_type">StatefulKnowledgeSession</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">JPAKnowledgeService</span><span class="java_separator">.</span><span class="java_plain">newStatefulKnowledgeSession</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span><span class="java_plain">&nbsp;env&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">int</span><span class="java_plain">&nbsp;sessionId&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">getId</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_type">UserTransaction</span><span class="java_plain">&nbsp;ut&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">(</span><span class="java_type">UserTransaction</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">InitialContext</span><span class="java_separator">().</span><span class="java_plain">lookup</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;java:comp/UserTransaction&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ut</span><span class="java_separator">.</span><span class="java_plain">begin</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;data1&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;data2&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">startProcess</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;process1&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ut</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>To use a JPA, the Environment must be set with both the
    <code class="code">EntityManagerFactory</code> and the <code class="code">TransactionManager</code>.
    If rollback occurs the ksession state is also rolled back, so you can
    continue to use it after a rollback. To load a previously persisted
    Stateful Knowledge Session you'll need the id, as shown below:</p><div class="example"><a id="d0e2720"/><p class="title"><b>Example 4.58. Loading a StatefulKnowledgeSession</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatefulKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">JPAKnowledgeService</span><span class="java_separator">.</span><span class="java_plain">loadStatefulKnowledgeSession</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sessionId</span><span class="java_separator">,</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span><span class="java_plain">&nbsp;env&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>To enable persistence several classes must be added to your
    persistence.xml, as in the example below:</p><div class="example"><a id="d0e2727"/><p class="title"><b>Example 4.59. Configuring JPA</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence-unit</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.drools.persistence.jpa&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">transaction-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;JTA&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">provider</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ejb.HibernatePersistence</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">provider</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">jta-data-source</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">jdbc/BitronixJTADataSource</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">jta-data-source</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.drools.persistence.session.SessionInfo</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.drools.persistence.processinstance.ProcessInstanceInfo</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.drools.persistence.processinstance.ProcessInstanceEventInfo</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.drools.persistence.processinstance.WorkItemInfo</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.dialect&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.hibernate.dialect.H2Dialect&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.max_fetch_depth&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;3&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.hbm2ddl.auto&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;update&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.show_sql&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.transaction.manager_lookup_class&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.hibernate.transaction.BTMTransactionManagerLookup&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">persistence-unit</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>The jdbc JTA data source would have to be configured first. Bitronix
    provides a number of ways of doing this, and its documentation should be
    contsulted for details. For a quick start, here is the programmatic
    approach:</p><div class="example"><a id="d0e2734"/><p class="title"><b>Example 4.60. Configuring JTA DataSource</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">PoolingDataSource</span><!-- <br/> --><span class="java_plain">&nbsp;ds&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">PoolingDataSource</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">ds</span><span class="java_separator">.</span><span class="java_plain">setUniqueName</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;jdbc/BitronixJTADataSource&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ds</span><span class="java_separator">.</span><span class="java_plain">setClassName</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;org.h2.jdbcx.JdbcDataSource&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ds</span><span class="java_separator">.</span><span class="java_plain">setMaxPoolSize</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">3</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ds</span><span class="java_separator">.</span><span class="java_plain">setAllowLocalTransactions</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ds</span><span class="java_separator">.</span><span class="java_plain">getDriverProperties</span><span class="java_separator">().</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;user&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;sa&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ds</span><span class="java_separator">.</span><span class="java_plain">getDriverProperties</span><span class="java_separator">().</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;password&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;sasa&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ds</span><span class="java_separator">.</span><span class="java_plain">getDriverProperties</span><span class="java_separator">().</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;URL&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;jdbc:h2:mem:mydb&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ds</span><span class="java_separator">.</span><span class="java_plain">init</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>Bitronix also provides a simple embedded JNDI service, ideal for
    testing. To use it add a jndi.properties file to your META-INF and add the
    following line to it:</p><div class="example"><a id="d0e2741"/><p class="title"><b>Example 4.61. JNDI properties</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">java.naming.factory.initial=bitronix.tm.jndi.BitronixInitialContextFactory
</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2746"/>4.3.11. Drools Clips</h3></div></div></div><p>Drools Clips is an alpha level research project to provide a Clips
    like front end ot Drools. As of Drools 5.2 this module as stopped working,
    we will try and fix for 5.3.</p><p>Deftemplates are working, the knowledge base handles multiple name
    spaces and you can attach the knoweldge base to the session for interative
    building, to provide a more "shell" like environment suitable for
    Clips.</p><div class="itemizedlist"><ul><li><p>deftemplate</p></li><li><p>defrule</p></li><li><p>deffunction</p></li><li><p>and/or/not/exists/test conditional elements</p></li><li><p>Literal, Variable, Return Value and Predicate field
        constarints</p></li></ul></div><div class="mediaobject"><img src="images/Chapter-User_Guide/clips-shell.png"/></div><p>This project is very early stages and in need of love. If you want
    to help, open up eclipse import api, core, compiler and clips and you
    should be good to go. The unit tests should be self explanatory.</p></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2774"/>Chapter 5. The Rule Language</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e2777">5.1. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2785">5.1.1. A rule file</a></span></dt><dt><span class="section"><a href="#d0e2818">5.1.2. What makes a rule</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e2854">5.2. Keywords</a></span></dt><dt><span class="section"><a href="#d0e3049">5.3. Comments</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3054">5.3.1. Single line comment</a></span></dt><dt><span class="section"><a href="#d0e3067">5.3.2. Multi-line comment</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3080">5.4. Error Messages</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3085">5.4.1. Message format</a></span></dt><dt><span class="section"><a href="#d0e3116">5.4.2. Error Messages Description</a></span></dt><dt><span class="section"><a href="#d0e3271">5.4.3. Other Messages</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3276">5.5. Package</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3299">5.5.1. import</a></span></dt><dt><span class="section"><a href="#d0e3313">5.5.2. global</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3356">5.6. Function</a></span></dt><dt><span class="section"><a href="#d0e3390">5.7. Type Declaration</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3418">5.7.1. Declaring New Types</a></span></dt><dt><span class="section"><a href="#d0e3524">5.7.2. Declaring Metadata</a></span></dt><dt><span class="section"><a href="#d0e3689">5.7.3. Declaring Metadata for Existing Types</a></span></dt><dt><span class="section"><a href="#d0e3732">5.7.4. Parameterized constructors for declared types</a></span></dt><dt><span class="section"><a href="#d0e3745">5.7.5. Non Typesafe Classes</a></span></dt><dt><span class="section"><a href="#d0e3750">5.7.6. Accessing Declared Types from the Application Code</a></span></dt><dt><span class="section"><a href="#d0e3799">5.7.7. Type Declaration 'extends'</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3808">5.8. Rule</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3850">5.8.1. Rule Attributes</a></span></dt><dt><span class="section"><a href="#d0e4010">5.8.2. Timers and Calendars</a></span></dt><dt><span class="section"><a href="#d0e4051">5.8.3. Left Hand Side (when) syntax</a></span></dt><dt><span class="section"><a href="#d0e5989">5.8.4. The Right Hand Side (then)</a></span></dt><dt><span class="section"><a href="#d0e6228">5.8.5. A Note on Auto-boxing and Primitive Types</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6233">5.9. Query</a></span></dt><dt><span class="section"><a href="#d0e6300">5.10. Domain Specific Languages</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6310">5.10.1. When to Use a DSL</a></span></dt><dt><span class="section"><a href="#d0e6317">5.10.2. DSL Basics</a></span></dt><dt><span class="section"><a href="#d0e6387">5.10.3. Adding Constraints to Facts</a></span></dt><dt><span class="section"><a href="#d0e6432">5.10.4. Developing a DSL</a></span></dt><dt><span class="section"><a href="#d0e6445">5.10.5. DSL and DSLR Reference</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6648">5.11. XML Rule Language</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6657">5.11.1. When to use XML</a></span></dt><dt><span class="section"><a href="#d0e6668">5.11.2. The XML format</a></span></dt><dt><span class="section"><a href="#d0e6714">5.11.3. Legacy Drools 2.x XML rule format</a></span></dt><dt><span class="section"><a href="#d0e6719">5.11.4. Automatic transforming between formats (XML and DRL)</a></span></dt></dl></dd></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2777"/>5.1. Overview</h2></div></div></div><p>Drools has a "native" rule language. 
  This format is very light in terms of punctuation, and supports
  natural and domain specific languages via "expanders" that allow the
  language to morph to your problem domain. This chapter is mostly concerted
  with this native rule format. The diagrams used to present the syntax are
  known as "railroad" diagrams, and they are basically flow charts for the
  language terms. The
  technically very keen may also refer to <code class="filename">DRL.g</code> which is 
  the Antlr3
  grammar for the rule language. If you use the Rule Workbench, a lot of the
  rule structure is done for you with content assistance, for example, type
  "ru" and press ctrl+space, and it will build the rule structure for
  you.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2785"/>5.1.1. A rule file</h3></div></div></div><p>A rule file is typically a file with a .drl extension. In a DRL file
    you can have multiple rules, queries and functions, as well as some
    resource declarations like imports, globals and attributes that are
    assigned and used by your rules and queries. However, you are also able to
    spread your rules across multiple rule files (in that case, the extension
    .rule is suggested, but not required) - spreading rules across files can
    help with managing large numbers of rules. A DRL file is simply a text
    file.</p><p>The overall structure of a rule file is:</p><div class="example"><a id="d0e2792"/><p class="title"><b>Example 5.1. Rules file</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>package </strong></span><em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>package-name</code></em>

<em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>imports</code></em>

<em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>globals</code></em>

<em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>functions</code></em>

<em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>queries</code></em>

<em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>rules</code></em>
</pre></div></div><br class="example-break"/><p>The order in which the elements are declared is not important,
    except for the package name that, if declared, must be the first element
    in the rules file. All elements are optional, so you will use only those
    you need. We will discuss each of them in the following sections.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2818"/>5.1.2. What makes a rule</h3></div></div></div><p>For the inpatients, just as an early view, a rule has the following
    rough structure:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>rule</strong></span> <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>"name"</code></em>
    <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>attributes</code></em>
    <span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>when</strong></span>
        <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>LHS</code></em>
    <span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>then</strong></span>
        <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>RHS</code></em>
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end</strong></span>
</pre><p>It's really that simple. Mostly punctuation is not needed,
    even the double quotes for "name" are optional, as are newlines.
    Attributes are simple (always optional) hints to how the rule should
    behave. LHS is the conditional parts of the rule, which follows a certain
    syntax which is covered below. RHS is basically a block that allows
    dialect specific semantic code to be executed.</p><p>It is important to note that white space is not important,
      <span class="emphasis"><em>except</em></span> in
    the case of domain specific languages, where lines are processed
    one by one and spaces may be significant to the domain language.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2854"/>5.2. Keywords</h2></div></div></div><p>Drools 5 introduces the concept of <span class="emphasis"><em>hard</em></span> and
  <span class="emphasis"><em>soft</em></span> keywords.</p><p>Hard keywords are reserved, you cannot use any hard keyword when
  naming your domain objects, properties, methods, functions and other
  elements that are used in the rule text.</p><p>Here is the list of hard keywords that must be avoided as identifiers
  when writing rules:</p><div class="itemizedlist"><ul><li><p><code class="literal">true</code></p></li><li><p><code class="literal">false</code></p></li><li><p><code class="literal">null</code></p></li></ul></div><p>Soft keywords are just recognized in their context, enabling you to
  use these words in any other place if you wish, although, it is still
  recommended to avoid them, to avoid confusions, if possible. Here is a list
  of the soft keywords:</p><div class="itemizedlist"><ul><li><p><code class="literal">lock-on-active</code></p></li><li><p><code class="literal">date-effective</code></p></li><li><p><code class="literal">date-expires</code></p></li><li><p><code class="literal">no-loop</code></p></li><li><p><code class="literal">auto-focus</code></p></li><li><p><code class="literal">activation-group</code></p></li><li><p><code class="literal">agenda-group</code></p></li><li><p><code class="literal">ruleflow-group</code></p></li><li><p><code class="literal">entry-point</code></p></li><li><p><code class="literal">duration</code></p></li><li><p><code class="literal">package</code></p></li><li><p><code class="literal">import</code></p></li><li><p><code class="literal">dialect</code></p></li><li><p><code class="literal">salience</code></p></li><li><p><code class="literal">enabled</code></p></li><li><p><code class="literal">attributes</code></p></li><li><p><code class="literal">rule</code></p></li><li><p><code class="literal">extend</code></p></li><li><p>when</p></li><li><p>then</p></li><li><p><code class="literal">template</code></p></li><li><p><code class="literal">query</code></p></li><li><p><code class="literal">declare</code></p></li><li><p><code class="literal">function</code></p></li><li><p><code class="literal">global</code></p></li><li><p><code class="literal">eval</code></p></li><li><p><code class="literal">not</code></p></li><li><p><code class="literal">in</code></p></li><li><p><code class="literal">or</code></p></li><li><p><code class="literal">and</code></p></li><li><p><code class="literal">exists</code></p></li><li><p><code class="literal">forall</code></p></li><li><p>accumulate</p></li><li><p>collect</p></li><li><p>from</p></li><li><p><code class="literal">action</code></p></li><li><p><code class="literal">reverse</code></p></li><li><p><code class="literal">result</code></p></li><li><p><code class="literal">end</code></p></li><li><p>over</p></li><li><p><code class="literal">init</code></p></li></ul></div><p>Of course, you can have these (hard and soft) words as part of a
  method name in camel case, like notSomething() or accumulateSomething() -
  there are no issues with that scenario.</p><p>Although the 3 hard keywords above are unlikely to be used in your
  existing domain models, if you absolutely need to use them as identifiers
  instead of keywords, the DRL language provides the ability to escape hard
  keywords on rule text. To escape a word, simply enclose it in grave accents,
  like this:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Holiday( `true` == "yes" ) // please note that Drools will resolve that reference to the method Holiday.isTrue()</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e3049"/>5.3. Comments</h2></div></div></div><p>Comments are sections of text that are ignored by the rule engine.
  They are stripped out when they are encountered, except inside semantic code
  blocks, like the RHS of a rule.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3054"/>5.3.1. Single line comment</h3></div></div></div><div class="figure"><a id="d0e3057"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/single_line_comment.png" align="middle" alt="Single line comment"/></div></div><p class="title"><b>Figure 5.1. Single line comment</b></p></div><br class="figure-break"/><p>To create single line comments, you can use either '#' or '//'. The
    parser will ignore anything in the line after the comment symbol.
    Example:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Testing Comments"
when
    # this is a single line comment
    // this is also a single line comment
    eval( true ) # this is a comment in the same line of a pattern
then
    // this is a comment inside a semantic code block
    # this is another comment in a semantic code block
end
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3067"/>5.3.2. Multi-line comment</h3></div></div></div><div class="figure"><a id="d0e3070"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/multi_line_comment.png" align="middle" alt="Multi-line comment"/></div></div><p class="title"><b>Figure 5.2. Multi-line comment</b></p></div><br class="figure-break"/><p>Multi-line comments are used to comment blocks of text, both in and
    outside semantic code blocks. Example:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Test Multi-line Comments"
when
    /* this is a multi-line comment
       in the left hand side of a rule */
    eval( true )
then
    /* and this is a multi-line comment
       in the right hand side of a rule */
end </pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e3080"/>5.4. Error Messages</h2></div></div></div><p>Drools 5 introduces standardized error messages. This standardization
  aims to help users to find and resolve problems in a easier and faster way.
  In this section you will learn how to identify and interpret those error
  messages, and you will also receive some tips on how to solve the problems
  associated with them.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3085"/>5.4.1. Message format</h3></div></div></div><p>The standardization includes the error message format and to better
    explain this format, let's use the following example:</p><div class="figure"><a id="d0e3090"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/error_message.png" align="middle" alt="Error Message Format"/></div></div><p class="title"><b>Figure 5.3. Error Message Format</b></p></div><br class="figure-break"/><p><span class="bold"><strong>1st Block:</strong></span> This area identifies the
    error code.</p><p><span class="bold"><strong>2nd Block:</strong></span> Line and column
    information.</p><p><span class="bold"><strong>3rd Block:</strong></span> Some text describing the
    problem.</p><p><span class="bold"><strong>4th Block:</strong></span> This is the first
    context. Usually indicates the rule, function, template or query where the
    error occurred. This block is not mandatory.</p><p><span class="bold"><strong>5th Block:</strong></span> Identifies the pattern
    where the error occurred. This block is not mandatory.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3116"/>5.4.2. Error Messages Description</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e3119"/>5.4.2.1. 101: No viable alternative</h4></div></div></div><p>Indicates the most common errors, where the parser came to a
      decision point but couldn't identify an alternative. Here are some
      examples:</p><div class="example"><a id="d0e3124"/><p class="title"><b>Example 5.2. </b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">1: rule one
2:   when
3:     exists Foo()
4:     <span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>exits</strong></span> Bar()
5:   then
6: end
</pre></div></div><br class="example-break"/><p>The above example generates this message:</p><div class="itemizedlist"><ul><li><p>[ERR 101] Line 4:4 no viable alternative at input 'exits' in
          rule one</p></li></ul></div><p>At first glance this seems to be valid syntax, but it is not
      (exits != exists). Let's take a look at next example:</p><div class="example"><a id="d0e3138"/><p class="title"><b>Example 5.3. </b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">1: package org.drools;
2: rule
3:   when
4:     Object()
5:   then
6:     System.out.println("A RHS");
7: end
</pre></div></div><br class="example-break"/><p>Now the above code generates this message:</p><div class="itemizedlist"><ul><li><p>[ERR 101] Line 3:2 no viable alternative at input
          'WHEN'</p></li></ul></div><p>This message means that the parser encountered the token <span class="bold"><strong>WHEN</strong></span>, actually a hard keyword, but it's in the
      wrong place since the the rule name is missing.</p><p>The error "no viable alternative" also occurs when you make a
      simple lexical mistake. Here is a sample of a lexical problem:</p><div class="example"><a id="d0e3154"/><p class="title"><b>Example 5.4. </b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">1: rule simple_rule
2:   when
3:     Student( name == "Andy )
4:   then
5: end
</pre></div></div><br class="example-break"/><p>The above code misses to close the quotes and because of this the
      parser generates this error message:</p><div class="itemizedlist"><ul><li><p>[ERR 101] Line 0:-1 no viable alternative at input
          '&lt;eof&gt;' in rule simple_rule in pattern Student</p></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Usually the Line and Column information are accurate, but in
        some cases (like unclosed quotes), the parser generates a 0:-1
        position. In this case you should check whether you didn't forget to
        close quotes, apostrophes or parentheses.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e3167"/>5.4.2.2. 102: Mismatched input</h4></div></div></div><p>This error indicates that the parser was looking for a particular
      symbol that it didn’t ﬁnd at the current input position. Here are some
      samples:</p><div class="example"><a id="d0e3172"/><p class="title"><b>Example 5.5. </b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">1: rule simple_rule
2:   when
3:     foo3 : Bar(
</pre></div></div><br class="example-break"/><p>The above example generates this message:</p><div class="itemizedlist"><ul><li><p>[ERR 102] Line 0:-1 mismatched input '&lt;eof&gt;' expecting
          ')' in rule simple_rule in pattern Bar</p></li></ul></div><p>To fix this problem, it is necessary to complete the rule
      statement.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Usually when you get a 0:-1 position, it means that parser
        reached the end of source.</p></div><p>The following code generates more than one error message:</p><div class="example"><a id="d0e3188"/><p class="title"><b>Example 5.6. </b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">1: package org.drools;
2:
3: rule "Avoid NPE on wrong syntax"
4:   when
5:     not( Cheese( ( type == "stilton", price == 10 ) || ( type == "brie", price == 15 ) ) from $cheeseList )
6:   then
7:     System.out.println("OK");
8: end
</pre></div></div><br class="example-break"/><p>These are the errors associated with this source:</p><div class="itemizedlist"><ul><li><p>[ERR 102] Line 5:36 mismatched input ',' expecting ')' in rule
          "Avoid NPE on wrong syntax" in pattern Cheese</p></li><li><p>[ERR 101] Line 5:57 no viable alternative at input 'type' in
          rule "Avoid NPE on wrong syntax"</p></li><li><p>[ERR 102] Line 5:106 mismatched input ')' expecting 'then' in
          rule "Avoid NPE on wrong syntax"</p></li></ul></div><p>Note that the second problem is related to the first. To fix it,
      just replace the commas (',') by AND operator ('&amp;&amp;').</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>In some situations you can get more than one error message. Try
        to fix one by one, starting at the first one. Some error messages are
        generated merely as consequences of other errors.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e3208"/>5.4.2.3. 103: Failed predicate</h4></div></div></div><p>A validating semantic predicate evaluated to false. Usually these
      semantic predicates are used to identify soft keywords. This sample
      shows exactly this situation:</p><div class="example"><a id="d0e3213"/><p class="title"><b>Example 5.7. </b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""> 1: package nesting;
 2: dialect "mvel"
 3:
 4: import org.drools.Person
 5: import org.drools.Address
 6: 
 7: <span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>fdsfdsfds</strong></span>
 8: 
 9: rule "test something"
10:   when
11:     p: Person( name=="Michael" )
12:   then
13:     p.name = "other";
14:     System.out.println(p.name);
15: end
</pre></div></div><br class="example-break"/><p>With this sample, we get this error message:</p><div class="itemizedlist"><ul><li><p>[ERR 103] Line 7:0 rule 'rule_key' failed predicate:
          {(validateIdentifierKey(DroolsSoftKeywords.RULE))}? in rule</p></li></ul></div><p>The <span class="bold"><strong>fdsfdsfds</strong></span> text is invalid and
      the parser couldn’t identify it as the soft keyword
      <code class="literal">rule</code>.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>This error is very similar to 102: Mismatched input, but usually
        involves soft keywords.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e3236"/>5.4.2.4. 104: Trailing semi-colon not allowed</h4></div></div></div><p>This error is associated with the <code class="literal">eval</code> clause,
      where its expression may not be terminated with a semicolon. Check this
      example:</p><div class="example"><a id="d0e3244"/><p class="title"><b>Example 5.8. </b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">1: rule simple_rule
2:   when
3:     eval(abc();)
4:   then
5: end
</pre></div></div><br class="example-break"/><p>Due to the trailing semicolon within eval, we get this error
      message:</p><div class="itemizedlist"><ul><li><p>[ERR 104] Line 3:4 trailing semi-colon not allowed in rule
          simple_rule</p></li></ul></div><p>This problem is simple to fix: just remove the semi-colon.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e3255"/>5.4.2.5. 105: Early Exit</h4></div></div></div><p>The recognizer came to a subrule in the grammar that must match an
      alternative at least once, but the subrule did not match anything.
      Simply put: the parser has entered a branch from where there is no way
      out. This example illustrates it:</p><div class="example"><a id="d0e3260"/><p class="title"><b>Example 5.9. </b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">1: template test_error
2:   aa s  11;
3: end
</pre></div></div><br class="example-break"/><p>This is the message associated to the above sample:</p><div class="itemizedlist"><ul><li><p>[ERR 105] Line 2:2 required (...)+ loop did not match anything
          at input 'aa' in template test_error</p></li></ul></div><p>To fix this problem it is necessary to remove the numeric value as
      it is neither a valid data type which might begin a new template slot
      nor a possible start for any other rule file construct.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3271"/>5.4.3. Other Messages</h3></div></div></div><p>Any other message means that something bad has happened, so please
    contact the development team.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e3276"/>5.5. Package</h2></div></div></div><p>A package is a collection of rules and other related constructs, such
  as imports and globals. The package members are typically related to each
  other - perhaps HR rules, for instance. A package represents a namespace,
  which ideally is kept unique for a given grouping of rules. The package name
  itself is the namespace, and is not related to files or folders in any
  way.</p><p>It is possible to assemble rules from multiple rule sources, and have
  one top level package configuration that all the rules are kept under (when
  the rules are assembled). Although, it is not possible to merge into the
  same package resources declared under different names. A single Rulebase
  may, however, contain multiple packages built on it. A common structure is to
  have all the rules for a package in the same file as the package declaration
  (so that is it entirely self-contained).</p><p>The following railroad diagram shows all the components that may make
  up a package. Note that a package <span class="emphasis"><em>must</em></span> have a namespace and be declared
  using standard Java conventions for package names; i.e., no spaces, unlike
  rule names which allow spaces. In terms of the order of elements, they can
  appear in any order in the rule file, with the exception of the <code class="literal">package</code>
  statement, which must be at the top of the file. In all cases, the semicolons are
  optional.</p><div class="figure"><a id="d0e3291"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/package.png" align="middle" alt="package"/></div></div><p class="title"><b>Figure 5.4. package</b></p></div><br class="figure-break"/><p>Notice that any rule atttribute (as described the section Rule Attributes)
  may also be written at package level, superseding the attribute's default value.
  The modified default may still be replaced by an attribute setting within
  a rule.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3299"/>5.5.1. import</h3></div></div></div><div class="figure"><a id="d0e3302"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Rule_Language/import.png" alt="import"/></div></div><p class="title"><b>Figure 5.5. import</b></p></div><br class="figure-break"/><p>Import statements work like import statements in Java. You need to
    specify the fully qualified paths and type names for any objects you want
    to use in the rules. Drools automatically imports classes from the
    Java package of the same name, and also from the package
    <code class="code">java.lang</code>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3313"/>5.5.2. global</h3></div></div></div><div class="figure"><a id="d0e3316"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Rule_Language/global.png" alt="global"/></div></div><p class="title"><b>Figure 5.6. global</b></p></div><br class="figure-break"/><p>With <code class="literal">global</code> you define global variables. They are used to make
    application objects available to the rules. Typically, they are used
    to provide data or services that the rules use, especially application
    services used in rule consequences, and to return data from the rules,
    like logs or values added in rule consequences, or for the rules to
    interact with the application, doing callbacks. Globals are not 
    inserted into the Working Memory, and therefore a global should never be
    used to establish conditions in rules except when it has a
    constant immutable value. The engine cannot be notified about value
    changes of globals and does not track their changes. Incorrect use
    of globals in constraints may yield surprising results - surprising
    in a bad way.</p><p>If multiple packages declare globals with the same identifier they
    must be of the same type and all of them will reference the same global
    value.</p><p>In order to use globals you must:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Declare your global variable in your rules file and use it in
        rules. Example:</p><pre xmlns="" class="">global java.util.List myGlobalList;

rule "Using a global"
when
    eval( true )
then
    myGlobalList.add( "Hello World" );
end
</pre></li><li><p>Set the global value on your working memory. It is a best
        practice to set all global values before asserting any fact to the
        working memory. Example:</p><pre xmlns="" class="JAVA"><!-- <br/> --><span class="java_type">List</span><!-- <br/> --><span class="java_plain">&nbsp;list&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ArrayList</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">WorkingMemory</span><span class="java_plain">&nbsp;wm&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;rulebase</span><span class="java_separator">.</span><span class="java_plain">newStatefulSession</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">wm</span><span class="java_separator">.</span><span class="java_plain">setGlobal</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;myGlobalList&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;list&nbsp;</span><span class="java_separator">);</span>
</pre></li></ol></div><p>Note that these are just named instances of objects that you pass in
    from your application to the working memory. This means you can pass in
    any object you want: you could pass in a service locator, or perhaps a
    service itself. With the new <code class="literal">from</code> element it is now common to pass a
    Hibernate session as a global, to allow <code class="literal">from</code> to pull data from a named
    Hibernate query.</p><p>One example may be an instance of a Email service. In your
    integration code that is calling the rule engine, you obtain your
    emailService object, and then set it in the working memory. In the DRL,
    you declare that you have a global of type EmailService, and give it the
    name "email". Then in your rule consequences, you can use things like
    email.sendSMS(number, message).</p><p>Globals are not designed to share data between rules and they should
    never be used for that purpose. Rules always reason and react to the
    working memory state, so if you want to pass data from rule to rule, assert
    the data as facts into the working memory.</p><p>It is strongly discouraged to set or change a global value from
    inside your rules. We recommend to you always set the value from your
    application using the working memory interface.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e3356"/>5.6. Function</h2></div></div></div><div class="figure"><a id="d0e3359"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/function.png" align="middle" alt="function"/></div></div><p class="title"><b>Figure 5.7. function</b></p></div><br class="figure-break"/><p>Functions are a way to put semantic code in your rule source file, as
  opposed to in normal Java classes. They can't do anything more than what you
  can do with helper classes. (In fact, the compiler generates the helper class
  for you behind the scenes.) The main advantage of using functions in a rule
  is that you can keep the logic all in one place, and you can change the
  functions as needed (which can be a good or a bad thing). Functions are most
  useful for invoking actions on the consequence (<code class="literal">then</code>) part of a rule,
  especially if that particular action is used over and over again, perhaps
  with only differing parameters for each rule.</p><p>A typical function declaration looks like:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">function String hello(String name) {
    return "Hello "+name+"!";
}
</pre><p>Note that the <code class="literal">function</code> keyword is used, even though its not really
  part of Java. Parameters to the function are defined as for a method, and
  you don't have to have parameters if they are not needed. The return type
  is defined just like in a regular method.</p><p>Alternatively, you could use a static method in a helper class,
  e.g., <code class="code">Foo.hello()</code>. Drools supports the use of
  function imports, so all you would need to do is:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">import function my.package.Foo.hello</pre><p>Irrespective of the way the function is defined or imported, you
  use a function by calling it by its name, in the consequence or inside
  a semantic code block. Example:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "using a static function"
when 
    eval( true )
then
    System.out.println( hello( "Bob" ) );
end
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e3390"/>5.7. Type Declaration</h2></div></div></div><div class="figure"><a id="d0e3393"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/meta_data.png" align="middle" alt="meta_data"/></div></div><p class="title"><b>Figure 5.8. meta_data</b></p></div><br class="figure-break"/><div class="figure"><a id="d0e3399"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/type_declaration.png" align="middle" alt="type_declaration"/></div></div><p class="title"><b>Figure 5.9. type_declaration</b></p></div><br class="figure-break"/><p>Type declarations have two main goals in the rules engine: to allow
  the declaration of new types, and to allow the declaration of metadata for
  types.</p><div class="itemizedlist"><ul><li><p><span class="bold"><strong>Declaring new types:</strong></span> Drools works
      out of the box with plain Java objects as facts. Sometimes, however,
      users may want to define the model directly to the rules engine, without
      worrying about creating models in a lower level language like Java. At
      other times, there is a domain model already built, but eventually the
      user wants or needs to complement this model with additional entities
      that are used mainly during the reasoning process.</p></li><li><p><span class="bold"><strong>Declaring metadata:</strong></span> facts may
      have meta information associated to them. Examples of meta information
      include any kind of data that is not represented by the fact attributes
      and is consistent among all instances of that fact type. This meta
      information may be queried at runtime by the engine and used in the
      reasoning process.</p></li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3418"/>5.7.1. Declaring New Types</h3></div></div></div><p>To declare a new type, all you need to do is use the keyword
    <code class="literal">declare</code>, followed by the list of fields, and the
    keyword <code class="literal">end</code>.</p><div class="example"><a id="d0e3429"/><p class="title"><b>Example 5.10. Declaring a new fact type: Address</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>declare</strong></span> Address
   number : int
   streetName : String
   city : String
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end</strong></span>
</pre></div></div><br class="example-break"/><p>The previous example declares a new fact type called
    <code class="code">Address</code>. This fact type will have three attributes:
    <code class="code">number</code>, <code class="code">streetName</code> and <code class="code">city</code>. Each
    attribute has a type that can be any valid Java type, including any other
    class created by the user or even other fact types previously
    declared.</p><p>For instance, we may want to declare another fact type
    <code class="code">Person</code>:</p><div class="example"><a id="d0e3458"/><p class="title"><b>Example 5.11. declaring a new fact type: Person</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>declare</strong></span> Person
    name : String
    dateOfBirth : java.util.Date
    address : Address
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end</strong></span>
</pre></div></div><br class="example-break"/><p>As we can see on the previous example, <code class="code">dateOfBirth</code> is
    of type <code class="code">java.util.Date</code>, from the Java API, while
    <code class="code">address</code> is of the previously defined fact type
    Address.</p><p>You may avoid having to write the fully qualified name of a class
    every time you write it by using the <code class="literal">import</code> clause, as
    previously discussed.</p><div class="example"><a id="d0e3484"/><p class="title"><b>Example 5.12. Avoiding the need to use fully qualified class names by using
      import</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>import</strong></span> java.util.Date

<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>declare</strong></span> Person
    name : String
    dateOfBirth : Date
    address : Address
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end</strong></span></pre></div></div><br class="example-break"/><p>When you declare a new fact type, Drools will, at compile time,
    generate bytecode that implements a Java class representing the fact type.
    The generated Java class will be a one-to-one Java Bean mapping of the
    type definition. So, for the previous example, the generated Java class
    would be:</p><div class="example"><a id="d0e3498"/><p class="title"><b>Example 5.13. generated Java class for the previous Person fact type
      declaration</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">implements</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Serializable</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;java</span><span class="java_separator">.</span><span class="java_plain">util</span><span class="java_separator">.</span><span class="java_type">Date</span><span class="java_plain">&nbsp;dateOfBirth</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Address</span><span class="java_plain">&nbsp;address</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;empty&nbsp;constructor</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;constructor&nbsp;with&nbsp;all&nbsp;fields&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;dateOfBirth</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Address</span><span class="java_plain">&nbsp;address&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;keys&nbsp;are&nbsp;defined</span><span class="java_separator">,</span><span class="java_plain">&nbsp;constructor&nbsp;with&nbsp;keys</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">keys</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getters&nbsp;and&nbsp;setters</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;equals</span><span class="java_operator">/</span><span class="java_plain">hashCode</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;toString</span>
<!--  --><br/><span class="java_separator">}</span>
</pre></div></div><br class="example-break"/><p>Since the generated class is a simple Java class, it can be used
    transparently in the rules, like any other fact.</p><div class="example"><a id="d0e3505"/><p class="title"><b>Example 5.14. Using the declared types in rules</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>rule</strong></span> "Using a declared Type"
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>when</strong></span> 
    $p : Person( name == "Bob" )
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>then</strong></span>
    <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>// Insert Mark, who is Bob's mate.</em></span>
    Person mark = new Person();
    mark.setName("Mark");
    insert( mark );
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end</strong></span>
</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3524"/>5.7.2. Declaring Metadata</h3></div></div></div><p>Metadata may be assigned to several different constructions in
    Drools: fact types, fact attributes and rules. Drools uses the at sign
    ('@') to introduce metadata, and it always uses the form:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@<span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>metadata_key</em></span>( <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>metadata_value</em></span> )</pre><p>The parenthesized <span class="emphasis"><em>metadata_value</em></span> is
    optional.</p><p>For instance, if you want to declare a metadata attribute like
    <code class="code">author</code>, whose value is <span class="emphasis"><em>Bob</em></span>, you could
    simply write:</p><div class="example"><a id="d0e3550"/><p class="title"><b>Example 5.15. Declaring a metadata attribute</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@author( Bob )</pre></div></div><br class="example-break"/><p>Drools allows the declaration of any arbitrary metadata attribute,
    but some will have special meaning to the engine, while others are simply
    available for querying at runtime. Drools allows the declaration of
    metadata both for fact types and for fact attributes. Any metadata that is
    declared before the attributes of a fact type are assigned to the fact
    type, while metadata declared after an attribute are assigned to that
    particular attribute.</p><div class="example"><a id="d0e3557"/><p class="title"><b>Example 5.16. Declaring metadata attributes for fact types and
      attributes</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>import</strong></span> java.util.Date

<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>declare</strong></span> Person
    <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>@author</em></span>( Bob )
    <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>@dateOfCreation</em></span>( 01-Feb-2009 )

    name : String <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>@key @maxLength</em></span>( 30 )
    dateOfBirth : Date 
    address : Address
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end</strong></span></pre></div></div><br class="example-break"/><p>In the previous example, there are two metadata items declared for
    the fact type (<code class="code">@author</code> and <code class="code">@dateOfCreation</code>) and
    two more defined for the name attribute (<code class="code">@key</code> and
    <code class="code">@maxLength</code>). Please note that the <code class="code">@key</code> metadata
    has no required value, and so the parentheses and the value were
    omitted.:</p><p>@position can be used to declare the position of a field, overriding
    the default declared order. This is used for positional constraints in
    patterns.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">declare Cheese
    name : String @position(1)
    shop : String @position(2)
    price : int @position(0)
end
</pre><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e3599"/>5.7.2.1. Predefined class level annotations</h4></div></div></div><p>Some annotations have predefined semantics that are interpreted by
      the engine. The following is a list of some of these predefined
      annotations and their meaning.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e3604"/>5.7.2.1.1. @role( &lt;fact | event&gt; )</h5></div></div></div><p>See Drools Fusion documentation for details.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e3609"/>5.7.2.1.2. @typesafe( &lt;boolean&gt; )</h5></div></div></div><p>By default all type declarations are compiled with type safety
        enabled; @typesafe( false ) provides a means to override this
        behaviour by permitting a fall-back, to type unsafe evaluation where
        all constraints are generated as MVEL constraints and executed
        dynamically. This can be important when dealing with collections that
        do not have any generics or mixed type collections.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e3614"/>5.7.2.1.3. @timestamp( &lt;attribute name&gt; )</h5></div></div></div><p>See Drools Fusion documentation for details.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e3619"/>5.7.2.1.4. @duration( &lt;attribute name&gt; )</h5></div></div></div><p>See Drools Fusion documentation for details.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e3624"/>5.7.2.1.5. @expires( &lt;time interval&gt; )</h5></div></div></div><p>See Drools Fusion documentation for details.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e3629"/>5.7.2.1.6. @propertyChangeSupport</h5></div></div></div><p>Facts that implement support for property changes as defined in
        the Javabean(tm) spec, now can be annotated so that the engine
        register itself to listen for changes on fact properties. The boolean
        parameter that was used in the insert() method in the Drools 4 API is
        deprecated and does not exist in the drools-api module.</p><div class="example"><a id="d0e3634"/><p class="title"><b>Example 5.17. @propertyChangeSupport</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">declare Person
  @propertyChangeSupport
end</pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e3639"/>5.7.2.2. Predefined attribute level annotations</h4></div></div></div><p>As noted before, Drools also supports annotations in type
      attributes. Here is a list of predefined attribute annotations.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e3644"/>5.7.2.2.1. @key</h5></div></div></div><p>Declaring an attribute as a key attribute has 2 major effects on
        generated types:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The attribute will be used as a key identifier for the
              type, and as so, the generated class will implement the equals()
              and hashCode() methods taking the attribute into account when
              comparing instances of this type.</p></li><li><p>Drools will generate a constructor using all the key
              attributes as parameters.</p></li></ol></div><p>For instance:</p><div class="example"><a id="d0e3658"/><p class="title"><b>Example 5.18. example of @key declarations for a type</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">declare Person
    firstName : String @key
    lastName : String @key
    age : int
end
</pre></div></div><br class="example-break"/><p>For the previous example, Drools will generate equals() and
        hashCode() methods that will check the firstName and lastName
        attributes to determine if two instances of Person are equal to each
        other, but will not check the age attribute. It will also generate a
        constructutor taking firstName and lastName as parameters, allowing
        one to create instances with a code like this:</p><div class="example"><a id="d0e3665"/><p class="title"><b>Example 5.19. creating an instance using the key constructor</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person person = new Person( "John", "Doe" );</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e3670"/>5.7.2.2.2. @position</h5></div></div></div><p>Patterns support positional arguments on type
        declarations.</p><p>Positional arguments are ones where you don't need to specify
        the field name, as the position maps to a known named field. i.e.
        Person( name == "mark" ) can be rewritten as Person( "mark"; ). The
        semicolon ';' is important so that the engine knows that everything
        before it is a positional argument. Otherwise we might assume it was a
        boolean expression, which is how it could be interpretted after the
        semicolon. You can mix positional and named arguments on a pattern by
        using the semicolon ';' to separate them. Any variables used in a
        positional that have not yet been bound will be bound to the field
        that maps to that position.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">declare Cheese
    name : String
    shop : String
    price : int
end
</pre><p>The default order is the declared order, but this can be
        overiden using @position</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">declare Cheese
    name : String @position(1)
    shop : String @position(2)
    price : int @position(0)
end
</pre><p>The @Position annotation, in the org.drools.definition.type
        package, can be used to annotate original pojos on the classpath.
        Currently only fields on classes can be annotated. Inheritence of
        classes is supported, but not interfaces of methods yet.</p><p>Example patterns, with two constraints and a binding. Remember
        semicolon ';' is used to differentiate the positional section from the
        named argument section. Variables and literals and expressions using
        just literals are supported in posional arguments, but not
        variables.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
Cheese( "stilton", "Cheese Shop", p; )
Cheese( "stilton", "Cheese Shop"; p : price )
Cheese( "stilton"; shop == "Cheese Shop", p : price )
Cheese( name == "stilton"; shop == "Cheese Shop", p : price )
</pre></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3689"/>5.7.3. Declaring Metadata for Existing Types</h3></div></div></div><p>Drools allows the declaration of metadata attributes for existing
    types in the same way as when declaring metadata attributes for new fact
    types. The only difference is that there are no fields in that
    declaration.</p><p>For instance, if there is a class org.drools.examples.Person, and
    one wants to declare metadata for it, it's possible to write the following
    code:</p><div class="example"><a id="d0e3696"/><p class="title"><b>Example 5.20. Declaring metadata for an existing type</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>import</strong></span> org.drools.examples.Person

<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>declare</strong></span> Person
    <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>@author</em></span>( Bob )
    <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>@dateOfCreation</em></span>( 01-Feb-2009 )
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end</strong></span>
</pre></div></div><br class="example-break"/><p>Instead of using the import, it is also possible to reference the
    class by its fully qualified name, but since the class will also be
    referenced in the rules, it is usually shorter to add the import and use
    the short class name everywhere.</p><div class="example"><a id="d0e3717"/><p class="title"><b>Example 5.21. Declaring metadata using the fully qualified class name</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>declare</strong></span> org.drools.examples.Person
    <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>@author</em></span>( Bob )
    <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>@dateOfCreation</em></span>( 01-Feb-2009 )
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end</strong></span></pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3732"/>5.7.4. Parameterized constructors for declared types</h3></div></div></div><p>Generate constructors with parameters for declared types.</p><p>Example: for a declared type like the following:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">declare Person
    firstName : String @key
    lastName : String @key
    age : int
end
</pre><p>The compiler will implicitly generate 3 constructors: one without
    parameters, one with the @key fields, and one with all fields.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person() // parameterless constructor
Person( String firstName, String lastName )
Person( String firstName, String lastName, int age )</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3745"/>5.7.5. Non Typesafe Classes</h3></div></div></div><p>@typesafe( &lt;boolean&gt;) has been added to type declarations. By
    default all type declarations are compiled with type safety enabled;
    @typesafe( false ) provides a means to override this behaviour by
    permitting a fall-back, to type unsafe evaluation where all constraints
    are generated as MVEL constraints and executed dynamically. This can be
    important when dealing with collections that do not have any generics or
    mixed type collections.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3750"/>5.7.6. Accessing Declared Types from the Application Code</h3></div></div></div><p>Declared types are usually used inside rules files, while Java
    models are used when sharing the model between rules and applications.
    Although, sometimes, the application may need to access and handle facts
    from the declared types, especially when the application is wrapping the
    rules engine and providing higher level, domain specific user interfaces
    for rules management.</p><p>In such cases, the generated classes can be handled as usual with
    the Java Reflection API, but, as we know, that usually requires a lot of
    work for small results. Therefore, Drools provides a simplified API for
    the most common fact handling the application may want to do.</p><p>The first important thing to realize is that a declared fact will
    belong to the package where it was declared. So, for instance, in the
    example below, <code class="code">Person</code> will belong to the
    <code class="code">org.drools.examples</code> package, and so the fully qualified name
    of the generated class will be
    <code class="code">org.drools.examples.Person</code>.</p><div class="example"><a id="d0e3768"/><p class="title"><b>Example 5.22. Declaring a type in the org.drools.examples package</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>package</strong></span> org.drools.examples

<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>import</strong></span> java.util.Date

<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>declare</strong></span> Person
    name : String
    dateOfBirth : Date
    address : Address
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end</strong></span></pre></div></div><br class="example-break"/><p>Declared types, as discussed previously, are generated at knowledge
    base compilation time, i.e., the application will only have access to them
    at application run time. Therefore, these classes are not available for
    direct reference from the application.</p><p>Drools then provides an interface through which users can handle
    declared types from the application code:
    <code class="code">org.drools.definition.type.FactType</code>. Through this interface,
    the user can instantiate, read and write fields in the declared fact
    types.</p><div class="example"><a id="d0e3790"/><p class="title"><b>Example 5.23. Handling declared fact types through the API</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// get a reference to a knowledge base with a declared type:
KnowledgeBase kbase = ...

// get the declared FactType
FactType personType = kbase.getFactType( "org.drools.examples",
                                         "Person" );

// handle the type as necessary:
// create instances:
Object bob = personType.newInstance();

// set attributes values
personType.set( bob,
                "name",
                "Bob" );
personType.set( bob,
                "age",
                42 );

// insert fact into a session
StatefulKnowledgeSession ksession = ...
ksession.insert( bob );
ksession.fireAllRules();

// read attributes
String name = personType.get( bob, "name" );
int age = personType.get( bob, "age" );

</pre></div></div><br class="example-break"/><p>The API also includes other helpful methods, like setting all the
    attributes at once, reading values from a Map, or reading all attributes
    at once, into a Map.</p><p>Although the API is similar to Java reflection (yet much simpler to
    use), it does not use reflection underneath, relying on much more
    performant accessors implemented with generated bytecode.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3799"/>5.7.7. Type Declaration 'extends'</h3></div></div></div><p>Type declarations now support 'extends' keyword for
    inheritance</p><p>In order to extend a type declared in Java by a DRL declared
    subtype, repeat the supertype in a declare statement without any
    fields.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">import org.people.Person

declare Person
end

declare Student extends Person
    school : String
end

declare LongTermStudent extends Student
    years : int
    course : String
end</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e3808"/>5.8. Rule</h2></div></div></div><div class="figure"><a id="d0e3811"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/rule.png" align="middle" alt="rule"/></div></div><p class="title"><b>Figure 5.10. rule</b></p></div><br class="figure-break"/><p>A rule specifies that <span class="emphasis"><em>when</em></span> a particular set of
  conditions occur, specified in the Left Hand Side (LHS),
  <span class="emphasis"><em>then</em></span> do what queryis specified as a list of actions in
  the Right Hand Side (RHS). A common question from users is "Why use when
  instead of if?" "When" was chosen over "if" because "if" is normally part of
  a procedural execution flow, where, at a specific point in time, a condition
  is to be checked. In contrast, "when" indicates that the condition
  evaluation is not tied to a specific evaluation sequence or point in time,
  but that it happens continually, at any time during the life time of the
  engine; whenever the condition is met, the actions are executed.</p><p>A rule must have a name, unique within its rule package. If you define
  a rule twice in the same DRL it produces an error while loading. If you add
  a DRL that includes a rule name already in the package, it replaces the
  previous rule. If a rule name is to have spaces, then it will need to be
  enclosed in double quotes (it is best to always use double quotes).</p><p>Attributes - described below - are optional. They are best written one
  per line.</p><p>The LHS of the rule follows the <code class="literal">when</code> keyword
  (ideally on a new line), similarly the RHS follows the
  <code class="literal">then</code> keyword (again, ideally on a newline). The rule is
  terminated by the keyword <code class="literal">end</code>. Rules cannot be
  nested.</p><div class="example"><a id="d0e3840"/><p class="title"><b>Example 5.24. Rule Syntax Overview</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "&lt;name&gt;"
    &lt;attribute&gt;*
when
    &lt;conditional element&gt;*
then
    &lt;action&gt;*
end</pre></div></div><br class="example-break"/><div class="example"><a id="d0e3845"/><p class="title"><b>Example 5.25. A simple rule</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Approve if not rejected"
  salience -100 
  agenda-group "approval"
    when
        not Rejection() 
        p : Policy(approved == false, policyState:status)
        exists Driver(age &gt; 25)
        Process(status == policyState)
    then
        log("APPROVED: due to no objections."); 
        p.setApproved(true);
end</pre></div></div><br class="example-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e3850"/>5.8.1. Rule Attributes</h3></div></div></div><p>Rule attributes provide a declarative way to influence the behavior
    of the rule. Some are quite simple, while others are part of complex
    subsystems such as ruleflow. To get the most from Drools you should make
    sure you have a proper understanding of each attribute.</p><div class="figure"><a id="d0e3855"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/rule_attributes.png" align="middle" alt="rule attributes"/></div></div><p class="title"><b>Figure 5.11. rule attributes</b></p></div><br class="figure-break"/><div class="variablelist"><dl><dt><span class="term"><code class="literal">no-loop</code></span></dt><dd><p>default value: <code class="literal">false</code></p><p>type: Boolean</p><p>When a rule's consequence modifies a fact it may cause the
          rule to activate again, causing an infinite loop. Setting no-loop to
          true will skip the creation of another Activation for the rule with
          the current set of facts.</p></dd><dt><span class="term"><code class="literal">ruleflow-group</code></span></dt><dd><p>default value: N/A</p><p>type: String</p><p>Ruleflow is a Drools feature that lets you exercise control
          over the firing of rules. Rules that are assembled by the same
          ruleflow-group identifier fire only when their group is
          active.</p></dd><dt><span class="term"><code class="literal">lock-on-active</code></span></dt><dd><p>default value: <code class="literal">false</code></p><p>type: Boolean</p><p>Whenever a ruleflow-group becomes active or an agenda-group
          receives the focus, any rule within that group that has
          lock-on-active set to true will not be activated any more;
          irrespective of the origin of the update, the activation of a
          matching rule is discarded. This is a stronger version of no-loop,
          because the change could now be caused not only by the rule itself.
          It's ideal for calculation rules where you have a number of rules
          that modify a fact and you don't want any rule re-matching and
          firing again. Only when the ruleflow-group is no longer active or
          the agenda-group loses the focus those rules with lock-on-active set
          to true become eligible again for their activations to be placed
          onto the agenda.</p></dd><dt><span class="term"><code class="literal">salience</code></span></dt><dd><p>default value: <code class="literal">0</code></p><p>type: integer</p><p>Each rule has an integer salience attribute which defaults to
          zero and can be negative or positive. Salience is a form of priority
          where rules with higher salience values are given higher priority
          when ordered in the Activation queue.</p><p>Drools also supports dynamic salience where you can use an
          expression involving bound variables.</p><div class="example"><a id="d0e3914"/><p class="title"><b>Example 5.26. Dynamic Salience</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Fire in rank order 1,2,.."
        salience( -$rank )
    when
        Element( $rank : rank,... )
    then
        ...
end</pre></div></div><br class="example-break"/></dd><dt><span class="term"><code class="literal">agenda-group</code></span></dt><dd><p>default value: MAIN</p><p>type: String</p><p>Agenda groups allow the user to partition the Agenda providing
          more execution control. Only rules in the agenda group that has
          acquired the focus are allowed to fire.</p></dd><dt><span class="term"><code class="literal">auto-focus</code></span></dt><dd><p>default value: <code class="literal">false</code></p><p>type: Boolean</p><p>When a rule is activated where the <code class="code">auto-focus</code>
          value is true and the rule's agenda group does not have focus yet,
          then it is given focus, allowing the rule to potentially
          fire.</p></dd><dt><span class="term"><code class="literal">activation-group</code></span></dt><dd><p>default value: N/A</p><p>type: String</p><p>Rules that belong to the same activation-group, identified by
          this attribute's string value, will only fire exclusively. In other
          words, the first rule in an activation-group to fire will cancel the
          other rules' activations, i.e., stop them from firing.</p><p>Note: This used to be called Xor group, but technically it's
          not quite an Xor. You may still hear people mention Xor group; just
          swap that term in your mind with activation-group.</p></dd><dt><span class="term"><code class="literal">dialect</code></span></dt><dd><p>default value: as specified by the package</p><p>type: String</p><p>possible values: "java" or "mvel"</p><p>The dialect species the language to be used for any code
          expressions in the LHS or the RHS code block. Currently two dialects
          are available, Java and MVEL. While the dialect can be specified at
          the package level, this attribute allows the package definition to
          be overridden for a rule.</p></dd><dt><span class="term"><code class="literal">date-effective</code></span></dt><dd><p>default value: N/A</p><p>type: String, containing a date and time definition</p><p>A rule can only activate if the current date and time is after
          date-effective attribute.</p></dd><dt><span class="term"><code class="literal">date-expires</code></span></dt><dd><p>default value: N/A</p><p>type: String, containing a date and time definition</p><p>A rule cannot activate if the current date and time is after
          the date-expires attribute.</p></dd><dt><span class="term"><code class="literal">duration</code></span></dt><dd><p>default value: no default value</p><p>type: long</p><p>The duration dictates that the rule will fire after a
          specified duration, if it is still true.</p></dd></dl></div><div class="example"><a id="d0e4005"/><p class="title"><b>Example 5.27. Some attribute examples</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "my rule"
  salience 42
  agenda-group "number 1"
    when ...</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4010"/>5.8.2. Timers and Calendars</h3></div></div></div><p>Rules now suport both interval and cron based timers, which replace
    the now deprecated duration attribute.</p><div class="example"><a id="d0e4015"/><p class="title"><b>Example 5.28. Sample timer attribute uses</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">timer&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">int</span><!-- <br/> --><span class="java_operator">:</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">initial&nbsp;delay</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">repeat&nbsp;interval</span><!-- <br/> --><span class="java_operator">&gt;?</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">timer&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">30</span><span class="java_plain">s&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">timer&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">30</span><span class="java_plain">s&nbsp;</span><span class="java_literal">5</span><span class="java_plain">m&nbsp;</span><span class="java_separator">)</span>
</span>
<!--  --><br/><span class="java_plain">timer&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cron</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">cron&nbsp;expression</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">timer&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cron</span><span class="java_operator">:*</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_operator">/</span><span class="java_literal">15</span><span class="java_plain">&nbsp;</span><span class="java_operator">*</span><span class="java_plain">&nbsp;</span><span class="java_operator">*</span><span class="java_plain">&nbsp;</span><span class="java_operator">*</span><span class="java_plain">&nbsp;</span><span class="java_operator">?</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span></pre></div></div><br class="example-break"/><p>Interval (indicated by "int:") timers follow the semantics of
    java.util.Timer objects, with an initial delay and an optional repeat
    interval. Cron (indicated by "cron:") timers follow standard Unix cron
    expressions:</p><div class="example"><a id="d0e4022"/><p class="title"><b>Example 5.29. A Cron Example</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">rule&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;Send&nbsp;SMS&nbsp;every&nbsp;15&nbsp;minutes&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;timer&nbsp;</span><span class="java_separator">(</span><span class="java_plain">cron</span><span class="java_operator">:*</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_operator">/</span><span class="java_literal">15</span><span class="java_plain">&nbsp;</span><span class="java_operator">*</span><span class="java_plain">&nbsp;</span><span class="java_operator">*</span><span class="java_plain">&nbsp;</span><span class="java_operator">*</span><span class="java_plain">&nbsp;</span><span class="java_operator">?</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">when</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;$a&nbsp;</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_type">Alarm</span><span class="java_separator">(</span><span class="java_plain">&nbsp;on&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">then</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;channels</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;sms&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">].</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Sms</span><span class="java_separator">(</span><span class="java_plain">&nbsp;$a</span><span class="java_separator">.</span><span class="java_plain">mobileNumber</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;The&nbsp;alarm&nbsp;is&nbsp;still&nbsp;on&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">end</span></pre></div></div><br class="example-break"/><p>Calendars are used to control when rules can fire. The Calendar API
    is modelled on <a class="link" href="http://www.quartz-scheduler.org/" target="">Quartz</a>:</p><div class="example"><a id="d0e4032"/><p class="title"><b>Example 5.30. Adapting a Quartz Calendar</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Calendar</span><!-- <br/> --><span class="java_plain">&nbsp;weekDayCal&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">QuartzHelper</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">quartzCalendarAdapter</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">org</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">quartz</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_type">Calendar</span><!-- <br/> --><span class="java_plain">&nbsp;quartzCal</span><!-- <br/> --><span class="java_separator">)</span></pre></div></div><br class="example-break"/><p>Calendars are registered with the StatefulKnowledgeSession:</p><div class="example"><a id="d0e4039"/><p class="title"><b>Example 5.31. Registering a Calendar</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getCalendars</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">set</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;weekday&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;weekDayCal&nbsp;</span><!-- <br/> --><span class="java_separator">);</span></pre></div></div><br class="example-break"/><p>They can be used in conjunction with normal rules and rules
    including timers. The rule attribute "calendars" may contain one or more
    comma-separated calendar names written as string literals.</p><div class="example"><a id="d0e4046"/><p class="title"><b>Example 5.32. Using Calendars and Timers together</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">rule&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;weekdays&nbsp;are&nbsp;high&nbsp;priority&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;calendars&nbsp;</span><span class="java_literal">&quot;weekday&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;timer&nbsp;</span><span class="java_separator">(</span><span class="java_type">int</span><span class="java_operator">:</span><span class="java_literal">0</span><span class="java_plain">&nbsp;</span><span class="java_literal">1</span><span class="java_plain">h</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">when&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Alarm</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">then</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;send</span><span class="java_separator">(</span><span class="java_plain">&nbsp;&quot;priority&nbsp;high&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;we&nbsp;have&nbsp;an&nbsp;alarm&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">end&nbsp;</span>
</span>
<!--  --><br/><span class="java_plain">rule&nbsp;</span><span class="java_literal">&quot;weekend&nbsp;are&nbsp;low&nbsp;priority&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;calendars&nbsp;</span><span class="java_literal">&quot;weekend&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;timer&nbsp;</span><span class="java_separator">(</span><span class="java_type">int</span><span class="java_operator">:</span><span class="java_literal">0</span><span class="java_plain">&nbsp;</span><span class="java_literal">4</span><span class="java_plain">h</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">when&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Alarm</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">then</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;send</span><span class="java_separator">(</span><span class="java_plain">&nbsp;&quot;priority&nbsp;low&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;we&nbsp;have&nbsp;an&nbsp;alarm&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">end</span></pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4051"/>5.8.3. Left Hand Side (when) syntax</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e4054"/>5.8.3.1. What is the Left Hand Side?</h4></div></div></div><p>The Left Hand Side (LHS) is a common name for the conditional part
      of the rule. It consists of zero or more Conditional Elements. If the
      LHS is empty, it will be considered as a condition element that is
      always true and it will be activated once, when a new WorkingMemory
      session is created.</p><div class="figure"><a id="d0e4059"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/lhs.png" align="middle" alt="Left Hand Side"/></div></div><p class="title"><b>Figure 5.12. Left Hand Side</b></p></div><br class="figure-break"/><div class="example"><a id="d0e4065"/><p class="title"><b>Example 5.33. Rule without a Conditional Element</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "no CEs"
when
    // empty
then
    ... // actions (executed once)
end

# The above rule is internally rewritten as:

rule "eval(true)"
when
    eval( true )
then
    ... // actions (executed once)
end</pre></div></div><br class="example-break"/><p>Conditional elements work on one or more
      <span class="emphasis"><em>patterns</em></span> (which are described below). The most
      common conditional element is "<code class="literal">and"</code>. Therefore it is
      implicit when you have multiple patterns in the LHS of a rule that are
      not connected in any way:</p><div class="example"><a id="d0e4078"/><p class="title"><b>Example 5.34. Implicit and</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "2 unconnected patterns"
when
    Pattern1()
    Pattern2()
then
    ... // actions
end

# The above rule is internally rewritten as:

rule "2 and connected patterns"
when
    Pattern1()
    and Pattern2()
then
    ... // actions
end</pre></div></div><br class="example-break"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>An "<code class="literal">and"</code> cannot have a leading declaration
        binding (unlike for example <code class="literal">or</code>). This is obvious,
        since a declaration can only reference a single fact at a time, and
        when the "<code class="literal">and"</code> is satisfied it matches both facts -
        so which fact would the declaration bind to?</p><pre xmlns="" class="">// Compile error
$person : (Person( name == "Romeo" ) and Person( name == "Juliet"))</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e4097"/>5.8.3.2. Pattern (conditional element)</h4></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4100"/>5.8.3.2.1. What is a pattern?</h5></div></div></div><p>A pattern element is the most important Conditional Element. It
        can potentially match on each fact that is inserted in the working
        memory.</p><p>A pattern contains of zero or more constraints and has an
        optional pattern binding. The railroad diagram below shows the syntax
        for this.</p><div class="figure"><a id="d0e4107"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/pattern.png" align="middle" alt="Pattern"/></div></div><p class="title"><b>Figure 5.13. Pattern</b></p></div><br class="figure-break"/><p>In its simplest form, with no constraints, a pattern matches
        against a fact of the given type. In the following case the type is
        <code class="code">Cheese</code>, which means that the pattern will match against
        all <code class="code">Person</code> objects in the Working Memory:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person()</pre><p>The type need not be the actual class of some fact object.
        Patterns may refer to superclasses or even interfaces, thereby
        potentially matching facts from many different classes.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Object() // matches all objects in the working memory</pre><p>Inside of the pattern parenthesis is where all the action
        happens: it defines the constraints for that pattern. For example,
        with a age related constraint:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( age == 100 )</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>For backwards compatibility reasons it's allowed to suffix
          patterns with the <code class="literal">;</code> character. But it is not
          recommended to do that.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4137"/>5.8.3.2.2. Pattern binding</h5></div></div></div><p>For referring to the matched object, use a pattern binding
        variable such as <code class="code">$p</code>.</p><div class="example"><a id="d0e4145"/><p class="title"><b>Example 5.35. Pattern with a binding variable</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule ...
when
    $p : Person()
then
    System.out.println( "Person " + $p );
end</pre></div></div><br class="example-break"/><p>The prefixed dollar symbol (<code class="literal">$</code>) is just a
        convention; it can be useful in complex rules where it helps to easily
        differentiate between variables and fields, but it is not
        mandatory.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e4155"/>5.8.3.3. Constraint (part of a pattern)</h4></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4158"/>5.8.3.3.1. What is a constraint?</h5></div></div></div><p>A constraint is an expression that returns
        <code class="literal">true</code> or <code class="literal">false</code>. This example has
        a constraint that states <span class="emphasis"><em>5 is smaller than
        6</em></span>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( 5 &lt; 6 )  // just an example, as constraints like this would be useless in a real pattern</pre><p>In essence, it's a Java expression with some enhancements (such
        as property access) and a few differences (such as
        <code class="literal">equals()</code> semantics for <code class="literal">==</code>).
        Let's take a deeper look.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4182"/>5.8.3.3.2. Property access on Java Beans (POJO's)</h5></div></div></div><p>Any bean property can be used directly. A bean property is
        exposed using a standard Java bean getter: a method
        <code class="literal">getMyProperty()</code> (or
        <code class="literal">isMyProperty()</code> for a primitive boolean) which takes
        no arguments and return something. For example: the age property is
        written as <code class="literal">age</code> in DRL instead of the getter
        <code class="literal">getAge()</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( age == 50 )

// this is the same as:
Person( getAge() == 50 )</pre><p>Drools uses the standard JDK <code class="literal">Introspector</code>
        class to do this mapping, so it follows the standard Java bean
        specification.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>We recommend using property access (<code class="literal">age</code>)
          over using getters explicitly (<code class="literal">getAge()</code>) because
          of performance enhancements through field indexing.</p></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>Property accessors must not change the state of the object in
          a way that may effect the rules. Remember that the rule engine
          effectively caches the results of its matching in between
          invocations to make it faster.</p><pre xmlns="" class="">public int getAge() {
    age++; // Do NOT do this
    return age;
}</pre><pre xmlns="" class="">public int getAge() {
    Date now = DateUtil.now(); // Do NOT do this
    return DateUtil.differenceInYears(now, birthday);
}</pre><p>To solve this latter case, insert a fact that wraps the
          current date into working memory and update that fact between
          <code class="literal">fireAllRules</code> as needed.</p></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The following fallback applies: if the getter of a property
          cannot be found, the compiler will resort to using the property name
          as a method name and without arguments:</p><pre xmlns="" class="">Person( age == 50 )

// If Person.getAge() does not exists, this falls back to:
Person( age() == 50 )</pre></div><p>Nested property access is also supported:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( address.houseNumber == 50 )

// this is the same as:
Person( getAddress().getHouseNumber() == 50 )</pre><p>Nested properties are also indexed.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>In a stateful session, care should be taken when using nested
          accessors as the Working Memory is not aware of any of the nested
          values, and does not know when they change. Either consider them
          immutable while any of their parent references are inserted into the
          Working Memory. Or, instead, if you wish to modify a nested value
          you should mark all of the outer facts as updated. In the above
          example, when the <code class="literal">houseNumber</code> changes, any
          <code class="literal">Person</code> with that <code class="literal">Address</code> must
          be marked as updated.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4250"/>5.8.3.3.3. Java expression</h5></div></div></div><p>You can use any Java expression that returns a
        <code class="literal">boolean</code> as a constraint inside the parentheses of a
        pattern. Java expressions can be mixed with other expression
        enhancements, such as property access:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( age == 50 )</pre><p>It is possible to change the evaluation priority by using
        parentheses, as in any logic or mathematical expression:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( age &gt; 100 &amp;&amp; ( age % 10 == 0 ) )</pre><p>It is possible to reuse Java methods:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( Math.round( weight / ( height * height ) ) &lt; 25.0 )</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>As for property accessors, methods must not change the state
          of the object in a way that may affect the rules. Any method
          executed on a fact in the LHS should be a <span class="emphasis"><em>read
          only</em></span> method.</p><pre xmlns="" class="">Person( incrementAndGetAge() == 10 ) // Do NOT do this</pre></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>The state of a fact should not change between rule invocations
          (unless those facts are marked as updated to the working memory on
          every change):</p><pre xmlns="" class="">Person( System.currentTimeMillis() % 1000 == 0 ) // Do NOT do this</pre></div><p>Normal Java operator precedence applies, see the operator
        precedence list below.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>All operators have normal Java semantics except for
          <code class="literal">==</code> and <code class="literal">!=</code>.</p><p>The <code class="literal">==</code> operator has null-safe
          <code class="literal">equals()</code> semantics:</p><pre xmlns="" class="">// Similar to: java.util.Objects.equals(person.getFirstName(), "John")
// so (because "John" is not null) similar to:
// "John".equals(person.getFirstName())
Person( firstName == "John" )</pre><p>The <code class="literal">!=</code> operator has null-safe
          <code class="literal">!equals()</code> semantics:</p><pre xmlns="" class="">// Similar to: !java.util.Objects.equals(person.getFirstName(), "John")
Person( firstName != "John" )</pre></div><p>Type coercion is always attempted if the field and the value are
        of different types; exceptions will be thrown if a bad coercion is
        attempted. For instance, if "ten" is provided as a string in a numeric
        evaluator, an exception is thrown, whereas "10" would coerce to a
        numeric 10. Coercion is always in favor of the field type and not the
        value type:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( age == "10" ) // "10" is coerced to 10</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4316"/>5.8.3.3.4. Comma separated AND</h5></div></div></div><p>The comma character ('<code class="literal">,</code>') is used to separate
        constraint groups. It has implicit <span class="emphasis"><em>AND</em></span> connective
        semantics.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Person is at least 50 and weighs at least 80 kg
Person( age &gt; 50, weight &gt; 80 )</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Person is at least 50, weighs at least 80 kg and is taller than 2 meter.
Person( age &gt; 50, weight &gt; 80, height &gt; 2 )</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Although the <code class="literal">&amp;&amp;</code> and
          <code class="literal">,</code> operators have the same semantics, they are
          resolved with different priorities: The
          <code class="literal">&amp;&amp;</code> operator precedes the
          <code class="literal">||</code> operator. Both the
          <code class="literal">&amp;&amp;</code> and <code class="literal">||</code> operator
          precede the <code class="literal">,</code> operator. See the operator
          precedence list below.</p><p>The comma operator should be preferred at the top level
          constraint, as it makes constraints easier to read and the engine
          will often be able to optimize them better.</p></div><p>The comma (<code class="literal">,</code>) operator cannot be embedded in
        a composite constraint expression, such as parentheses:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( ( age &gt; 50, weight &gt; 80 ) || height &gt; 2 ) // Do NOT do this: compile error

// Use this instead
Person( ( age &gt; 50 &amp;&amp; weight &gt; 80 ) || height &gt; 2 )</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4364"/>5.8.3.3.5. Binding variables</h5></div></div></div><p>A property can be bound to a variable:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// 2 persons of the same age
Person( $firstAge : age ) // binding
Person( age == $firstAge ) // constraint expression</pre><p>The prefixed dollar symbol (<code class="literal">$</code>) is just a
        convention; it can be useful in complex rules where it helps to easily
        differentiate between variables and fields.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>For backwards compatibility reasons, It's allowed (but not
          recommended) to mix a constraint binding and constraint expressions
          as such:</p><pre xmlns="" class="">// Not recommended
Person( $age : age * 2 &lt; 100 )</pre><pre xmlns="" class="">// Recommended (seperates bindings and constraint expressions)
Person( age * 2 &lt; 100, $age : age )</pre></div><p>Bound variable restrictions using the operator
        <code class="literal">==</code> provide for very fast execution as it use hash
        indexing to improve performance.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4388"/>5.8.3.3.6. Unification</h5></div></div></div><p>Drools does not allow bindings to the same declaration. However
        this is an important aspect to derivation query unification. While
        positional arguments are always processed with unification a special
        unification symbol, ':=', was introduced for named arguments named
        arguments. The following "unifies" the age argument across two
        people.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( $age := age ) 
Person( $age := age) </pre><p>In essence unification will declare a binding for the first
        occurance, and constrain to the same value of the bound field for
        sequence occurances.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4397"/>5.8.3.3.7. Special literal support</h5></div></div></div><p>Besides normal Java literals (including Java 5 enums), this
        literal is also supported:</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4402"/>5.8.3.3.7.1. Date literal</h6></div></div></div><p>The date format <code class="literal">dd-mmm-yyyy</code> is supported by
          default. You can customize this by providing an alternative date
          format mask as the System property named
          <code class="code">drools.dateformat</code>. If more control is required, use a
          restriction.</p><div class="example"><a id="d0e4413"/><p class="title"><b>Example 5.36. Date Literal Restriction</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cheese( bestBefore &lt; "27-Oct-2009" )</pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4418"/>5.8.3.3.8. List and Map access</h5></div></div></div><p>It's possible to directly access a <code class="literal">List</code> value
        by index:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Same as childList(0).getAge() == 18
Person( childList[0].age == 18 )</pre><p>It's also possible to directly access a <code class="literal">Map</code>
        value by key:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Same as credentialMap.get("jsmith").isValid()
Person( credentialMap["jsmith"].valid )</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4435"/>5.8.3.3.9. Abbreviated combined relation condition</h5></div></div></div><p>This allows you to place more than one restriction on a field
        using the restriction connectives <code class="literal">&amp;&amp;</code> or
        <code class="literal">||</code>. Grouping via parentheses is permitted,
        resulting in a recursive syntax pattern.</p><div class="figure"><a id="d0e4446"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/abbreviatedCombinedRelationCondition.png" align="middle" alt="Abbreviated combined relation condition"/></div></div><p class="title"><b>Figure 5.14. Abbreviated combined relation condition</b></p></div><br class="figure-break"/><div class="figure"><a id="d0e4452"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/abbreviatedCombinedRelationConditionGroup.png" align="middle" alt="Abbreviated combined relation condition with parentheses"/></div></div><p class="title"><b>Figure 5.15. Abbreviated combined relation condition with
          parentheses</b></p></div><br class="figure-break"/><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Simple abbreviated combined relation condition using a single &amp;&amp;
Person( age &gt; 30 &amp;&amp; &lt; 40 )</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Complex abbreviated combined relation using groupings
Person( age ( (&gt; 30 &amp;&amp; &lt; 40) ||
              (&gt; 20 &amp;&amp; &lt; 25) ) )</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Mixing abbreviated combined relation with constraint connectives
Person( age &gt; 30 &amp;&amp; &lt; 40 || location == "london" )</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4464"/>5.8.3.3.10. Special DRL operators</h5></div></div></div><div class="figure"><a id="d0e4467"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/operator.png" align="middle" alt="Operators"/></div></div><p class="title"><b>Figure 5.16. Operators</b></p></div><br class="figure-break"/><p>Coercion to the correct value for the evaluator and the field
        will be attempted.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4475"/>5.8.3.3.10.1. The operators <code class="literal">&lt;</code>
          <code class="literal">&lt;=</code> <code class="literal">&gt;</code>
          <code class="literal">&gt;=</code></h6></div></div></div><p>These operators can be used on properties with natural
          ordering. For example, for Date fields, <code class="literal">&lt;</code>
          means <span class="emphasis"><em>before</em></span>, for <code class="literal">String</code>
          fields, it means alphabetically lower.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( firstName &lt; $otherFirstName )</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( birthDate &lt; $otherBirthDate )</pre><p>Only applies on <code class="literal">Comperable</code>
          properties.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4509"/>5.8.3.3.10.2. The operator <code class="literal">matches</code></h6></div></div></div><p>Matches a field against any valid Java <a id="d0e4516" class="indexterm"/>Regular Expression. Typically that regexp is a string
          literal, but variables that resolve to a valid regexp are also
          allowed.</p><div class="example"><a id="d0e4520"/><p class="title"><b>Example 5.37. Regular Expression Constraint</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cheese( type matches "(Buffalo)?\\S*Mozarella" )</pre></div></div><br class="example-break"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Like in Java, regular expressions written as string literals
            <span class="emphasis"><em>need to escape '<code class="literal">\</code></em></span>'.</p></div><p>Only applies on <code class="literal">String</code> properties.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4538"/>5.8.3.3.10.3. The operator <code class="literal">not matches</code></h6></div></div></div><p>The operator returns true if the String does not match the
          regular expression. The same rules apply as for the
          <code class="literal">matches</code> operator. Example:</p><div class="example"><a id="d0e4548"/><p class="title"><b>Example 5.38. Regular Expression Constraint</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cheese( type not matches "(Buffulo)?\\S*Mozarella" )</pre></div></div><br class="example-break"/><p>Only applies on <code class="literal">String</code> properties.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4558"/>5.8.3.3.10.4. The operator <code class="literal">contains</code></h6></div></div></div><p>The operator <code class="literal">contains</code> is used to check
          whether a field that is a <a id="d0e4568" class="indexterm"/>Collection or array contains the specified
          value.</p><div class="example"><a id="d0e4572"/><p class="title"><b>Example 5.39. Contains with Collections</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CheeseCounter( cheeses contains "stilton" ) // contains with a String literal
CheeseCounter( cheeses contains $var ) // contains with a variable</pre></div></div><br class="example-break"/><p>Only applies on <code class="literal">Collection</code>
          properties.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4582"/>5.8.3.3.10.5. The operator <code class="literal">not contains</code></h6></div></div></div><p>The operator <code class="literal">not contains</code> is used to check
          whether a field that is a <a id="d0e4592" class="indexterm"/>Collection or array does <span class="emphasis"><em>not</em></span>
          contain the specified value.</p><div class="example"><a id="d0e4599"/><p class="title"><b>Example 5.40. Literal Constraint with Collections</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CheeseCounter( cheeses not contains "cheddar" ) // not contains with a String literal
CheeseCounter( cheeses not contains $var ) // not contains with a variable</pre></div></div><br class="example-break"/><p>Only applies on <code class="literal">Collection</code>
          properties.</p><div class="blockquote"><blockquote class="blockquote"><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>For backward compatibility, the
              <code class="literal">excludes</code> operator is supported as a synonym
              for <code class="literal">not contains</code>.</p></div></blockquote></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4619"/>5.8.3.3.10.6. The operator <code class="literal">memberOf</code></h6></div></div></div><p>The operator <code class="literal">memberOf</code> is used to check
          whether a field is a member of a collection or array; that
          collection must be a variable.</p><div class="example"><a id="d0e4629"/><p class="title"><b>Example 5.41. Literal Constraint with Collections</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CheeseCounter( cheese memberOf $matureCheeses )</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4634"/>5.8.3.3.10.7. The operator <code class="literal">not memberOf</code></h6></div></div></div><p>The operator <code class="literal">not memberOf</code> is used to check
          whether a field is not a member of a collection or array; that
          collection must be a variable.</p><div class="example"><a id="d0e4644"/><p class="title"><b>Example 5.42. Literal Constraint with Collections</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CheeseCounter( cheese not memberOf $matureCheeses )</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4649"/>5.8.3.3.10.8. The operator <code class="literal">soundslike</code></h6></div></div></div><p>This operator is similar to <code class="literal">matches</code>, but it
          checks whether a word has almost the same sound (using English
          pronunciation) as the given value. This is based on the Soundex
          algorithm (see
          <code class="code">http://en.wikipedia.org/wiki/Soundex</code>).</p><div class="example"><a id="d0e4662"/><p class="title"><b>Example 5.43. Test with soundslike</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// match cheese "fubar" or "foobar"
Cheese( name soundslike 'foobar' )</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4667"/>5.8.3.3.10.9. The operator <code class="literal">str</code></h6></div></div></div><p>This operator <code class="literal">str</code> is used to check whether
          a field that is a <code class="literal">String</code> starts with or ends with
          a certain value. It can also be used to check the length of the
          String.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Message( routingValue str[startsWith] "R1" )</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Message( routingValue str[endsWith] "R2" )</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Message( routingValue str[length] 17 )</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4686"/>5.8.3.3.10.10. The operators <code class="literal">in</code> and <code class="literal">not
          in</code> (compound value restriction)</h6></div></div></div><p>The compound value restriction is used where there is more
          than one possible value to match. Currently only the
          <code class="literal">in</code> and <code class="literal">not in</code> evaluators
          support this. The second operand of this operator must be a
          comma-separated list of values, enclosed in parentheses. Values may
          be given as variables, literals, return values or qualified
          identifiers. Both evaluators are actually <span class="emphasis"><em>syntactic
          sugar</em></span>, internally rewritten as a list of multiple
          restrictions using the operators <code class="literal">!=</code> and
          <code class="literal">==</code>.</p><div class="figure"><a id="d0e4712"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/compoundValueRestriction.png" align="middle" alt="compoundValueRestriction"/></div></div><p class="title"><b>Figure 5.17. compoundValueRestriction</b></p></div><br class="figure-break"/><div class="example"><a id="d0e4718"/><p class="title"><b>Example 5.44. Compound Restriction using "in"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( $cheese : favouriteCheese )
Cheese( type in ( "stilton", "cheddar", $cheese ) )</pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4723"/>5.8.3.3.11. Inline eval operator (deprecated)</h5></div></div></div><div class="figure"><a id="d0e4726"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/inlineEvalConstraint.png" align="middle" alt="Inline Eval Expression"/></div></div><p class="title"><b>Figure 5.18. Inline Eval Expression</b></p></div><br class="figure-break"/><p>An <a id="d0e4734" class="indexterm"/>inline eval constraint can use any valid dialect
        expression as long as it results to a primitive boolean. The
        expression must be constant over time. Any previously bound variable,
        from the current or previous pattern, can be used; autovivification is
        also used to auto-create field binding variables. When an identifier
        is found that is not a current variable, the builder looks to see if
        the identifier is a field on the current object type, if it is, the
        field binding is auto-created as a variable of the same name. This is
        called autovivification of field variables inside of inline
        eval's.</p><p>This example will find all male-female pairs where the male is 2
        years older than the female; the variable <code class="code">age</code> is
        auto-created in the second pattern by the autovivification
        process.</p><div class="example"><a id="d0e4743"/><p class="title"><b>Example 5.45. Return Value operator</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Person( girlAge : age, sex = "F" )
Person( eval( age == girlAge + 2 ), sex = 'M' ) // eval() is actually obselete in this example</pre></div></div><br class="example-break"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Inline eval's are effectively obsolete as their inner syntax
          is now directly supported. It's recommended not to use them. Simply
          write the expression without wrapping eval() around it.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4751"/>5.8.3.3.12. Operator precedence</h5></div></div></div><p>The operators are evaluated in this precedence:</p><div class="table"><a id="d0e4756"/><p class="title"><b>Table 5.1. Operator precedence</b></p><div class="table-contents"><table summary="Operator precedence" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="center">Operator type</th><th align="center">Operators</th><th align="center">Notes</th></tr></thead><tbody><tr><td>(nested) property access</td><td><code class="literal">.</code></td><td>Not normal Java semantics</td></tr><tr><td>List/Map access</td><td><code class="literal">[ ]</code></td><td>Not normal Java semantics</td></tr><tr><td>constraint binding</td><td><code class="literal">:</code></td><td>Not normal Java semantics</td></tr><tr><td>multiplicative</td><td><code class="literal">*</code> <code class="literal">/</code>
                <code class="literal">%</code></td><td> </td></tr><tr><td>additive</td><td><code class="literal">+</code> <code class="literal">-</code></td><td> </td></tr><tr><td>shift</td><td><code class="literal">&lt;&lt;</code> <code class="literal">&gt;&gt;</code>
                <code class="literal">&gt;&gt;&gt;</code></td><td> </td></tr><tr><td>relational</td><td><code class="literal">&lt;</code> <code class="literal">&gt;</code>
                <code class="literal">&lt;=</code> <code class="literal">&gt;=</code>
                <code class="literal">instanceof</code></td><td> </td></tr><tr><td>equality</td><td><code class="literal">==</code> <code class="literal">!=</code></td><td>Does not use normal Java (<span class="emphasis"><em>not</em></span>)
                <span class="emphasis"><em>same</em></span> semantics: uses
                (<span class="emphasis"><em>not</em></span>) <span class="emphasis"><em>equals</em></span>
                semantics instead.</td></tr><tr><td>non-short circuiting AND</td><td><code class="literal">&amp;</code></td><td> </td></tr><tr><td>non-short circuiting exclusive OR</td><td><code class="literal">^</code></td><td> </td></tr><tr><td>non-short circuiting inclusive OR</td><td><code class="literal">|</code></td><td> </td></tr><tr><td>logical AND</td><td><code class="literal">&amp;&amp;</code></td><td> </td></tr><tr><td>logical OR</td><td><code class="literal">||</code></td><td> </td></tr><tr><td>ternary</td><td><code class="literal">? :</code></td><td> </td></tr><tr><td>Comma separated AND</td><td><code class="literal">,</code></td><td>Not normal Java semantics</td></tr></tbody></table></div></div><br class="table-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e4921"/>5.8.3.4. Positional Arguments</h4></div></div></div><p>Patterns now support positional arguments on type
      declarations.</p><p>Positional arguments are ones where you don't need to specify the
      field name, as the position maps to a known named field. i.e. Person(
      name == "mark" ) can be rewritten as Person( "mark"; ). The semicolon
      ';' is important so that the engine knows that everything before it is a
      positional argument. Otherwise we might assume it was a boolean
      expression, which is how it could be interpretted after the semicolon.
      You can mix positional and named arguments on a pattern by using the
      semicolon ';' to separate them. Any variables used in a positional that
      have not yet been bound will be bound to the field that maps to that
      position.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">declare Cheese
    name : String
    shop : String
    price : int
end
</pre><p>Example patterns, with two constraints and a binding. Remember
      semicolon ';' is used to differentiate the positional section from the
      named argument section. Variables and literals and expressions using
      just literals are supported in posional arguments, but not variables.
      Positional arguments are always resolved using unification.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cheese( "stilton", "Cheese Shop", p; )
Cheese( "stilton", "Cheese Shop"; p : price )
Cheese( "stilton"; shop == "Cheese Shop", p : price )
Cheese( name == "stilton"; shop == "Cheese Shop", p : price )
</pre><p>Positional arguments that are given a previously declared binding
      will consrain against that using unification; these are referred to as
      input arguments. If the binding does not yet exist, it will create the
      declaration binding it to the field represented by the position
      argument; these are referred to as output arguments.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e4936"/>5.8.3.5. Basic conditional elements</h4></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4939"/>5.8.3.5.1. Conditional Element <code class="literal">and</code></h5></div></div></div><p>The Conditional Element <code class="literal">"and"</code> is used to
        group other Conditional Elements into a logical conjunction. Drools
        supports both prefix <code class="literal">and</code> and infix
        <code class="literal">and</code>.</p><div class="figure"><a id="d0e4955"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/infixAnd.png" align="middle" alt="infixAnd"/></div></div><p class="title"><b>Figure 5.19. infixAnd</b></p></div><br class="figure-break"/><p>Traditional infix <code class="literal">and</code> is supported:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">//infixAnd
Cheese( cheeseType : type ) and Person( favouriteCheese == cheeseType )</pre><p>Explicit grouping with parentheses is also supported:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">//infixAnd with grouping
( Cheese( cheeseType : type ) and
  ( Person( favouriteCheese == cheeseType ) or 
    Person( favouriteCheese == cheeseType ) )</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The symbol <code class="literal">&amp;&amp;</code> (as an alternative to
          <code class="literal">and</code>) is deprecated. But it is still supported in
          the syntax for backwards compatibility.</p></div><div class="figure"><a id="d0e4981"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/prefixAnd.png" align="middle" alt="prefixAnd"/></div></div><p class="title"><b>Figure 5.20. prefixAnd</b></p></div><br class="figure-break"/><p>Prefix <code class="literal">and</code> is also supported:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">(and Cheese( cheeseType : type )
     Person( favouriteCheese == cheeseType ) )</pre><p>The root element of the LHS is an implicit prefix
        <code class="literal">and</code> and doesn't need to be specified:</p><div class="example"><a id="d0e4999"/><p class="title"><b>Example 5.46. implicit root prefixAnd</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">when
    Cheese( cheeseType : type )
    Person( favouriteCheese == cheeseType )
then
    ...</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e5004"/>5.8.3.5.2. Conditional Element <code class="literal">or</code></h5></div></div></div><p>The Conditional Element <code class="literal">or</code> is used to group
        other Conditional Elements into a logical disjunction. Drools supports
        both prefix <code class="literal">or</code> and infix
        <code class="literal">or</code>.</p><div class="figure"><a id="d0e5020"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/infixOr.png" align="middle" alt="infixOr"/></div></div><p class="title"><b>Figure 5.21. infixOr</b></p></div><br class="figure-break"/><p>Traditional infix <code class="literal">or</code> is supported:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">//infixOr
Cheese( cheeseType : type ) or Person( favouriteCheese == cheeseType )</pre><p>Explicit grouping with parentheses is also supported:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">//infixOr with grouping
( Cheese( cheeseType : type ) or
  ( Person( favouriteCheese == cheeseType ) and
    Person( favouriteCheese == cheeseType ) )</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The symbol <code class="literal">||</code> (as an alternative to
          <code class="literal">or</code>) is deprecated. But it is still supported in
          the syntax for backwards compatibility.</p></div><div class="figure"><a id="d0e5046"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/prefixOr.png" align="middle" alt="prefixOr"/></div></div><p class="title"><b>Figure 5.22. prefixOr</b></p></div><br class="figure-break"/><p>Prefix <code class="literal">or</code> is also supported:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">(or Person( sex == "f", age &gt; 60 )
    Person( sex == "m", age &gt; 65 )</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The behavior of the Conditional Element <code class="literal">or</code>
          is different from the connective <code class="literal">||</code> for
          constraints and restrictions in field constraints. The engine
          actually has no understanding of the Conditional Element
          <code class="literal">or</code>. Instead, via a number of different logic
          transformations, a rule with <code class="literal">or</code> is rewritten as a
          number of subrules. This process ultimately results in a rule that
          has a single <code class="literal">or</code> as the root node and one subrule
          for each of its CEs. Each subrule can activate and fire like any
          normal rule; there is no special behavior or interaction between
          these subrules. - This can be most confusing to new rule
          authors.</p></div><p>The Conditional Element <code class="literal">or</code> also allows for
        optional pattern binding. This means that each resulting subrule will
        bind its pattern to the pattern binding. Each pattern must be bound
        separately, using eponymous variables:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">pensioner : ( Person( sex == "f", age &gt; 60 ) or Person( sex == "m", age &gt; 65 ) )</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">(or pensioner : Person( sex == "f", age &gt; 60 ) 
    pensioner : Person( sex == "m", age &gt; 65 ) )</pre><p>Since the conditional element <code class="literal">or</code> results in
        multiple subrule generation, one for each possible logically outcome,
        the example above would result in the internal generation of two
        rules. These two rules work independently within the Working Memory,
        which means both can match, activate and fire - there is no
        shortcutting.</p><p>The best way to think of the conditional element
        <code class="literal">or</code> is as a shortcut for generating two or more
        similar rules. When you think of it that way, it's clear that for a
        single rule there could be multiple activations if two or more terms
        of the disjunction are true.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e5096"/>5.8.3.5.3. Conditional Element <code class="literal">not</code></h5></div></div></div><div class="figure"><a id="d0e5101"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/not.png" align="middle" alt="not"/></div></div><p class="title"><b>Figure 5.23. not</b></p></div><br class="figure-break"/><p>The CE <code class="literal">not</code> is first order logic's
        non-existential quantifier and checks for the non-existence of
        something in the Working Memory. Think of "not" as meaning "there must
        be none of...".</p><p>The keyword <code class="literal">not</code> may be followed by
        parentheses around the CEs that it applies to. In the simplest case of
        a single pattern (like below) you may optionally omit the
        parentheses.</p><div class="example"><a id="d0e5117"/><p class="title"><b>Example 5.47. No Busses</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">not Bus()</pre></div></div><br class="example-break"/><div class="example"><a id="d0e5122"/><p class="title"><b>Example 5.48. No red Busses</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Brackets are optional:
not Bus(color == "red")
// Brackets are optional:
not ( Bus(color == "red", number == 42) )
// "not" with nested infix <code xmlns="http://www.w3.org/1999/xhtml" class="literal">and</code> - two patterns,
// brackets are requires:
not ( Bus(color == "red") and
      Bus(color == "blue") )</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e5130"/>5.8.3.5.4. Conditional Element <code class="literal">exists</code></h5></div></div></div><div class="figure"><a id="d0e5135"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/exists.png" align="middle" alt="exists"/></div></div><p class="title"><b>Figure 5.24. exists</b></p></div><br class="figure-break"/><p>The CE <code class="literal">exists</code> is first order logic's
        existential quantifier and checks for the existence of something in
        the Working Memory. Think of "exists" as meaning "there is at least
        one..". It is different from just having the pattern on its own, which
        is more like saying "for each one of...". If you use
        <code class="literal">exists</code> with a pattern, the rule will only activate
        at most once, regardless of how much data there is in working memory
        that matches the condition inside of the <code class="literal">exists</code>
        pattern. Since only the existence matters, no bindings will be
        established.</p><p>The keyword <code class="literal">exists</code> must be followed by
        parentheses around the CEs that it applies to. In the simplest case of
        a single pattern (like below) you may omit the parentheses.</p><div class="example"><a id="d0e5157"/><p class="title"><b>Example 5.49. At least one Bus</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">exists Bus()</pre></div></div><br class="example-break"/><div class="example"><a id="d0e5162"/><p class="title"><b>Example 5.50. At least one red Bus</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">exists Bus(color == "red")
// brackets are optional:
exists ( Bus(color == "red", number == 42) )
// "exists" with nested infix <code xmlns="http://www.w3.org/1999/xhtml" class="literal">and</code>,
// brackets are required:
exists ( Bus(color == "red") and
         Bus(color == "blue") )</pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5170"/>5.8.3.6. Advanced conditional elements</h4></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e5173"/>5.8.3.6.1. Conditional Element <code class="literal">forall</code></h5></div></div></div><div class="figure"><a id="d0e5178"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/forall.png" align="middle" alt="forall"/></div></div><p class="title"><b>Figure 5.25. forall</b></p></div><br class="figure-break"/><p>The Conditional Element <code class="literal">forall</code> completes the
        First Order Logic support in Drools. The Conditional Element
        <code class="literal">forall</code> evaluates to true when all facts that match
        the first pattern match all the remaining patterns. Example:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "All English buses are red"
when
    forall( $bus : Bus( type == 'english') 
                   Bus( this == $bus, color = 'red' ) )
then
    # all english buses are red
end</pre><p>In the above rule, we "select" all Bus objects whose type is
        "english". Then, for each fact that matches this pattern we evaluate
        the following patterns and if they match, the forall CE will evaluate
        to true.</p><p>To state that all facts of a given type in the working memory
        must match a set of constraints, <code class="literal">forall</code> can be
        written with a single pattern for simplicity. Example:</p><div class="example"><a id="d0e5201"/><p class="title"><b>Example 5.51. Single Pattern Forall</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "All Buses are Red"
when
    forall( Bus( color == 'red' ) )
then
    # all asserted Bus facts are red
end</pre></div></div><br class="example-break"/><p>Another example shows multiple patterns inside the
        <code class="literal">forall</code>:</p><div class="example"><a id="d0e5211"/><p class="title"><b>Example 5.52. Multi-Pattern Forall</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "all employees have health and dental care programs"
when
    forall( $emp : Employee()
            HealthCare( employee == $emp )
            DentalCare( employee == $emp )
          )
then
    # all employees have health and dental care
end</pre></div></div><br class="example-break"/><p>Forall can be nested inside other CEs. For instance,
        <code class="literal">forall</code> can be used inside a <code class="literal">not</code>
        CE. Note that only single patterns have optional parentheses, so that
        with a nested <code class="literal">forall</code> parentheses must be
        used:</p><div class="example"><a id="d0e5227"/><p class="title"><b>Example 5.53. Combining Forall with Not CE</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "not all employees have health and dental care"
when 
    not ( forall( $emp : Employee()
                  HealthCare( employee == $emp )
                  DentalCare( employee == $emp ) ) 
        )
then
    # not all employees have health and dental care
end</pre></div></div><br class="example-break"/><p>As a side note, <code class="code">forall( p1 p2 p3...)</code> is equivalent
        to writing:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">not(p1 and not(and p2 p3...))</pre><p>Also, it is important to note that <code class="literal">forall</code> is
        a <span class="emphasis"><em>scope delimiter</em></span>. Therefore, it can use any
        previously bound variable, but no variable bound inside it will be
        available for use outside of it.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e5247"/>5.8.3.6.2. Conditional Element <code class="literal">from</code></h5></div></div></div><div class="figure"><a id="d0e5252"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/from.png" align="middle" alt="from"/></div></div><p class="title"><b>Figure 5.26. from</b></p></div><br class="figure-break"/><p>The Conditional Element <code class="literal">from</code> enables users to
        specify an arbitrary source for data to be matched by LHS patterns.
        This allows the engine to reason over data not in the Working Memory.
        The data source could be a sub-field on a bound variable or the
        results of a method call. It is a powerful construction that allows
        out of the box integration with other application components and
        frameworks. One common example is the integration with data retrieved
        on-demand from databases using hibernate named queries.</p><p>The expression used to define the object source is any
        expression that follows regular MVEL syntax. Therefore, it allows you
        to easily use object property navigation, execute method calls and
        access maps and collections elements.</p><p>Here is a simple example of reasoning and binding on another
        pattern sub-field:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "validate zipcode"
when
    Person( $personAddress : address ) 
    Address( zipcode == "23920W") from $personAddress 
then
    # zip code is ok
end</pre><p>With all the flexibility from the new expressiveness in the
        Drools engine you can slice and dice this problem many ways. This is
        the same but shows how you can use a graph notation with the
        'from':</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "validate zipcode"
when
    $p : Person( ) 
    $a : Address( zipcode == "23920W") from $p.address 
then
    # zip code is ok
end</pre><p>Previous examples were evaluations using a single pattern. The
        CE <code class="literal">from</code> also support object sources that return a
        collection of objects. In that case, <code class="literal">from</code> will
        iterate over all objects in the collection and try to match each of
        them individually. For instance, if we want a rule that applies 10%
        discount to each item in an order, we could do:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "apply 10% discount to all items over US$ 100,00 in an order"
when
    $order : Order()
    $item  : OrderItem( value &gt; 100 ) from $order.items
then
    # apply discount to $item
end</pre><p>The above example will cause the rule to fire once for each item
        whose value is greater than 100 for each given order.</p><p>You must take caution, however, when using
        <code class="literal">from</code>, especially in conjunction with the
        <code class="literal">lock-on-active</code> rule attribute as it may produce
        unexpected results. Consider the example provided earlier, but now
        slightly modified as follows:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Assign people in North Carolina (NC) to sales region 1"
ruleflow-group "test"
lock-on-active true
when
    $p : Person( ) 
    $a : Address( state == "NC") from $p.address 
then
    modify ($p) {} #Assign person to sales region 1 in a modify block
end

rule "Apply a discount to people in the city of Raleigh"
ruleflow-group "test"
lock-on-active true
when
    $p : Person( ) 
    $a : Address( city == "Raleigh") from $p.address 
then
    modify ($p) {} #Apply discount to person in a modify block
end</pre><p>In the above example, persons in Raleigh, NC should be assigned
        to sales region 1 and receive a discount; i.e., you would expect both
        rules to activate and fire. Instead you will find that only the second
        rule fires.</p><p>If you were to turn on the audit log, you would also see that
        when the second rule fires, it deactivates the first rule. Since the
        rule attribute <code class="literal">lock-on-active</code> prevents a rule from
        creating new activations when a set of facts change, the first rule
        fails to reactivate. Though the set of facts have not changed, the use
        of <code class="literal">from</code> returns a new fact for all intents and
        purposes each time it is evaluated.</p><p>First, it's important to review why you would use the above
        pattern. You may have many rules across different rule-flow groups.
        When rules modify working memory and other rules downstream of your
        RuleFlow (in different rule-flow groups) need to be reevaluated, the
        use of <code class="literal">modify</code> is critical. You don't, however, want
        other rules in the same rule-flow group to place activations on one
        another recursively. In this case, the <code class="literal">no-loop</code>
        attribute is ineffective, as it would only prevent a rule from
        activating itself recursively. Hence, you resort to
        <code class="literal">lock-on-active</code>.</p><p>There are several ways to address this issue:</p><div class="itemizedlist"><ul><li><p>Avoid the use of <code class="literal">from</code> when you can assert
            all facts into working memory or use nested object references in
            your constraint expressions (shown below).</p></li><li><p>Place the variable assigned used in the modify block as the
            last sentence in your condition (LHS).</p></li><li><p>Avoid the use of <code class="literal">lock-on-active</code> when you
            can explicitly manage how rules within the same rule-flow group
            place activations on one another (explained below).</p></li></ul></div><p>The preferred solution is to minimize use of
        <code class="literal">from</code> when you can assert all your facts into
        working memory directly. In the example above, both the Person and
        Address instance can be asserted into working memory. In this case,
        because the graph is fairly simple, an even easier solution is to
        modify your rules as follows:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Assign people in North Carolina (NC) to sales region 1"
ruleflow-group "test"
lock-on-active true
when
    $p : Person(address.state == "NC" )  
then
    modify ($p) {} #Assign person to sales region 1 in a modify block
end

rule "Apply a discount to people in the city of Raleigh"
ruleflow-group "test"
lock-on-active true
when
    $p : Person(address.city == "Raleigh" )  
then
    modify ($p) {} #Apply discount to person in a modify block
end</pre><p>Now, you will find that both rules fire as expected. However, it
        is not always possible to access nested facts as above. Consider an
        example where a Person holds one or more Addresses and you wish to use
        an existential quantifier to match people with at least one address
        that meets certain conditions. In this case, you would have to resort
        to the use of <code class="literal">from</code> to reason over the
        collection.</p><p>There are several ways to use <code class="literal">from</code> to achieve
        this and not all of them exhibit an issue with the use of
        <code class="literal">lock-on-active</code>. For example, the following use of
        <code class="literal">from</code> causes both rules to fire as expected:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Assign people in North Carolina (NC) to sales region 1"
ruleflow-group "test"
lock-on-active true
when
    $p : Person($addresses : addresses)
    exists (Address(state == "NC") from $addresses)  
then
    modify ($p) {} #Assign person to sales region 1 in a modify block
end

rule "Apply a discount to people in the city of Raleigh"
ruleflow-group "test"
lock-on-active true
when
    $p : Person($addresses : addresses)
    exists (Address(city == "Raleigh") from $addresses)  
then
    modify ($p) {} #Apply discount to person in a modify block
end</pre><p>However, the following slightly different approach does exhibit
        the problem:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Assign people in North Carolina (NC) to sales region 1"
ruleflow-group "test"
lock-on-active true
when
    $assessment : Assessment()
    $p : Person()
    $addresses : List() from $p.addresses
    exists (Address( state == "NC") from $addresses) 
then
    modify ($assessment) {} #Modify assessment in a modify block
end

rule "Apply a discount to people in the city of Raleigh"
ruleflow-group "test"
lock-on-active true
when
    $assessment : Assessment()
    $p : Person()
    $addresses : List() from $p.addresses 
    exists (Address( city == "Raleigh") from $addresses)
then
    modify ($assessment) {} #Modify assessment in a modify block
end</pre><p>In the above example, the $addresses variable is returned from
        the use of <code class="literal">from</code>. The example also introduces a new
        object, assessment, to highlight one possible solution in this case.
        If the $assessment variable assigned in the condition (LHS) is moved
        to the last condition in each rule, both rules fire as
        expected.</p><p>Though the above examples demonstrate how to combine the use of
        <code class="literal">from</code> with <code class="literal">lock-on-active</code> where
        no loss of rule activations occurs, they carry the drawback of placing
        a dependency on the order of conditions on the LHS. In addition, the
        solutions present greater complexity for the rule author in terms of
        keeping track of which conditions may create issues.</p><p>A better alternative is to assert more facts into working
        memory. In this case, a person's addresses may be asserted into
        working memory and the use of <code class="literal">from</code> would not be
        necessary.</p><p>There are cases, however, where asserting all data into working
        memory is not practical and we need to find other solutions. Another
        option is to reevaluate the need for
        <code class="literal">lock-on-active</code>. An alternative to
        <code class="literal">lock-on-active</code> is to directly manage how rules
        within the same rule-flow group activate one another by including
        conditions in each rule that prevent rules from activating each other
        recursively when working memory is modified. For example, in the case
        above where a discount is applied to citizens of Raleigh, a condition
        may be added to the rule that checks whether the discount has already
        been applied. If so, the rule does not activate.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e5389"/>5.8.3.6.3. Conditional Element <code class="literal">collect</code></h5></div></div></div><div class="figure"><a id="d0e5394"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/collect.png" align="middle" alt="collect"/></div></div><p class="title"><b>Figure 5.27. collect</b></p></div><br class="figure-break"/><p>The Conditional Element <code class="literal">collect</code> allows rules
        to reason over a collection of objects obtained from the given source
        or from the working memory. In First Oder Logic terms this is the
        cardinality quantifier. A simple example:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">import java.util.ArrayList

rule "Raise priority if system has more than 3 pending alarms"
when
    $system : System()
    $alarms : ArrayList( size &gt;= 3 )
              from collect( Alarm( system == $system, status == 'pending' ) )
then
    # Raise priority, because system $system has
    # 3 or more alarms pending. The pending alarms
    # are $alarms.
end</pre><p>In the above example, the rule will look for all pending alarms
        in the working memory for each given system and group them in
        ArrayLists. If 3 or more alarms are found for a given system, the rule
        will fire.</p><p>The result pattern of <code class="literal">collect</code> can be any
        concrete class that implements the <code class="code">java.util.Collection</code>
        interface and provides a default no-arg public constructor. This means
        that you can use Java collections like ArrayList, LinkedList, HashSet,
        etc., or your own class, as long as it implements the
        <code class="code">java.util.Collection</code> interface and provide a default
        no-arg public constructor.</p><p>Both source and result patterns can be constrained as any other
        pattern.</p><p>Variables bound before the <code class="literal">collect</code> CE are in
        the scope of both source and result patterns and therefore you can use
        them to constrain both your source and result patterns. But note that
        <code class="literal">collect</code> is a scope delimiter for bindings, so that
        any binding made inside of it is not available for use outside of
        it.</p><p>Collect accepts nested <code class="literal">from</code> CEs. The
        following example is a valid use of "collect":</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">import java.util.LinkedList;

rule "Send a message to all mothers"
when
    $town : Town( name == 'Paris' )
    $mothers : LinkedList() 
               from collect( Person( gender == 'F', children &gt; 0 ) 
                             from $town.getPeople() 
                           )
then
    # send a message to all mothers
end</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e5437"/>5.8.3.6.4. Conditional Element <code class="literal">accumulate</code></h5></div></div></div><div class="figure"><a id="d0e5442"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/accumulate.png" align="middle" alt="accumulate"/></div></div><p class="title"><b>Figure 5.28. accumulate</b></p></div><br class="figure-break"/><p>The Conditional Element <code class="literal">accumulate</code> is a more
        flexible and powerful form of <code class="literal">collect</code>, in the sense
        that it can be used to do what <code class="literal">collect</code> does and
        also achieve results that the CE <code class="literal">collect</code> is not
        capable of doing. Basically, what it does is that it allows a rule to
        iterate over a collection of objects, executing custom actions for
        each of the elements, and at the end it returns a result
        object.</p><p>Accumulate supports both the use of pre-defined accumulate
        functions, or the use of inline custom code. Inline custom code should
        be avoided though, as it is extremely hard to maintain, and frequently
        leads to code duplication. Accumulate functions are easier to test and
        reuse.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e5464"/>5.8.3.6.4.1. Accumulate Functions</h6></div></div></div><p>The accumulate CE is a very powerful CE, but it gets real
          declarative and easy to use when using predefined functions that are
          known as Accumulate Functions. They work exactly like accumulate,
          but instead of explicitly writing custom code in every accumulate
          CE, the user can use predefined code for common operations.</p><p>For instance, a rule to apply a 10% discount on orders over
          $100 could be written in the following way, using Accumulate
          Functions:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Apply 10% discount to orders over US$ 100,00"
when
    $order : Order()
    $total : Number( doubleValue &gt; 100 ) 
             from accumulate( OrderItem( order == $order, $value : value ),
                              sum( $value ) )
then
    # apply discount to $order
end</pre><p>In the above example, sum is an Accumulate Function and will
          sum the $value of all OrderItems and return the result.</p><p>Drools ships with the following built-in accumulate
          functions:</p><div class="itemizedlist"><ul><li><p>average</p></li><li><p>min</p></li><li><p>max</p></li><li><p>count</p></li><li><p>sum</p></li><li><p>collectList</p></li><li><p>collectSet</p></li></ul></div><p>These common functions accept any expression as input. For
          instance, if someone wants to calculate the average profit on all
          items of an order, a rule could be written using the average
          function:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Average profit"
when
    $order : Order()
    $profit : Number() 
              from accumulate( OrderItem( order == $order, $cost : cost, $price : price )
                               average( 1 - $cost / $price ) )
then
    # average profit for $order is $profit
end</pre><p>Accumulate Functions are all pluggable. That means that if
          needed, custom, domain specific functions can easily be added to the
          engine and rules can start to use them without any restrictions. To
          implement a new Accumulate Functions all one needs to do is to
          create a Java class that implements the
          <code class="code">org.drools.runtime.rule.TypedAccumulateFunction</code>
          interface and add a line to the configuration file or set a system
          property to let the engine know about the new function. As an
          example of an Accumulate Function implementation, the following is
          the implementation of the <code class="literal">average</code>
          function:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;*&nbsp;An&nbsp;implementation&nbsp;of&nbsp;an&nbsp;accumulator&nbsp;capable&nbsp;of&nbsp;calculating&nbsp;average&nbsp;values</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;*/</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">AverageAccumulateFunction</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">AccumulateFunction</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;readExternal</span><span class="java_separator">(</span><span class="java_type">ObjectInput</span><span class="java_plain">&nbsp;in</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">IOException</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ClassNotFoundException</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;writeExternal</span><span class="java_separator">(</span><span class="java_type">ObjectOutput</span><span class="java_plain">&nbsp;out</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">IOException</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">AverageData</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Externalizable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;total&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">AverageData</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;readExternal</span><span class="java_separator">(</span><span class="java_type">ObjectInput</span><span class="java_plain">&nbsp;in</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">IOException</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ClassNotFoundException</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;in</span><span class="java_separator">.</span><span class="java_plain">readInt</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;in</span><span class="java_separator">.</span><span class="java_plain">readDouble</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;writeExternal</span><span class="java_separator">(</span><span class="java_type">ObjectOutput</span><span class="java_plain">&nbsp;out</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">IOException</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out</span><span class="java_separator">.</span><span class="java_plain">writeInt</span><span class="java_separator">(</span><span class="java_plain">count</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out</span><span class="java_separator">.</span><span class="java_plain">writeDouble</span><span class="java_separator">(</span><span class="java_plain">total</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_comment">/*</span><span class="java_plain">&nbsp;(non-Javadoc)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;org.drools.base.accumulators.AccumulateFunction#createContext()</span>
<!--  --><br/><span class="java_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;createContext</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AverageData</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_comment">/*</span><span class="java_plain">&nbsp;(non-Javadoc)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;org.drools.base.accumulators.AccumulateFunction#init(java.lang.Object)</span>
<!--  --><br/><span class="java_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;init</span><span class="java_separator">(</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;context</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">AverageData</span><span class="java_plain">&nbsp;data&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">AverageData</span><span class="java_separator">)</span><span class="java_plain">&nbsp;context</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span><span class="java_separator">.</span><span class="java_plain">count&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span><span class="java_separator">.</span><span class="java_plain">total&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_comment">/*</span><span class="java_plain">&nbsp;(non-Javadoc)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;org.drools.base.accumulators.AccumulateFunction#accumulate(java.lang.Object,&nbsp;java.lang.Object)</span>
<!--  --><br/><span class="java_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;accumulate</span><span class="java_separator">(</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;context</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_plain">&nbsp;value</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">AverageData</span><span class="java_plain">&nbsp;data&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">AverageData</span><span class="java_separator">)</span><span class="java_plain">&nbsp;context</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span><span class="java_separator">.</span><span class="java_plain">count</span><span class="java_operator">++</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span><span class="java_separator">.</span><span class="java_plain">total&nbsp;</span><span class="java_operator">+=</span><span class="java_plain">&nbsp;</span><span class="java_separator">((</span><span class="java_type">Number</span><span class="java_separator">)</span><span class="java_plain">&nbsp;value</span><span class="java_separator">).</span><span class="java_plain">doubleValue</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_comment">/*</span><span class="java_plain">&nbsp;(non-Javadoc)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;org.drools.base.accumulators.AccumulateFunction#reverse(java.lang.Object,&nbsp;java.lang.Object)</span>
<!--  --><br/><span class="java_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;reverse</span><span class="java_separator">(</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;context</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_plain">&nbsp;value</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">AverageData</span><span class="java_plain">&nbsp;data&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">AverageData</span><span class="java_separator">)</span><span class="java_plain">&nbsp;context</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span><span class="java_separator">.</span><span class="java_plain">count</span><span class="java_operator">--</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span><span class="java_separator">.</span><span class="java_plain">total&nbsp;</span><span class="java_operator">-=</span><span class="java_plain">&nbsp;</span><span class="java_separator">((</span><span class="java_type">Number</span><span class="java_separator">)</span><span class="java_plain">&nbsp;value</span><span class="java_separator">).</span><span class="java_plain">doubleValue</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_comment">/*</span><span class="java_plain">&nbsp;(non-Javadoc)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;org.drools.base.accumulators.AccumulateFunction#getResult(java.lang.Object)</span>
<!--  --><br/><span class="java_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_plain">&nbsp;getResult</span><span class="java_separator">(</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;context</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">AverageData</span><span class="java_plain">&nbsp;data&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">AverageData</span><span class="java_separator">)</span><span class="java_plain">&nbsp;context</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Double</span><span class="java_separator">(</span><span class="java_plain">&nbsp;data</span><span class="java_separator">.</span><span class="java_plain">count&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_plain">&nbsp;</span><span class="java_operator">?</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">&nbsp;data</span><span class="java_separator">.</span><span class="java_plain">total&nbsp;</span><span class="java_operator">/</span><span class="java_plain">&nbsp;data</span><span class="java_separator">.</span><span class="java_plain">count&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_comment">/*</span><span class="java_plain">&nbsp;(non-Javadoc)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;org.drools.base.accumulators.AccumulateFunction#supportsReverse()</span>
<!--  --><br/><span class="java_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;supportsReverse</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{</span><span class="java_javadoc_tag">@inheritDoc</span><span class="java_javadoc_comment">}</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Class</span><span class="java_operator">&lt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">?</span><span class="java_plain">&nbsp;</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;getResultType</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_type">Number</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">}</span>
</pre><p>The code for the function is very simple, as we could expect,
          as all the "dirty" integration work is done by the engine. Finally,
          to plug the function into the engine, we added it to the
          configuration file:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">drools.accumulate.function.average =
   org.drools.base.accumulators.AverageAccumulateFunction</pre><p>Here, "drools.accumulate.function." is a prefix that must
          always be used, "average" is how the function will be used in the
          rule file, and
          "org.drools.base.accumulators.AverageAccumulateFunction" is the
          fully qualified name of the class that implements the function
          behavior.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e5519"/>5.8.3.6.4.2. Accumulate with inline custom code</h6></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>The use of accumulate with inline custom code is not a good
            practice for several reasons, including dificulties on maintaining
            and testing rules that use them, as well as the inability of
            reusing that code. Implementing your own accumulate functions is
            very simple and straightforward, they are easy to unit test and to
            use. This form of accumulate is supported for backward
            compatibility only.</p></div><p>The general syntax of the <code class="literal">accumulate</code> CE
          with inline custom code is:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>&lt;result pattern&gt;</code></em> <code xmlns="http://www.w3.org/1999/xhtml" class="literal">from accumulate(</code> <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>&lt;source pattern&gt;</code></em><code xmlns="http://www.w3.org/1999/xhtml" class="literal">,</code>
                                  <code xmlns="http://www.w3.org/1999/xhtml" class="literal">init(</code> <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>&lt;init code&gt;</code></em> <code xmlns="http://www.w3.org/1999/xhtml" class="literal">),</code>
                                  <code xmlns="http://www.w3.org/1999/xhtml" class="literal">action(</code> <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>&lt;action code&gt;</code></em> <code xmlns="http://www.w3.org/1999/xhtml" class="literal">),</code>
                                  <code xmlns="http://www.w3.org/1999/xhtml" class="literal">reverse(</code> <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>&lt;reverse code&gt;</code></em> <code xmlns="http://www.w3.org/1999/xhtml" class="literal">),</code>
                                  <code xmlns="http://www.w3.org/1999/xhtml" class="literal">result(</code> <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>&lt;result expression&gt;</code></em> <code xmlns="http://www.w3.org/1999/xhtml" class="literal">) )</code>
</pre><p>The meaning of each of the elements is the following:</p><div class="itemizedlist"><ul><li><p><span class="emphasis"><em>&lt;source pattern&gt;</em></span>: the source
              pattern is a regular pattern that the engine will try to match
              against each of the source objects.</p></li><li><p><span class="emphasis"><em>&lt;init code&gt;</em></span>: this is a semantic
              block of code in the selected dialect that will be executed once
              for each tuple, before iterating over the source objects.</p></li><li><p><span class="emphasis"><em>&lt;action code&gt;</em></span>: this is a
              semantic block of code in the selected dialect that will be
              executed for each of the source objects.</p></li><li><p><span class="emphasis"><em>&lt;reverse code&gt;</em></span>: this is an
              optional semantic block of code in the selected dialect that if
              present will be executed for each source object that no longer
              matches the source pattern. The objective of this code block is
              to undo any calculation done in the <span class="emphasis"><em>&lt;action
              code&gt;</em></span> block, so that the engine can do decremental
              calculation when a source object is modified or retracted,
              hugely improving performance of these operations.</p></li><li><p><span class="emphasis"><em>&lt;result expression&gt;</em></span>: this is a
              semantic expression in the selected dialect that is executed
              after all source objects are iterated.</p></li><li><p><span class="emphasis"><em>&lt;result pattern&gt;</em></span>: this is a
              regular pattern that the engine tries to match against the
              object returned from the <span class="emphasis"><em>&lt;result
              expression&gt;</em></span>. If it matches, the
              <code class="literal">accumulate</code> conditional element evaluates to
              <span class="emphasis"><em>true</em></span> and the engine proceeds with the
              evaluation of the next CE in the rule. If it does not matches,
              the <code class="literal">accumulate</code> CE evaluates to
              <span class="emphasis"><em>false</em></span> and the engine stops evaluating CEs
              for that rule.</p></li></ul></div><p>It is easier to understand if we look at an example:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Apply 10% discount to orders over US$ 100,00"
when
    $order : Order()
    $total : Number( doubleValue &gt; 100 ) 
             from accumulate( OrderItem( order == $order, $value : value ),
                              init( double total = 0; ),
                              action( total += $value; ),
                              reverse( total -= $value; ),
                              result( total ) )
then
    # apply discount to $order
end</pre><p>In the above example, for each <code class="code">Order</code> in the
          Working Memory, the engine will execute the <span class="emphasis"><em>init
          code</em></span> initializing the total variable to zero. Then it
          will iterate over all <code class="code">OrderItem</code> objects for that order,
          executing the <span class="emphasis"><em>action</em></span> for each one (in the
          example, it will sum the value of all items into the total
          variable). After iterating over all <code class="code">OrderItem</code> objects,
          it will return the value corresponding to the <span class="emphasis"><em>result
          expression</em></span> (in the above example, the value of variable
          <code class="code">total</code>). Finally, the engine will try to match the
          result with the <code class="code">Number</code> pattern, and if the double value
          is greater than 100, the rule will fire.</p><p>The example used Java as the semantic dialect, and as such,
          note that the usage of the semicolon as statement delimiter is
          mandatory in the init, action and reverse code blocks. The result is
          an expression and, as such, it does not admit ';'. If the user uses
          any other dialect, he must comply to that dialect's specific
          syntax.</p><p>As mentioned before, the <span class="emphasis"><em>reverse code</em></span> is
          optional, but it is strongly recommended that the user writes it in
          order to benefit from the <span class="emphasis"><em>improved performance on update
          and retract</em></span>.</p><p>The <code class="literal">accumulate</code> CE can be used to execute
          any action on source objects. The following example instantiates and
          populates a custom object:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Accumulate using custom objects"
when
    $person   : Person( $likes : likes )
    $cheesery : Cheesery( totalAmount &gt; 100 )
                from accumulate( $cheese : Cheese( type == $likes ),
                                 init( Cheesery cheesery = new Cheesery(); ),
                                 action( cheesery.addCheese( $cheese ); ),
                                 reverse( cheesery.removeCheese( $cheese ); ),
                                 result( cheesery ) );
then
    // do something
end</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e5676"/>5.8.3.6.4.3. Multi-function Accumulates</h6></div></div></div><p>The accumulate CE now supports multiple functions. For
          instance, if one needs to find the minimum, maximum and average
          value for the same set of data, instead of having to repeat the
          accumulate statement 3 times, a single accumulate can be
          used.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Max, min and average" 
    when
        accumulate( Cheese( $price : price ),
                    $max : max( $price ),
                    $min : min( $price ),
                    $avg : average( $price ) )
    then
        // do something
end </pre></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5683"/>5.8.3.7. Conditional Element <code class="literal">eval</code></h4></div></div></div><div class="figure"><a id="d0e5688"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/eval.png" align="middle" alt="eval"/></div></div><p class="title"><b>Figure 5.29. eval</b></p></div><br class="figure-break"/><p>The conditional element <code class="literal">eval</code> is essentially a
      catch-all which allows any semantic code (that returns a primitive
      boolean) to be executed. This code can refer to variables that were
      bound in the LHS of the rule, and functions in the rule package. Overuse
      of eval reduces the declarativeness of your rules and can result in a
      poorly performing engine. While <code class="literal">eval</code> can be used
      anywhere in the patterns, the best practice is to add it as the last
      conditional element in the LHS of a rule.</p><p>Evals cannot be indexed and thus are not as efficient as Field
      Constraints. However this makes them ideal for being used when functions
      return values that change over time, which is not allowed within Field
      Constraints.</p><p>For folks who are familiar with Drools 2.x lineage, the old Drools
      parameter and condition tags are equivalent to binding a variable to an
      appropriate type, and then using it in an eval node.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">p1 : Parameter()
p2 : Parameter()
eval( p1.getList().containsKey( p2.getItem() ) )</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">p1 : Parameter()
p2 : Parameter()
// call function isValid in the LHS
eval( isValid( p1, p2 ) )</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5710"/>5.8.3.8. Railroad diagrams</h4></div></div></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/AccumulateAction.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/AccumulateClause.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/AccumulateFunction.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/AccumulateInit.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/AccumulateResult.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/AccumulateReverse.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/AccumulateSteps.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Accumulations.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/AdditiveExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Annotation.png"/></div><div class="mediaobject"><object type="image/svg+xml" data="images/Chapter-Language_Reference/Arguments.svg,"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ArrayCreatorRest.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ArrayInitializer.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/AssignmentOperator.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/BindingPattern.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Block.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/BooleanLiteral.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/CompilationUnit.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ConditionalAnd.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ConditionalElementAccumulate.png"/></div><div class="mediaobject"><object type="image/svg+xml" data="images/Chapter-Language_Reference/ConditionalElementEval.svg,"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ConditionalElementExists.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ConditionalElementForall.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ConditionalElementNot.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ConditionalElement.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ConditionalExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ConditionalOrExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ConditionalOr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Constraints.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/CreatedName.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Creator.png"/></div><div class="mediaobject"><object type="image/svg+xml" data="images/Chapter-Language_Reference/Definition.svg,"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Digit.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ExplicitGenericInvocationSuffix.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ExplicitGenericInvocation.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Exponent.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ExpressionList.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Expression.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Field.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Fraction.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/FromAccumulateClause.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/FromClause.png"/></div><div class="mediaobject"><object type="image/svg+xml" data="images/Chapter-Language_Reference/FromCollectClause.svg,"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/FunctionDefinition.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/GlobalDefinition.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/IdentifierSuffix.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ImportDefinition.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/InExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/InlineListExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/InlineMapExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/InnerCreator.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/InstanceOfExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/IntLiteral.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Literal.png"/></div><div class="mediaobject"><object type="image/svg+xml" data="images/Chapter-Language_Reference/ModifyStatement.svg,"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/NonWildcardTypeArguments.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/OrRestriction.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/OverClause.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Parameters.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Pattern.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Placeholders.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Primary.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/PrimitiveType.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/QualifiedName.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/QueryDefinition.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/QueryOptions.png"/></div><div class="mediaobject"><object type="image/svg+xml" data="images/Chapter-Language_Reference/RealLiteral.svg,"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/RealTypeSuffix.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/RelationalExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/RelationalOperator.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/RhsStatement.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/RuleAttributes.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/RuleAttribute.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/RuleDefinition.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/RuleOptions.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Selector.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ShiftExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/SingleRestriction.png"/></div><div class="mediaobject"><object type="image/svg+xml" data="images/Chapter-Language_Reference/SourcePattern.svg,"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/StringId.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/SuperSuffix.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/ThenPart.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/TypeArguments.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/TypeArgument.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/TypeDefinition.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/TypeOptions.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Type.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/UnaryExprNotPlusMinus.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/UnaryExpr.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/Value.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/VariableInitializer.png"/></div><div class="mediaobject"><img src="images/Chapter-Language_Reference/WhenPart.png"/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e5989"/>5.8.4. The Right Hand Side (then)</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5992"/>5.8.4.1. Usage</h4></div></div></div><p>The Right Hand Side (RHS) is a common name for the consequence or
      action part of the rule; this part should contain a list of actions to
      be executed. It is bad practice to use imperative or conditional code in
      the RHS of a rule; as a rule should be atomic in nature - "when this,
      then do this", not "when this, maybe do this". The RHS part of a rule
      should also be kept small, thus keeping it declarative and readable. If
      you find you need imperative and/or conditional code in the RHS, then
      maybe you should be breaking that rule down into multiple rules. The
      main purpose of the RHS is to insert, retractor modify working memory
      data. To assist with that there are a few convenience methods you can
      use to modify working memory; without having to first reference a
      working memory instance.</p><p><code class="literal">update(</code><span class="emphasis"><em>object,
      handle</em></span><code class="literal">);</code> will tell the engine that an
      object has changed (one that has been bound to something on the LHS) and
      rules may need to be reconsidered.</p><p><code class="literal">update(</code><span class="emphasis"><em>object</em></span><code class="literal">);</code>
      can also be used; here the Knowledge Helper will look up the facthandle
      for you, via an identity check, for the passed object. (Note that if you
      provide Property Change Listeners to your Java beans that you are
      inserting into the engine, you can avoid the need to call
      <code class="code">update()</code> when the object changes.)</p><p><code class="literal">insert(new</code>
      <span class="emphasis"><em>Something</em></span><code class="literal">());</code> will place a new
      object of your creation into the Working Memory.</p><p><code class="literal">insertLogical(new</code>
      <span class="emphasis"><em>Something</em></span><code class="literal">());</code> is similar to
      insert, but the object will be automatically retracted when there are no
      more facts to support the truth of the currently firing rule.</p><p><code class="literal">retract(</code><span class="emphasis"><em>handle</em></span><code class="literal">);</code>
      removes an object from Working Memory.</p><p>These convenience methods are basically macros that provide short
      cuts to the <code class="code">KnowledgeHelper</code> instance that lets you access
      your Working Memory from rules files. The predefined variable
      <code class="code">drools</code> of type <code class="code">KnowledgeHelper</code> lets you call
      several other useful methods. (Refer to the <code class="code">KnowledgeHelper</code>
      interface documentation for more advanced operations).</p><div class="itemizedlist"><ul><li><p>The call <code class="code">drools.halt()</code> terminates rule execution
          immediately. This is required for returning control to the point
          whence the current session was put to work with
          <code class="code">fireUntilHalt()</code>.</p></li><li><p>Methods <code class="code">insert(Object o)</code>, <code class="code">update(Object
          o)</code> and <code class="code">retract(Object o)</code> can be called on
          <code class="code">drools</code> as well, but due to their frequent use they can
          be called without the object reference.</p></li><li><p><code class="code">drools.getWorkingMemory()</code> returns the
          <code class="code">WorkingMemory</code> object.</p></li><li><p><code class="code">drools.setFocus( String s)</code> sets the focus to the
          specified agenda group.</p></li><li><p><code class="code">drools.getRule().getName()</code>, called from a rule's
          RHS, returns the name of the rule.</p></li><li><p><code class="code">drools.getTuple()</code> returns the Tuple that matches
          the currently executing rule, and
          <code class="code">drools.getActivation()</code> delivers the corresponding
          Activation. (These calls are useful for logging and debugging
          purposes.)</p></li></ul></div><p>The full Knowledge Runtime API is exposed through another
      predefined variable, <code class="code">kcontext</code>, of type
      <code class="code">KnowledgeContext</code>. Its method
      <code class="code">getKnowledgeRuntime()</code> delivers an object of type
      <code class="code">KnowledgeRuntime</code>, which, in turn, provides access to a
      wealth of methods, many of which are quite useful for coding RHS
      logic.</p><div class="itemizedlist"><ul><li><p>The call <code class="code">kcontext.getKnowledgeRuntime().halt()</code>
          terminates rule execution immediately.</p></li><li><p>The accessor <code class="code">getAgenda()</code> returns a reference to
          this session's <code class="code">Agenda</code>, which in turn provides access to
          the various rule groups: activation groups, agenda groups, and rule
          flow groups. A fairly common paradigm is the activation of some
          agenda group, which could be done with the lengthy call:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;give&nbsp;focus&nbsp;to&nbsp;the&nbsp;agenda&nbsp;group&nbsp;</span><!-- <br/> --><span class="java_type">CleanUp</span>
<!--  --><br/><span class="java_plain">kcontext</span><span class="java_separator">.</span><span class="java_plain">getKnowledgeRuntime</span><span class="java_separator">().</span><span class="java_plain">getAgenda</span><span class="java_separator">().</span><span class="java_plain">getAgendaGroup</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;CleanUp&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">).</span><span class="java_plain">setFocus</span><span class="java_separator">();</span></pre><p>(You can achieve the same using <code class="code">drools.setFocus(
          "CleanUp" )</code>.)</p></li><li><p>To run a query, you call <code class="code">getQueryResults(String
          query)</code>, whereupon you may process the results, as explained
          in section “<span class="quote"><a class="link" href="#">Query</a></span>”.</p></li><li><p>A set of methods dealing with event management lets you, among
          other things, add and remove event listeners for the Working Memory
          and the Agenda.</p></li><li><p>Method<code class="code">getKnowledgeBase()</code> returns the
          <code class="code">KnowledgeBase</code> object, the backbone of all the Knowledge
          in your system, and the originator of the current session.</p></li><li><p>You can manage globals with <code class="code">setGlobal(...)</code>,
          <code class="code">getGlobal(...)</code> and <code class="code">getGlobals()</code>.</p></li><li><p>Method <code class="code">getEnvironment()</code> returns the runtime's
          <code class="code">Environment</code> which works much like what you know as your
          operating system's environment.</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e6186"/>5.8.4.2. The <code class="literal">modify</code> Statement</h4></div></div></div><p>This language extension provides a structured approach to fact
      updates. It combines the update operation with a number of setter calls
      to change the object's fields. This is the syntax schema for the
      <code class="literal">modify</code> statement:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><code xmlns="http://www.w3.org/1999/xhtml" class="literal">modify ( </code><em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>&lt;fact-expression&gt;</code></em><code xmlns="http://www.w3.org/1999/xhtml" class="literal"> ) {</code>
    <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>&lt;expression&gt;</code></em> [ <code xmlns="http://www.w3.org/1999/xhtml" class="literal">,</code> <em xmlns="http://www.w3.org/1999/xhtml" class="replaceable"><code>&lt;expression&gt;</code></em> ]*
<code xmlns="http://www.w3.org/1999/xhtml" class="literal">}</code></pre><p>The parenthesized <span class="emphasis"><em>&lt;fact-expression&gt;</em></span>
      must yield a fact object reference. The expression list in the block
      should consist of setter calls for the given object, to be written
      without the usual object reference, which is automatically prepended by
      the compiler.</p><p>The example illustrates a simple fact modification.</p><div class="example"><a id="d0e6223"/><p class="title"><b>Example 5.54. A modify statement</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "modify stilton"
when
    $stilton : Cheese(type == "stilton")
then
    modify( $stilton ){
        setPrice( 20 ),
        setAge( "overripe" )
    }
end</pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6228"/>5.8.5. A Note on Auto-boxing and Primitive Types</h3></div></div></div><p>Drools attempts to preserve numbers in their primitive or object
    wrapper form, so a variable bound to an int primitive when used in a code
    block or expression will no longer need manual unboxing; unlike Drools 3.0
    where all primitives were autoboxed, requiring manual unboxing. A variable
    bound to an object wrapper will remain as an object; the existing JDK 1.5
    and JDK 5 rules to handle auto-boxing and unboxing apply in this case.
    When evaluating field constraints, the system attempts to coerce one of
    the values into a comparable format; so a primitive is comparable to an
    object wrapper.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e6233"/>5.9. Query</h2></div></div></div><div class="figure"><a id="d0e6236"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Rule_Language/query.png" align="middle" alt="query"/></div></div><p class="title"><b>Figure 5.30. query</b></p></div><br class="figure-break"/><p>A query is a simple way to search the working memory for facts that
  match the stated conditions. Therefore, it contains only the structure of
  the LHS of a rule, so that you specify neither "when" nor "then". A query
  has an optional set of parameters, each of which can be optionally typed. If
  the type is not given, the type Object is assumed. The engine will attempt
  to coerce the values as needed. Query names are global to the KnowledgeBase;
  so do not add queries of the same name to different packages for the same
  RuleBase.</p><p>To return the results use
  <code class="code">ksession.getQueryResults("name")</code>, where "name" is the query's
  name. This returns a list of query results, which allow you to retrieve the
  objects that matched the query.</p><p>The first example presents a simple query for all the people over the
  age of 30. The second one, using parameters, combines the age limit with a
  location.</p><div class="example"><a id="d0e6251"/><p class="title"><b>Example 5.55. Query People over the age of 30</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">query "people over the age of 30" 
    person : Person( age &gt; 30 )
end</pre></div></div><br class="example-break"/><div class="example"><a id="d0e6256"/><p class="title"><b>Example 5.56. Query People over the age of x, and who live in y</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">query "people over the age of x"  (int x, String y)
    person : Person( age &gt; x, location == y )
end</pre></div></div><br class="example-break"/><p>We iterate over the returned QueryResults using a standard "for" loop.
  Each element is a QueryResultsRow which we can use to access each of the
  columns in the tuple. These columns can be accessed by bound declaration
  name or index position.</p><div class="example"><a id="d0e6263"/><p class="title"><b>Example 5.57. Query People over the age of 30</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">QueryResults results = ksession.getQueryResults( "people over the age of 30" );
System.out.println( "we have " + results.size() + " people over the age  of 30" );

System.out.println( "These people are are over 30:" );

for ( QueryResultsRow row : results ) {
    Person person = ( Person ) row.get( "person" );
    System.out.println( person.getName() + "\n" );
}</pre><p>Support for positional syntax has been added for more compact code.
    By default the the declared type order in the type declaration matches the
    argument position. But it possible to override these using the @position
    annotation.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">declare Cheese
    name : String @position(1)
    shop : String @position(2)
    price : int @position(0)
end
</pre><p>The @Position annotation, in the org.drools.definition.type package,
    can be used to annotate original pojos on the classpath. Currently only
    fields on classes can be annotated. Inheritence of classes is supported,
    but not interfaces of methods yet.</p><p>Queries can now call other queries, this combined with optional
    query arguments provides deriviation query style backward chaining.
    Positional and mixed positional/named type is supported. Literal
    expressions can passed as query arguments, but at this stage you cannot
    mix expressions with variables. Here s an example of a query that calls
    another query. Note that 'z' here will always be an 'out' variable. The
    '?' symbol means the query is pull only, once the results are returned you
    will not received further results as the underlying data changes.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">declare Location
    thing : String 
    location : String 
end

query isContainedIn( String x, String y ) 
    Location(x, y;)
    or 
    ( Location(z, y;) and ?isContainedIn(x, z;) )
end</pre><p>As previously mentioned you can use live "open" queries to
    reactively receive changes over time from the query results, as the
    underlying data it queries against changes. Notice the "look" rule calls
    the query without using '?'.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">query isContainedIn( String x, String y ) 
    Location(x, y;)
    or 
    ( Location(z, y;) and isContainedIn(x, z;) )
end

rule look when 
    Person( $l : likes ) 
    isContainedIn( $l, 'office'; )
then
   insertLogical( $l 'is in the office' );
end 
</pre><p>Drools supports unification for derivation queries, in short this
    means that arguments are optional. It is possible to call queries from
    java leaving arguments unspecified using the static field
    org.drools.runtime.rule.Variable.v - note you must use 'v' and not an
    alternative instanceof Variable. These are referred to as 'out' arguments.
    Note that the query itself does not declare at compile time whether an
    argument is in or an out, this can be defined purely at runtime on each
    use. The following example will return all objects contained in the
    office.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">results = ksession.getQueryResults( "isContainedIn", new Object[] {  Variable.v, "office" } );
l = new ArrayList&lt;List&lt;String&gt;&gt;();
for ( QueryResultsRow r : results ) {
    l.add( Arrays.asList( new String[] { (String) r.get( "x" ), (String) r.get( "y" ) } ) );
}  
</pre><p>The algorithm uses stacks to handle recursion, so the method stack
    will not blow up.</p><p>The following is not yet suported:</p><div class="itemizedlist"><ul><li><p>List and Map unification</p></li><li><p>Variables for the fields of facts</p></li><li><p>Expression unification - pred( X, X + 1, X * Y / 7 )</p></li></ul></div></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e6300"/>5.10. Domain Specific Languages</h2></div></div></div><p><a id="d0e6304" class="indexterm"/>Domain Specific Languages (or DSLs) are a way of creating a rule
  language that is dedicated to your problem domain. A set of DSL definitions
  consists of transformations from DSL "sentences" to DRL constructs, which lets
  you use of all the underlying rule language and engine features. Given a
  DSL, you write rules in DSL rule (or DSLR) files, which will be translated
  into DRL files.</p><p>DSL and DSLR files are plain text files, and you can use any text
  editor to create and modify them. But there are also DSL and DSLR editors,
  both in the IDE as well as in the web based BRMS, and you can use those
  as well, although they may not provide you with the full DSL functionality.
  </p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6310"/>5.10.1. When to Use a DSL</h3></div></div></div><p>DSLs can serve as a layer of separation between rule authoring (and
    rule authors) and the technical intricacies resulting from the modelling
    of domain object and the rule engine's native language and methods. If your
    rules need to be read and validated by domain experts (such as business
    analysts, for instance) who are not programmers, you should consider 
    using a DSL; it hides implementation details and focuses on the rule logic
    proper. DSL sentences can also act as "templates" for conditional elements and
    consequence actions that are used repeatedly in your rules, possibly with
    minor variations. You may define DSL sentences as being mapped to these
    repeated phrases, with parameters providing a means for accomodating those
    variations.</p><p>DSLs have no impact on the rule engine at runtime, they are just a
    compile time feature, requiring a special parser and transformer.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6317"/>5.10.2. DSL Basics</h3></div></div></div><p>The Drools DSL mechanism allows you to customise conditional
    expressions and consequence actions. A global substitution mechanism
    ("keyword") is also available.</p><div class="example"><a id="d0e6322"/><p class="title"><b>Example 5.58. Example <a id="d0e6325" class="indexterm"/>DSL mapping</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[when]Something is {colour}=Something(colour=="{colour}")</pre></div></div><br class="example-break"/><p>In the preceding example, <code class="code">[when]</code> indicates the scope of
    the expression, i.e., whether it is valid for the LHS or the RHS of a rule. The
    part after the bracketed keyword is the expression that you use in the rule;
    typically a natural language expression, but it doesn't have to be. The
    part to the right of the equal sign ("=") is the mapping of the expression into
    the rule language. The form of this string depends on its destination, RHS or 
    LHS. If it is for the LHS, then it ought to be a term according to the regular
    LHS syntax; if it is for the RHS then it might be a Java statement.</p><p>Whenever the DSL parser matches a line from the rule file written in the
    DSL with an expression in the DSL definition, it performs three steps of
    string manipulation. First, it extracts the string values appearing where the
    expression contains variable names in braces (here: <code class="code">{colour}</code>). Then,
    the values obtained from these captures are then interpolated wherever that name,
    again enclosed in braces, occurs on the right hand side of the mapping. Finally, the
    interpolated string replaces whatever was matched by the entire expression
    in the line of the DSL rule file.</p><p>Note that the expressions (i.e., the strings on the left hand side of the
    equal sign) are used as regular expressions in a pattern matching operation
    against a line of the DSL rule file, matching all or part of a line. This means
    you can use (for instance) a '?' to indicate that the preceding character is
    optional. One good reason to use this is to overcome variations in natural language
    phrases of your DSL. But, given that these expressions are regular
    expression patterns, this also means that all "magic" characters of Java's
    pattern syntax have to be escaped with a preceding backslash ('\').</p><p>It is important to note that the compiler transforms DSL rule files
    line by line. In the above example, all the text after "Something is " to
    the end of the line is captured as the replacement value for "{colour}",
    and this is used for interpolating the target string. This may not be exactly
    what you want. For instance, when you intend to merge different DSL
    expressions to generate a composite DRL pattern, you need to transform a DSLR
    line in several independent operations. The best way to achieve this is to
    ensure that the captures are surrounded by characteristic text - words or 
    even single characters. As a result,
    the matching operation done by the parser plucks out a substring from 
    somewhere within the line. In the example below, quotes are used as 
    distinctive characters. Note that the characters that surround the capture
    are not included during interpolation, just the contents between them.</p><p>As a rule of thumb, use quotes for textual data that a rule editor
    may want to enter. You can also enclose the capture with words to ensure
    that the text is correctly matched. Both is illustrated by the following
    example. Note that a single line such as <code class="code">Something is "green" and
    another solid thing</code> is now correctly expanded.</p><div class="example"><a id="d0e6351"/><p class="title"><b>Example 5.59. Example with quotes</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[when]something is "{colour}"=Something(colour=="{colour}")
[when]another {state} thing=OtherThing(state=="{state}"</pre></div></div><br class="example-break"/><p>It is a good idea to avoid punctuation (other than quotes or
    apostrophes) in your DSL expressions as much as possible. The main reason
    is that punctuation is easy to forget for rule authors using your DSL.
    Another reason is that parentheses, the period and the question mark are magic
    characters, requiring escaping in the DSL definition.</p><p>In a DSL mapping, the braces "{" and "}" should only be used to
    enclose a variable definition or reference, resulting in a capture. If they
    should occur literally, either in the expression or within the replacement
    text on the right hand side, they must be escaped with a preceding backslash
    ("\"):</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[then]do something= if (foo) \{ doSomething(); \}
    </pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>If braces "{" and "}" should appear in the replacement string of a
    DSL definition, escape them with a backslash ('\').</p></div><div class="example"><a id="d0e6365"/><p class="title"><b>Example 5.60. Examples of DSL mapping entries</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""># This is a comment to be ignored.
[when]There is a person with name of "{name}"=Person(name=="{name}")
[when]Person is at least {age} years old and lives in "{location}"=
      Person(age &gt;= {age}, location=="{location}")
[then]Log "{message}"=System.out.println("{message}");
[when]And = and</pre></div></div><br class="example-break"/><p>Given the above DSL examples, the following examples show the expansion of various
    DSLR snippets:</p><div class="example"><a id="d0e6372"/><p class="title"><b>Example 5.61. Examples of DSL expansions </b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">There is a person with name of "Kitty"
   ==&gt; Person(name="Kitty")
Person is at least 42 years old and lives in "Atlanta"
   ==&gt; Person(age &gt;= 42, location="Atlanta")
Log "boo"
   ==&gt; System.out.println("boo");
There is a person with name of "Bob" and Person is at least 30 years old and lives in "Utah"
   ==&gt; Person(name="Bob") and Person(age &gt;= 30, location="Utah")</pre></div></div><br class="example-break"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Don't forget that if you are capturing plain text from a DSL rule line
    and want to use it as a string literal in the expansion, you must provide
    the quotes on the right hand side of the mapping.</p></div><p>You can chain DSL expressions together on one line, as long as it is
    clear to the parser where one ends and the next one begins and where the
    text representing a parameter ends. (Otherwise you risk getting all the
    text until the end of the line as a parameter value.) The DSL expressions are
    tried, one after the other, according to their order in the DSL definition
    file. After any match, all remaining DSL expressions are investigated,
    too.</p><p>The resulting DRL text may consist of more than one line. Line ends
    are in the replacement text are written as <code class="code">\n</code>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6387"/>5.10.3. Adding Constraints to Facts</h3></div></div></div><p>A common requirement when writing rule conditions is to be able to
    add an arbitrary combination of constraints to a pattern. Given that a
    fact type may have many fields, having to provide an individual DSL
    statement for each combination would be plain folly.</p><p>The DSL facility allows you to add constraints to a pattern by a
    simple convention: if your DSL expression starts with a hyphen
    (minus character, "-") it is assumed to be a field constraint and,
    consequently, is is added to the last pattern line preceding it.</p><p>For an example, lets take look at class <code class="code">Cheese</code>,
    with the following fields: type, price, age and country. We can
    express some LHS condition in normal DRL like the following</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cheese(age &lt; 5, price == 20, type=="stilton", country=="ch")</pre><p>The DSL definitions given below result in three DSL phrases which
    may be used to create any combination of constraint involving these fields.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[when]There is a Cheese with=Cheese()
[when]- age is less than {age}=age&lt;{age}
[when]- type is '{type}'=type=='{type}'
[when]- country equal to '{country}'=country=='{country}'</pre><p>You can then write rules with conditions like the following:
    </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">There is a Cheese with
        - age is less than 42
        - type is 'stilton'</pre><p> The parser will pick up a line
    beginning with "-" and add it as a constraint to  the preceding pattern,
    inserting a comma when it is required. For the preceding example, the
    resulting DRL is: </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cheese(age&lt;42, type=='stilton')</pre><p>
    </p><p>Combining all all numeric fields with all relational operators
    (according to the DSL expression "age is less than..." in the preceding
    example) produces an unwieldy amount of DSL entries. But you can define
    DSL phrases for the various operators and even a generic expression
    that handles any field constraint, as shown below. (Notice that
    the expression definition contains a regular expression in addition
    to the variable name.)</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[when][]is less than or equal to=&lt;=
[when][]is less than=&lt;
[when][]is greater than or equal to=&gt;=
[when][]is greater than=&gt;
[when][]is equal to===
[when][]equals===
[when][]There is a Cheese with=Cheese()</pre>
[when][]- {field:\w*} {operator} {value:\d*}={field} {operator} {value} 

    <p>Given these DSL definitions, you can write rules with conditions
    such as:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">There is a Cheese with
   - age is less than 42
   - rating is greater than 50
   - type equals 'stilton'</pre><p>In this specific case, a phrase such as "is less than" is replaced by
    <code class="code">&lt;</code>, and then the line matches the last DSL entry. This
    removes the hyphen, but the final result is still added as a constraint
    to the preceding pattern. After processing all of the lines, the resulting
    DRL text is:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cheese(age&lt;42, rating &gt; 50, type=='stilton')</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The order of the entries in the DSL is important if separate DSL
    expressions are intended to match the same line, one after the other.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6432"/>5.10.4. Developing a DSL</h3></div></div></div><p>A good way to get started is to write representative samples of the
    rules your application requires, and to test them as you develop. This will
    provide you with a stable framework of conditional elements and their
    constraints. Rules, both in DRL and in DSLR, refer to entities according
    to the data model representing the application data that should be subject
    to the reasoning process defined in rules. Notice that writing rules
    is generally easier if most of the data model's types are facts.</p><p>Given an initial set of rules, it should be possible to identify
    recurring or similar code snippets and to mark variable parts as
    parameters. This provides reliable leads as to what might be a handy
    DSL entry. Also, make sure you have a full grasp of the jargon the 
    domain experts are using, and base your DSL phrases on this vocabulary.</p><p>You may postpone implementation decisions concerning conditions
    and actions during this first design phase by leaving certain conditional
    elements and actions in their DRL form by prefixing a line with a
    greater sign ("&gt;"). (This is also handy for inserting debugging
    statements.)</p><p>During the next development phase, you should find that the DSL
    configuration stabilizes pretty quickly. New rules can be written by
    reusing the existing DSL definitions, or by adding a parameter to an
    existing condition or consequence entry.</p><p>Try to keep the number of DSL entries small. Using parameters
    lets you apply the same DSL sentence for similar rule patterns or
    constraints. But do not exaggerate: authors using the DSL should still
    be able to identify DSL phrases by some fixed text.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6445"/>5.10.5. DSL and DSLR Reference</h3></div></div></div><p>A DSL file is a text file in a line-oriented format. Its
    entries are used for transforming a DSLR file into a file according
    to DRL syntax.</p><div class="itemizedlist"><ul><li><p>A line starting with "#" or "//"
        (with or without preceding white space) is treated as a comment.
        A comment line starting with "#/" is scanned for
        words requesting a debug option, see below.</p></li><li><p>Any line starting with an opening bracket ("[") is assumed to
        be the first line of a DSL entry definition.</p></li><li><p>Any other line is appended to the preceding DSL entry
        definition, with the line end replaced by a space.</p></li></ul></div><p>A DSL entry consists of the following four parts:</p><div class="itemizedlist"><ul><li><p>A scope definition, written as one of the keywords
        "when" or "condition", "then" or "consequence", "*"
        and "keyword", enclosed in brackets ("[" and "]"). This indicates
        whether the DSL entry is valid for the condition or the
        consequence of a rule, or both. A scope indication of "keyword"
        means that the entry has global significance, i.e., it is
        recognized anywhere in a DSLR file.</p></li><li><p>A type definition, written as a Java class name,
        enclosed in brackets. This part is optional unless the
        the next part begins with an opening bracket. An empty
        pair of brackets is valid, too.</p></li><li><p>A DSL expression consists of a (Java) regular expression,
        with any number of embedded <span class="emphasis"><em>variable definitions,</em></span>
        terminated by an equal sign ("="). A variable definition is enclosed
        in braces ("{" and "}"). It
        consists of a variable name and two optional attachements, separated
        by colons (":"). If there is one attachment, it is a regular expression
        for matching text that is to be assigned to the variable; if there
        are two attachments, the first one is a hint for the GUI
        editor and the second one the regular expression.</p><p>Note that all characters that are "magic" in regular
        expressions must be escaped with a preceding backslash ("\")
        if they should occur literally within the expression.</p></li><li><p>The remaining part of the line after the delimiting equal
        sign is the replacement text for any DSLR text matching the
        regular expression. It may contain variable references, i.e.,
        a variable name enclosed in braces. Optionally, the variable name
        may be followed by an exclamation mark ("!") and a transformation
        function, see below.</p><p>Note that braces ("{" and "}") must be escaped with a
        preceding backslash ("\") if they should occur literally
        within the replacement string.</p></li></ul></div><p>Debugging of DSL expansion can be turned on, selectively,
    by using a comment line starting with "#/" which
    may contain one or more words from the table presented below.
    The resulting output is written to standard output.</p><div class="table"><a id="d0e6484"/><p class="title"><b>Table 5.2. Debug options for DSL expansion</b></p><div class="table-contents"><table summary="Debug options for DSL expansion" border="1"><colgroup><col/><col/></colgroup><thead><tr><th>Word</th><th>Description</th></tr></thead><tbody><tr><td>result</td><td>Prints the resulting DRL text, with line numbers.</td></tr><tr><td>steps</td><td>Prints each expansion step of condition and consequence
            lines.</td></tr><tr><td>keyword</td><td>Dumps the internal representation of all DSL entries with
            scope "keyword".</td></tr><tr><td>when</td><td>Dumps the internal representation of all DSL entries with
            scope "when" or "*".</td></tr><tr><td>then</td><td>Dumps the internal representation of all DSL entries with
            scope "then" or "*".</td></tr><tr><td>usage</td><td>Displays a usage statistic of all DSL entries.</td></tr></tbody></table></div></div><br class="table-break"/><p>Below are some sample DSL definitions, with comments describing the
    language features they illustrate.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""># Comment: DSL examples

#/ debug: display result and usage

# keyword definition: replaces "regula" by "rule"
[keyword][]regula=rule

# conditional element: "T" or "t", "a" or "an", convert matched word
[when][][Tt]here is an? {entity:\w+}=
        ${entity!lc}: {entity!ucfirst} ()

# consequence statement: convert matched word, literal braces
[then][]update {entity:\w+}=modify( ${entity!lc} )\{ \}
</pre><p>The transformation of a DSLR file proceeds as follows:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The text is read into memory.</p></li><li><p>Each of the "keyword" entries is applied to the entire text.
        First, the regular expression from the keyword definition is modified
        by replacing white space sequences with a pattern matching any number
        of white space characters, and by replacing variable definitions with
        a capture made from the regular expression provided with the definition,
        or with the default (".*?"). Then, the DSLR text is searched exhaustively
        for occurrences of strings matching the modified regular expression.
        Substrings of a matching string corresponding to variable captures are
        extracted and replace variable references in the corresponding
        replacement text, and this text replaces the matching string in the
        DSLR text.</p></li><li><p>Sections of the DSLR text between "when" and "then", and
        "then" and "end", respectively, are located and processed in a
        uniform manner, line by line, as described below.</p><p>For a line, each DSL entry pertaining to the line's section
        is taken in turn, in the order it appears in the DSL file. Its
        regular expression part is modified: white space is replaced by
        a pattern matching any number of white space characters; variable
        definitions with a regular expression are replaced by a capture
        with this regular expression, its default being ".*?".
        If the resulting regular expression matches all or part of the
        line, the matched part is replaced by the suitably modified
        replacement text.</p><p>Modification of the replacement text is done by replacing
        variable references with the text corresponding to the regular
        expression capture. This text may be modified according to the
        string transformation function given in the variable reference;
        see below for details.</p><p>If there is a variable reference naming a variable that is not
        defined in the same entry, the expander substitutes a value bound to
        a variable of that name, provided it was defined in one of the
        preceding lines of the current rule.</p></li><li><p>If a DSLR line in a condition is written with a leading
        hyphen, the expanded result is inserted into the last line, which
        should contain a pattern CE, i.e., a type name followed by a pair
        of parentheses. if this pair is empty, the expanded line (which
        should contain a valid constraint) is simply inserted, otherwise
        a comma (",") is inserted beforehand.  </p><p>If a DSLR line in a consequence is written with a leading
        hyphen, the expanded result is inserted into the last line, which
        should contain a "modify" statement, ending in a pair of braces
        ("{" and "}"). If this pair is empty, the expanded line (which
        should contain a valid method call) is simply inserted, otherwise
        a comma (",") is inserted beforehand.
        </p></li></ol></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>It is currently <span class="emphasis"><em>not</em></span> possible to use a line
    with a leading hyphen to insert text into other conditional element
    forms (e.g., "accumulate") or it may only work for the first insertion
    (e.g., "eval").</p></div><p>All string transformation functions are described in the following
    table.</p><div class="table"><a id="d0e6560"/><p class="title"><b>Table 5.3. String transformation functions</b></p><div class="table-contents"><table summary="String transformation functions" border="1"><colgroup><col/><col/></colgroup><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>uc</td><td>Converts all letters to upper case.</td></tr><tr><td>lc</td><td>Converts all letters to lower case.</td></tr><tr><td>ucfirst</td><td>Converts the first letter to upper case, and
            all other letters to lower case.</td></tr><tr><td>num</td><td>Extracts all digits and "-" from the string. If the
            last two digits in the original string are preceded by "." or
            ",", a decimal period is inserted in the corresponding position.</td></tr><tr><td><span class="emphasis"><em>a</em></span>?<span class="emphasis"><em>b</em></span>/<span class="emphasis"><em>c</em></span></td><td>Compares the string with string <span class="emphasis"><em>a</em></span>, and if they
            are equal, replaces it with <span class="emphasis"><em>b</em></span>, otherwise with
            <span class="emphasis"><em>c</em></span>. But <span class="emphasis"><em>c</em></span> can be another triplet
            <span class="emphasis"><em>a</em></span>, <span class="emphasis"><em>b</em></span>, <span class="emphasis"><em>c</em></span>, so
            that the entire structure is, in fact, a translation table.</td></tr></tbody></table></div></div><br class="table-break"/><p>The following DSL examples show how to use string transformation functions.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""># definitions for conditions
[when][]There is an? {entity}=${entity!lc}: {entity!ucfirst}()
[when][]- with an? {attr} greater than {amount}={attr} &lt;= {amount!num}
[when][]- with a {what} {attr}={attr} {what!positive?&gt;0/negative?%lt;0/zero?==0/ERROR}</pre><p>A file containing a DSL definition is customarily given the extension
    <code class="code">.dsl</code>. It is passed to the Knowledge Builder with 
    <code class="code">ResourceType.DSL</code>. For a file using DSL definition, the extension
    <code class="code">.dslr</code> should be used. The Knowledge Builder expects
    <code class="code">ResourceType.DSLR</code>. The IDE, however, relies on file extensions
    to correctly recognize and work with your rules file.</p><p>The DSL must be passed to the Knowledge Builder ahead of any rules
    file using the DSL.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">KnowledgeBuilder kBuilder = new KnowledgeBuilder();
Resource dsl = ResourceFactory.newClassPathResource( dslPath, getClass() );
kBuilder.add( dsl, ResourceType.DSL );
Resource dslr = ResourceFactory.newClassPathResource( dslrPath, getClass() );
kBuilder.add( dslr, ResourceType.DSLR );
</pre><p>For parsing and expanding a DSLR file the DSL configuration is read
    and supplied to the parser. Thus, the parser can "recognize" the DSL
    expressions and transform them into native rule language expressions.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e6648"/>5.11. XML Rule Language</h2></div></div></div><p>As an option, Drools also supports a "native" <a id="d0e6653" class="indexterm"/> rule language as an alternative to DRL. This allows you to
  capture and manage your rules as XML data. Just like the non-XML DRL format,
  the XML format is parsed into the internal "AST" representation - as fast as
  possible (using a SAX parser). There is no external transformation step
  required. All the features are available with XML that are available to
  DRL.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6657"/>5.11.1. When to use XML</h3></div></div></div><p>There are several scenarios that XML is desirable. However, we
    recommend that it is not a default choice, as XML is not readily human
    readable (unless you like headaches) and can create visually bloated
    rules.</p><p>If you do want to edit XML by hand, use a good schema aware editor
    that provides nice hierarchical views of the XML, ideally visually
    (commercial tools like XMLSpy, Oxygen etc are good, but cost money, but
    then so do headache tablets).</p><p>Other scenarios where you may want to use the XML format are if you
    have a tool that generates rules from some input (programmatically
    generated rules), or perhaps interchange from another rule language, or
    from another tool that emits XML (using XSLT you can easily transform
    between XML formats). Note you can always generate normal DRL as
    well.</p><p>Alternatively you may be embedding Drools in a product that already
    uses XML for configuration, so you would like the rules to be in an XML
    format. You may be creating your own rule language on XML - note that you
    can always use the AST objects directly to create your own rule language
    as well (the options are many, due to the open architecture).</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6668"/>5.11.2. The XML format</h3></div></div></div><p>A full W3C standards (XMLSchema) compliant XSD is provided that
    describes the XML language, which will not be repeated here verbatim. A
    summary of the language follows.</p><div class="example"><a id="d0e6673"/><p class="title"><b>Example 5.62. A rule in XML<a id="d0e6676" class="indexterm"/></b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_processing_instruction">&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;UTF-8&quot;?&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">package</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;com.sample&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://drools.org/drools-4.0&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xs</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xs:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://drools.org/drools-4.0&nbsp;drools-4.0.xsd&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">import</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;java.util.HashMap&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">import</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.drools.*&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">global</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;x&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;com.sample.X&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">global</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;yada&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;com.sample.Yada&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">function</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">return-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;void&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;myFunc&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">parameter</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foo&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Bar&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">parameter</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;bada&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Bing&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">body</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;hello&nbsp;world&quot;);</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">body</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">function</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;simple_rule&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule-attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;salience&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;10&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule-attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;no-loop&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule-attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;agenda-group&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;agenda-group&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule-attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;activation-group&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;activation-group&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">lhs</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foo2&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Bar&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">or-constraint-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">and-constraint-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">or-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">and-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_attribute_value">&quot;&nbsp;value=&quot;</span><span class="xml_plain">60</span><span class="xml_attribute_value">&quot;&nbsp;/</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span class="xml_attribute_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_attribute_value">&quot;&nbsp;value=&quot;</span><span class="xml_plain">70</span><span class="xml_attribute_value">&quot;&nbsp;/</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span class="xml_attribute_name">and-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">and-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_attribute_value">&quot;&nbsp;value=&quot;</span><span class="xml_plain">50</span><span class="xml_attribute_value">&quot;&nbsp;/</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span class="xml_attribute_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_attribute_value">&quot;&nbsp;value=&quot;</span><span class="xml_plain">55</span><span class="xml_attribute_value">&quot;&nbsp;/</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span class="xml_attribute_name">and-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">or-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a3&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;black&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">and-constraint-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">and-constraint-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;40&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a3&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;pink&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">and-constraint-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">and-constraint-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;12&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a3&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">or-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;yellow&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;blue&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">or-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">and-constraint-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">or-constraint-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">not</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Person&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;likes&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">variable-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;type&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">exists</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Person&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;likes&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">variable-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;type&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">exists</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">not</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">or-conditional-element</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foo3&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Bar&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">or-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;3&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;4&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">or-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a3&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hello&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a4&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;null&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foo4&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Bar&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-binding</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a4&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;!=&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;4&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;!=&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;5&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">or-conditional-element</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foo5&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Bar&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;b&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">or-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">return-value-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">a4&nbsp;+&nbsp;1</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">return-value-restriction</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">variable-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_attribute_value">&quot;&nbsp;identifier=&quot;</span><span class="xml_attribute_name">a4</span><span class="xml_attribute_value">&quot;&nbsp;/</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span class="xml_attribute_name">qualified-identifier-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;org.drools.Bar.BAR_ENUM_VALUE</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">qualified-identifier-restriction</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">or-restriction-connective</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foo6&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Bar&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-binding</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;a4&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">field-constraint</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">field-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;b&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">literal-restriction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;==&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;6&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">field-constraint</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">lhs</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rhs</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;a&nbsp;==&nbsp;b&nbsp;)&nbsp;{</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(&nbsp;foo3&nbsp;);</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retract(&nbsp;foo4&nbsp;);</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;}</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&nbsp;a4&nbsp;);</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">rhs</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">rule</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">package</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>In the preceding XML text you will see the typical XML
      element, the package declaration, imports, globals, functions,
      and the rule itself. Most of the elements are self explanatory
      if you have some  understanding of the Drools features.</p><p>The <code class="code">import</code> elements import the types you wish to
      use in the rule.</p><p>The <code class="code">global</code> elements define global objects that can
      be referred to in the rules.</p><p>The <code class="code">function</code> contains a function declaration, for
      a function to be used in the rules. You have to specify a return type,
      a unique name and parameters, in the body goes a snippet of code.</p><p>The rule is discussed below.</p><div class="example"><a id="d0e6700"/><p class="title"><b>Example 5.63. Detail of rule element</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;simple_rule&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule-attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;salience&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;10&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule-attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;no-loop&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule-attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;agenda-group&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;agenda-group&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rule-attribute</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;activation-group&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;activation-group&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">lhs</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;cheese&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Cheese&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">from</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">accumulate</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Person&quot;</span><span class="xml_tag_symbols">&gt;&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">init</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;total&nbsp;=&nbsp;0;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">init</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">action</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total&nbsp;+=&nbsp;$cheese.getPrice();</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">action</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">result</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;Integer(&nbsp;total&nbsp;)&nbsp;);</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">result</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">accumulate</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">from</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;max&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Number&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">from</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">accumulate</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pattern</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">identifier</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;cheese&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">object-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Cheese&quot;</span><span class="xml_tag_symbols">&gt;&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">external-function</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">evaluator</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;max&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">expression</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;$price&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">accumulate</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">from</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">pattern</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">lhs</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rhs</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;list1.add(&nbsp;$cheese&nbsp;);</span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">rhs</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">rule</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><br />
</pre></div></div><br class="example-break"/><p>In the above detail of the rule we see that the rule has LHS
      and RHS (conditions and consequence) sections.
    The RHS is simple, it is just a block of semantic code that will be
    executed when the rule is activated. The LHS is slightly more
    complicated as it contains nested elements for conditional elements,
    constraints and restrictions.</p><p>A key element of the LHS is the Pattern element. This allows you to
    specify a type (class) and perhaps bind a variable to an instance of that
    class. Nested under the pattern object are constraints and restrictions
  that have to be met. The Predicate and Return Value constraints
  allow Java expressions to be embedded.</p><p>That leaves the conditional elements, not, exists, and, or etc. They
    work like their DRL counterparts. Elements that are nested under and an
    "and" element are logically "anded" together. Likewise with "or" (and you
    can nest things further). "Exists" and "Not" work around patterns, to check
    for the existence or nonexistence of a fact meeting the pattern's
    constraints.</p><p>The Eval element allows the execution of a valid snippet of Java
    code - as long as it evaluates to a boolean (do not end it with a
    semi-colon, as it is just a fragment) - this can include calling a
    function. The Eval is less efficient than the columns, as the rule engine
    has to evaluate it each time, but it is a "catch all" feature for when you
    can express what you need to do with Column constraints.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6714"/>5.11.3. Legacy Drools 2.x XML rule format</h3></div></div></div><p>The Drools 2.x legacy XML format is no longer supported by Drools XML parser</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6719"/>5.11.4. Automatic transforming between formats (XML and DRL)</h3></div></div></div><p>Drools comes with some utility classes to transform between formats.
    This works by parsing the rules from the source format into the AST, and
    then "dumping" out to the appropriate target format. This allows you, for
    example, to write rules in DRL, and when needed, export to XML if
    necessary at some point in the future.</p><p>The classes to look at if you need to do this are: </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">XmlDumper - for exporting XML.
DrlDumper - for exporting DRL.
DrlParser - reading DRL.
XmlPackageReader - reading XML.
</pre><p> Using combinations of the above, you can convert between any
    format (including round trip). Note that DSLs will not be preserved (from
    DRLs that are using a DSL) - but they will be able to be converted.</p><p>Feel free to make use of XSLT to provide all sorts of possibilities
  for XML, XSLT and its ilk are what make XML powerful.</p></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e6731"/>Chapter 6. Authoring</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e6734">6.1. Decision Tables in Spreadsheets</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6746">6.1.1. When to Use Decision Tables</a></span></dt><dt><span class="section"><a href="#d0e6764">6.1.2. Overview</a></span></dt><dt><span class="section"><a href="#d0e6802">6.1.3. How Decision Tables Work</a></span></dt><dt><span class="section"><a href="#d0e6875">6.1.4. Spreadsheet Syntax</a></span></dt><dt><span class="section"><a href="#d0e7349">6.1.5. Creating and integrating Spreadsheet based Decision Tables</a></span></dt><dt><span class="section"><a href="#d0e7368">6.1.6. Managing Business Rules in Decision Tables</a></span></dt><dt><span class="section"><a href="#d0e7413">6.1.7. Rule Templates</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e7501">6.2. Templates</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7514">6.2.1. The Rule Template File</a></span></dt><dt><span class="section"><a href="#d0e7610">6.2.2. Expanding a Template</a></span></dt><dt><span class="section"><a href="#d0e7666">6.2.3. Example</a></span></dt></dl></dd></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e6734"/>6.1. Decision Tables in Spreadsheets</h2></div></div></div><p>Decision tables are a "precise yet compact" (ref. Wikipedia) way of representing conditional logic, and are well
  suited to <span class="emphasis"><em>business</em></span> level rules.</p><p>Drools supports managing rules in a spreadsheet format. Supported formats are Excel (XLS), and CSV, which means
  that a variety of spreadsheet programs (such as Microsoft Excel, OpenOffice.org Calc amongst others) can be utilized.
  It is expected that web based decision table editors will be included in a near future release.</p><p>Decision tables are an old concept (in software terms) but have proven useful over the years. Very briefly
  speaking, in Drools decision tables are a way to generate rules driven from the data entered into a spreadsheet. All
  the usual features of a spreadsheet for data capture and manipulation can be taken advantage of.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6746"/>6.1.1. When to Use Decision Tables</h3></div></div></div><p>Consider decision tables as a course of action if rules exist that can be expressed as rule
    templates and data: each row of a decision table provides data that is combined with a template to
    generate a rule.</p><p>Many businesses already use spreadsheets for managing data, calculations, etc. If you are happy to continue
    this way, you can also manage your business rules this way. This also assumes you are happy to manage packages of
    rules in <code class="filename">.xls</code> or <code class="filename">.csv</code> files. Decision tables are not recommended for rules
    that do not follow a set of templates, or where there are a small number of rules (or if there is a dislike towards
    software like Excel or OpenOffice.org). They are ideal in the sense that there can be control over what
    <span class="emphasis"><em>parameters</em></span> of rules can be edited, without exposing the rules directly.</p><p>Decision tables also provide a degree of insulation from the underlying object model.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6764"/>6.1.2. Overview</h3></div></div></div><p>Here are some examples of real world decision tables (slightly edited to protect the innocent).</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/excel.png"/></div></div><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/actions.png"/></div></div><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/open_office.png"/></div></div><p>In the above examples, the technical aspects of the decision table have been collapsed away (using a standard
    spreadsheet feature).</p><p>The rules start from row 17, with each row resulting in a rule. The conditions are in columns C, D, E, etc.,
    the actions being off-screen. The values in the cells are quite simple, and their meaning is indicated by the
    headers in Row 16. Column B is just a description. It is customary to use color to make it obvious what the
    different areas of the table mean.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Note that although the decision tables look like they process top down, this is not necessarily the case.
      Ideally, rules are authored without regard for the order of rows, simply because this makes maintenance easier, as
      rows will not need to be shifted around all the time.</p></div><p>As each row is a rule, the same principles apply. As the rule engine processes the facts, any rules that match
    may fire. (Some people are confused by this. It is possible to clear the agenda when a rule fires and simulate a
    very simple decision table where only the first match effects an action.) Also note that you can have multiple tables on one
    spreadsheet. This way, rules can be grouped where they share common templates, yet at the end of the day they are
    all combined into one rule package. Decision tables are essentially a tool to generate DRL rules
    automatically.</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/multi_table.png"/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6802"/>6.1.3. How Decision Tables Work</h3></div></div></div><p>The key point to keep in mind is that in a decision table each row is a rule, and each column in that row is
    either a condition or action for that rule.</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/row_col.png"/></div></div><p>The spreadsheet looks for the <em class="firstterm">RuleTable</em> keyword to indicate the start of a rule table
    (both the starting row and column). Other keywords are also used to define other package level attributes (covered
    later). It is important to keep the keywords in one column. By convention the second column ("B") is used for this,
    but it can be any column (convention is to leave a margin on the left for notes). In the following diagram, C is
    actually the column where it starts. Everything to the left of this is ignored.</p><p>If we expand the hidden sections, it starts to make more sense how it works; note the keywords in column
    C.</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/expanded.png"/></div></div><p>Now the hidden magic which makes it work can be seen. The RuleSet keyword indicates the name to be used in the
    <span class="emphasis"><em>rule package</em></span> that will encompass all the rules. This name is optional, using a default, but it
    <span class="emphasis"><em>must</em></span> have the <span class="emphasis"><em>RuleSet</em></span> keyword in the cell immediately to the right.</p><p>The other keywords visible in Column C are Import and Sequential which will be covered later. The RuleTable
    keyword is important as it indicates that a chunk of rules will follow, based on some rule templates. After the
    RuleTable keyword there is a name, used to prefix the names of the generated rules. The row numbers are appended to
    guarantee unique rule names. The column of RuleTable indicates the column in which the rules start; columns to the
    left are ignored.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>In general the keywords make up name-value pairs.</p></div><p>Referring to row 14 (the row immediately after RuleTable), the keywords CONDITION and ACTION indicate that the
    data in the columns below are for either the LHS or the RHS parts of a rule. There are other attributes on the rule
    which can also be optionally set this way.</p><p>Row 15 contains declarations of <em class="firstterm">ObjectTypes</em>. The content in this row is optional, but
    if this option is not in use, the row must be left blank; however this option is usually found to be quite useful.
    When using this row, the values in the cells below (row 16) become constraints on that object type. In the above
    case, it generates <code class="code">Person(age=="42")</code> and <code class="code">Cheese(type=="stilton")</code>, where 42 and
    "stilton" come from row 18. In the above example, the "==" is implicit; if just a field name is given the
    translator assumes that it is to generate an exact match.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>An ObjectType declaration can span columns (via merged cells), meaning that all columns below the merged
      range are to be combined into one set of constraints within a single pattern matching a single fact at a time,
      as opposed to non-merged cells containing the same ObjectType, but resulting in different patterns, potentially
      matching different or identical facts.</p></div><p>Row 16 contains the rule templates themselves. They can use the "$param" placeholder to indicate where data
    from the cells below should be interpolated. (For multiple insertions, use "$1", "$2", etc., indicating parameters
    from a comma-separated list in a cell below.) Row 17 is ignored; it may contain textual descriptions of the column's
    purpose.</p><p>Rows 18 and 19 show data, which will be combined (interpolated) with the templates in row 15, to generate
    rules. If a cell contains no data, then its template is ignored. (This would mean that some condition or action does
    not apply for that rule row.) Rule rows are read until there is a blank row. Multiple RuleTables can exsist in a
    sheet. Row 20 contains another keyword, and a value. The row positions of keywords like this do not matter (most
    people put them at the top) but their column should be the same one where the RuleTable or RuleSet keywords should
    appear. In our case column C has been chosen to be significant, but any other column could be used instead.</p><p>In the above example, rules would be rendered like the following (as it uses the "ObjectType" row):</p><pre class="screen">//row 18
rule "Cheese_fans_18"
when
    Person(age=="42")
    Cheese(type=="stilton")
then
    list.add("Old man stilton");
end
</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The constraints <code class="code">age=="42"</code> and <code class="code">type=="stilton"</code> are interpreted as single
      constraints, to be added to the respective ObjectType in the cell above. If the cells above were spanned, then
      there could be multiple constraints on one "column".</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6875"/>6.1.4. Spreadsheet Syntax</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e6878"/>6.1.4.1. Spreadsheet Structure</h4></div></div></div><p>There are two types of rectangular areas defining data that is used for generating a DRL file.
      One, marked by a cell labelled <code class="code">RuleSet</code>, defines all DRL items except rules. The
      other one may occur repeatedly and is to the right and below a cell whose contents begin with
      <code class="code">RuleTable</code>. These areas represent the actual decision tables, each area resulting
      in a set of rules of similar structure.</p><p>A Rule Set area may contain cell pairs, one below the <code class="code">RuleSet</code> cell and containing
      a keyword designating the kind of value contained in the other one that follows in the same row.
      </p><p>The columns of a Rule Table area define patterns and constraints for the left hand sides of
      the rules derived from it, actions for the consequences of the rules, and the values of
      individual rule attributes. Thus, a Rule Table area should contain one or more columns, both for
      conditions and actions, and an arbitrary selection of columns for rule attributes, at most one
      column for each of these. The first four rows following the row with the cell marked with
      <code class="code">RuleTable</code> are earmarked as header area, mostly used for the definition of code to
      construct the rules. It is any additional row below these four header rows that spawns another
      rule, with its data providing for variations in the code defined in the Rule Table header.</p><p>All keywords are case insensitive.</p><p>Only the first worksheet is examined for decision tables.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e6903"/>6.1.4.2. Rule Set Entries</h4></div></div></div><p>Entries in a Rule Set area may define DRL constructs (except rules), and specify rule
      attributes. While entries for constructs may be used repeatedly, each rule attribute may be
      given at most once, and it applies to all rules unless it is overruled by the same attribute
      being defined within the Rule Table area.</p><p>Entries must be given in a vertically stacked sequence of cell pairs. The first one
      contains a keyword and the one to its right the value, as shown in the table below.
      This sequence of cell pairs may be interrupted by blank rows or even a Rule Table, as long
      as the column marked by <code class="code">RuleSet</code> is upheld as the one containing the keyword.
      </p><div class="table"><a id="d0e6913"/><p class="title"><b>Table 6.1. Entries in the Rule Set area</b></p><div class="table-contents"><table summary="Entries in the Rule Set area" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Keyword</th><th>Value</th><th>Usage</th></tr></thead><tbody><tr><td>RuleSet</td><td>The package name for the generated DRL file.
                     Optional, the default is <code class="code">rule_table</code>.</td><td>Must be First entry.</td></tr><tr><td>Sequential</td><td>"true" or "false". If "true", then salience is used to ensure that
              rules fire from the top down.</td><td>Optional, at most once. If omitted, no firing order is imposed.</td></tr><tr><td>Import</td><td>A comma-separated list of Java classes to import.</td><td>Optional, may be used repeatedly.</td></tr><tr><td>Variables</td><td>Declarations of DRL globals, i.e., a type followed by a variable name.
              Multiple global definitions must be separated with a comma.</td><td>Optional, may be used repeatedly.</td></tr><tr><td>Functions</td><td>One or more function definitions, according to DRL syntax.</td><td>Optional, may be used repeatedly.</td></tr><tr><td>Queries</td><td>One or more query definitions, according to DRL syntax.</td><td>Optional, may be used repeatedly.</td></tr></tbody></table></div></div><br class="table-break"/><p>For defining rule attributes that apply to all rules in the generated DRL file
      you can use any of the entries in the following table. Notice, however, that the
      proper keyword must be used. Also, each of these attributes may be used only once.
      </p><div class="table"><a id="d0e6973"/><p class="title"><b>Table 6.2. Rule attribute entries in the Rule Set area</b></p><div class="table-contents"><table summary="Rule attribute entries in the Rule Set area" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Keyword</th><th>Initial</th><th>Value</th></tr></thead><tbody><tr><td>PRIORITY</td><td>P</td><td>An integer defining the "salience" value for the rule. Overriden by the "Sequential" flag.</td></tr><tr><td>DURATION</td><td>D</td><td>A long integer value defining the "duration" value for the rule.</td></tr><tr><td>NO-LOOP</td><td>U</td><td>A Boolean value. "true" inhibits looping of rules due to changes made by its consequence.</td></tr><tr><td>LOCK-ON-ACTIVE</td><td>L</td><td>A Boolean value. "true" inhibits additional activations of all rules with this flag set within
              the same ruleflow or agenda group.</td></tr><tr><td>AUTO-FOCUS</td><td>F</td><td>A Boolean value. "true" for a rule within an agenda group causes activations of the rule to
              automatically give the focus to the group.</td></tr><tr><td>ACTIVATION-GROUP</td><td>X</td><td>A string identifying an activation (or XOR) group. Only one rule within
              an activation group will fire, i.e., the first one to fire cancels any existing activations of
              other rules within the same group.</td></tr><tr><td>AGENDA-GROUP</td><td>G</td><td>A string identifying an agenda group, which has to be activated by giving it the
              "focus", which is one way of controlling the flow between groups of rules.</td></tr><tr><td>RULEFLOW-GROUP</td><td>R</td><td>A string identifying a rule-flow group.</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e7042"/>6.1.4.3. Rule Tables</h4></div></div></div><p>All Rule Tables begin with a cell containing "RuleTable", optionally followed by a string
      within the same cell. The string is used as the initial part of the name for all rules derived
      from this Rule Table, with the row number appended for distinction. (This automatic naming can
      be overridden by using a NAME column.) All other cells defining rules of this Rule Table are
      below and to the right of this cell.</p><p>The next row defines the column type, with each column resulting in a part of the
      condition or the consequence, or providing some rule attribute, the rule name or a comment.
      The table below shows which column headers are available; additional columns may be used
      according to the table showing rule attribute entries given in the preceding section.
      Note that each attribute column may be used at most once. For a column header, either
      use the keyword or any other word beginning with the letter given in the "Initial" column
      of these tables.</p><div class="table"><a id="d0e7049"/><p class="title"><b>Table 6.3. Column Headers in the Rule Table </b></p><div class="table-contents"><table summary="Column Headers in the Rule Table " border="1"><colgroup><col/><col/><col/><col/></colgroup><thead><tr><th>Keyword</th><th>Initial</th><th>Value</th><th>Usage</th></tr></thead><tbody><tr><td>NAME</td><td>N</td><td>Provides the name for the rule generated from that row. The default is constructed
              from the text following the RuleTable tag and the row number.</td><td>At most one column</td></tr><tr><td>DESCRIPTION</td><td>I</td><td>A text, resulting in a comment within the generated rule.</td><td>At most one column</td></tr><tr><td>CONDITION</td><td>C</td><td>Code snippet and interpolated values for constructing a constraint within
              a pattern in a condition.</td><td>At least one per rule table</td></tr><tr><td>ACTION</td><td>A</td><td>Code snippet and interpolated values for constructing an action for the
              consequence of the rule.</td><td>At least one per rule table</td></tr><tr><td>METADATA</td><td>@</td><td>Code snippet and interpolated values for constructing a metadata entry
              for the rule.</td><td>Optional, any number of columns</td></tr></tbody></table></div></div><br class="table-break"/><p>Given a column headed CONDITION, the cells in successive lines result in a conditional element.</p><div class="itemizedlist"><ul><li><p>Text in the first cell below CONDITION develops into a pattern for the rule condition, with
          the snippet in the next line becoming a constraint. If the cell is merged with one or more neighbours,
          a single pattern with multiple constraints is formed: all constraints are combined into a parenthesized
          list and appended to the text in this cell. The cell may be left blank, which means that the code
          snippet in the next row must result in a valid conditional element on its own.</p><p>To include a pattern without constraints, you can write the pattern in front of the text
          for another pattern.</p><p>The pattern may be written with or without an empty pair of parentheses. A "from" clause may be
          appended to the pattern.</p><p>If the pattern ends with "eval", code snippets are supposed to produce boolean expressions
          for inclusion into a pair of parentheses after "eval".</p></li><li><p>Text in the second cell below CONDITION is processed in two steps.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The code snippet in this cell is modified by interpolating values from cells farther down in the column.
              If you want to create a constraint consisting of a comparison using "==" with the value from the cells below,
              the field selector alone is sufficient. Any other comparison operator must be specified as the last item
              within the snippet, and the value from the cells below is appended. For all other constraint forms, you must
              mark the position for including the contents of
              a cell with the symbol <code class="code">$param</code>. Multiple insertions are possible by using the symbols
              <code class="code">$1</code>, <code class="code">$2</code>, etc., and a comma-separated list of values in the cells below.</p><p>A text according to the pattern
              <code class="code">forall(</code><span class="emphasis"><em>delimiter</em></span><code class="code">){</code><span class="emphasis"><em>snippet</em></span><code class="code">}</code>
              is expanded by repeating the <span class="emphasis"><em>snippet</em></span> once for each of the values of the comma-separated
              list of values in each of the cells below, inserting the value in place of the symbol <code class="code">$</code> and
              by joining these expansions by the given <span class="emphasis"><em>delimiter</em></span>. Note that the forall construct may
              be surrounded by other text.
              </p></li><li><p>If the cell in the preceding row is not empty, the completed code snippet is added to the
              conditional element from that cell. A pair of parentheses is provided automatically, as well as
              a separating comma if multiple constraints are added to a pattern in a merged cell.</p><p>If the cell above is empty, the interpolated result is used as is.</p></li></ol></div></li><li><p>Text in the third cell below CONDITION is for documentation only. It should be used to
          indicate the column's purpose to a human reader.</p></li><li><p>From the fourth row on, non-blank entries provide data for interpolation as described
          above. A blank cell results in the omission of the conditional element or constaint for this
          rule.</p></li></ul></div><p>Given a column headed ACTION, the cells in successive lines result in an action statement.</p><div class="itemizedlist"><ul><li><p>Text in the first cell below ACTION is optional. If present, it is interpreted as an object
          reference.</p></li><li><p>Text in the second cell below ACTION is processed in two steps.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The code snippet in this cell is modified by interpolating values from cells farther down in the column.
              For a singular insertion, mark the position for including the contents of a cell with the symbol
              <code class="code">$param</code>. Multiple insertions are possible by using the symbols <code class="code">$1</code>, <code class="code">$2</code>,
              etc., and a comma-separated list of values in the cells below.</p><p>A method call without interpolation can be achieved by a text without any marker symbols. In this case,
              use any non-blank entry in a row below to include the statement.</p><p>The forall construct is available here, too.</p></li><li><p>If the first cell is not empty, its text, followed by a period, the text in the second cell
              and a terminating semicolon are stringed together, resulting in a method call which is added as an
              action statement for the consequence.
              </p><p>If the cell above is empty, the interpolated result is used as is.</p></li></ol></div></li><li><p>Text in the third cell below ACTION is for documentation only. It should be used to indicate the
          column's purpose to a human reader.</p></li><li><p>From the fourth row on, non-blank entries provide data for interpolation as described
          above. A blank cell results in the omission of the action statement for this rule.</p></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Using <code class="code">$1</code> instead of <code class="code">$param</code> works in most cases, but it will fail
        if the replacement text contains a comma: then, only the part preceding the first comma is inserted.
        Use this "abbreviation" judiciously.</p></div><p>Given a column headed METADATA, the cells in successive lines result in a metadata annotation
      for the generated rules.</p><div class="itemizedlist"><ul><li><p>Text in the first cell below METADATA is ignored.</p></li><li><p>Text in the second cell below METADATA is subject to interpolation, as described above,
          using values from the cells in the rule rows. The metadata marker character <code class="code">@</code>
          is prefixed automatically, and thus it should not be included in the text for this cell.</p></li><li><p>Text in the third cell below METADATA is for documentation only. It should be used to
          indicate the column's purpose to a human reader.</p></li><li><p>From the fourth row on, non-blank entries provide data for interpolation as described
          above. A blank cell results in the omission of the metadata annotation for this rule.</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e7234"/>6.1.4.4. Examples</h4></div></div></div><p>The various interpolations are illustrated in the following example.</p><div class="example"><a id="d0e7239"/><p class="title"><b>Example 6.1. Interpolating cell data</b></p><div class="example-contents"><p>If the template is <code class="code">Foo(bar == $param)</code> and the cell is <code class="code">42</code>, then the result is
        <code class="code">Foo(bar == 42)</code>.</p><p>If the template is <code class="code">Foo(bar &lt; $1, baz == $2)</code> and the cell contains <code class="code">42,43</code>,
        the result will be <code class="code">Foo(bar &lt; 42, baz ==43)</code>.</p><p>The template <code class="code">forall(&amp;&amp;){bar != $}</code> with a cell containing <code class="code">42,43</code>
        results in <code class="code">bar != 42 &amp;&amp; bar != 43</code>.</p></div></div><br class="example-break"/><p>The next example demonstrates the joint effect of a cell defining the pattern type and the code
       snippet below it.
        </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/spanned_column.png"/></div></div><p>
      This spreadsheet section shows how the <code class="code">Person</code> type declaration spans 2 columns, and thus
      both constraints will appear as <code class="code">Person(age == ..., type == ...)</code>. Since only
      the field names are present in the snippet, they imply an equality test.</p><p>In the following example the marker symbol <code class="code">$param</code> is used. 
        </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/with_param.png"/></div></div><p>
      The result of this column is the pattern <code class="code">Person(age == "42"))</code>. You may have
      noticed that the marker and the operator "==" are redundant.</p><p>The next example illustrates that a trailing insertion marker can be omitted.
        </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/operator_completion.png"/></div></div><p>
      Here, appending the value from the cell is implied, resulting in <code class="code">Person(age &lt; "42")).</code>
      </p><p>You can provide the definition of a binding variable, as in the example below.
      . </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/with_binding.png"/></div></div><p>
      Here, the result is <code class="code">c: Cheese(type == "stilton").</code> Note that the quotes are provided
      automatically. Actually, anything can be placed in the object type row. Apart from the definition
      of a binding variable,  it could alse be an additional pattern that is to be inserted literally.
      </p><p>A simple construction of an action statement with the insertion of a single value is shown
      below.
        </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/consequence.png"/></div></div><p>
      The cell below the ACTION header is left blank. Using this style, anything can be placed in the
      consequence, not just a sinle method call. (The same technique is applicable within a 
      CONDITION column as well.)</p><p>Below is a comprehensive example, showing the use of various column headers. It is not
      an error to have no value below a column header (as in the NO-LOOP column): here, the attribute
      will not be applied in any of the rules.
        </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/Key.png"/></div></div><p>
      </p><p>And, finally, here is an example of Import, Variables and Functions.
      </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/keywords.png"/></div></div><p>
      Multiple package names within the same cell must be separated by a comma. Also, the
      pairs of type and variable names must be comma-separated. Functions, however, must be
      written as they appear in a DRL file. This should appear in the same column as the
      "RuleSet" keyword; it could be above, between or below all the rule rows.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>It may be more convenient to use Import, Variables, Functions and Queries repeatedly
        rather than packing several definitions into a single cell.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7349"/>6.1.5. Creating and integrating Spreadsheet based Decision Tables</h3></div></div></div><p>The API to use spreadsheet based decision tables is in the drools-decisiontables module. There is really only
    one class to look at: <code class="literal">SpreadsheetCompiler</code>. This class will take spreadsheets in various formats,
    and generate rules in DRL (which you can then use in the normal way). The <code class="literal">SpreadsheetCompiler</code> can
    just be used to generate partial rule files if it is wished, and assemble it into a complete rule package after the
    fact (this allows the separation of technical and non-technical aspects of the rules if needed).</p><p>To get started, a sample spreadsheet can be used as a base. Alternatively, if the plug-in is being used (Rule
    Workbench IDE), the wizard can generate a spreadsheet from a template (to edit it an xls compatible spreadsheet
    editor will need to be used). </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/wizard.png"/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7368"/>6.1.6. Managing Business Rules in Decision Tables</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e7371"/>6.1.6.1. Workflow and Collaboration</h4></div></div></div><p>Spreadsheets are well established business tools (in use for over 25 years). Decision tables lend themselves
      to close collaboration between IT and domain experts, while making the business rules clear to business analysts,
      it is an ideal separation of concerns.</p><p>Typically, the whole process of authoring rules (coming up with a new decision table) would be something
      like:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Business analyst takes a template decision table (from a repository, or from IT)</p></li><li><p>Decision table business language descriptions are entered in the table(s)</p></li><li><p>Decision table rules (rows) are entered (roughly)</p></li><li><p>Decision table is handed to a technical resource, who maps the business language (descriptions) to
          scripts (this may involve software development of course, if it is a new application or data model)</p></li><li><p>Technical person hands back and reviews the modifications with the business analyst.</p></li><li><p>The business analyst can continue editing the rule rows as needed (moving columns around is also fine
          etc).</p></li><li><p>In parallel, the technical person can develop test cases for the rules (liaising with business analysts)
          as these test cases can be used to verify rules and rule changes once the system is running.</p></li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e7400"/>6.1.6.2. Using spreadsheet features</h4></div></div></div><p>Features of applications like Excel can be used to provide assistance in entering data into spreadsheets,
      such as validating fields. Lists that are stored in other worksheets can be used to provide valid lists of values
      for cells, like in the following diagram. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/lists.png"/></div></div><p>Some applications provide a limited ability to keep a history of changes, but it is recommended to use an
      alternative means of revision control. When changes are being made to rules over time, older versions are archived
      (many open source solutions exist for this, such as Subversion or Git).</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7413"/>6.1.7. Rule Templates</h3></div></div></div><p>Related to decision tables (but not necessarily requiring a spreadsheet) are "Rule Templates" (in the
    drools-templates module). These use any tabular data source as a source of rule data - populating a template to
    generate many rules. This can allow both for more flexible spreadsheets, but also rules in existing databases for
    instance (at the cost of developing the template up front to generate the rules).</p><p>With Rule Templates the data is separated from the rule and there are no restrictions on which part of the
    rule is data-driven. So whilst you can do everything you could do in decision tables you can also do the
    following:</p><div class="itemizedlist"><ul><li><p>store your data in a database (or any other format)</p></li><li><p>conditionally generate rules based on the values in the data</p></li><li><p>use data for any part of your rules (e.g. condition operator, class name, property name)</p></li><li><p>run different templates over the same data</p></li></ul></div><p>As an example, a more classic decision table is shown, but without any hidden rows for the rule meta data
    (so the spreadsheet only contains the raw data to generate the rules).</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Decision_Tables/template1.png"/></div></div><p>See the <code class="filename">ExampleCheese.xls</code> in the examples download for the above spreadsheet.</p><p>If this was a regular decision table there would be hidden rows before row 1 and between rows 1 and 2
    containing rule metadata. With rule templates the data is completely separate from the rules. This has two handy
    consequences - you can apply multiple rule templates to the same data and your data is not tied to your rules at
    all. So what does the template look like?</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
1  template header
2  age
3  type
4  log
5
6  package org.drools.examples.templates;
7
8  global java.util.List list;
9
10 template "cheesefans"
11
12 rule "Cheese fans_@{row.rowNumber}"
13 when
14    Person(age == @{age})
15    Cheese(type == "@{type}")
16 then
17    list.add("@{log}");
18 end
19
20 end template
</pre><p>Annotations to the preceding program listing:
    </p><div class="itemizedlist"><ul><li><p>Line 1: All rule templates start with <code class="code">template header</code>.</p></li><li><p>Lines 2-4: Following the header is the list of columns in the order
                      they appear in the data. In this case we are calling the first column <code class="code">age</code>,
                      the second <code class="code">type</code> and the third <code class="code">log</code>.</p></li><li><p>Line 5: An empty line signifies the end of the column definitions.</p></li><li><p>Lines 6-9: Standard rule header text. This is standard rule DRL and will appear
                      at the top of the generated DRL. Put the package statement and any imports and 
                      global and function definitions into this section.</p></li><li><p>Line 10: The keyword <code class="code">template</code> signals the start of a rule template. There
                      can be more than one template in a template file, but each template should have
                      a unique name.</p></li><li><p>Lines 11-18: The rule template - see below for details.</p></li><li><p>Line 20: The keywords <code class="code">end template</code> signify the end of the template.</p></li></ul></div><p>
    </p><p>The rule templates rely on MVEL to do substitution using the syntax @{token_name}. There is currently one
    built-in expression, @{row.rowNumber} which gives a unique number for each row of data and enables you to generate
    unique rule names. For each row of data a rule will be generated with the values in the data substituted for the
    tokens in the template. With the example data above the following rule file would be generated:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
package org.drools.examples.templates;

global java.util.List list;

rule "Cheese fans_1"
when
  Person(age == 42)
  Cheese(type == "stilton")
then
  list.add("Old man stilton");
end

rule "Cheese fans_2"
when
  Person(age == 21)
  Cheese(type == "cheddar")
then
  list.add("Young man cheddar");
end
</pre><p>The code to run this is simple:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">DecisionTableConfiguration</span><span class="java_plain">&nbsp;dtableconfiguration&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newDecisionTableConfiguration</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">dtableconfiguration</span><span class="java_separator">.</span><span class="java_plain">setInputType</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">DecisionTableInputType</span><span class="java_separator">.</span><span class="java_plain">XLS&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kbuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;getSpreadsheetName</span><span class="java_separator">(),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DTABLE</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dtableconfiguration&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e7501"/>6.2. Templates</h2></div></div></div><p>If you discover that you have a group of rules following
    the same arrangement of patterns, constraints and actions on
    the RHS, differing only in constants or names for objects or
    fields, you might think of employing Drool's rule template feature
    for generating the actual rules. You would write a 
    <span class="emphasis"><em>rule template</em></span> file, containing the
    textual skeleton of your rule and use the Drools template
    compiler in combination with a collection of objects providing
    the actual values for the "flesh" of the rules for their
    instantiation.</p><p>The mechanism is very similar to what a macro processor
    does. The major advantage proffered by template expansion is
    that it's nicely integrated in the overall handling of
    Knowledge Resources.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="caution"><h2>Caution</h2><p>This is an experimental feature. In particular,
    the API is subject to change.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7514"/>6.2.1. The Rule Template File</h3></div></div></div><p>A rule template file begins with a header defining the
      placeholders, or <span class="emphasis"><em>formal template parameters</em></span> 
      for the strings that are to be inserted during instantiation. 
      After the first line, which invariably contains <code class="literal">template header</code>,
      you should write a number of lines, each of which contains a single
      parameter name.</p><div class="example"><a id="d0e7525"/><p class="title"><b>Example 6.2. Rule template file: template header</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>template header</strong></span>
<span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>parameter-name-1</em></span>
...
<span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>parameter-name-n</em></span>
...</pre></div></div><br class="example-break"/><p>The template header is followed by the text that is to
      be replicated and interpolated with the actual parameters. It
      may begin with a <code class="literal">package</code> statement, followed by some
      additional lines. These 
      may be sectioned into one or more templates, each of them
      between a pair of matching <code class="literal">template</code> and
      <code class="literal">end template</code> statements. The <code class="literal">template</code> takes
      an argument, which puts a name to the template. The name
      can be a simple unquoted name or an arbitrary string enclosed
      in double quotes. The template text between these lines may
      contain one or more rules, constituting the "raw material"
      for the expansion.</p><div class="example"><a id="d0e7553"/><p class="title"><b>Example 6.3. Rule template file: templates</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>template header</strong></span>
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong><span class="emphasis"><em>parameter-name-1</em></span></strong></span>
...
<span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>parameter-name-n</em></span>
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>package ...</strong></span>     # optional
<span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>header text</em></span>    # optional
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>template</strong></span> <span xmlns="http://www.w3.org/1999/xhtml" class="emphasis"><em>template-name</em></span>
...
// template text
...
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>end template</strong></span>
...</pre></div></div><br class="example-break"/><p>The resulting text will begin with the package line and the
      header text following it, if present. Then, each template text
      will be expanded individually, yielding one set of rules for each
      of the actual parameter sets. Therefore, the structure of the
      template sections affect the order of the generated rules, since
      the generator iterates over the sections and then over the
      set of actual parameters.</p><p>Any interpolation takes place between a pair of <code class="literal">template</code>
      and <code class="literal">end template</code> statements, when this template is
      expanded. The template text is scanned for occurrences of
      <span class="emphasis"><em>parameter expansions</em></span> written according to:
      </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>@{<span class="emphasis"><em>parameter-name</em></span>}</strong></span></pre><p>
      The name between '@{' and '}' should be one of the parameter names
      defined in the template header. The substitution is effected anywhere,
      even within string literals.</p><p>An important parameter is available without having to be
      included in the data source providing the actual values. The
      parameter substitution
      <span class="bold"><strong><code class="code">@{row.rowNumber}</code></strong></span>
      expands to the integers 0, 1, 2, etc., providing a unique distinction
      for the instantiation derived from a parameter set. You would use this
      as part of each rule name, because, without this precaution, there
      would be duplicate rule names. (You are, of course, free to use your
      own identification included as an extra parameter.)</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7610"/>6.2.2. Expanding a Template</h3></div></div></div><p>To expand a template, you must prepare a data source. This can
      be a spreadsheet, as explained in the previous section. Here, we'll
      concentrate on expansion driven by Java objects. There are two
      straightforward ways of supplying values for a fixed set of names:
      Java objects, in the JavaBeans style, and Maps. Both of them can
      be arranged in a <code class="code">Collection</code>, whose elements will be
      processed during the expansion, resulting in an instantiation
      for each element.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e7618"/>6.2.2.1. Instantiation from Java Objects</h4></div></div></div><p>You may use a Java object that provides getter methods
        corresponding to all of the parameter names of your template
        file. If, for instance, you have defined a header</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
template header
type
limit
word</pre><p>the following Java class could be used:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;t</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;l</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;w&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;&nbsp;getType</span><span class="java_separator">(){...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getLimit</span><span class="java_separator">(){...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;isWord</span><span class="java_separator">(){...}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Although interpolation is pure text manipulation, the actual values
        supplied may be of any type, just as long as this type provides a
        reasonable <code class="code">toString()</code> method. (For simple types, the
        eponymous static method of the related class from <code class="code">java.lang</code>
        is used.)</p><p>Assuming that we have created a <code class="code">Collection&lt;ParamSet&gt;</code>
        for a template file <code class="code">template.drl</code>, we can now proceed to
        request its expansion.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">ParamSet</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;paramSets&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_operator">&lt;</span><span class="java_type">ParamSet</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;populate&nbsp;paramSets</span>
<!--  --><br/><span class="java_plain">paramSets</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Foo&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">42</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">paramSets</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Bar&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">13</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">false</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">ObjectDataCompiler</span><span class="java_plain">&nbsp;converter&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ObjectDataCompiler</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">InputStream</span><span class="java_plain">&nbsp;templateStream&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">getClass</span><span class="java_separator">().</span><span class="java_plain">getResourceAsStream</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;template.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;converter</span><span class="java_separator">.</span><span class="java_plain">compile</span><span class="java_separator">(</span><span class="java_plain">&nbsp;objs</span><span class="java_separator">,</span><span class="java_plain">&nbsp;templateStream&nbsp;</span><span class="java_separator">);</span></pre>

        The resulting string contains the expanded rules text. You could
        write it to a file and proceed as usual, but it's also possible to
        feed this to a <code class="code">KnowledgeBuilder</code> and continue with the
        resulting Knowledge Packages.

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kBase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kBuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Reader</span><span class="java_plain">&nbsp;rdr&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">StringReader</span><span class="java_separator">(</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">kBuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newReaderResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;rdr&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throw</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IllegalStateException</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;DRL&nbsp;errors&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">kBase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e7653"/>6.2.2.2. Instantiation from Maps</h4></div></div></div><p>A <code class="code">Map</code> that provides the values for substituting
        template parameters should have a (string) key set matching all of
        the parameter names. Again, values could be from any class, as long
        as they provide a good <code class="code">toString()</code> method. The expansion
        would use the same approach, just differing in the way the
        map collection is composed.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">Map</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_type">Object</span><span class="java_operator">&gt;&gt;</span><span class="java_plain">&nbsp;paramMaps&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_operator">&lt;</span><span class="java_type">Map</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_type">Object</span><span class="java_operator">&gt;&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;populate&nbsp;paramMaps</span>
<!--  --><br/><span class="java_type">ObjectDataCompiler</span><span class="java_plain">&nbsp;converter&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ObjectDataCompiler</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">InputStream</span><span class="java_plain">&nbsp;templateStream&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">getClass</span><span class="java_separator">().</span><span class="java_plain">getResourceAsStream</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;template.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;converter</span><span class="java_separator">.</span><span class="java_plain">compile</span><span class="java_separator">(</span><span class="java_plain">&nbsp;objs</span><span class="java_separator">,</span><span class="java_plain">&nbsp;templateStream&nbsp;</span><span class="java_separator">);</span></pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7666"/>6.2.3. Example</h3></div></div></div><p>The following example illustrates template expansion. It is based on simple
       objects of class <code class="code">Item</code> containing a couple of integer fields and an
       <code class="code">enum</code> field of type <code class="code">ItemCode</code>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;n</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;p</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;w</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_plain">&nbsp;c&nbsp;</span><span class="java_separator">){...}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;&nbsp;&nbsp;getName</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getWeight</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPrice</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_plain">&nbsp;getCode</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{...}</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;enum&nbsp;</span><span class="java_type">ItemCode</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;LOCK</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;STOCK</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;BARREL</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>The rule template contains a single rule. Notice that the field
         name for the range test is a parameter, which enables us to instantiate
         the template for different fields.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
template header
field
lower
upper
codes

package range;
template "inRange"
rule "is in range @{row.rowNumber}"
when
    Item( $name : name, $v : @{field} &gt;= @{lower} &amp;&amp; &lt;= @{upper}, $code : code @{codes} )
then
    System.out.println( "Item " + $name + " @{field} in range: " + $v + " code: " + $code );
end
end template</pre><p>The next code snippet is from the application, where several
         parameter sets have to be set up. First, there is class
         <code class="code">ParamSet</code>, for storing a set of actual parameters.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">EnumSet</span><span class="java_operator">&lt;</span><span class="java_type">ItemCode</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;codeSet</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;f</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;l</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;u</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">EnumSet</span><span class="java_operator">&lt;</span><span class="java_type">ItemCode</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cs&nbsp;</span><span class="java_separator">){...}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getField</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;field</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;getLower</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;lower</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;getUpper</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;upper</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getCodes</span><span class="java_separator">(){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">StringBuilder</span><span class="java_plain">&nbsp;sb&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">StringBuilder</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;conn&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">for</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_plain">&nbsp;ic</span><span class="java_operator">:</span><span class="java_plain">&nbsp;codeSet&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb</span><span class="java_separator">.</span><span class="java_plain">append</span><span class="java_separator">(</span><span class="java_plain">&nbsp;conn&nbsp;</span><span class="java_separator">).</span><span class="java_plain">append</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;&nbsp;==&nbsp;ItemCode.&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">).</span><span class="java_plain">append</span><span class="java_separator">(</span><span class="java_plain">&nbsp;ic&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;&nbsp;||&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;sb</span><span class="java_separator">.</span><span class="java_plain">toString</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Note that the method <code class="code">getCodes()</code> does returns the
        <code class="code">EnumSet&lt;ItemCode&gt;</code> field value as a <code class="code">String</code>
        value representing a multiple restriction, i.e., a test for one out
        of a list of values.</p><p>The task of expanding a template, passing the resulting DRL text
        to a Knowledge Builder and adding the resulting Knowledge Packages
        to a Knowledge Base is generic. The utility class <code class="code">Expander</code>
        takes care of this, using a Knowledge Base, the <code class="code">InputStream</code>
        with the rule template and the collection of parameter sets.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Expander</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;expand</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kBase</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">InputStream</span><span class="java_plain">&nbsp;is</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Collection</span><span class="java_operator">&lt;?&gt;</span><span class="java_plain">&nbsp;act&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ObjectDataCompiler</span><span class="java_plain">&nbsp;converter&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ObjectDataCompiler</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;converter</span><span class="java_separator">.</span><span class="java_plain">compile</span><span class="java_separator">(</span><span class="java_plain">&nbsp;act</span><span class="java_separator">,</span><span class="java_plain">&nbsp;is&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kBuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Reader</span><span class="java_plain">&nbsp;rdr&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">StringReader</span><span class="java_separator">(</span><span class="java_plain">&nbsp;drl&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newReaderResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;rdr&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">for</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderError</span><span class="java_plain">&nbsp;err</span><span class="java_operator">:</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">){</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">err</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;err</span><span class="java_separator">.</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throw</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IllegalStateException</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;DRL&nbsp;errors&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kBase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>We are now all set to prepare the Knowledge Base with some
        generated rules. First, we define several parameter sets,
        constructed as <code class="code">ParamSet</code> objects, and add them to a
        <code class="code">List</code>, which is passed to the <code class="code">expand</code>
        method shown above. Then we launch a stateful session, insert a
        few <code class="code">Item</code>, and watch what happens.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">ParamSet</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cfl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_operator">&lt;</span><span class="java_type">ParamSet</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">cfl</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;weight&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">10</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">99</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">EnumSet</span><span class="java_separator">.</span><span class="java_plain">of</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">LOCK</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">STOCK&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cfl</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ParamSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;price&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_literal">10</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">50</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">EnumSet</span><span class="java_separator">.</span><span class="java_plain">of</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">BARREL&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kBase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Expander</span><span class="java_plain">&nbsp;ex&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Expander</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">InputStream</span><span class="java_plain">&nbsp;dis&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">FileInputStream</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">File</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;rangeTemp.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ex</span><span class="java_separator">.</span><span class="java_plain">expand</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kBase</span><span class="java_separator">,</span><span class="java_plain">&nbsp;dis</span><span class="java_separator">,</span><span class="java_plain">&nbsp;cfl&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_type">StatefulKnowledgeSession</span><span class="java_plain">&nbsp;session&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kBase</span><span class="java_separator">.</span><span class="java_plain">newStatefulKnowledgeSession</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;A&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">130</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">42</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">LOCK&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;B&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">44</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">100</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">STOCK&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;C&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">123</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">180</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">BARREL&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;D&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">85</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_literal">9</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ItemCode</span><span class="java_separator">.</span><span class="java_plain">LOCK&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span></pre><p>Notice that the two resulting rules deal with
         <span class="emphasis"><em>different</em></span> fields, one with an item's weight,
         the other one with its price. - Below is the output.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
Item E price in range: 25 code: BARREL
Item A weight in range: 42 code: LOCK</pre></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e7737"/>Chapter 7. The Java Rule Engine API</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e7740">7.1. Introduction</a></span></dt><dt><span class="section"><a href="#d0e7755">7.2. How To Use</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7760">7.2.1. Building and Registering RuleExecutionSets</a></span></dt><dt><span class="section"><a href="#d0e7793">7.2.2. Using Stateful and Stateless RuleSessions</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e7828">7.3. References</a></span></dt></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e7740"/>7.1. Introduction</h2></div></div></div><p>
    Drools provides an implementation of the Java Rule Engine API (known
    as JSR94), which allows for support of multiple rule engines from a
    single API. JSR94 does not deal in any way with the rule language
                itself. W3C is working on the
    <a class="ulink" href="http://www.w3.org/TR/2006/WD-rif-ucr-20060323/">Rule Interchange Format (RIF)</a>
    and the OMG has started to work on a standard based on
    <a class="ulink" href="http://ruleml.org/">RuleML</a>.
    Recently Haley Systems has also proposed a rule language standard
                called RML.
  </p><p>It should be remembered that the JSR94 standard represents the "least
    common denominator" in features across rule engines. This means that
                there is less functionality in the JSR94 API than in the standard
                Knowledge (Drools and jBPM) API. So, by using JSR94, you forfeit the advantage of using the
    full capabilities of the Drools Rule Engine. It is necessary to expose
    further functionality, like globals and support for DRL, DSL and XML,
    via property maps due to the very basic feature set of JSR94; this
                introduces non-portable functionality. Furthermore, as JSR94 does not
                provide a rule language, you are only solving a small fraction of the
                complexity of switching rule engines with very little gain. So, while
                we support JSR94, for those that insist on using it, we strongly
                recommend you program against the Knowledge (Drools and jBPM) API.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e7755"/>7.2. How To Use</h2></div></div></div><p>There are two parts to working with JSR94. The first part is the
  administrative API that deals with building and registering RuleExecutionSet objects,
  the second part is runtime session execution of these RuleExecutionSets.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7760"/>7.2.1. Building and Registering RuleExecutionSets</h3></div></div></div><p>The RuleServiceProviderManager manages the registration and
    retrieval of RuleServiceProviders. The Drools RuleServiceProvider
    implementation is automatically registered via a static block when the
    class is loaded using Class.forNamem, in much the same way as JDBC
    drivers.</p><div class="example"><a id="d0e7765"/><p class="title"><b>Example 7.1. Automatic RuleServiceProvider Registration</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">RuleServiceProviderImpl</span><!-- <br/> --><span class="java_plain">&nbsp;is&nbsp;registered&nbsp;to&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;http://drools.org/&quot;</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;via&nbsp;a&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;initialization&nbsp;block</span>
<!--  --><br/><span class="java_type">Class</span><span class="java_separator">.</span><span class="java_plain">forName</span><span class="java_separator">(</span><span class="java_literal">&quot;org.drools.jsr94.rules.RuleServiceProviderImpl&quot;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Get</span><span class="java_plain">&nbsp;the&nbsp;rule&nbsp;service&nbsp;provider&nbsp;from&nbsp;the&nbsp;provider&nbsp;manager</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_type">RuleServiceProvider</span><span class="java_plain">&nbsp;ruleServiceProvider&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">RuleServiceProviderManager</span><span class="java_separator">.</span><span class="java_plain">getRuleServiceProvider</span><span class="java_separator">(</span><span class="java_literal">&quot;http://drools.org/&quot;</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/><p>The RuleServiceProvider provides access to the RuleRuntime and
    RuleAdministrator APIs. The RuleAdministrator provides an administration
    API for the management of RuleExecutionSet objects, making it possible to
    register a RuleExecutionSet that can then be retrieved via the
    RuleRuntime.</p><p>First, you need to create a RuleExecutionSet before it can be
    registered; RuleAdministrator provides factory methods to return an empty
    LocalRuleExecutionSetProvider or RuleExecutionSetProvider. The
    LocalRuleExecutionSetProvider should be used to load a RuleExecutionSets
    from local sources that are not serializable, like Streams. The
    RuleExecutionSetProvider can be used to load RuleExecutionSets from
    serializable sources, like DOM Elements or Packages. Both the
    "ruleAdministrator.getLocalRuleExecutionSetProvider( null );" and the
    "ruleAdministrator.getRuleExecutionSetProvider( null );" take null as a
    parameter, as the properties map for these methods is not currently
    used.</p><div class="example"><a id="d0e7774"/><p class="title"><b>Example 7.2. Registering a LocalRuleExecutionSet with the RuleAdministrator
      API</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Get</span><!-- <br/> --><span class="java_plain">&nbsp;the&nbsp;</span><!-- <br/> --><span class="java_type">RuleAdministration</span>
<!--  --><br/><span class="java_type">RuleAdministrator</span><span class="java_plain">&nbsp;ruleAdministrator&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ruleServiceProvider</span><span class="java_separator">.</span><span class="java_plain">getRuleAdministrator</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">LocalRuleExecutionSetProvider</span><span class="java_plain">&nbsp;ruleExecutionSetProvider&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;ruleAdministrator</span><span class="java_separator">.</span><span class="java_plain">getLocalRuleExecutionSetProvider</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Create</span><span class="java_plain">&nbsp;a&nbsp;</span><span class="java_type">Reader</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;the&nbsp;drl</span>
<!--  --><br/><span class="java_plain">URL&nbsp;drlUrl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;URL</span><span class="java_separator">(</span><span class="java_literal">&quot;http://mydomain.org/sources/myrules.drl&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Reader</span><span class="java_plain">&nbsp;drlReader&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">InputStreamReader</span><span class="java_separator">(</span><span class="java_plain">&nbsp;&nbsp;drlUrl</span><span class="java_separator">.</span><span class="java_plain">openStream</span><span class="java_separator">()</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Create</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">RuleExecutionSet</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;the&nbsp;drl</span>
<!--  --><br/><span class="java_type">RuleExecutionSet</span><span class="java_plain">&nbsp;ruleExecutionSet&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;ruleExecutionSetProvider</span><span class="java_separator">.</span><span class="java_plain">createRuleExecutionSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;drlReader</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>"ruleExecutionSetProvider.createRuleExecutionSet( reader, null )" in
    the above example takes a null parameter for the properties map; however
    it can actually be used to provide configuration for the incoming source.
    When null is passed the default is used to load the input as a drl.
    Allowed keys for a map are "source" and "dsl". The key "source" takes "drl" or
    "xml" as its value; you set "source" to "drl" to load a DRL, or to "xml" to
    load an XML source; "xml" will ignore any "dsl" key/value settings. The
    "dsl" key can take a Reader or a String (the contents of the dsl) as a
    value.</p><div class="example"><a id="d0e7781"/><p class="title"><b>Example 7.3. Specifying a DSL when registering a LocalRuleExecutionSet</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Get</span><!-- <br/> --><span class="java_plain">&nbsp;the&nbsp;</span><!-- <br/> --><span class="java_type">RuleAdministration</span>
<!--  --><br/><span class="java_type">RuleAdministration</span><span class="java_plain">&nbsp;ruleAdministrator&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ruleServiceProvider</span><span class="java_separator">.</span><span class="java_plain">getRuleAdministrator</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">LocalRuleExecutionSetProvider</span><span class="java_plain">&nbsp;ruleExecutionSetProvider&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;ruleAdministrator</span><span class="java_separator">.</span><span class="java_plain">getLocalRuleExecutionSetProvider</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Create</span><span class="java_plain">&nbsp;a&nbsp;</span><span class="java_type">Reader</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;the&nbsp;drl</span>
<!--  --><br/><span class="java_plain">URL&nbsp;drlUrl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;URL</span><span class="java_separator">(</span><span class="java_literal">&quot;http://mydomain.org/sources/myrules.drl&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Reader</span><span class="java_plain">&nbsp;drlReader&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">InputStreamReader</span><span class="java_separator">(</span><span class="java_plain">&nbsp;&nbsp;drlUrl</span><span class="java_separator">.</span><span class="java_plain">openStream</span><span class="java_separator">()</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Create</span><span class="java_plain">&nbsp;a&nbsp;</span><span class="java_type">Reader</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;the&nbsp;dsl&nbsp;and&nbsp;a&nbsp;put&nbsp;in&nbsp;the&nbsp;properties&nbsp;map</span>
<!--  --><br/><span class="java_plain">URL&nbsp;dslUrl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;URL</span><span class="java_separator">(</span><span class="java_literal">&quot;http://mydomain.org/sources/myrules.dsl&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Reader</span><span class="java_plain">&nbsp;dslReader&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">InputStreamReader</span><span class="java_separator">(</span><span class="java_plain">&nbsp;dslUrl</span><span class="java_separator">.</span><span class="java_plain">openStream</span><span class="java_separator">()</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Map</span><span class="java_plain">&nbsp;properties&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">HashMap</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">properties</span><span class="java_separator">.</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;source&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">properties</span><span class="java_separator">.</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;dsl&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;dslReader&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Create</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">RuleExecutionSet</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;the&nbsp;drl&nbsp;and&nbsp;dsl</span>
<!--  --><br/><span class="java_type">RuleExecutionSet</span><span class="java_plain">&nbsp;ruleExecutionSet&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;ruleExecutionSetProvider</span><span class="java_separator">.</span><span class="java_plain">createRuleExecutionSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;reader</span><span class="java_separator">,</span><span class="java_plain">&nbsp;properties&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>When registering a RuleExecutionSet you must specify the name to be
    used for its retrieval. There is also a field to pass properties, which is
    currently unused - so just pass null.</p><div class="example"><a id="d0e7788"/><p class="title"><b>Example 7.4. Register the RuleExecutionSet</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Register</span><!-- <br/> --><span class="java_plain">&nbsp;the&nbsp;</span><!-- <br/> --><span class="java_type">RuleExecutionSet</span><!-- <br/> --><span class="java_plain">&nbsp;with&nbsp;the&nbsp;</span><!-- <br/> --><span class="java_type">RuleAdministrator</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;uri&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ruleExecutionSet</span><span class="java_separator">.</span><span class="java_plain">getName</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">ruleAdministrator</span><span class="java_separator">.</span><span class="java_plain">registerRuleExecutionSet</span><span class="java_separator">(</span><span class="java_plain">uri</span><span class="java_separator">,</span><span class="java_plain">&nbsp;ruleExecutionSet</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7793"/>7.2.2. Using Stateful and Stateless RuleSessions</h3></div></div></div><p>The Runtime, obtained from the RuleServiceProvider, is used to
    create stateful and stateless rule engine sessions.</p><div class="example"><a id="d0e7798"/><p class="title"><b>Example 7.5. Getting the RuleRuntime</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">RuleRuntime</span><!-- <br/> --><span class="java_plain">&nbsp;ruleRuntime&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;ruleServiceProvider</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getRuleRuntime</span><!-- <br/> --><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>To create a rule session you must use one of the two RuleRuntime
    public constants. These are "RuleRuntime.STATEFUL_SESSION_TYPE" and
    "RuleRuntime.STATELESS_SESSION_TYPE", accompanying the URI to the
    RuleExecutionSet you wish to instantiate a RuleSession for. The properties
    map can be null, or it can be used to specify globals, as shown in the
    next section. The createRuleSession(...) method returns a RuleSession
    instance which must then be cast to StatefulRuleSession or
    StatelessRuleSession.</p><div class="example"><a id="d0e7805"/><p class="title"><b>Example 7.6. Stateful Rule</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">StatefulRuleSession</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;ruleRuntime</span><span class="java_separator">.</span><span class="java_plain">createRuleSession</span><span class="java_separator">(</span><span class="java_plain">&nbsp;uri</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">RuleRuntime</span><span class="java_separator">.</span><span class="java_plain">STATEFUL_SESSION_TYPE&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">addObject</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">PurchaseOrder</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;lots&nbsp;of&nbsp;cheese&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">executeRules</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>The StatelessRuleSession has a very simple API; you can only call
    executeRules(List list) passing a list of objects, and an optional filter,
    the resulting objects are then returned.</p><div class="example"><a id="d0e7812"/><p class="title"><b>Example 7.7. Stateless</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">StatelessRuleSession</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;ruleRuntime</span><span class="java_separator">.</span><span class="java_plain">createRuleSession</span><span class="java_separator">(</span><span class="java_plain">&nbsp;uri</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">RuleRuntime</span><span class="java_separator">.</span><span class="java_plain">STATELESS_SESSION_TYPE&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;list&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">list</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">PurchaseOrder</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;even&nbsp;more&nbsp;cheese&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">executeRules</span><span class="java_separator">(</span><span class="java_plain">&nbsp;list&nbsp;</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e7817"/>7.2.2.1. Globals</h4></div></div></div><p>It is possible to support globals with JSR94, in a manner that is
      not portable, by using the properties map passed to the RuleSession factory
      method. Globals must be defined in the DRL or XML file first, otherwise
      an exception will be thrown. The key represents the identifier declared
      in the DRL or XML, and the value is the instance you wish to be used in
      the execution. In the following example the results are collected in a
      java.util.List which is used as global:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">java</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">util</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_type">List</span><!-- <br/> --><span class="java_plain">&nbsp;globalList&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;java</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">util</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_type">ArrayList</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">java</span><span class="java_separator">.</span><span class="java_plain">util</span><span class="java_separator">.</span><span class="java_type">Map</span><span class="java_plain">&nbsp;map&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;java</span><span class="java_separator">.</span><span class="java_plain">util</span><span class="java_separator">.</span><span class="java_type">HashMap</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">map</span><span class="java_separator">.</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;list&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;globalList&nbsp;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_type">Open</span><span class="java_plain">&nbsp;a&nbsp;stateless&nbsp;</span><span class="java_type">Session</span>
<!--  --><br/><span class="java_type">StatelessRuleSession</span><span class="java_plain">&nbsp;srs&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">(</span><span class="java_type">StatelessRuleSession</span><span class="java_separator">)</span><span class="java_plain">&nbsp;runtime</span><span class="java_separator">.</span><span class="java_plain">createRuleSession</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;SistersRules&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">RuleRuntime</span><span class="java_separator">.</span><span class="java_plain">STATELESS_SESSION_TYPE&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Persons</span><span class="java_plain">&nbsp;added&nbsp;to&nbsp;</span><span class="java_type">List</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;call&nbsp;executeRules</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;giving&nbsp;a&nbsp;</span><span class="java_type">List</span><span class="java_plain">&nbsp;of&nbsp;</span><span class="java_type">Objects</span><span class="java_plain">&nbsp;as&nbsp;parameter</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">There</span><span class="java_plain">&nbsp;are&nbsp;rules&nbsp;which&nbsp;will&nbsp;put&nbsp;</span><span class="java_type">Objects</span><span class="java_plain">&nbsp;in&nbsp;the&nbsp;</span><span class="java_type">List</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;fetch&nbsp;the&nbsp;list&nbsp;from&nbsp;the&nbsp;map</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;list&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">java</span><span class="java_separator">.</span><span class="java_plain">util</span><span class="java_separator">.</span><span class="java_type">List</span><span class="java_separator">)</span><span class="java_plain">&nbsp;map</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_literal">&quot;list&quot;</span><span class="java_separator">);</span></pre><p>Do not forget to declare the global "list" in your DRL:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">package SistersRules; 
import org.drools.jsr94.rules.Person; 
global java.util.List list
rule FindSisters 
when 
    $person1 : Person ( $name1:name ) 
    $person2 : Person ( $name2:name ) 
    eval( $person1.hasSister($person2) ) 
then 
    list.add($person1.getName() + " and " + $person2.getName() +" are sisters"); 
    assert( $person1.getName() + " and " + $person2.getName() +" are sisters"); 
end</pre></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e7828"/>7.3. References</h2></div></div></div><p>If you need more information on JSR 94, please refer to the following
  references </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Official JCP Specification for Java Rule Engine API (JSR
        94)</p><div class="itemizedlist"><ul><li><p><a class="ulink" href="http://www.jcp.org/en/jsr/detail?id=94">http://www.jcp.org/en/jsr/detail?id=94</a></p></li></ul></div></li><li><p>The Java Rule Engine API documentation</p><div class="itemizedlist"><ul><li><p><a class="ulink" href="http://www.javarules.org/api_doc/api/index.html">http://www.javarules.org/api_doc/api/index.html</a></p></li></ul></div></li><li><p>The Logic From The Bottom Line: An Introduction to The Drools
        Project. By N. Alex Rupp, published on TheServiceSide.com in
        2004</p><div class="itemizedlist"><ul><li><p><a class="ulink" href="http://www.theserverside.com/articles/article.tss?l=Drools">http://www.theserverside.com/articles/article.tss?l=Drools</a></p></li></ul></div></li><li><p>Getting Started With the Java Rule Engine API (JSR 94): Toward
        Rule-Based Applications. By Dr. Qusay H. Mahmoud, published on Sun
        Developer Network in 2005</p><div class="itemizedlist"><ul><li><p><a class="ulink" href="http://java.sun.com/developer/technicalArticles/J2SE/JavaRule.html">http://java.sun.com/developer/technicalArticles/J2SE/JavaRule.html</a></p></li></ul></div></li><li><p>Jess and the javax.rules API. By Ernest Friedman-Hill, published
        on TheServerSide.com in 2003</p><div class="itemizedlist"><ul><li><p><a class="ulink" href="http://www.theserverside.com/articles/article.tss?l=Jess">http://www.theserverside.com/articles/article.tss?l=Jess</a></p></li></ul></div></li></ol></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e7874"/>Chapter 8. The Rule IDE (Eclipse)</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e7892">8.1. Features Outline</a></span></dt><dt><span class="section"><a href="#d0e7948">8.2. Drools Runtimes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7953">8.2.1. Defining a Drools Runtime</a></span></dt><dt><span class="section"><a href="#d0e7990">8.2.2. Selecting a runtime for your Drools project</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8005">8.3. Creating a Rule Project</a></span></dt><dt><span class="section"><a href="#d0e8028">8.4. Creating a New Rule and Wizards</a></span></dt><dt><span class="section"><a href="#d0e8049">8.5. Textual Rule Editor</a></span></dt><dt><span class="section"><a href="#d0e8072">8.6. Drools Views</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8089">8.6.1. The Working Memory View</a></span></dt><dt><span class="section"><a href="#d0e8103">8.6.2. The Agenda View</a></span></dt><dt><span class="section"><a href="#d0e8117">8.6.3. The Global Data View</a></span></dt><dt><span class="section"><a href="#d0e8131">8.6.4. The Audit View</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8215">8.7. Domain Specific Languages</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8222">8.7.1. Editing languages</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8245">8.8. The Rete View</a></span></dt><dt><span class="section"><a href="#d0e8261">8.9. Large DRL Files</a></span></dt><dt><span class="section"><a href="#d0e8277">8.10. Debugging Rules</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8288">8.10.1. Creating Breakpoints</a></span></dt><dt><span class="section"><a href="#d0e8302">8.10.2. Debugging Rules</a></span></dt></dl></dd></dl></div><p>The Eclipse based IDE provides developers (and very technical users)
  with an environment to edit and test rules in various formats, and integrate
  it deeply with their applications. In cases where you prefer business rules
  and web tooling, you will want to look at the BRMS (but using the BRMS and
  the IDE together is not uncommon).</p><p>The Drools IDE is delivered as an Eclipse plug-in, which allows you to
  author and manage rules from within Eclipse, as well as integrate rules with
  your application. This is an optional tool, and not all components are
  required to be used, you can use what components are relevant to you. The
  Drools IDE is also a part of the Red Hat Developer Studio (formerly known as
  JBoss IDE).</p><p>This guide will cover some of the features of JBoss Drools, in as far
  as the IDE touches on them (it is assumed that the reader has some
  familiarity with rule engines, and Drools in particular. It is important to
  note that none of the underlying features of the rule engine are dependent
  on Eclipse, and integrators are free to use their tools of choice, as always
  ! Plenty of people use IntelliJ with rules, for instance.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>You can get the plug-in either as a zip to download, or from an
    update site. Refer to the chapter on installation.</p></div><div class="figure"><a id="d0e7886"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-IDE/all.png" alt="Overview"/></div></div><p class="title"><b>Figure 8.1. Overview</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e7892"/>8.1. Features Outline</h2></div></div></div><p>The rules IDE has the following features</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Textual/graphical rule editor</p><div class="orderedlist"><ol><li><p>An editor that is aware of DRL syntax, and provides content
            assistance (including an outline view)</p></li><li><p>An editor that is aware of DSL (domain specific langauge)
            extensions, and provides content assistance.</p></li></ol></div></li><li><p>RuleFlow graphical editor</p><p>You can edit visual graphs which represent a process (a rule
        flow). The RuleFlow can then be applied to your rule package to have
        imperative control.</p></li><li><p>Wizards for fast creation of</p><div class="orderedlist"><ol><li><p>a "rules" project</p></li><li><p>a rule resource, either as a DRL file or a "guided rule
            editor" file (.brl)</p></li><li><p>a Domain Specific language</p></li><li><p>a decision table</p></li><li><p>a ruleflow</p></li></ol></div></li><li><p>A domain specific language editor</p><div class="orderedlist"><ol><li><p>Create and manage mappings from your user's language to the
            rule language</p></li></ol></div></li><li><p>Rule validation</p><div class="orderedlist"><ol><li><p>As rules are entered, the rule is "built" in the background
            and errors reported via the problem view where possible</p></li></ol></div></li></ol></div><p>The above features make use of Eclipse infrastructure and features,
    with all of the power of Eclipse being available.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e7948"/>8.2. Drools Runtimes</h2></div></div></div><p>A Drools runtime is a collection of jar files that represent one
    specific release of the Drools project jars. To create a runtime, you must
    point the IDE to the release of your choice. If you want to create a new
    runtime based on the latest Drools project jars included in the plugin
    itself, you can also easily do that. You are required to specify a default
    Drools runtime for your Eclipse workspace, but each individual project can
    override the default and select the appropriate runtime for that project
    specifically.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7953"/>8.2.1. Defining a Drools Runtime</h3></div></div></div><p>To define one or more Drools runtimes using the Eclipse
      preferences view you open up your Preferences, by selecting the
      "Preferences" menu item in the menu "Window". A "Preferences" dialog
      should show all your settings. On the left side of this dialog, under
      the Drools category, select "Installed Drools runtimes". The panel on
      the right should then show the currently defined Drools runtimes. If you
      have not yet defined any runtimes, it should look like the figure
      below.</p><div class="mediaobject" align="center"><img src="images/Chapter-IDE/drools-runtimes.png" align="middle"/></div><p>To define a new Drools runtime, click on the add button. A dialog
      such as the one shown below should pop up, asking for the name of your
      runtime and the location on your file system where it can be
      found.</p><div class="mediaobject" align="center"><img src="images/Chapter-IDE/drools-runtimes-add.png" align="middle"/></div><p>In general, you have two options:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>If you simply want to use the default jar files as included in
          the Drools Eclipse plugin, you can create a new Drools runtime
          automatically by clicking the "Create a new Drools 5 runtime ..."
          button. A file browser will show up, asking you to select the folder
          on your file system where you want this runtime to be created. The
          plugin will then automatically copy all required dependencies to the
          specified folder. After selecting this folder, the dialog should
          look like the figure shown below.</p></li><li><p>If you want to use one specific release of the Drools project,
          you should create a folder on your file system that contains all the
          necessary Drools libraries and dependencies. Instead of creating a
          new Drools runtime as explained above, give your runtime a name and
          select the location of this folder containing all the required
          jars.</p></li></ol></div><div class="mediaobject" align="center"><img src="images/Chapter-IDE/drools-runtimes-add2.png" align="middle"/></div><p>After clicking the OK button, the runtime should show up in your
      table of installed Drools runtimes, as shown below. Click on checkbox in
      front of the newly created runtime to make it the default Drools
      runtime. The default Drools runtime will be used as the runtime of all
      your Drools project that have not selected a project-specific
      runtime.</p><div class="mediaobject" align="center"><img src="images/Chapter-IDE/drools-runtimes2.png" align="middle"/></div><p>You can add as many Drools runtimes as you need. For example, the
      screenshot below shows a configuration where two runtimes have been
      defined: a Drools 5.1.1 runtime and a Drools 5.2.0.M2 runtime. The
      Drools 5.1.1 runtime is selected as the default one.</p><div class="mediaobject" align="center"><img src="images/Chapter-IDE/drools-runtimes3.png" align="middle"/></div><p>Note that you will need to restart Eclipse if you changed the
      default runtime and you want to make sure that all the projects that are
      using the default runtime update their classpath accordingly.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e7990"/>8.2.2. Selecting a runtime for your Drools project</h3></div></div></div><p>Whenever you create a Drools project (using the New Drools Project
      wizard or by converting an existing Java project to a Drools project
      using the action "Convert to Drools Project" that is shown when you are
      in the Drools perspective and you right-click an existing Java project),
      the plugin will automatically add all the required jars to the classpath
      of your project.</p><p>When creating a new Drools project, the plugin will automatically
      use the default Drools runtime for that project, unless you specify a
      project-specific one. You can do this in the final step of the New
      Drools Project wizard, as shown below, by deselecting the "Use default
      Drools runtime" checkbox and selecting the appropriate runtime in the
      drop-down box. If you click the "Configure workspace settings ..." link,
      the workspace preferences showing the currently installed Drools
      runtimes will be opened, so you can add new runtimes there.</p><div class="mediaobject" align="center"><img src="images/Chapter-IDE/drools-runtimes-newproject.png" align="middle"/></div><p>You can change the runtime of a Drools project at any time by
      opening the project properties and selecting the Drools category, as
      shown below. Mark the "Enable project specific settings" checkbox and
      select the appropriate runtime from the drop-down box. If you click the
      "Configure workspace settings ..." link, the workspace preferences
      showing the currently installed Drools runtimes will be opened, so you
      can add new runtimes there. If you deselect the "Enable project specific
      settings" checkbox, it will use the default runtime as defined in your
      global preferences.</p><div class="mediaobject" align="center"><img src="images/Chapter-IDE/drools-runtimes-project.png" align="middle"/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8005"/>8.3. Creating a Rule Project</h2></div></div></div><p>The aim of the new project wizard is to set up an executable
    scaffold project to start using rules immediately. This will set up a
    basic structure, the classpath, sample rules and a test case to get you
    started.</p><div class="figure"><a id="d0e8010"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/new_project1.png" align="middle" alt="New rule project scaffolding"/></div></div><p class="title"><b>Figure 8.2. New rule project scaffolding</b></p></div><br class="figure-break"/><p>When you choose to create a new "rule project" you will get a choice
    to add some default artifacts to it, like rules, decision tables,
    ruleflows, etc. These can serve as a starting point, and will give you
    something executable almost immediately, which you can then modify and
    mould to your needs. The simplest case (a hello world rule) is shown
    below. Feel free to experiment with the plug-in at this point.</p><div class="figure"><a id="d0e8018"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/new_project2.png" align="middle" alt="New rule project result"/></div></div><p class="title"><b>Figure 8.3. New rule project result</b></p></div><br class="figure-break"/><p>The newly created project contains an example rule file (Sample.drl)
    in the src/rules directory and an example Java file (DroolsTest.java) that
    can be used to execute the rules in a Drools engine. You'll find this in
    the folder src/java, in the com.sample package. All the other jars that
    are necessary during execution are also added to the classpath in a custom
    classpath container called Drools Library. Rules do not have to be kept in
    "Java" projects at all, this is just a convenience for people who are
    already using Eclipse as their Java IDE.</p><p>Important note: The Drools plug-in adds a "Drools Builder"
    capability to your Eclipse instance. This means you can enable a builder
    on any project that will build and validate your rules when resources
    change. This happens automatically with the Rule Project Wizard, but you
    can also enable it manually on any project. One downside of this is that
    if you have rule files with a large number of rules (more than 500 rules
    per file), it means that the background builder may be doing a lot of work
    to build the rules on each change. An option here is to turn off the
    builder, or put the large rules into .rule files, where you can still use
    the rule editor, but it won't build them in the background. To fully
    validate the rules you will need to run them in a unit test of
    course.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8028"/>8.4. Creating a New Rule and Wizards</h2></div></div></div><p>You can create a rule simple as an empty text ".drl" file, or use
    the wizard to do so. The wizard menu can be invoked with Control+N, or by
    choosing it from the toolbar, where there is a menu with the JBoss Drools
    icon.</p><div class="figure"><a id="d0e8033"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/wizards.png" align="middle" alt="The wizard menu"/></div></div><p class="title"><b>Figure 8.4. The wizard menu</b></p></div><br class="figure-break"/><p>The wizard will ask for some basic options for generating a rule
    resource. These are just hints - you can change your mind later. For
    storing rule files you would typically create a directory src/rules and
    create suitably named subdirectories. The package name is mandatory, and
    is similar to a package name in Java; i.e., it establishes a namespace for
    grouping related rules.</p><div class="figure"><a id="d0e8041"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/new_rule.jpg" align="middle" alt="New rule wizard"/></div></div><p class="title"><b>Figure 8.5. New rule wizard</b></p></div><br class="figure-break"/><p>The result of this wizard is a rule skeleton, for you to expand. As
    with all wizards, they are an optional help - you don't have to use them
    if you don't want to.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8049"/>8.5. Textual Rule Editor</h2></div></div></div><p>The rule editor is where rule managers and developers will be
    spending most of their time. The rule editor follows the pattern of a
    normal text editor in Eclipse, with all the customary features of a text
    editor. On top of this, the rule editor provides pop-up content
    assistance. You invoke pop-up content assistance the "normal" way by
    pressing Control+Space.</p><div class="figure"><a id="d0e8054"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/editor1.jpg" align="middle" alt="The rule editor in action"/></div></div><p class="title"><b>Figure 8.6. The rule editor in action</b></p></div><br class="figure-break"/><p>The rule editor works on files that have a .drl (or .rule)
    extension. Usually these contain related rules, but it would also be
    possible to have rules in individual files, grouped by being in the same
    package "namespace", if you so prefer. These DRL files are plain text
    files.</p><p>You can see from the example above that the rule group is using a
    domain specific language. Note the expander keyword, which tells the rule
    compiler to look for a dsl file of that name, to resolve the rule
    language. Even with the domain specific language (DSL) the rules are still
    stored as plain text as you see it onscreen, which allows simpler
    management of rules and versions, e.g., comparing versions of
    rules.</p><p>The editor has an outline view that is kept in sync with the
    structure of the rules; it is updated on save. This provides a quick way
    of navigating around rules by name, even in a file which may have hundreds
    of rules. The items are sorted alphabetically by default.</p><div class="figure"><a id="d0e8066"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/outline.jpg" align="middle" alt="The rule outline view"/></div></div><p class="title"><b>Figure 8.7. The rule outline view</b></p></div><br class="figure-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8072"/>8.6. Drools Views</h2></div></div></div><p>When debugging an application using a Drools engine, these views can
    be used to check the state of the Drools engine itself: the Working Memory
    View, the Agenda View, and the Global Data View. To be able to use these
    views, create breakpoints in your code invoking the working memory. For
    example, the line where you call workingMemory.fireAllRules() is a good
    candidate. If the debugger halts at that joinpoint, you should select the
    working memory variable in the debug variables view. The available views
    can then be used to show the details of the selected working
    memory:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The Working Memory View shows all elements of the Drools working
        memory.</p></li><li><p>The Agenda View shows all elements on the agenda. For each rule
        on the agenda, the rule name and bound variables are shown.</p></li><li><p>The Global Data View shows all global data currently defined in
        the Drools working memory.</p></li></ol></div><p>The Audit view can be used to display audit logs containing events
    that were logged during the execution of a rules engine, in tree
    form.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e8089"/>8.6.1. The Working Memory View</h3></div></div></div><div class="mediaobject"><img src="images/Chapter-IDE/workingMemory.png"/></div><p>The Working Memory View shows all elements in the working memory
      of the Drools engine.</p><p>An action is added to the right of the view, to customize what is
      shown:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The Show Logical Structure toggles showing the logical
          structure of the elements in the working memory, or all their
          details. Logical structures allow for visualizing sets of elements
          in a more obvious way.</p></li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e8103"/>8.6.2. The Agenda View</h3></div></div></div><div class="mediaobject"><img src="images/Chapter-IDE/agenda.png"/></div><p>The Agenda View shows all elements on the agenda. For each rule on
      the agenda, the rule name and bound variables are shown.</p><p>An action is added to the right of the view, to customize what is
      shown:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The Show Logical Structure toggles showing the logical
          structure of the agenda item, or all their details. Logical
          structures allow for example visualizing sets of elements in a more
          obvious way. The logical structure of AgendaItems shows the rule
          that is represented by the AgendaItem, and the values of all the
          parameters used in the rule.</p></li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e8117"/>8.6.3. The Global Data View</h3></div></div></div><div class="mediaobject"><img src="images/Chapter-IDE/globals.png"/></div><p>The Global Data View shows all global data currently defined in
      the Drools engine.</p><p>An action is added to the right of the view, to customize what is
      shown:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The Show Logical Structure toggles showing the logical
          structure of the elements in the working memory, or all their
          details. Logical structures allow for example visualizing sets of
          elements in a more obvious way.</p></li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e8131"/>8.6.4. The Audit View</h3></div></div></div><div class="mediaobject"><img src="images/Chapter-IDE/audit.jpg"/></div><p>The audit view visualizes an audit log, that is optionally created
      when executing the rules engine. To create an audit log, use the
      following code:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">WorkingMemory</span><!-- <br/> --><span class="java_plain">&nbsp;workingMemory&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;ruleBase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newWorkingMemory</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Create</span><span class="java_plain">&nbsp;a&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Working</span><span class="java_plain">&nbsp;</span><span class="java_type">Memory</span><span class="java_plain">&nbsp;</span><span class="java_type">Logger</span><span class="java_separator">,</span><span class="java_plain">&nbsp;that&nbsp;logs&nbsp;to&nbsp;file</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_type">WorkingMemoryFileLogger</span><span class="java_plain">&nbsp;logger&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">WorkingMemoryFileLogger</span><span class="java_separator">(</span><span class="java_plain">workingMemory</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">An</span><span class="java_plain">&nbsp;event</span><span class="java_separator">.</span><span class="java_plain">log&nbsp;file&nbsp;is&nbsp;created&nbsp;in&nbsp;the&nbsp;subdirectory&nbsp;log&nbsp;</span><span class="java_separator">(</span><span class="java_plain">which&nbsp;must&nbsp;exist</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;of&nbsp;the&nbsp;working&nbsp;directory</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">logger</span><span class="java_separator">.</span><span class="java_plain">setFileName</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;log/event&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">workingMemory</span><span class="java_separator">.</span><span class="java_plain">assertObject</span><span class="java_separator">(...);</span>
<!--  --><br/><span class="java_plain">workingMemory</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;stop&nbsp;logging</span>
<!--  --><br/><span class="java_plain">logger</span><span class="java_separator">.</span><span class="java_plain">writeToDisk</span><span class="java_separator">();</span></pre><p>Open the log by clicking the Open Log action, the first icon in
      the Audit View, and select the file. The Audit View now shows all events
      that where logged during the executing of the rules. There are different
      types of events, each with a different icon:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Object inserted, a green square: <span class="inlinemediaobject"><img src="images/Chapter-IDE/greensquare.GIF"/></span></p></li><li><p>Object updated, a yellow square: <span class="inlinemediaobject"><img src="images/Chapter-IDE/yellowsquare.GIF"/></span></p></li><li><p>Object removed, a red square: <span class="inlinemediaobject"><img src="images/Chapter-IDE/redsquare.GIF"/></span></p></li><li><p>Activation created, a right arrow: <span class="inlinemediaobject"><img src="images/Chapter-IDE/arrowright.GIF"/></span></p></li><li><p>Activation cancelled, a left arrow: <span class="inlinemediaobject"><img src="images/Chapter-IDE/arrowleft.GIF"/></span></p></li><li><p>Activation executed, a blue diamond: <span class="inlinemediaobject"><img src="images/Chapter-IDE/bluediamond.GIF"/></span></p></li><li><p>Ruleflow start or end, the "process" icon: <span class="inlinemediaobject"><img src="images/Chapter-IDE/process.gif"/></span></p></li><li><p>Ruleflow-group activation or deactivation, the "activity"
          icon: <span class="inlinemediaobject"><img src="images/Chapter-IDE/activity.gif"/></span></p></li><li><p>Rule package addition or removal, the Drools icon:
          <span class="inlinemediaobject"><img src="images/Chapter-IDE/drools.gif"/></span></p></li><li><p>Rule addition or removal, the Drools icon: <span class="inlinemediaobject"><img src="images/Chapter-IDE/drools.gif"/></span></p></li></ol></div><p>All these events show extra information concerning the event, like
      the id and toString representation of the object in case of working
      memory events (insert, modify and retract), the name of the rule and all
      the variables bound in the activation in case of an activation event
      (created, cancelled or executed). If an event occurs when executing an
      activation, it is shown as a child of the activation's execution event.
      For some events, you can retrieve the "cause":</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The cause of an object modified or retracted event is the last
          object event for that object. This is either the object asserted
          event, or the last object modified event for that object.</p></li><li><p>The cause of an activation cancelled or executed event is the
          corresponding activation created event.</p></li></ol></div><p>When selecting an event, the cause of that event is shown in green
      in the audit view (if visible of course). You can also right click the
      action and select the "Show Cause" menu item. This will scroll you to
      the cause of the selected event.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8215"/>8.7. Domain Specific Languages</h2></div></div></div><p>Domain Specific Languages (DSL) enable you to create a language that
    allows your rules to look like - rules! Most often the domain specific
    language reads like natural language. Typically you would look at how a
    business analyst would describe the rule, in their own words, and then map
    this to your object model, via rule constructs. A side benefit of this is
    that it can provide an insulation layer between your domain objects and
    the rules themselves (as we know you like to refactor). A domain specific
    language will grow as the rules grow, and works best when there are common
    terms used over an over, with different parameters.</p><p>To aid with this, the rule workbench provides an editor for Domain
    Specific Languages. They are stored in a plain text format, so you can use
    any editor of your choice; this format is simply a slightly enhanced
    version of the "Properties" file format. The editor will be invoked on any
    files with a .dsl extension. There is also a wizard to create a sample
    DSL.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e8222"/>8.7.1. Editing languages</h3></div></div></div><div class="figure"><a id="d0e8225"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/dsl_editor.jpg" align="middle" alt="The Domain Specific Language editor"/></div></div><p class="title"><b>Figure 8.8. The Domain Specific Language editor</b></p></div><br class="figure-break"/><p>The DSL editor provides a tabular view of the mapping of Language
      to Rule Expressions. The Language Expression is what is used in the
      rules. This also feeds the content assistance for the rule editor, so
      that it can suggest Language Expressions from the DSL configuration.
      (The rule editor loads the DSL configuration when the rule resource is
      loaded for editing.) The Rule language mapping defines the "code" for
      the rules into which the language expression will be compiled by the
      rule engine compiler. The form of this Rule language expression depends
      on it being intended for the condition or the action part of a rule.
      (For the RHS it may be a snippet of Java, for instance). The "scope"
      item indicates where the expression belongs, "when" indicating the LHS,
      "then" the RHS, and "*" meaning anywhere. It's also possible to create
      aliases for keywords.</p><p>By selecting a mapping item (a row in the table) you can see the
      expression and mapping in the text fields below the table. Double
      clicking or pressing the edit button will open the edit dialog. Other
      buttons let you remove and add mappings. Don't remove mappings while
      they are still in use.</p><div class="figure"><a id="d0e8235"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/mapping_editor.jpg" align="middle" alt="Language Mapping editor dialog"/></div></div><p class="title"><b>Figure 8.9. Language Mapping editor dialog</b></p></div><br class="figure-break"/><p>Here is a short description of the DSL translation process. The
      parser reads the rule text in a DSL, line by line, and tries to match
      some "Language Expression", depending on the scope. After a match, the
      values that correspond to a placeholder between curly braces (e.g.,
      {age}) are extracted from the rule source. The placeholders in the
      corresponding "Rule Expression" are replaced by their corresponding
      value. In the example above, the natural language expression maps to two
      constraints on a fact of type Person, based on the fields age and
      location, and the {age} and {location} values are extracted from the
      original rule text.</p><p>If you do not wish to use a language mapping for a particular rule
      in a drl, prefix the expression with &gt; and the compiler will not try
      to translate it according to the language definition. Also note that
      Domain Specific Languages are optional. When the rule is compiled, the
      .dsl file will also need to be available.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8245"/>8.8. The Rete View</h2></div></div></div><p>The Rete Tree View shows you the current Rete Network for your DRL
    file. You display it by clicking on the tab "Rete Tree" at the bottom of
    the DRL Editor window. With the Rete Network visualization being open, you
    can use drag-and-drop on individual nodes to arrange optimal network
    overview. You may also select multiple nodes by dragging a rectangle over
    them; then the entire group can be moved around. The Eclips toolbar icons
    for zooming in and out can be used in the customary manner.</p><p>In the current release there is no export function to creates a gif
    or jpeg file. Meanwhile, please use ctrl + alt + print to create a copy of
    your current Eclipse window, and cut it off.</p><div class="mediaobject"><img src="images/Chapter-IDE/thereteview.jpg"/></div><p>The Rete View is an advanced feature which takes full advantage of
    the Eclipse Graphical Editing Framework (GEF).</p><p>The Rete view works only in Drools Rule Projects, where the Drools
    Builder is set in the project´s properties.</p><p>If you are using Drools in another type of project where you are not
    having a Drools Rule Project with the appropriate Drools Builder, you can
    use a workaround: Set up a little Drools Rule Project next to it, putting
    needed libraries into it, and the DRLs you want to inspect with the Rete
    View. Just click on the right tab below in the DRL Editor, followed by a
    click on "Generate Rete View".</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8261"/>8.9. Large DRL Files</h2></div></div></div><p>Depending on the JDK you use, it may be necessary to increase the
    permanent generation max size. Both the SUN and the IBM JDK have a
    permanent generation, whereas BEA JRockit does not.</p><p>To increase the permanent generation, start Eclipse with
    -XX:MaxPermSize=###m</p><p>Example: c:\Eclipse\Eclipse.exe -XX:MaxPermSize=128m</p><p>Rulesets of 4,000 rules or greater should set the permanent
    generation to at least 128Mb.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>This may also apply to compiling large numbers of rules in
      general, as there is generally one or more classes per rule.</p></div><p>As an alternative to the above, you may put rules in a file with the
    ".rule" extension, and the background builder will not try to compile them
    with each change, which may provide performance improvements if your IDE
    becomes sluggish with very large numbers of rules.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8277"/>8.10. Debugging Rules</h2></div></div></div><div class="figure"><a id="d0e8280"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/debug-overview.png" align="middle" alt="Debugging"/></div></div><p class="title"><b>Figure 8.10. Debugging</b></p></div><br class="figure-break"/><p>You can debug rules during the execution of your Drools application.
    You can add breakpoints in the consequences of your rules, and whenever
    such a breakpoint is encountered during the execution of the rules,
    execution is halted. You can then inspect the variables known at that
    point and use any of the default debugging actions to decide what should
    happen next: step over, continue, etc. You can also use the debug views to
    inspect the content of the working memory and the Agenda.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e8288"/>8.10.1. Creating Breakpoints</h3></div></div></div><p>You can add and remove rule breakpoints in DRL files in two ways,
      similar to adding breakpoints to Java files:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Double-click the ruler of the DRL editor at the line where you
          want to add a breakpoint. Note that rule breakpoints can only be
          created in the consequence of a rule. Double-clicking on a line
          where no breakpoint is allowed will do nothing. A breakpoint can be
          removed by double-clicking the ruler once more.</p></li><li><p>If you right-click the ruler, a popup menu will show up,
          containing the "Toggle breakpoint" action. Note that rule
          breakpoints can only be created in the consequence of a rule. The
          action is automatically disabled if no rule breakpoint is allowed at
          that line. Clicking the action will add a breakpoint at the selected
          line, or remove it if there was one already.</p></li></ol></div><p>The Debug Perspective contains a Breakpoints view which can be
      used to see all defined breakpoints, get their properties,
      enable/disable or remove them, etc.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e8302"/>8.10.2. Debugging Rules</h3></div></div></div><p>Drools breakpoints are only enabled if you debug your application
      as a Drools Application. You can do this like this:</p><div class="figure"><a id="d0e8307"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/debugAsDrools.png" align="middle" alt="Debug as Drools Application"/></div></div><p class="title"><b>Figure 8.11. Debug as Drools Application</b></p></div><br class="figure-break"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Select the main class of your application. Right click it and
          select the "Debug As &gt;" sub-menu and select Drools Application.
          Alternatively, you can also select the "Debug ..." menu item to open
          a new dialog for creating, managing and running debug configurations
          (see the screenshot below).</p></li><li><p>Select the "Drools Application" item in the left tree and
          click the "New launch configuration" button (leftmost icon in the
          toolbar above the tree). This will create a new configuration with
          some of the properties (like project and main class)already filled
          in, based on the main class you selected in the beginning. All
          properties shown here are the same as for any standard Java
          program.</p></li><li><p>Change the name of your debug configuration to something
          meaningful. You can just accept the defaults for all other
          properties. For more information about these properties, please
          check the Eclipse JDT documentation.</p></li><li><p>Click the "Debug" button on the bottom to start debugging your
          application. You only have to define your debug configuration once.
          The next time you run your Drools application, you don't have to
          create a new one but select the previously defined one in the tree
          on the left, as a sub-element of the "Drools Application" tree node,
          and then click the Debug button. The Eclipse toolbar also contains
          shortcut buttons to quickly re-execute one of your previous
          configurations (at least when one of the Java, Java Debug, or Drools
          perspectives has been selected).</p></li></ol></div><div class="figure"><a id="d0e8326"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/debug_rules_configuration.png" align="middle" alt="Debug as Drools Application Configuration"/></div></div><p class="title"><b>Figure 8.12. Debug as Drools Application Configuration</b></p></div><br class="figure-break"/><p>After clicking the "Debug" button, the application starts
      executing and will halt if any breakpoint is encountered. This can be a
      Drools rule breakpoint, or any other standard Java breakpoint. Whenever
      a Drools rule breakpoint is encountered, the corresponding DRL file is
      opened and the active line is highlighted. The Variables view also
      contains all rule parameters and their value. You can then use the
      default Java debug actions to decide what to do next: resume, terminate,
      step over, etc. The debug view can also be used to inspect the contents
      of the Working Memory and the Agenda at that time as well. You don't
      have to select a Working Memory now, as the current executing working
      memory is automatically shown.</p><div class="figure"><a id="d0e8334"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-IDE/debug.png" align="middle" alt="Debugging"/></div></div><p class="title"><b>Figure 8.13. Debugging</b></p></div><br class="figure-break"/></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8340"/>Chapter 9. Examples</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e8343">9.1. Getting the Examples</a></span></dt><dt><span class="section"><a href="#d0e8350">9.2. Hello World</a></span></dt><dt><span class="section"><a href="#d0e8618">9.3. State Example</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8623">9.3.1. Understanding the State Example</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8904">9.4. Fibonacci Example</a></span></dt><dt><span class="section"><a href="#d0e9110">9.5. Banking Tutorial</a></span></dt><dt><span class="section"><a href="#d0e9437">9.6. Pricing Rule Decision Table Example</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9461">9.6.1. Executing the example</a></span></dt><dt><span class="section"><a href="#d0e9503">9.6.2. The decision table</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e9568">9.7. Pet Store Example</a></span></dt><dt><span class="section"><a href="#d0e10130">9.8. Honest Politician Example</a></span></dt><dt><span class="section"><a href="#d0e10259">9.9. Sudoku Example</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10280">9.9.1. Sudoku Overview</a></span></dt><dt><span class="section"><a href="#d0e10294">9.9.2. Running the Example</a></span></dt><dt><span class="section"><a href="#d0e10361">9.9.3. Java Source and Rules Overview</a></span></dt><dt><span class="section"><a href="#d0e10491">9.9.4. Sudoku Validator Rules (validate.drl)</a></span></dt><dt><span class="section"><a href="#d0e10500">9.9.5. Sudoku Solving Rules (sudoku.drl)</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e10536">9.10. Number Guess</a></span></dt><dt><span class="section"><a href="#d0e10827">9.11. Miss Manners and Benchmarking</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10849">9.11.1. Introduction</a></span></dt><dt><span class="section"><a href="#d0e10935">9.11.2. Indepth Discussion</a></span></dt><dt><span class="section"><a href="#d0e11145">9.11.3. Output Summary</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e11200">9.12. Conway's Game Of Life</a></span></dt></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8343"/>9.1. Getting the Examples</h2></div></div></div><p>Make sure the Drools Eclipse plugin is installed, which
      needs the Graphical Editing Framework (GEF) dependency installed
                        first. Then download and extract the
      drools-examples zip file, which includes an already created Eclipse
      project. Import that project into a new Eclipse workspace. The rules
      all have example classes that execute the rules. If you want to try
      the examples in another project (or another IDE) then you will need
      to set up the dependencies by hand, of course. Many, but not all of the
      examples are documented below, enjoy!</p><p>Some examples require Java 1.6 to run.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8350"/>9.2. Hello World</h2></div></div></div><pre class="screen"><span class="bold"><strong>Name:</strong></span> Hello World
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.helloworld.HelloWorldExample
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> HelloWorld.drl
<span class="bold"><strong>Objective:</strong></span> demonstrate basic rules in use</pre><p>The "Hello World" example shows a simple example of rules usage, and
  both the MVEL and Java dialects.</p><p>This example demonstrates how to build Knowledge Bases and Sessions.
  Also, audit logging and debug outputs are shown, which is ommitted
  from other examples as it's all very similar. A <code class="code">KnowledgeBuilder</code>
  is used to turn a DRL source file into <code class="code">Package</code> objects which
  the Knowledge Base can consume. The add method takes a <code class="code">Resource</code>
  interface and a Resource Type as parameters. The <code class="code">Resource</code> can be 
  used to retrieve a DRL source file from various locations; in this case the
  DRL file is being retrieved from the classpath using a
  <code class="code">ResourceFactory</code>, but it could come from a disk file or a URL.
  Here, we only add a single DRL source file, but multiple DRL files can be 
  added. Also, DRL files with different namespaces can be added, where
  the Knowledge Builder creates a package for each namespace. Multiple
  packages of different namespaces can be added to the same Knowledge Base.
  When all the DRL files have been added, we should check the builder for 
  errors. While the Knowledge Base will validate the package, it will only
  have access to the error information as a String, so if you wish to debug
  the error information you should do it on the <code class="code">KnowledgeBuilder</code>
  instance. Once you know the builder is error free, get the
  <code class="code">Package</code> collection, instantiate a <code class="code">KnowledgeBase</code>
  from the <code class="code">KnowledgeBaseFactory</code> and add the package
  collection.</p><div class="example"><a id="d0e8403"/><p class="title"><b>Example 9.1. HelloWorld: Creating the KnowledgeBase and Session</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">final</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_plain">&nbsp;will&nbsp;parse&nbsp;and&nbsp;compile&nbsp;in&nbsp;one&nbsp;step</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_literal">&quot;HelloWorld.drl&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">HelloWorldExample</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Check</span><span class="java_plain">&nbsp;the&nbsp;builder&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;errors</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">hasErrors</span><span class="java_separator">())</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">getErrors</span><span class="java_separator">().</span><span class="java_plain">toString</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throw</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">RuntimeException</span><span class="java_separator">(</span><span class="java_literal">&quot;Unable&nbsp;to&nbsp;compile&nbsp;\&quot;HelloWorld.drl\&quot;.&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;get&nbsp;the&nbsp;compiled&nbsp;packages&nbsp;</span><span class="java_separator">(</span><span class="java_plain">which&nbsp;are&nbsp;serializable</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">KnowledgePackage</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;pkgs&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;add&nbsp;the&nbsp;packages&nbsp;to&nbsp;a&nbsp;knowledgebase&nbsp;</span><span class="java_separator">(</span><span class="java_plain">deploy&nbsp;the&nbsp;knowledge&nbsp;packages</span><span class="java_separator">).</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">pkgs</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">StatefulKnowledgeSession</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">.</span><span class="java_plain">newStatefulKnowledgeSession</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>Drools has an event model that exposes much of what's happening
  internally. Two default debug listeners are supplied,
  <code class="code">DebugAgendaEventListener</code> and 
  <code class="code">DebugWorkingMemoryEventListener</code> which print out
  debug event information to the <code class="code">System.err</code> stream displayed
  in the Console window. Adding listeners to a
  Session is trivial, as shown below. The <code class="code">KnowledgeRuntimeLogger</code>
  provides execution auditing, the result of which can be viewed in a
  graphical viewer. The logger is actually a specialised implementation
  built on the Agenda and Working Memory listeners. When the engine has
  finished executing, <code class="code">logger.close()</code> must be called.</p><p>Most of the examples use the Audit logging features of Drools to
  record execution flow for later inspection.</p><div class="example"><a id="d0e8427"/><p class="title"><b>Example 9.2. HelloWorld: Event logging and Auditing</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;setup&nbsp;the&nbsp;debug&nbsp;listeners</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">addEventListener</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">DebugAgendaEventListener</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">addEventListener</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">DebugWorkingMemoryEventListener</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;setup&nbsp;the&nbsp;audit&nbsp;logging</span>
<!--  --><br/><span class="java_type">KnowledgeRuntimeLogger</span><span class="java_plain">&nbsp;logger&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">KnowledgeRuntimeLoggerFactory</span><span class="java_separator">.</span><span class="java_plain">newFileLogger</span><span class="java_separator">(</span><span class="java_plain">ksession</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;log/helloworld&quot;</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/><p>The single class used in this example is very simple. It has two
  fields: the message, which is a String and the status which can be one
  of the two integers <code class="code">HELLO</code> or <code class="code">GOODBYE</code>.</p><div class="example"><a id="d0e8440"/><p class="title"><b>Example 9.3. HelloWorld example: Message Class</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">static</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Message</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;HELLO&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;GOODBYE&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">1</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>A single <code class="code">Message</code> object is created with the
  message text "Hello World" and the status <code class="code">HELLO</code> and then
  inserted into the engine, at which point <code class="code">fireAllRules()</code>
  is executed. Remember that all the network evaluation is done
  during the insert time, so that by the time the program execution reaches the
  <code class="code">fireAllRules()</code> method call the engine already knows which rules
  are fully matches and able to fire.</p><div class="example"><a id="d0e8459"/><p class="title"><b>Example 9.4. HelloWorld: Execution</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">final</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Message</span><!-- <br/> --><span class="java_plain">&nbsp;message&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Message</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">message</span><span class="java_separator">.</span><span class="java_plain">setMessage</span><span class="java_separator">(</span><span class="java_literal">&quot;Hello&nbsp;World&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">message</span><span class="java_separator">.</span><span class="java_plain">setStatus</span><span class="java_separator">(</span><span class="java_type">Message</span><span class="java_separator">.</span><span class="java_plain">HELLO</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">message</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">logger</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">dispose</span><span class="java_separator">();</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span></pre></div></div><br class="example-break"/><p>To execute the example as a Java application:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Open the class org.drools.examples.helloworld.HelloWorldExample in your
      Eclipse IDE</p></li><li><p>Right-click the class and select "Run as..." and then "Java
      application"</p></li></ol></div><p>If we put a breakpoint on the <code class="code">fireAllRules()</code> method
  and select the <code class="code">ksession</code> variable, we can see that the
  "Hello World" rule is already activated and on the Agenda, confirming
  that all the pattern matching work was already done during the insert.</p><div class="figure"><a id="d0e8481"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/HelloWorldExample/helloworld_agenda1.png" alt="Hello World: fireAllRules Agenda View"/></div></div><p class="title"><b>Figure 9.1. Hello World: fireAllRules Agenda View</b></p></div><br class="figure-break"/><p>The may application print outs go to to System.out while the debug
  listener print outs go to System.err.</p><div class="example"><a id="d0e8489"/><p class="title"><b>Example 9.5. HelloWorld: System.out in the Console window</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Hello World
Goodbye cruel world</pre></div></div><br class="example-break"/><div class="example"><a id="d0e8494"/><p class="title"><b>Example 9.6. HelloWorld: System.err in the Console window</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">==&gt;[ActivationCreated(0): rule=Hello World; 
                   tuple=[fid:1:1:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]]
[ObjectInserted: handle=[fid:1:1:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96];
                 object=org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]
[BeforeActivationFired: rule=Hello World; 
                   tuple=[fid:1:1:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]]
==&gt;[ActivationCreated(4): rule=Good Bye; 
                   tuple=[fid:1:2:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]]
[ObjectUpdated: handle=[fid:1:2:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96];
                old_object=org.drools.examples.helloworld.HelloWorldExample$Message@17cec96;
                new_object=org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]
[AfterActivationFired(0): rule=Hello World]
[BeforeActivationFired: rule=Good Bye; 
                   tuple=[fid:1:2:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]]
[AfterActivationFired(4): rule=Good Bye]  </pre></div></div><br class="example-break"/><p>The LHS (after <code class="literal">when</code>) section of the rule states that it will be
  activated for each <code class="code">Message</code> object inserted into the Working
  Memory whose status is <code class="code">Message.HELLO</code>. Besides that, two 
  variable bindings are created: the variable <code class="code">message</code> is bound
  to the <code class="code">message</code> attribute and the variable <code class="code">m</code>
  is bound to the matched <code class="code">Message</code> object itself.</p><p>The RHS (after <code class="literal">then</code>) or consequence part of the rule is
  written using the MVEL expression language, as declared by
  the rule's attribute <code class="code">dialect</code>. After printing the content of
  the bound variable <code class="code">message</code> to <code class="code">System.out</code>,
  the rule changes the values of the <code class="code">message</code> and
  <code class="code">status</code> attributes of the <code class="code">Message</code> object
  bound to <code class="code">m</code>. This is done MVEL's <code class="literal">modify</code> statement,
  which allows you to apply a block of assignments in one statement, with the
  engine being automatically notified of the changes at the end of the 
  block.</p><div class="example"><a id="d0e8551"/><p class="title"><b>Example 9.7. HelloWorld: rule "Hello World"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Hello World"
      dialect "mvel"
  when
      m : Message( status == Message.HELLO, message : message )
  then
      System.out.println( message ); 
      modify ( m ) { message = "Goodbyte cruel world",
                     status = Message.GOODBYE };
end</pre></div></div><br class="example-break"/><p>We can set a breakpoint into the DRL, on the <code class="literal">modify</code>
  call, and inspect the Agenda view again during the execution of the
  rule's consequence. This time we start the execution via "Debug As"
  and "Drools application" and not by running a "Java application":</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Open the class <code class="code">org.drools.examples.HelloWorld</code> in your
      Eclipse IDE.</p></li><li><p>Right-click the class and select "Debug as..." and then "Drools
      application".</p></li></ol></div><p>Now we can see that the other rule <code class="code">"Good Bye"</code>, which
  uses the Java dialect, is activated and placed on the Agenda.</p><div class="figure"><a id="d0e8576"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/HelloWorldExample/helloworld_agenda2.png" alt="Hello World: rule &#34;Hello World&#34; Agenda View"/></div></div><p class="title"><b>Figure 9.2. Hello World: rule "Hello World" Agenda View</b></p></div><br class="figure-break"/><p>The "Good Bye" rule, which specifies the "java" dialect, is similar
  to the "Hello World" rule except that it matches <code class="code">Message</code>
  objects whose  status is <code class="code">Message.GOODBYE</code>.</p><div class="example"><a id="d0e8590"/><p class="title"><b>Example 9.8. HelloWorld: rule "Good Bye"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Good Bye"
      dialect "java"
  when
      Message( status == Message.GOODBYE, message : message )
  then
      System.out.println( message ); 
end</pre></div></div><br class="example-break"/><p>Remember the Java code where we used the
  <code class="code">KnowledgeRuntimeLoggerFactory</code> method <code class="code">newFileLogger</code>
  to create a <code class="code">KnowledgeRuntimeLogger</code> and called
  <code class="code">logger.close()</code> at the end. This created an audit log file that
  can be shown in the Audit view. We use the Audit view in many of the
  examples to demostrate the example execution flow. In the view screen shot
  below we can see that the object is inserted, which creates an activation
  for the "Hello World" rule; the activation is then executed which updates
  the <code class="code">Message</code> object causing the "Good Bye" rule to
  activate; finally the "Good Bye" rule also executes. Selecting an event in
  the Audit view highlights the origin event in green; therefore the
  "Activation created" event is highlighted in green as the origin of the
  "Activation executed" event.</p><div class="figure"><a id="d0e8612"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/HelloWorldExample/helloworld_auditview1.png" alt="Hello World: Audit View"/></div></div><p class="title"><b>Figure 9.3. Hello World: Audit View</b></p></div><br class="figure-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8618"/>9.3. State Example</h2></div></div></div><p>This example is implemented in three different versions to
    demonstrate different ways of implementing the same basic behavior:
    forward chaining, i.e., the ability the engine has to  evaluate,
    activate and fire rules in sequence, based on changes on the facts
    in the Working Memory.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e8623"/>9.3.1. Understanding the State Example</h3></div></div></div><pre class="screen"><span class="bold"><strong>Name:</strong></span> State Example
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.state.StateExampleUsingSalience
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> StateExampleUsingSalience.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrates basic rule use
  and Conflict Resolution for rule firing priority.</pre><p>Each <code class="code">State</code> class has fields for its name and its
      current state (see the class <code class="code">org.drools.examples.state.State</code>).
      The two possible states for each objects are:</p><div class="itemizedlist"><ul><li><p><code class="code">NOTRUN</code></p></li><li><p><code class="code">FINISHED</code></p></li></ul></div><div class="example"><a id="d0e8662"/><p class="title"><b>Example 9.9. State Class</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">State</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;NOTRUN&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;FINISHED&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">1</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">PropertyChangeSupport</span><span class="java_plain">&nbsp;changes&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">PropertyChangeSupport</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;state</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;setters&nbsp;and&nbsp;getters&nbsp;go&nbsp;here</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Ignoring the <code class="code">PropertyChangeSupport</code>, which will
      be explained later, we see the creation of four <code class="code">State</code>
      objects named A, B, C and D. Initially their states are set to
      <code class="code">NOTRUN</code>, which is default for the used constructor.
      Each instance is asserted in turn into the Session and then
      <code class="code">fireAllRules()</code> is called.</p><div class="example"><a id="d0e8681"/><p class="title"><b>Example 9.10. Salience State: Execution</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">State</span><!-- <br/> --><span class="java_plain">&nbsp;a&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">State</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;A&quot;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">State</span><span class="java_plain">&nbsp;b&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">State</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;B&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">State</span><span class="java_plain">&nbsp;c&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">State</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;C&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">State</span><span class="java_plain">&nbsp;d&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">State</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;D&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">By</span><span class="java_plain">&nbsp;setting&nbsp;dynamic&nbsp;to&nbsp;TRUE</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Drools</span><span class="java_plain">&nbsp;will&nbsp;use&nbsp;</span><span class="java_type">JavaBean</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">PropertyChangeListeners</span><span class="java_plain">&nbsp;so&nbsp;you&nbsp;don't&nbsp;have&nbsp;to&nbsp;call&nbsp;modify&nbsp;or&nbsp;update</span><span class="java_separator">().</span>
<!--  --><br/><span class="java_type">boolean</span><span class="java_plain">&nbsp;dynamic&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;a</span><span class="java_separator">,</span><span class="java_plain">&nbsp;dynamic&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;b</span><span class="java_separator">,</span><span class="java_plain">&nbsp;dynamic&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;c</span><span class="java_separator">,</span><span class="java_plain">&nbsp;dynamic&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;d</span><span class="java_separator">,</span><span class="java_plain">&nbsp;dynamic&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">dispose</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Stateful</span><span class="java_plain">&nbsp;rule&nbsp;session&nbsp;must&nbsp;always&nbsp;be&nbsp;disposed&nbsp;when&nbsp;finished</span></pre></div></div><br class="example-break"/><p>To execute the application:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Open the class <code class="code">org.drools.examples.state.StateExampleUsingSalience</code> in your Eclipse IDE.</p></li><li><p>Right-click the class and select "Run as..." and then
          "Java application"</p></li></ol></div><p>You will see the following output in the Eclipse console
      window:</p><div class="example"><a id="d0e8700"/><p class="title"><b>Example 9.11. Salience State: Console Output</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">A finished
B finished
C finished
D finished
</pre></div></div><br class="example-break"/><p>There are four rules in total. First, the <code class="code">Bootstrap</code>
      rule fires, setting A to state <code class="code">FINISHED</code>, which then
      causes B to change its state to <code class="code">FINISHED</code>. C and D are
      both dependent on B, causing a conflict which is resolved by the
      salience values. Let's look at the way this was executed.</p><p>The best way to understand what is happening is to use the
      Audit Logging feature to graphically see the results of each
      operation. To view the Audit log generated by a run of this
      example:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>If the Audit View is not visible, click on "Window" and
          then select "Show View", then "Other..." and "Drools" and
          finally "Audit View".</p></li><li><p>In the "Audit View" click the "Open Log" button and select
          the file "&lt;drools-examples-dir&gt;/log/state.log".</p></li></ol></div><p>After that, the "Audit view" will look like the following
      screenshot:</p><div class="figure"><a id="d0e8727"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/StateExample/state_example_audit1.png" alt="Salience State Example Audit View"/></div></div><p class="title"><b>Figure 9.4. Salience State Example Audit View</b></p></div><br class="figure-break"/><p>Reading the log in the "Audit View", top to bottom, we see every
      action and the corresponding changes in the Working Memory. This way
      we observe that the assertion of the State object A in the state
      <code class="code">NOTRUN</code> activates the <code class="code">Bootstrap</code> rule, while
      the assertions of the other <code class="code">State</code> objects have no
      immediate effect.</p><div class="example"><a id="d0e8744"/><p class="title"><b>Example 9.12. Salience State: Rule "Bootstrap"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule Bootstrap
    when
        a : State(name == "A", state == State.NOTRUN )
    then
        System.out.println(a.getName() + " finished" );
        a.setState( State.FINISHED );
end</pre></div></div><br class="example-break"/><p>The execution of rule Bootstrap changes the state of A to
      <code class="code">FINISHED</code>, which, in turn, activates rule "A to B".</p><div class="example"><a id="d0e8754"/><p class="title"><b>Example 9.13. Salience State: Rule "A to B"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "A to B"
    when
        State(name == "A", state == State.FINISHED )
        b : State(name == "B", state == State.NOTRUN )
    then
        System.out.println(b.getName() + " finished" );
        b.setState( State.FINISHED );
end
</pre></div></div><br class="example-break"/><p>The execution of rule "A to B" changes the state of B to
      <code class="code">FINISHED</code>, which activates both, rules "B to C" and
      "B to D", placing their Activations onto the Agenda. From this moment
      on, both rules may fire and, therefore, they are said to be
      "in conflict". The conflict resolution strategy allows the engine's
      Agenda to decide which rule to fire. As rule "B to C"  has the
      <span class="bold"><strong>higher salience value</strong></span> (10 versus
      the default salience value of 0), it fires first, modifying object C
      to state <code class="code">FINISHED</code>. The Audit view shown above reflects
      the  modification of the <code class="code">State</code> object in the rule "A to B",
      which results in two activations being in conflict. The Agenda view
      can also be used to investigate the state of the Agenda, with debug
      points being placed in the rules themselves and the Agenda view opened.
      The screen shot below shows the breakpoint in the rule "A to B" and
      the state of the Agenda with the two conflicting rules.</p><div class="figure"><a id="d0e8773"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/StateExample/state_example_agenda1.png" alt="State Example Agenda View"/></div></div><p class="title"><b>Figure 9.5. State Example Agenda View</b></p></div><br class="figure-break"/><div class="example"><a id="d0e8779"/><p class="title"><b>Example 9.14. Salience State: Rule "B to C"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "B to C"
        salience 10
    when
        State(name == "B", state == State.FINISHED )
        c : State(name == "C", state == State.NOTRUN )
    then
        System.out.println(c.getName() + " finished" );
        c.setState( State.FINISHED );
end
</pre></div></div><br class="example-break"/><p>Rule "B to D"  fires last, modifying object D to state
      <code class="code">FINISHED</code>.</p><div class="example"><a id="d0e8789"/><p class="title"><b>Example 9.15. Salience State: Rule "B to D"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "B to D"
    when
        State(name == "B", state == State.FINISHED )
        d : State(name == "D", state == State.NOTRUN )
    then
        System.out.println(d.getName() + " finished" );
        d.setState( State.FINISHED );
end</pre></div></div><br class="example-break"/><p>There are no more rules to execute and so the engine stops.</p><p>Another notable concept in this example is the use of
      <span class="emphasis"><em>dynamic facts</em></span>, based on
      <code class="code">PropertyChangeListener</code> objects. As described in the
      documentation, in order for the engine to see and react to changes of
      fact properties, the application must tell the engine that changes
      occurred. This can be done explicitly in the rules by using the
      <code class="literal">modify</code> statement, or implicitly by letting the engine know
      that the facts implement <code class="code">PropertyChangeSupport</code> as defined
      by the <span class="emphasis"><em>JavaBeans specification</em></span>. This example
      demonstrates how to use <code class="code">PropertyChangeSupport</code> to avoid
      the need for explicit <code class="literal">modify</code> statements in the rules. To
      make use of this feature, ensure that your facts implement
      <code class="code">PropertyChangeSupport</code>, the same way the class
      <code class="code">org.drools.example.State</code> does, and use the following
      code to insert the facts into the Working Memory:</p><div class="example"><a id="d0e8825"/><p class="title"><b>Example 9.16. Inserting a Dynamic Fact</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">By</span><!-- <br/> --><span class="java_plain">&nbsp;setting&nbsp;dynamic&nbsp;to&nbsp;TRUE</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Drools</span><!-- <br/> --><span class="java_plain">&nbsp;will&nbsp;use&nbsp;</span><!-- <br/> --><span class="java_type">JavaBean</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">PropertyChangeListeners</span><span class="java_plain">&nbsp;so&nbsp;you&nbsp;don't&nbsp;have&nbsp;to&nbsp;call&nbsp;modify&nbsp;or&nbsp;update</span><span class="java_separator">().</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;dynamic&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;fact</span><span class="java_separator">,</span><span class="java_plain">&nbsp;dynamic&nbsp;</span><span class="java_separator">);</span>
</pre></div></div><br class="example-break"/><p>When using <code class="code">PropertyChangeListener</code> objects, each
      setter must implement a little extra code for the notification. Here
      is the setter for <code class="code">state</code> in the class
      <code class="code">org.drools.examples</code>:</p>:
  
      <div class="example"><a id="d0e8842"/><p class="title"><b>Example 9.17. Setter Example with PropertyChangeSupport</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">void</span><!-- <br/> --><span class="java_plain">&nbsp;setState</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">final</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">int</span><!-- <br/> --><span class="java_plain">&nbsp;newState</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;oldState&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">state</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">state&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;newState</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">changes</span><span class="java_separator">.</span><span class="java_plain">firePropertyChange</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;state&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oldState</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newState&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>There are two other classes in this example:
      <code class="code">StateExampleUsingAgendGroup</code> and
      <code class="code">StateExampleWithDynamicRules</code>. Both execute from A to B
      to C to D, as just shown. The <code class="code">StateExampleUsingAgendGroup</code>
      uses agenda-groups to control the rule conflict and which one fires
      first. <code class="code">StateExampleWithDynamicRules</code> shows how an
      additional rule can be added to an already running Working Memory
      with all the existing data applying to it at runtime.</p><p>Agenda groups are a way to partition the Agenda into groups
      and to control which groups can execute. By default, all rules are
      in the agenda group "MAIN". The "agenda-group" attribute lets
      you specify a different agenda group for the rule. Initially,
      a Working Memory has its focus on the Agenda group "MAIN". A group's
      rules will only fire when the group receives the focus. This can be
      achieved either ny using the method by <code class="code">setFocus()</code> or the
      rule attribute <code class="literal">auto-focus</code>. "auto-focus" means that the rule
      automatically sets the focus to its agenda group when the rule is
      matched and activated. It is this "auto-focus" that enables rule
      "B to C" to fire before "B to D".</p><div class="example"><a id="d0e8869"/><p class="title"><b>Example 9.18. Agenda Group State Example: Rule "B to C"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "B to C"
      agenda-group "B to C"
      auto-focus true       
  when
      State(name == "B", state == State.FINISHED )      
      c : State(name == "C", state == State.NOTRUN )
  then
      System.out.println(c.getName() + " finished" );
      c.setState( State.FINISHED );
      kcontext.getKnowledgeRuntime().getAgenda().getAgendaGroup( "B to D" ).setFocus();
end</pre></div></div><br class="example-break"/><p>The rule "B to C" calls <code class="code">setFocus()</code> on the
      agenda group "B to D", allowing its active rules
      to fire, which allows the rule "B to D" to fire.</p><div class="example"><a id="d0e8879"/><p class="title"><b>Example 9.19. Agenda Group State Example: Rule "B to D"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "B to D"
      agenda-group "B to D"
  when
      State(name == "B", state == State.FINISHED )      
      d : State(name == "D", state == State.NOTRUN )
  then
      System.out.println(d.getName() + " finished" );
      d.setState( State.FINISHED );
end</pre></div></div><br class="example-break"/><p>The example <code class="code">StateExampleWithDynamicRules</code> adds
      another rule to the Rule Base after <code class="code">fireAllRules()</code>.
      The added rule is just another state transition.</p><div class="example"><a id="d0e8892"/><p class="title"><b>Example 9.20. Dynamic State Example: Rule "D to E"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "D to E"
  when
      State(name == "D", state == State.FINISHED )      
      e : State(name == "E", state == State.NOTRUN )
  then
      System.out.println(e.getName() + " finished" );
      e.setState( State.FINISHED );
end</pre></div></div><br class="example-break"/><p>This produces the following expected output:</p><div class="example"><a id="d0e8899"/><p class="title"><b>Example 9.21. Dynamic Sate Example Output</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">A finished
B finished
C finished
D finished
E finished
</pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e8904"/>9.4. Fibonacci Example</h2></div></div></div><pre class="screen"><span class="bold"><strong>Name:</strong></span> Fibonacci 
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.fibonacci.FibonacciExample
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> Fibonacci.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrates Recursion,
  the CE <code class="literal">not</code> and cross product matching</pre><p>The Fibonacci Numbers (see <a class="ulink" href="http://en.wikipedia.org/wiki/Fibonacci_number">http://en.wikipedia.org/wiki/Fibonacci_number</a>)
    discovered by Leonardo of Pisa (see <a class="ulink" href="http://en.wikipedia.org/wiki/Fibonacci">http://en.wikipedia.org/wiki/Fibonacci</a>) is a sequence 
    that starts with 0 and 1. The next Fibonacci number is obtained by adding
    the two preceding Fibonacci numbers. The Fibonacci sequence begins with
    0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597,
    2584, 4181, 6765, 10946,... The Fibonacci Example demonstrates recursion
    and conflict resolution with salience values.</p><p>The single fact class <code class="code">Fibonacci</code> is used in this
    example. It has two fields, sequence and value. The sequence field
    is used to indicate the position of the object in the Fibonacci
    number sequence. The value field shows the value of that
    Fibonacci object for that sequence position, using -1 to indicate
    a value that still needs to be computed.</p><div class="example"><a id="d0e8942"/><p class="title"><b>Example 9.22. Fibonacci Class</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">static</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Fibonacci</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;sequence</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">long</span><span class="java_plain">&nbsp;value</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Fibonacci</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;sequence&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">sequence&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;sequence</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">value&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_operator">-</span><span class="java_literal">1</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;setters&nbsp;and&nbsp;getters&nbsp;go&nbsp;here</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Execute the example:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Open the class <code class="classname">org.drools.examples.fibonacci.FibonacciExample</code> in your Eclipse IDE.</p></li><li><p>Right-click the class and select "Run as..." and then
        "Java application"</p></li></ol></div><p>Eclipse shows the following output in its console window (with
    "...snip..." indicating lines that were removed to save space):</p><div class="example"><a id="d0e8961"/><p class="title"><b>Example 9.23. Fibonacci Example: Console Output</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">recurse for 50
recurse for 49
recurse for 48
recurse for 47
...snip...
recurse for 5
recurse for 4
recurse for 3
recurse for 2
1 == 1
2 == 1
3 == 2
4 == 3
5 == 5
6 == 8
...snip...
47 == 2971215073
48 == 4807526976
49 == 7778742049
50 == 12586269025
</pre></div></div><br class="example-break"/><p>To kick this off from Java we only insert a single Fibonacci
    object, with a sequence field of 50. A recursive rule is then used
    to insert the other 49 <code class="code">Fibonacci</code> objects. This example
    doesn't use
    <code class="code">PropertyChangeSupport</code>. It uses the MVEL dialect, which
    means we can use the <code class="literal">modify</code> keyword, which allows a block
    setter action which also notifies the engine of changes.</p><div class="example"><a id="d0e8977"/><p class="title"><b>Example 9.24. Fibonacci Example: Execution</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">ksession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">insert</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Fibonacci</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">50</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>The rule Recurse is very simple. It matches each asserted
    <code class="code">Fibonacci</code> object with a value of -1, creating and 
    asserting a new <code class="code">Fibonacci</code> object with a sequence of
    one less than the currently matched object. Each time a Fibonacci
    object is added while the one with a sequence field equal to 1
    does not exist, the rule re-matches and fires again. The
    <code class="literal">not</code> conditional element is used to stop the rule's matching
    once we have all 50 Fibonacci objects in memory. The rule also has a
    salience value, because we need to have all 50 <code class="code">Fibonacci</code>
    objects asserted before we execute the Bootstrap rule.</p><div class="example"><a id="d0e8996"/><p class="title"><b>Example 9.25. Fibonacci Example: Rule "Recurse"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule Recurse
    salience 10
    when
        f : Fibonacci ( value == -1 )
        not ( Fibonacci ( sequence == 1 ) )
    then
        insert( new Fibonacci( f.sequence - 1 ) );
        System.out.println( "recurse for " + f.sequence );
end</pre></div></div><br class="example-break"/><p>The Audit view shows the original assertion of the
    <code class="code">Fibonacci</code> object with a sequence field of 50, done from
    Java code. From there on, the Audit view shows the continual
    recursion of the rule, where each asserted <code class="code">Fibonacci</code>
    object causes the Recurse rule to become activated and to fire again.</p><div class="figure"><a id="d0e9009"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/FibonacciExample/fibonacci1.png" alt="Fibonacci Example: &#34;Recurse&#34; Audit View 1"/></div></div><p class="title"><b>Figure 9.6. Fibonacci Example: "Recurse" Audit View 1</b></p></div><br class="figure-break"/><p>When a <code class="code">Fibonacci</code> object with a sequence field of 2 is
    asserted the "Bootstrap" rule is matched and activated along with the
    "Recurse" rule. Note the multi-restriction on field
    <code class="code">sequence</code>, testing for equality with 1 or 2.</p><div class="example"><a id="d0e9023"/><p class="title"><b>Example 9.26. Fibonacci Example: Rule "Bootstrap"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule Bootstrap
    when
        f : Fibonacci( sequence == 1 || == 2, value == -1 ) // multi-restriction
    then 
        modify ( f ){ value = 1 };
        System.out.println( f.sequence + " == " + f.value );
end</pre></div></div><br class="example-break"/><p>At this point the Agenda looks as shown below. However,
    the "Bootstrap" rule does not fire because the "Recurse" rule has a higher
    salience.</p><div class="figure"><a id="d0e9030"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/FibonacciExample/fibonacci_agenda1.png" alt="Fibonacci Example: &#34;Recurse&#34; Agenda View 1"/></div></div><p class="title"><b>Figure 9.7. Fibonacci Example: "Recurse" Agenda View 1</b></p></div><br class="figure-break"/><p>When a <code class="code">Fibonacci</code> object with a sequence of 1 is
    asserted the Bootstrap rule is matched again, causing two activations
    for this rule. Note that the "Recurse" rule does not match and activate
    because the <code class="literal">not</code> conditional element stops the rule's matching
    as soon as a <code class="code">Fibonacci</code> object with a sequence of 1
    exists.</p><div class="figure"><a id="d0e9047"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/FibonacciExample/fibonacci_agenda2.png" alt="Fibonacci Example: &#34;Recurse&#34; Agenda View 2"/></div></div><p class="title"><b>Figure 9.8. Fibonacci Example: "Recurse" Agenda View 2</b></p></div><br class="figure-break"/><p>Once we have two <code class="code">Fibonacci</code> objects with values
    not equal to -1 the "Calculate" rule is able to match. It was
    the "Bootstrap" rule that set the objects with sequence 1 and 2 to
    values of 1. At this point we have 50 Fibonacci objects in the Working
    Memory. Now we need to select a suitable triple to calculate each
    of their values in turn. Using three Fibonacci patterns in a rule without
    field constraints to confine the possible cross products would result
    in 50x49x48 possible combinations, leading to about 125,000 possible rule
    firings, most of them incorrect. The "Calculate" rule uses field
    constraints to correctly constraint the thee Fibonacci patterns in the
    correct order; this
    technique is called <span class="emphasis"><em>cross product matching</em></span>. The
    first pattern finds any Fibonacci with a value != -1 and binds both
    the pattern and the field.  The second Fibonacci does this, too, but
    it adds an additional field constraint to ensure that its sequence is
    greater by one than the Fibonacci bound to <code class="code">f1</code>. When this
    rule fires for the first time, we know that only sequences 1 and 2
    have values of 1, and the two constraints ensure that <code class="code">f1</code>
    references sequence 1 and <code class="code">f2</code> references sequence 2. The
    final pattern finds the Fibonacci with a value equal to -1 and with a
    sequence one greater than <code class="code">f2</code>. At this point, we have
    three <code class="code">Fibonacci</code> objects correctly selected from the
    available cross products, and we can calculate the value for the
    third <code class="code">Fibonacci</code> object that's bound to <code class="code">f3</code>.</p><div class="example"><a id="d0e9082"/><p class="title"><b>Example 9.27. Fibonacci Example: Rule "Calculate"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule Calculate
    when
        // Bind f1 and s1
        f1 : Fibonacci( s1 : sequence, value != -1 )
        // Bind f2 and v2; refer to bound variable s1
        f2 : Fibonacci( sequence == (s1 + 1), v2 : value != -1 )
        // Bind f3 and s3; alternative reference of f2.sequence
        f3 : Fibonacci( s3 : sequence == (f2.sequence + 1 ), value == -1 )      
    then
        // Note the various referencing rechniques.
        modify ( f3 ) { value = f1.value + v2 };
        System.out.println( s3 + " == " + f3.value );
end 
</pre></div></div><br class="example-break"/><p>The <code class="literal">modify</code> statement updated the value of the
    <code class="code">Fibonacci</code> object bound to <code class="code">f3</code>. This means
    we now have another new Fibonacci object with a value not equal to -1,
    which allows the "Calculate" rule to rematch and calculate the next
    Fibonacci number. The Audit view below shows how the firing of the
    last "Bootstrap" modifies the <code class="code">Fibonacci</code> object,
    enabling the "Calculate" rule to match, which then modifies
    another Fibonacci object allowing the "Calculate" rule to match again.
    This continues till the value is set for all <code class="code">Fibonacci</code>
    objects.</p><div class="figure"><a id="d0e9104"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/FibonacciExample/fibonacci4.png" alt="Fibonacci Example: &#34;Bootstrap&#34; Audit View"/></div></div><p class="title"><b>Figure 9.9. Fibonacci Example: "Bootstrap" Audit View</b></p></div><br class="figure-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e9110"/>9.5. Banking Tutorial</h2></div></div></div><pre class="screen"><span class="bold"><strong>Name:</strong></span> BankingTutorial
<span class="bold"><strong>Main class:</strong></span> org.drools.tutorials.banking.BankingExamplesApp.java
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> org.drools.tutorials.banking.*.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrate pattern matching, basic sorting and calculation rules.</pre><p>This tutorial demonstrates the process of developing a
    complete personal banking application to handle credits and debits on
    multiple accounts. It uses a set of design patterns that have
    been created for the process.</p><p>The class <code class="code">RuleRunner</code> is a simple harness to execute
    one or more DRL files against a set of data. It compiles the Packages 
    and creates the Knowledge Base for each execution, allowing us to
    easily execute each scenario and inspect the outputs. In reality this
    is not a good solution for a production system, where the Knowledge Base
    should be built just once and cached, but for the purposes of this
    tutorial it shall suffice.</p><div class="example"><a id="d0e9139"/><p class="title"><b>Example 9.28. Banking Tutorial: RuleRunner</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">RuleRunner</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">RuleRunner</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;runRules</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;rules</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;facts</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kbuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;i&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span><span class="java_plain">&nbsp;i&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">&nbsp;rules</span><span class="java_separator">.</span><span class="java_plain">length</span><span class="java_separator">;</span><span class="java_plain">&nbsp;i</span><span class="java_operator">++</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;ruleFile&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;rules</span><span class="java_separator">[</span><span class="java_plain">i</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Loading&nbsp;file:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;ruleFile&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;ruleFile</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">RuleRunner</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Collection</span><span class="java_operator">&lt;</span><span class="java_type">KnowledgePackage</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;pkgs&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;pkgs&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">StatefulKnowledgeSession</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">.</span><span class="java_plain">newStatefulKnowledgeSession</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;i&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span><span class="java_plain">&nbsp;i&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">&nbsp;facts</span><span class="java_separator">.</span><span class="java_plain">length</span><span class="java_separator">;</span><span class="java_plain">&nbsp;i</span><span class="java_operator">++</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_plain">&nbsp;fact&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;facts</span><span class="java_separator">[</span><span class="java_plain">i</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Inserting&nbsp;fact:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;fact&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;fact&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>The first of our sample Java classes loads and executes a single
    DRL file, <code class="filename">Example.drl</code>, but without inserting any
    data.</p><div class="example"><a id="d0e9149"/><p class="title"><b>Example 9.29. Banking Tutorial : Java Example1</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Example1</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;main</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;args</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">RuleRunner</span><span class="java_separator">().</span><span class="java_plain">runRules</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Example1.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">},</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[</span><span class="java_literal">0</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>The first simple rule to execute has a single <code class="literal">eval</code>
    condition that will alway be true, so that this rule will match and
    fire, once, after the start.</p><div class="example"><a id="d0e9159"/><p class="title"><b>Example 9.30. Banking Tutorial: Rule in Example1.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Rule 01"   
    when
        eval( 1==1 )
    then
        System.out.println( "Rule 01 Works" );
endh</pre></div></div><br class="example-break"/><p>The output for the rule is below, showing that the rule matches
    and executes the single print statement.</p><div class="example"><a id="d0e9166"/><p class="title"><b>Example 9.31. Banking Tutorial: Output of Example1.java</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Loading file: Example1.drl
Rule 01 Works</pre></div></div><br class="example-break"/><p>The next step is to assert some simple facts and print them
    out.</p><div class="example"><a id="d0e9173"/><p class="title"><b>Example 9.32. Banking Tutorial: Java Example2</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Example2</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;main</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;args</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Number</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;numbers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Number</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">wrap</span><span class="java_separator">(</span><span class="java_literal">3</span><span class="java_separator">),</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">),</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_literal">4</span><span class="java_separator">),</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">),</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_literal">5</span><span class="java_separator">)};</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">RuleRunner</span><span class="java_separator">().</span><span class="java_plain">runRules</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Example2.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">},</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numbers&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_type">Integer</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;i&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Integer</span><span class="java_separator">(</span><span class="java_plain">i</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>This doesn’t use any specific facts but instead asserts a set
    of <code class="code">java.lang.Integer</code> objects. This is not considered
    "best practice" as a number is not a useful fact, but we use it here
    to demonstrate basic techniques before more complexity is added.</p><p>Now we will create a simple rule to print out these numbers.</p><div class="example"><a id="d0e9185"/><p class="title"><b>Example 9.33. Banking Tutorial: Rule in Example2.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Rule 02"
    when
        Number( $intValue : intValue )
    then
        System.out.println( "Number found with value: " + $intValue ); 
end</pre></div></div><br class="example-break"/><p>Once again, this rule does nothing special. It identifies any
    facts that are <code class="code">Number</code> objects and prints out the values.
    Notice the use of the abstract class <code class="code">Number</code>: we inserted
    <code class="code">Integer</code> objects but we now look for any kind of number.
    The pattern matching engine is able to match interfaces and
    superclasses of asserted objects.</p><p>The output shows the DRL being loaded, the facts inserted and
    then the matched and fired rules. We can see that each inserted number
    is matched and fired and thus printed.</p><div class="example"><a id="d0e9203"/><p class="title"><b>Example 9.34. Banking Tutorial: Output of Example2.java</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Loading file: Example2.drl
Inserting fact: 3
Inserting fact: 1
Inserting fact: 4
Inserting fact: 1
Inserting fact: 5
Number found with value: 5
Number found with value: 1
Number found with value: 4
Number found with value: 1
Number found with value: 3
</pre></div></div><br class="example-break"/><p>There are certainly many better ways to sort numbers than using
    rules, but since we will need to apply some cashflows in date order
    when we start looking at banking rules we'll develop simple rule
    based sorting technique.</p><div class="example"><a id="d0e9210"/><p class="title"><b>Example 9.35. Banking Tutorial: Example3.java</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Example3</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;main</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;args</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Number</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;numbers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Number</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">wrap</span><span class="java_separator">(</span><span class="java_literal">3</span><span class="java_separator">),</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">),</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_literal">4</span><span class="java_separator">),</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">),</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_literal">5</span><span class="java_separator">)};</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">RuleRunner</span><span class="java_separator">().</span><span class="java_plain">runRules</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Example3.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">},</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numbers&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_type">Integer</span><span class="java_plain">&nbsp;wrap</span><span class="java_separator">(</span><span class="java_type">int</span><span class="java_plain">&nbsp;i</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Integer</span><span class="java_separator">(</span><span class="java_plain">i</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Again we insert our <code class="code">Integer</code> objects, but this time the
    rule is slightly different:</p><div class="example"><a id="d0e9220"/><p class="title"><b>Example 9.36. Banking Tutorial: Rule in Example3.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Rule 03"
    when
        $number : Number( )
        not Number( intValue &lt; $number.intValue )
    then
        System.out.println("Number found with value: " + $number.intValue() ); 
        retract( $number );
end</pre></div></div><br class="example-break"/><p>The first line of the rule identifies a <code class="code">Number</code> and
    extracts the value. The second line ensures that there does not exist
    a smaller number than the one found by the first pattern. We might
    expect to match only one number - the smallest in the set. However,
    the retraction of the number after it has been printed means that the
    smallest number has been removed, revealing the next smallest number,
    and so on. </p><p>The resulting output shows that the numbers are now
    sorted numerically.</p><div class="example"><a id="d0e9232"/><p class="title"><b>Example 9.37. Banking Tutorial: Output of Example3.java</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Loading file: Example3.drl
Inserting fact: 3
Inserting fact: 1
Inserting fact: 4
Inserting fact: 1
Inserting fact: 5
Number found with value: 1
Number found with value: 1
Number found with value: 3
Number found with value: 4
Number found with value: 5
</pre></div></div><br class="example-break"/><p>We are ready to start moving towards our personal accounting
    rules. The first step is to create a <code class="code">Cashflow</code> object.</p><div class="example"><a id="d0e9242"/><p class="title"><b>Example 9.38. Banking Tutorial: Class Cashflow</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Cashflow</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;&nbsp;&nbsp;date</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;amount</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Cashflow</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Cashflow</span><span class="java_separator">(</span><span class="java_type">Date</span><span class="java_plain">&nbsp;date</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;amount</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">date&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;date</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">amount&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;amount</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;getDate</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;date</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setDate</span><span class="java_separator">(</span><span class="java_type">Date</span><span class="java_plain">&nbsp;date</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">date&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;date</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;getAmount</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;amount</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setAmount</span><span class="java_separator">(</span><span class="java_type">double</span><span class="java_plain">&nbsp;amount</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">amount&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;amount</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Cashflow[date=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;date&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;,amount=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;amount&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;]&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Class <code class="code">Cashflow</code> has two simple attributes, a date
    and an amount. (Note that using the type <code class="code">double</code> for
    monetary units is generally <span class="emphasis"><em>not</em></span> a good idea
    because floating point numbers cannot represent most numbers accurately.)
    There is also an overloaded constructor to set the values, and a
    method <code class="code">toString</code> to print a cashflow. The Java code of
    <code class="filename">Example4.java</code> inserts five Cashflow objects,
    with varying dates and amounts.</p><div class="example"><a id="d0e9264"/><p class="title"><b>Example 9.39. Banking Tutorial: Example4.java</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Example4</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;main</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;args</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;cashflows&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;01/01/2007&quot;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">300.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;05/01/2007&quot;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">100.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;11/01/2007&quot;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">500.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;07/01/2007&quot;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">800.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;02/01/2007&quot;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">400.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">};</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">RuleRunner</span><span class="java_separator">().</span><span class="java_plain">runRules</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Example4.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">},</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cashflows&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>The convenience class <code class="code">SimpleDate</code> extends
    <code class="code">java.util.Date</code>, providing a constructor taking
    a String as input and defining a date format. The code is
    listed below</p><div class="example"><a id="d0e9277"/><p class="title"><b>Example 9.40. Banking Tutorial: Class SimpleDate</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">SimpleDate</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">extends</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Date</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDateFormat</span><span class="java_plain">&nbsp;format&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDateFormat</span><span class="java_separator">(</span><span class="java_literal">&quot;dd/MM/yyyy&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;datestr</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setTime</span><span class="java_separator">(</span><span class="java_plain">format</span><span class="java_separator">.</span><span class="java_plain">parse</span><span class="java_separator">(</span><span class="java_plain">datestr</span><span class="java_separator">).</span><span class="java_plain">getTime</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Now, let’s look at <code class="filename">Example4.drl</code> to see how
    we print the sorted <code class="code">Cashflow</code> objects:</p><div class="example"><a id="d0e9290"/><p class="title"><b>Example 9.41. Banking Tutorial: Rule in Example4.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Rule 04"   
    when
        $cashflow : Cashflow( $date : date, $amount : amount )
        not Cashflow( date &lt; $date)
    then
        System.out.println("Cashflow: "+$date+" :: "+$amount);  
        retract($cashflow);
end</pre></div></div><br class="example-break"/><p>Here, we identify a <code class="code">Cashflow</code> and extract the date
    and the amount. In the second line of the rule we ensure that there
    is no Cashflow with an earlier date than the one found. In the
    consequence, we print the <code class="code">Cashflow</code> that satisfies the
    rule and then retract it, making way for the next earliest
    <code class="code">Cashflow</code>. So, the output we generate is:</p><div class="example"><a id="d0e9306"/><p class="title"><b>Example 9.42. Banking Tutorial: Output of Example4.java</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Loading file: Example4.drl
Inserting fact: Cashflow[date=Mon Jan 01 00:00:00 GMT 2007,amount=300.0]
Inserting fact: Cashflow[date=Fri Jan 05 00:00:00 GMT 2007,amount=100.0]
Inserting fact: Cashflow[date=Thu Jan 11 00:00:00 GMT 2007,amount=500.0]
Inserting fact: Cashflow[date=Sun Jan 07 00:00:00 GMT 2007,amount=800.0]
Inserting fact: Cashflow[date=Tue Jan 02 00:00:00 GMT 2007,amount=400.0]
Cashflow: Mon Jan 01 00:00:00 GMT 2007 :: 300.0
Cashflow: Tue Jan 02 00:00:00 GMT 2007 :: 400.0
Cashflow: Fri Jan 05 00:00:00 GMT 2007 :: 100.0
Cashflow: Sun Jan 07 00:00:00 GMT 2007 :: 800.0
Cashflow: Thu Jan 11 00:00:00 GMT 2007 :: 500.0
</pre></div></div><br class="example-break"/><p>Next, we extend our <code class="code">Cashflow</code>, resulting in a
    <code class="code">TypedCashflow</code> which can be a credit or a debit operation.
    (Normally, we would just add this to the <code class="code">Cashflow</code> type, but
    we use extension to keep the previous version of the class intact.)</p><div class="example"><a id="d0e9322"/><p class="title"><b>Example 9.43. Banking Tutorial: Class TypedCashflow</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">TypedCashflow</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">extends</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Cashflow</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;CREDIT&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;DEBIT&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">1</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">(</span><span class="java_type">Date</span><span class="java_plain">&nbsp;date</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;type</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;amount</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">(</span><span class="java_plain">&nbsp;date</span><span class="java_separator">,</span><span class="java_plain">&nbsp;amount&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">type&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;type</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;getType</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;type</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setType</span><span class="java_separator">(</span><span class="java_type">int</span><span class="java_plain">&nbsp;type</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">type&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;type</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;TypedCashflow[date=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;getDate</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;,type=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">type&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;CREDIT&nbsp;</span><span class="java_operator">?</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Credit&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Debit&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;,amount=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;getAmount</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;]&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>There are lots of ways to improve this code, but for the sake
    of the example this will do.</p><p>Now let's create Example5, a class for running our code.</p><div class="example"><a id="d0e9331"/><p class="title"><b>Example 9.44. Banking Tutorial: Example5.java</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Example5</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;main</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;args</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;cashflows&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;01/01/2007&quot;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">CREDIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">300.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;05/01/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">CREDIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">100.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;11/01/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">CREDIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">500.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;07/01/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">DEBIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">800.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;02/01/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">DEBIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">400.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">};</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">RuleRunner</span><span class="java_separator">().</span><span class="java_plain">runRules</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Example5.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">},</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cashflows&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Here, we simply create a set of <code class="code">Cashflow</code> objects
    which are either credit or debit operations. We supply them and
    <code class="filename">Example5.drl</code> to the RuleEngine. </p><p>Now, let’s look at a rule printing the sorted
    <code class="code">Cashflow</code> objects.</p><div class="example"><a id="d0e9349"/><p class="title"><b>Example 9.45. Banking Tutorial: Rule in Example5.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Rule 05"  
    when
        $cashflow : TypedCashflow( $date : date,
                                   $amount : amount,
                                   type == TypedCashflow.CREDIT )
        not TypedCashflow( date &lt; $date,
                           type == TypedCashflow.CREDIT )
    then
        System.out.println("Credit: "+$date+" :: "+$amount);   
        retract($cashflow);
end</pre></div></div><br class="example-break"/><p>Here, we identify a <code class="code">Cashflow</code> fact with a type
    of <code class="code">CREDIT</code> and extract the date and the amount. In the
    second line of the rule we ensure that there is no <code class="code">Cashflow</code>
    of the same type with an earlier date than the one found. In the
    consequence, we print the cashflow satisfying the patterns and then
    retract it, making way for the next earliest cashflow of type
    <code class="code">CREDIT</code>.</p><p>So, the output we generate is</p><div class="example"><a id="d0e9370"/><p class="title"><b>Example 9.46. Banking Tutorial: Output of Example5.java</b></p><div class="example-contents"><pre class="screen">Loading file: Example5.drl
Inserting fact: TypedCashflow[date=Mon Jan 01 00:00:00 GMT 2007,type=Credit,amount=300.0]
Inserting fact: TypedCashflow[date=Fri Jan 05 00:00:00 GMT 2007,type=Credit,amount=100.0]
Inserting fact: TypedCashflow[date=Thu Jan 11 00:00:00 GMT 2007,type=Credit,amount=500.0]
Inserting fact: TypedCashflow[date=Sun Jan 07 00:00:00 GMT 2007,type=Debit,amount=800.0]
Inserting fact: TypedCashflow[date=Tue Jan 02 00:00:00 GMT 2007,type=Debit,amount=400.0]
Credit: Mon Jan 01 00:00:00 GMT 2007 :: 300.0
Credit: Fri Jan 05 00:00:00 GMT 2007 :: 100.0
Credit: Thu Jan 11 00:00:00 GMT 2007 :: 500.0
</pre></div></div><br class="example-break"/><p>Continuing our banking exercise, we are now going to process both
    credits and debits on two bank accounts, calculating the account balance.
    In order to do this, we create two separate <code class="code">Account</code> objects
    and inject them into the <code class="code">Cashflows</code> objects before passing
    them to the Rule Engine. The reason for this is to provide easy access
    to the correct account without having to resort to helper classes. Let’s
    take a look at the <code class="code">Account</code> class first. This is a simple
    Java object with an account number and balance:</p><div class="example"><a id="d0e9386"/><p class="title"><b>Example 9.47. Banking Tutorial: Class Account</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Account</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">long</span><span class="java_plain">&nbsp;&nbsp;&nbsp;accountNo</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;balance&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_separator">(</span><span class="java_type">long</span><span class="java_plain">&nbsp;accountNo</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">accountNo&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;accountNo</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">long</span><span class="java_plain">&nbsp;getAccountNo</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;accountNo</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setAccountNo</span><span class="java_separator">(</span><span class="java_type">long</span><span class="java_plain">&nbsp;accountNo</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">accountNo&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;accountNo</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;getBalance</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;balance</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setBalance</span><span class="java_separator">(</span><span class="java_type">double</span><span class="java_plain">&nbsp;balance</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">balance&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;balance</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Account[&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;accountNo=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;accountNo&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;,balance=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;balance&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;]&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Now let’s extend our <code class="code">TypedCashflow</code>, resulting in
    <code class="code">AllocatedCashflow</code>, to include an <code class="code">Account</code>
    reference.</p><div class="example"><a id="d0e9402"/><p class="title"><b>Example 9.48. Banking Tutorial: Class AllocatedCashflow</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">AllocatedCashflow</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">extends</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">TypedCashflow</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_plain">&nbsp;account</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_type">Account</span><span class="java_plain">&nbsp;account</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;date</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;type</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;amount</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">(</span><span class="java_plain">&nbsp;date</span><span class="java_separator">,</span><span class="java_plain">&nbsp;type</span><span class="java_separator">,</span><span class="java_plain">&nbsp;amount&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">account&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;account</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_plain">&nbsp;getAccount</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;account</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setAccount</span><span class="java_separator">(</span><span class="java_type">Account</span><span class="java_plain">&nbsp;account</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">account&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;account</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;AllocatedCashflow[&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;account=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;account&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;,date=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;getDate</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;,type=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">getType</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;CREDIT&nbsp;</span><span class="java_operator">?</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Credit&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Debit&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;,amount=&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;getAmount</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;]&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>The Java code of <code class="filename">Example5.java</code> creates 
    two <code class="code">Account</code> objects and passes one of them into each
    cashflow, in the constructor call.</p><div class="example"><a id="d0e9415"/><p class="title"><b>Example 9.49. Banking Tutorial: Example5.java</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Example6</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;main</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;args</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Account</span><span class="java_plain">&nbsp;acc1&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Account</span><span class="java_plain">&nbsp;acc2&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_separator">(</span><span class="java_literal">2</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;cashflows&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc1</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;01/01/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">CREDIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">300.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc1</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;05/02/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">CREDIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">100.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc2</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;11/03/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">CREDIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">500.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc1</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;07/02/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">DEBIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">800.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc2</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;02/03/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">DEBIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">400.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc1</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;01/04/2007&quot;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">CREDIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">200.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc1</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;05/04/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">CREDIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">300.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc2</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;11/05/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">CREDIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">700.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc1</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;07/05/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">DEBIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">900.00</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AllocatedCashflow</span><span class="java_separator">(</span><span class="java_plain">acc2</span><span class="java_separator">,</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDate</span><span class="java_separator">(</span><span class="java_literal">&quot;02/05/2007&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TypedCashflow</span><span class="java_separator">.</span><span class="java_plain">DEBIT</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_literal">100.00</span><span class="java_separator">)</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">};</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">RuleRunner</span><span class="java_separator">().</span><span class="java_plain">runRules</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Example6.drl&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">},</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cashflows&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Now, let’s look at the rule in <code class="filename">Example6.drl</code>
    to see how we apply each cashflow in date order and calculate and print
    the balance. </p><div class="example"><a id="d0e9425"/><p class="title"><b>Example 9.50. Banking Tutorial: Rule in Example6.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Rule 06 - Credit"  
    when
        $cashflow : AllocatedCashflow( $account : account,
                                       $date : date,
                                       $amount : amount,
                                       type == TypedCashflow.CREDIT )
        not AllocatedCashflow( account == $account, date &lt; $date)
    then
        System.out.println("Credit: " + $date + " :: " + $amount);     
        $account.setBalance($account.getBalance()+$amount);
        System.out.println("Account: " + $account.getAccountNo() +
                           " - new balance: " + $account.getBalance());          
        retract($cashflow);
end

rule "Rule 06 - Debit"  
    when
        $cashflow : AllocatedCashflow( $account : account,
                            $date : date,
                            $amount : amount,
                            type == TypedCashflow.DEBIT )
        not AllocatedCashflow( account == $account, date &lt; $date)
    then
        System.out.println("Debit: " + $date + " :: " + $amount);      
        $account.setBalance($account.getBalance() - $amount);
        System.out.println("Account: " + $account.getAccountNo() +
                           " - new balance: " + $account.getBalance());           
        retract($cashflow);
end</pre></div></div><br class="example-break"/><p>Although we have separate rules for credits and debits, but we do
    not specify a type when checking for earlier cashflows. This is so that
    all cashflows are applied in date order, regardless of the cashflow type.
    In the conditions we identify the account to work with, and in the
    consequences we update it with the cashflow amount.</p><div class="example"><a id="d0e9432"/><p class="title"><b>Example 9.51. Banking Tutorial: Output of Example6.java</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Loading file: Example6.drl
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Mon Jan 01 00:00:00 GMT 2007,type=Credit,amount=300.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Mon Feb 05 00:00:00 GMT 2007,type=Credit,amount=100.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=2,balance=0.0],date=Sun Mar 11 00:00:00 GMT 2007,type=Credit,amount=500.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Wed Feb 07 00:00:00 GMT 2007,type=Debit,amount=800.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=2,balance=0.0],date=Fri Mar 02 00:00:00 GMT 2007,type=Debit,amount=400.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Sun Apr 01 00:00:00 BST 2007,type=Credit,amount=200.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Thu Apr 05 00:00:00 BST 2007,type=Credit,amount=300.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=2,balance=0.0],date=Fri May 11 00:00:00 BST 2007,type=Credit,amount=700.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Mon May 07 00:00:00 BST 2007,type=Debit,amount=900.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=2,balance=0.0],date=Wed May 02 00:00:00 BST 2007,type=Debit,amount=100.0]
Debit: Fri Mar 02 00:00:00 GMT 2007 :: 400.0
Account: 2 - new balance: -400.0
Credit: Sun Mar 11 00:00:00 GMT 2007 :: 500.0
Account: 2 - new balance: 100.0
Debit: Wed May 02 00:00:00 BST 2007 :: 100.0
Account: 2 - new balance: 0.0
Credit: Fri May 11 00:00:00 BST 2007 :: 700.0
Account: 2 - new balance: 700.0
Credit: Mon Jan 01 00:00:00 GMT 2007 :: 300.0
Account: 1 - new balance: 300.0
Credit: Mon Feb 05 00:00:00 GMT 2007 :: 100.0
Account: 1 - new balance: 400.0
Debit: Wed Feb 07 00:00:00 GMT 2007 :: 800.0
Account: 1 - new balance: -400.0
Credit: Sun Apr 01 00:00:00 BST 2007 :: 200.0
Account: 1 - new balance: -200.0
Credit: Thu Apr 05 00:00:00 BST 2007 :: 300.0
Account: 1 - new balance: 100.0
Debit: Mon May 07 00:00:00 BST 2007 :: 900.0
Account: 1 - new balance: -800.0
</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e9437"/>9.6. Pricing Rule Decision Table Example</h2></div></div></div><p>The Pricing Rule decision table demonstrates the use of a 
    decision table in a spreadsheet, in Excel's XLS format, in calculating
    the retail cost of an insurance policy. The purpose of the provide set
    of rules is to calculate a base price and a discount for a
    car driver applying for a specific policy. The driver's age, history and
    the policy type all contribute to what the basic premium is, and an
    additional chunk of rules deals with refining this with a discount
    percentage.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Name:</strong></span> Example Policy Pricing
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Main class:</strong></span> org.drools.examples.decisiontable.PricingRuleDTExample
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Module:</strong></span> drools-examples
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Type:</strong></span> Java application
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Rules file:</strong></span> ExamplePolicyPricing.xls
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Objective:</strong></span> demonstrate spreadsheet-based decision tables.</pre><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9461"/>9.6.1. Executing the example</h3></div></div></div><p>Open the file <code class="filename">PricingRuleDTExample.java</code> and 
      execute it as a Java application. It should produce the following
      output in the Console window:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cheapest possible
BASE PRICE IS: 120
DISCOUNT IS: 20     </pre><p>The code to execute the example follows the usual pattern.
      The rules are loaded, the facts inserted and a Stateless Session is
      created. What is different is how the rules are added.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">DecisionTableConfiguration</span><!-- <br/> --><span class="java_plain">&nbsp;dtableconfiguration&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newDecisionTableConfiguration</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dtableconfiguration</span><span class="java_separator">.</span><span class="java_plain">setInputType</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">DecisionTableInputType</span><span class="java_separator">.</span><span class="java_plain">XLS&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">KnowledgeBuilder</span><span class="java_plain">&nbsp;kbuilder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBuilderFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBuilder</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Resource</span><span class="java_plain">&nbsp;xlsRes&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;ExamplePolicyPricing.xls&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;xlsRes</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DTABLE</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dtableconfiguration&nbsp;</span><span class="java_separator">);</span>
</pre><p>Note the use of the <code class="code">DecisionTableConfiguration</code> object.
      Its input type is set to <code class="code">DecisionTableInputType.XLS</code>.
      If you use the BRMS, all this is of course taken care of for you.</p><p>There are two fact types used in this example, <code class="code">Driver</code>
      and <code class="code">Policy</code>. Both are used with their default values. The
      <code class="code">Driver</code> is 30 years old, has had no prior claims and
      currently has a risk profile of <code class="code">LOW</code>. The <code class="code">Policy</code>
      being applied for is <code class="code">COMPREHENSIVE</code>, and it has not yet been
      approved.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9503"/>9.6.2. The decision table</h3></div></div></div><p>In this decision table, each row is a rule, and each column is
      a condition or an action.</p><div class="figure"><a id="d0e9508"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/PricingExample/DT_Config.png" alt="Decision table configuration"/></div></div><p class="title"><b>Figure 9.10. Decision table configuration</b></p></div><br class="figure-break"/><p>Referring to the spreadsheet show above, we have the
      <code class="code">RuleSet</code> declaration, which provides the package name.
      There are also other optional items you can have here, such as
      <code class="code">Variables</code> for global variables, and <code class="code">Imports</code>
      for importing classes. In this case, the namespace of the rules is
      the same as the fact classes we are using, so we can omit it.</p><p>Moving further down, we can see the <code class="code">RuleTable</code>
      declaration. The name after this (Pricing bracket) is used as the
      prefix for all the generated rules. Below that, we have
      "CONDITION or ACTION", indicating the purpose of the column, i.e.,
      whether it forms part of the condition or the consequence of the rule
      that will be generated.</p><p>You can see that there is a driver, his data spanned across three
      cells, which means that the template expressions below it apply to that
      fact. We observe the driver's age range (which uses <code class="code">$1</code> and
      <code class="code">$2</code> with comma-separated values), 
      <code class="code">locationRiskProfile</code>, and <code class="code">priorClaims</code> in the
      respective columns. In the action columns, we are set the policy
      base price and log a message.</p><div class="figure"><a id="d0e9544"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/PricingExample/DT_Table1.png" alt="Base price calculation"/></div></div><p class="title"><b>Figure 9.11. Base price calculation</b></p></div><br class="figure-break"/><p>In the preceding spreadsheet section, there are broad category
      brackets, indicated by the comment in the leftmost column. As we know
      the details of our drivers and their policies, we can tell (with a bit
      of thought) that they should match row number 18, as they have no
      prior accidents, and are 30 years old. This gives us a base price
      of 120.</p><div class="figure"><a id="d0e9552"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/PricingExample/DT_Table2.png" alt="Discount calculation"/></div></div><p class="title"><b>Figure 9.12. Discount calculation</b></p></div><br class="figure-break"/><p>The above section contains the conditions for the discount we
      might grant our driver. The discount results from the <code class="code">Age</code>
      bracket, the number of prior claims, and the policy type. In our case,
      the driver is 30, with no prior claims, and is applying for a
      <code class="code">COMPREHENSIVE</code> policy, which means we can give a discount
      of 20%. Note that this is actually a separate table, but in the same
      worksheet, so that different templates apply.</p><p>It is important to note that decision tables generate rules.
      This means they aren't simply top-down logic, but more a means to
      capture data resulting in rules. This is a subtle difference that
      confuses some people. The evaluation of the rules is not necessarily
      in the given order, since all the normal mechanics of the rule engine
      still apply.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e9568"/>9.7. Pet Store Example</h2></div></div></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Name:</strong></span> Pet Store 
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Main class:</strong></span> org.drools.examples.petstore.PetStoreExample
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Module:</strong></span> drools-examples
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Type:</strong></span> Java application
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Rules file:</strong></span> PetStore.drl
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Objective:</strong></span> Demonstrate use of Agenda Groups, Global Variables and integration with a GUI,
including callbacks from within the rules
</pre><p>The Pet Store example shows how to integrate Rules with a GUI,
      in this case a Swing based desktop application. Within the rules file,
      it demonstrates how to use Agenda groups and auto-focus to control
      which of a set of rules is allowed to fire at any given time. It also
      illustrates the mixing of the Java and MVEL dialects within the rules,
      the use of accumulate functions and the way of calling Java functions
      from within the ruleset.</p><p>All of the Java code is contained in one file,
      <code class="filename">PetStore.java</code>, defining the following principal
      classes (in addition to several classes to handle Swing Events):</p><div class="itemizedlist"><ul><li><p><code class="code">Petstore</code> contains the <code class="code">main()</code>
          method that we will look at shortly.</p></li><li><p><code class="code">PetStoreUI</code> is responsible for creating and
          displaying the Swing based GUI. It contains several smaller
          classes, mainly for responding to various GUI events such as
          mouse button clicks.</p></li><li><p><code class="code">TableModel</code> holds the table data. Think of it
          as a JavaBean that extends the Swing class
          <code class="code">AbstractTableModel</code>.</p></li><li><p><code class="code">CheckoutCallback</code> allows the GUI to interact
          with the Rules.</p></li><li><p><code class="code">Ordershow</code> keeps the items that we wish to
          buy.</p></li><li><p><code class="code">Purchase</code> stores details of the order and
          the products we are buying.</p></li><li><p><code class="code">Product</code> is a JavaBean holding details of
          the product available for purchase, and its price.</p></li></ul></div><p>Much of the Java code is either plain JavaBeans or Swing-based.
      Only a few Swing-related points will be discussed in this section,
      but a good tutorial about Swing components can be found at Sun's
      Swing website, in
      <a class="ulink" href="???">
      <code class="uri">http://java.sun.com/docs/books/tutorial/uiswing/</code>
      </a>.</p><p>The pieces of Java code in <code class="filename">Petstore.java</code>
      that relate to rules and facts are shown below.</p><div class="example"><a id="d0e9652"/><p class="title"><b>Example 9.52. Creating the PetStore RuleBase in PetStore.main</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;PetStore.drl&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">PetStore</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Create</span><span class="java_plain">&nbsp;the&nbsp;stock</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_type">Vector</span><span class="java_operator">&lt;</span><span class="java_type">Product</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;stock&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Vector</span><span class="java_operator">&lt;</span><span class="java_type">Product</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">stock</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Product</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Gold&nbsp;Fish&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">5</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">stock</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Product</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Fish&nbsp;Tank&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">25</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">stock</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Product</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Fish&nbsp;Food&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">2</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;A&nbsp;callback&nbsp;is&nbsp;responsible&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;populating&nbsp;the</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Working</span><span class="java_plain">&nbsp;</span><span class="java_type">Memory</span><span class="java_plain">&nbsp;and&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;firing&nbsp;all&nbsp;rules</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_type">PetStoreUI</span><span class="java_plain">&nbsp;ui&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">PetStoreUI</span><span class="java_separator">(</span><span class="java_plain">&nbsp;stock</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">CheckoutCallback</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ui</span><span class="java_separator">.</span><span class="java_plain">createAndShowGUI</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>The code shown above loads the rules from a DRL file on the
      classpath. Unlike other examples where the facts are asserted and
      fired straight away, this example defers this step to later. The
      way it does this is via the second last line where a
      <code class="code">PetStoreUI</code> object is created using a constructor 
      accepting the <code class="code">Vector</code> object <code class="code">stock</code>
      collecting our products, and an instance of
      the <code class="code">CheckoutCallback</code> class containing the Rule Base
      that we have just loaded.</p><p>The Java code that fires the rules is within the 
      <code class="code">CheckoutCallBack.checkout()</code> method. This is triggered
      (eventually) when the Checkout button is pressed by the user.</p><div class="example"><a id="d0e9676"/><p class="title"><b>Example 9.53. Firing the Rules - extract from CheckoutCallBack.checkout()</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_plain">&nbsp;checkout</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">JFrame</span><!-- <br/> --><span class="java_plain">&nbsp;frame</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">List</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Product</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;items</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Order</span><span class="java_plain">&nbsp;order&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Order</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Iterate</span><span class="java_plain">&nbsp;through&nbsp;list&nbsp;and&nbsp;add&nbsp;to&nbsp;cart</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Product</span><span class="java_plain">&nbsp;p</span><span class="java_operator">:</span><span class="java_plain">&nbsp;items&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order</span><span class="java_separator">.</span><span class="java_plain">addItem</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Purchase</span><span class="java_separator">(</span><span class="java_plain">&nbsp;order</span><span class="java_separator">,</span><span class="java_plain">&nbsp;p&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Add</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">JFrame</span><span class="java_plain">&nbsp;to&nbsp;the&nbsp;</span><span class="java_type">ApplicationData</span><span class="java_plain">&nbsp;to&nbsp;allow&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;user&nbsp;interaction</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">StatefulKnowledgeSession</span><span class="java_plain">&nbsp;ksession&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;kbase</span><span class="java_separator">.</span><span class="java_plain">newStatefulKnowledgeSession</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">setGlobal</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;frame&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;frame&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">setGlobal</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;textArea&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">output&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Product</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Gold&nbsp;Fish&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">5</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Product</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Fish&nbsp;Tank&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">25</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Product</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Fish&nbsp;Food&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">2</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Product</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Fish&nbsp;Food&nbsp;Sample&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;order&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Return</span><span class="java_plain">&nbsp;the&nbsp;state&nbsp;of&nbsp;the&nbsp;cart</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;order</span><span class="java_separator">.</span><span class="java_plain">toString</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span>
</pre></div></div><br class="example-break"/><p>Two items get passed into this method. One is the handle to the
      <code class="code">JFrame</code> Swing component surrounding the output text
      frame, at the bottom of the GUI. The second is a list of order items;
      this comes from the <code class="code">TableModel</code> storing the information
      from the "Table" area at the top right section of the GUI.</p><p>The for loop transforms the list of order items coming from the
      GUI into the <code class="code">Order</code> JavaBean, also contained in the
      file <code class="filename">PetStore.java</code>. Note that it would be 
      possible to refer to the Swing dataset directly within the rules,
      but it is better coding practice to do it this way, using simple
      Java objects. It means that we are not tied to Swing if we wanted
      to transform the sample into a Web application.</p><p>It is important to note that <span class="emphasis"><em>all state in this
      example is stored in the Swing components, and that the rules are
      effectively stateless.</em></span> Each time the "Checkout" button is
      pressed, this code copies the contents of the Swing
      <code class="code">TableModel</code> into the Session's Working Memory.</p><p>Within this code, there are nine calls to the Working Memory.
      The first of these creates a new Working Memory, as a Stateful
      Knowledge Session from the Knowledge Base. Remember that we passed
      in this Knowledge Base when we created the <code class="code">CheckoutCallBack</code>
      class in the <code class="code">main()</code> method. The next two calls pass in
      two objects that we will hold as global variables in the rules: the
      Swing text area and the Swing frame used for writing messages.</p><p>More inserts put information on products into the Working Memory,
      as well as the order list. The final call is the standard
      <code class="code">fireAllRules()</code>. Next, we look at what this method causes
      to happen within the rules file.</p><div class="example"><a id="d0e9718"/><p class="title"><b>Example 9.54. Package, Imports, Globals and Dialect: extract from PetStore.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">package</span><!-- <br/> --><span class="java_plain">&nbsp;org</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">drools</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">examples</span>
</span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;org</span><span class="java_separator">.</span><span class="java_plain">drools</span><span class="java_separator">.</span><span class="java_type">WorkingMemory</span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;org</span><span class="java_separator">.</span><span class="java_plain">drools</span><span class="java_separator">.</span><span class="java_plain">examples</span><span class="java_separator">.</span><span class="java_plain">petstore</span><span class="java_separator">.</span><span class="java_type">PetStoreExample</span><span class="java_separator">.</span><span class="java_type">Order</span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;org</span><span class="java_separator">.</span><span class="java_plain">drools</span><span class="java_separator">.</span><span class="java_plain">examples</span><span class="java_separator">.</span><span class="java_plain">petstore</span><span class="java_separator">.</span><span class="java_type">PetStoreExample</span><span class="java_separator">.</span><span class="java_type">Purchase</span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;org</span><span class="java_separator">.</span><span class="java_plain">drools</span><span class="java_separator">.</span><span class="java_plain">examples</span><span class="java_separator">.</span><span class="java_plain">petstore</span><span class="java_separator">.</span><span class="java_type">PetStoreExample</span><span class="java_separator">.</span><span class="java_type">Product</span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;java</span><span class="java_separator">.</span><span class="java_plain">util</span><span class="java_separator">.</span><span class="java_type">ArrayList</span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;javax</span><span class="java_separator">.</span><span class="java_plain">swing</span><span class="java_separator">.</span><span class="java_type">JOptionPane</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;javax</span><span class="java_separator">.</span><span class="java_plain">swing</span><span class="java_separator">.</span><span class="java_type">JFrame</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">global&nbsp;</span><span class="java_type">JFrame</span><span class="java_plain">&nbsp;frame&nbsp;</span>
<!--  --><br/><span class="java_plain">global&nbsp;javax</span><span class="java_separator">.</span><span class="java_plain">swing</span><span class="java_separator">.</span><span class="java_type">JTextArea</span><span class="java_plain">&nbsp;textArea</span></pre></div></div><br class="example-break"/><p>The first part of file <code class="filename">PetStore.drl</code>
      contains the standard package and import statements to make various
      Java classes available to the rules. New to us are the two globals
      <code class="code">frame</code> and <code class="code">textArea</code>. They hold references
      to the Swing components <code class="code">JFrame</code> and <code class="code">JTextArea</code>
      components that were previously passed on by the Java code calling
      the <code class="code">setGlobal()</code> method. Unlike  variables in rules,
      which expire as soon as the rule has fired, global variables retain
      their value for the lifetime of the Session.</p><p>The next extract from the file <code class="filename">PetStore.drl</code>
      contains two functions that are referenced by the rules that we will
      look at shortly.</p><div class="example"><a id="d0e9748"/><p class="title"><b>Example 9.55. Java Functions in the Rules: extract from PetStore.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">function&nbsp;</span><!-- <br/> --><span class="java_type">void</span><!-- <br/> --><span class="java_plain">&nbsp;doCheckout</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">JFrame</span><!-- <br/> --><span class="java_plain">&nbsp;frame</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">WorkingMemory</span><!-- <br/> --><span class="java_plain">&nbsp;workingMemory</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;options&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_literal">&quot;Yes&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;No&quot;</span><span class="java_separator">};</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;n&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">JOptionPane</span><span class="java_separator">.</span><span class="java_plain">showOptionDialog</span><span class="java_separator">(</span><span class="java_plain">frame</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;Would&nbsp;you&nbsp;like&nbsp;to&nbsp;checkout?&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">JOptionPane</span><span class="java_separator">.</span><span class="java_plain">YES_NO_OPTION</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">JOptionPane</span><span class="java_separator">.</span><span class="java_plain">QUESTION_MESSAGE</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options</span><span class="java_separator">[</span><span class="java_literal">0</span><span class="java_separator">]);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">n&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workingMemory</span><span class="java_separator">.</span><span class="java_plain">setFocus</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;checkout&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">function&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;requireTank</span><span class="java_separator">(</span><span class="java_type">JFrame</span><span class="java_plain">&nbsp;frame</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">WorkingMemory</span><span class="java_plain">&nbsp;workingMemory</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Order</span><span class="java_plain">&nbsp;order</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Product</span><span class="java_plain">&nbsp;fishTank</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;total</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;options&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_literal">&quot;Yes&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;No&quot;</span><span class="java_separator">};</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;n&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">JOptionPane</span><span class="java_separator">.</span><span class="java_plain">showOptionDialog</span><span class="java_separator">(</span><span class="java_plain">frame</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;Would&nbsp;you&nbsp;like&nbsp;to&nbsp;buy&nbsp;a&nbsp;tank&nbsp;for&nbsp;your&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;total&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;&nbsp;fish?&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;Purchase&nbsp;Suggestion&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">JOptionPane</span><span class="java_separator">.</span><span class="java_plain">YES_NO_OPTION</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">JOptionPane</span><span class="java_separator">.</span><span class="java_plain">QUESTION_MESSAGE</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">null</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options</span><span class="java_separator">[</span><span class="java_literal">0</span><span class="java_separator">]);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">print</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;SUGGESTION:&nbsp;Would&nbsp;you&nbsp;like&nbsp;to&nbsp;buy&nbsp;a&nbsp;tank&nbsp;for&nbsp;your&nbsp;&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;total&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;&nbsp;fish?&nbsp;-&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">n&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Purchase</span><span class="java_plain">&nbsp;purchase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Purchase</span><span class="java_separator">(</span><span class="java_plain">&nbsp;order</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fishTank&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workingMemory</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;purchase&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order</span><span class="java_separator">.</span><span class="java_plain">addItem</span><span class="java_separator">(</span><span class="java_plain">&nbsp;purchase&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Yes&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;No&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span>
</pre></div></div><br class="example-break"/><p>Having these functions in the rules file just makes the Pet Store
      example more compact. In real life you probably have the functions
      in a file of their own, within the same rules package, or as a
      static method on a standard Java class, and import them, using
      <code class="code">import function my.package.Foo.hello</code>.</p><p>The purpose of these two functions is:</p><div class="itemizedlist"><ul><li><p><code class="code">doCheckout()</code> displays a dialog asking users
          whether they wish to checkout. If they do, focus is set to the
          <code class="code">checkOut</code> agenda-group, allowing rules in that group
          to (potentially) fire.</p></li><li><p><code class="code">requireTank()</code> displays a dialog asking
          users whether they wish to buy a tank. If so, a new fish tank
          <code class="code">Product</code> is added to the order list in Working
          Memory.</p></li></ul></div><p>We'll see the rules that call these functions later on. The
      next set of examples are from the Pet Store rules themselves. The
      first extract is the one that happens to fire first, partly because
      it has the <code class="literal">auto-focus</code> attribute set to true.</p><div class="example"><a id="d0e9782"/><p class="title"><b>Example 9.56. Putting items into working memory: extract from PetStore.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Insert each item in the shopping cart into the Working Memory 
// Insert each item in the shopping cart into the Working Memory
rule "Explode Cart"
    agenda-group "init"
    auto-focus true
    salience 10
    dialect "java"
when
    $order : Order( grossTotal == -1 )
    $item : Purchase() from $order.items
then
    insert( $item );
    kcontext.getKnowledgeRuntime().getAgenda().getAgendaGroup( "show items" ).setFocus();
    kcontext.getKnowledgeRuntime().getAgenda().getAgendaGroup( "evaluate" ).setFocus();
end</pre></div></div><br class="example-break"/><p>This rule matches against all orders that do not yet have their
      <code class="code">grossTotal</code> calculated . It loops for each purchase item
      in that order. Some parts of the "Explode Cart" rule should be familiar:
      the rule name, the salience (suggesting the order for the rules being
      fired) and the dialect set to <code class="code">"java"</code>. There are three
      new features:</p><div class="itemizedlist"><ul><li><p><code class="literal">agenda-group</code> <code class="code">"init"</code> defines the name
           of the agenda group. In this case, there is only one rule in the
           group. However, neither the Java code nor a rule consequence sets
           the focus to this group, and therefore it relies on the next
           attribute for its chance to fire.</p></li><li><p><code class="literal">auto-focus</code> <code class="code">true</code> ensures that this rule,
          while being the only rule in the agenda group, gets a chance to fire
          when <code class="code">fireAllRules()</code> is called from the Java code.</p></li><li><p><code class="code">kcontext....setFocus()</code> sets the focus to the
          <code class="code">"show items"</code> and <code class="code">"evaluate"</code> agenda groups
          in turn, permitting their rules to fire. In practice, we loop
          through all items on the order, inserting them into memory, then
          firing the other rules after each insert.</p></li></ul></div><p>The next two listings show the rules within the
      <code class="code">"show items"</code> and <code class="code">evaluate</code> agenda groups.
      We look at them in the order that they are called.</p><div class="example"><a id="d0e9834"/><p class="title"><b>Example 9.57. Show Items in the GUI - extract from PetStore.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Show Items"
    agenda-group "show items"
    dialect "mvel"
when
    $order : Order( )
    $p : Purchase( order == $order )
then
   textArea.append( $p.product + "\n");
end
</pre></div></div><br class="example-break"/><p>The <code class="code">"show items"</code> agenda-group has only one rule,
      called "Show Items" (note the difference in case). For each purchase
      on the order currently in the Working Memory (or Session), it logs
      details to the text area at the bottom of the GUI. The
      <code class="code">textArea</code> variable used to do this is one of the global
      variables we looked at earlier.</p><p>The <code class="code">evaluate</code> Agenda group also gains focus from
      the <code class="code">"Explode Cart"</code> rule listed previously. This
      Agenda group has two rules, <code class="code">"Free Fish Food Sample"</code> and
      <code class="code">"Suggest Tank"</code>, shown below.</p><div class="example"><a id="d0e9861"/><p class="title"><b>Example 9.58. Evaluate Agenda Group: extract from PetStore.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Free Fish Food sample when we buy a Gold Fish if we haven't already bought 
// Fish Food and don't already have a Fish Food Sample
rule "Free Fish Food Sample"
    agenda-group "evaluate"
    dialect "mvel"
when
    $order : Order()
    not ( $p : Product( name == "Fish Food") &amp;amp;&amp;amp; Purchase( product == $p ) )
    not ( $p : Product( name == "Fish Food Sample") &amp;amp;&amp;amp; Purchase( product == $p ) )
    exists ( $p : Product( name == "Gold Fish") &amp;amp;&amp;amp; Purchase( product == $p ) )
    $fishFoodSample : Product( name == "Fish Food Sample" );
then
    System.out.println( "Adding free Fish Food Sample to cart" );
    purchase = new Purchase($order, $fishFoodSample);
    insert( purchase );
    $order.addItem( purchase ); 
end

// Suggest a tank if we have bought more than 5 gold fish and don't already have one
rule "Suggest Tank"
    agenda-group "evaluate"
    dialect "java"
when
    $order : Order()
    not ( $p : Product( name == "Fish Tank") &amp;amp;&amp;amp; Purchase( product == $p ) )
    ArrayList( $total : size &amp;gt; 5 ) from collect( Purchase( product.name == "Gold Fish" ) )
    $fishTank : Product( name == "Fish Tank" )
then
    requireTank(frame, drools.getWorkingMemory(), $order, $fishTank, $total); 
end
</pre></div></div><br class="example-break"/><p>The rule <code class="code">"Free Fish Food Sample"</code> will only fire if</p><div class="itemizedlist"><ul><li><p>we <span class="emphasis"><em>don't </em></span>already have any fish food, <span class="emphasis"><em>and</em></span></p></li><li><p>we <span class="emphasis"><em>don't</em></span> already have a free fish food sample,
          <span class="emphasis"><em>and</em></span></p></li><li><p>we <span class="emphasis"><em>do</em></span> have a Gold Fish in our order.</p></li></ul></div><p>If the rule does fire, it creates a new product (Fish Food Sample), and adds it to the
      order in Working Memory.</p><p>The rule <code class="code">"Suggest Tank"</code> will only fire if</p><div class="itemizedlist"><ul><li><p>we <span class="emphasis"><em>don't </em></span>already have a Fish Tank in our order,
          <span class="emphasis"><em>and</em></span></p></li><li><p>we <span class="emphasis"><em>do</em></span> have more than 5 Gold Fish Products
          in our order.</p></li></ul></div><p>If the rule does fire, it calls the <code class="code">requireTank()</code> function
      that we looked at earlier (showing a Dialog to the user, and adding a Tank to
      the order / working memory if confirmed). When calling the
      <span class="italic">requireTank</span>() function the rule passes
      the global <span class="italic">frame</span> variable so that the
      function has a handle to the Swing GUI.</p><p>The next rule we look at is <code class="code">"do checkout"</code>.</p><div class="example"><a id="d0e9932"/><p class="title"><b>Example 9.59. Doing the Checkout - extract (6) from PetStore.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "do checkout"
    dialect "java"
    when
    then
        doCheckout(frame, drools.getWorkingMemory());
end</pre></div></div><br class="example-break"/><p>The rule <code class="code">"do checkout"</code> has <span class="bold"><strong>no
      agenda group set and no auto-focus attribute</strong></span>. As such, is is
      deemed part of the default (MAIN) agenda group. This group gets focus by
      default when all the rules in agenda-groups that explicity had focus set
      to them have run their course.</p><p>There is no LHS to the rule, so the RHS will always call the
      <code class="code">doCheckout()</code> function. When calling the
      <code class="code">doCheckout()</code> function, the rule passes the global
      <code class="code">frame</code> variable to give the function a handle to the Swing GUI.
      As we saw earlier, the <code class="code">doCheckout()</code> function shows a
      confirmation dialog to the user. If confirmed, the function sets the focus
      to the <span class="italic">checkout</span> agenda-group, allowing
      the next lot of rules to fire.</p><div class="example"><a id="d0e9962"/><p class="title"><b>Example 9.60. Checkout Rules: extract from PetStore.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Gross Total"
    agenda-group "checkout"
    dialect "mvel"
when
   $order : Order( grossTotal == -1)
   Number( total : doubleValue )
       from accumulate( Purchase( $price : product.price ), sum( $price ) )
then
    modify( $order ) { grossTotal = total };
    textArea.append( "\ngross total=" + total + "\n" );
end

rule "Apply 5% Discount"
    agenda-group "checkout"
dialect "mvel"
when
   $order : Order( grossTotal &amp;gt;= 10 &amp;amp;&amp;amp; &amp;lt; 20 )
then
   $order.discountedTotal = $order.grossTotal * 0.95;
   textArea.append( "discountedTotal total=" + $order.discountedTotal + "\n" );
end


rule "Apply 10% Discount"
    agenda-group "checkout"
    dialect "mvel"
when
   $order : Order( grossTotal &amp;gt;= 20 )
then
   $order.discountedTotal = $order.grossTotal * 0.90;
   textArea.append( "discountedTotal total=" + $order.discountedTotal + "\n" );
end
</pre></div></div><br class="example-break"/><p>There are three rules in the <span class="italic">checkout</span> agenda-group:</p><div class="itemizedlist"><ul><li><p>If we haven't already calculated the gross total,
          <code class="code">Gross Total</code> accumulates the product prices into a total,
          puts this total into Working Memory, and displays it via the Swing
          <code class="code">JTextArea</code>, using the <code class="code">textArea</code> global
          variable yet again.</p></li><li><p>If our gross total is between 10 and 20, 
          <code class="code">"Apply 5% Discount"</code> calculates the discounted total and
          adds it to the Working Memory and displays it in the text area.</p></li><li><p>If our gross total is not less than 20, 
          <code class="code">"Apply 10% Discount"</code> calculates the discounted total and
          adds it to the Working Memory and displays it in the text area.</p></li></ul></div><p>Now that we've run through what happens in the code, let's have a
      look at what happens when we actually run the code. The file
      <code class="filename">PetStore.java</code> contains a <code class="code">main()</code> method,
      so that it can be run as a standard Java application, either from the
      command line or via the IDE. This assumes you have your classpath set
      correctly. (See the start of the examples section for more information.)</p><p>The first screen that we see is the Pet Store Demo. It has a list
      of available products (top left), an empty list of selected products
      (top right), checkout and reset buttons (middle) and an empty system
      messages area (bottom).</p><div class="figure"><a id="d0e10007"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/PetStoreExample/1-PetStore-Start-Screen.png" alt="PetStore Demo just after Launch"/></div></div><p class="title"><b>Figure 9.13. PetStore Demo just after Launch</b></p></div><br class="figure-break"/><p>To get to this point, the following things have happened:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The <code class="code">main()</code> method has run and loaded the Rule Base
          <span class="emphasis"><em>but not yet fired the rules</em></span>. So far, this is the
          only code in connection with rules that has been run.</p></li><li><p>A new <code class="code">PetStoreUI</code> object has been created and given a
          handle to the Rule Base, for later use.</p></li><li><p>Various Swing components do their stuff, and the above screen
          is shown and <span class="emphasis"><em>waits for user input</em></span>.</p></li></ol></div><p>Clicking on various products from the list might give you a
      screen similar to the one below.</p><div class="figure"><a id="d0e10039"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/PetStoreExample/2-stock-added-to-order-list.png" alt="PetStore Demo with Products Selected"/></div></div><p class="title"><b>Figure 9.14. PetStore Demo with Products Selected</b></p></div><br class="figure-break"/><p>Note that <span class="emphasis"><em>no rules code has been fired here</em></span>. This
      is only Swing code, listening for mouse click events, and adding some
      selected product to the <code class="code">TableModel</code> object for display in the
      top right hand section. (As an aside, note that this is a classic use of
      the Model View Controller design pattern).</p><p>It is only when we press the "Checkout" button that we fire our
      business rules, in roughly the same order that we walked through the
      code earlier.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Method <code class="code">CheckOutCallBack.checkout()</code> is called
          (eventually) by the Swing class waiting for the click on the
          "Checkout" button. This inserts the data from the
          <code class="code">TableModel</code> object (top right hand side of the GUI),
          and inserts it into the Session's Working Memory. It then fires
          the rules.</p></li><li><p>The <code class="code">"Explode Cart"</code> rule is the first to fire,
          given that it has <code class="literal">auto-focus</code> set to true. It loops through
          all the products in the cart, ensures that the products are in the
          Working Memory, and then gives the <code class="code">"Show Items"</code> and
          <code class="code">Evaluation</code> agenda groups a chance to fire. The rules
          in these groups add the contents of the cart to the text area
          (at the bottom of the window), decide whether or not to give us free
          fish food, and to ask us whether we want to buy a fish tank. This
          is shown in the figure below.</p></li></ol></div><div class="figure"><a id="d0e10080"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/PetStoreExample/3-purchase-suggestion.png" alt="Do we want to buy a fish tank?"/></div></div><p class="title"><b>Figure 9.15. Do we want to buy a fish tank?</b></p></div><br class="figure-break"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The <span class="italic">Do Checkout</span> rule is the next to fire as it (a) No other agenda group currently has focus and (b) it is part of the default (MAIN) agenda group. It always calls the<span class="italic"> doCheckout() function </span>which displays a 'Would you like to Checkout?' Dialog Box.</p></li><li><p>The <code class="code">doCheckout()</code> function sets the focus to the
          <code class="code">checkout</code> agenda-group, giving the rules in that group
          the option to fire.</p></li><li><p>The rules in the the <code class="code">checkout</code> agenda-group display
          the contents of the cart and apply the appropriate discount.</p></li><li><p><span class="emphasis"><em>Swing then waits for user input</em></span> to either
          checkout more products (and to cause the rules to fire again), or to
          close the GUI - see the figure below.</p></li></ol></div><div class="figure"><a id="d0e10116"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/PetStoreExample/4-Petstore-final-screen.png" alt="Petstore Demo after all rules have fired."/></div></div><p class="title"><b>Figure 9.16. Petstore Demo after all rules have fired.</b></p></div><br class="figure-break"/><p>We could add more System.out calls to demonstrate this flow of
      events. The output, as it currently appears in the Console window, is
      given in the listing below.</p><div class="example"><a id="d0e10124"/><p class="title"><b>Example 9.61. Console (System.out) from running the PetStore GUI</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Adding free Fish Food Sample to cart 
SUGGESTION: Would you like to buy a tank for your 6 fish? - Yes</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e10130"/>9.8. Honest Politician Example</h2></div></div></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Name:</strong></span> Honest Politician
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Main class:</strong></span> org.drools.examples.honestpolitician.HonestPoliticianExample
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Module:</strong></span> drools-examples
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Type:</strong></span> Java application
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Rules file:</strong></span> HonestPoliticianExample.drl
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Objective:</strong></span> Illustrate the concept of "truth maintenance" based on the logical insertion of facts
</pre><p>The Honest Politician example demonstrates truth maintenance with
  logical assertions. The basic premise is that an object can only exist
  while a statement is true. A rule's consequence can logically insert an 
  object with the <code class="code">insertLogical()</code> method. This means the object
  will only remain in the Working Memory as long as the rule that logically
  inserted  it remains true. When the rule is no longer true the object is
  automatically retracted.</p><p>In this example there is the class <code class="code">Politician</code>, with a
  name and a boolean value for being honest. Four politicians with honest
  state set to true are inserted.</p><div class="example"><a id="d0e10162"/><p class="title"><b>Example 9.62. Class Politician</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Politician</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;honest</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><div class="example"><a id="d0e10167"/><p class="title"><b>Example 9.63. Honest Politician: Execution</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Politician</span><!-- <br/> --><span class="java_plain">&nbsp;blair&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Politician</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;blair&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">true</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Politician</span><span class="java_plain">&nbsp;bush&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Politician</span><span class="java_separator">(</span><span class="java_literal">&quot;bush&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Politician</span><span class="java_plain">&nbsp;chirac&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Politician</span><span class="java_separator">(</span><span class="java_literal">&quot;chirac&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Politician</span><span class="java_plain">&nbsp;schroder&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Politician</span><span class="java_separator">(</span><span class="java_literal">&quot;schroder&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;blair&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;bush&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;chirac&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;schroder&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>The Console window output shows that, while there is at
    least one honest politician, democracy lives. However, as each
    politician is in turn corrupted by an evil corporation, so that
    all politicians become dishonest, democracy is dead.</p><div class="example"><a id="d0e10174"/><p class="title"><b>Example 9.64. Honest Politician: Console Output</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Hurrah!!! Democracy Lives
I'm an evil corporation and I have corrupted schroder
I'm an evil corporation and I have corrupted chirac
I'm an evil corporation and I have corrupted bush
I'm an evil corporation and I have corrupted blair
We are all Doomed!!! Democracy is Dead
</pre></div></div><br class="example-break"/><p>As soon as there is at least one honest politician in the
    Working Memory a new <code class="code">Hope</code> object is logically asserted.
    This object will only exist while there is at least one honest
    politician. As soon as all politicians are dishonest, the
    <code class="code">Hope</code> object will be automatically retracted. This rule
    is given a salience of 10 to ensure that it fires before any other
    rule, as at this stage the "Hope is Dead" rule is actually true.</p><div class="example"><a id="d0e10187"/><p class="title"><b>Example 9.65. Honest Politician: Rule "We have an honest politician"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "We have an honest Politician"
    salience 10
    when
        exists( Politician( honest == true ) )
    then
        insertLogical( new Hope() );
end</pre></div></div><br class="example-break"/><p>As soon as a <code class="code">Hope</code> object exists the "Hope Lives" rule
  matches and fires. It has a salience of 10 so that it takes priority
  over "Corrupt the Honest".</p><div class="example"><a id="d0e10197"/><p class="title"><b>Example 9.66. Honest Politician: Rule "Hope Lives"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Hope Lives"
    salience 10
        when
            exists( Hope() )
        then
            System.out.println("Hurrah!!! Democracy Lives");
end</pre></div></div><br class="example-break"/><p>Now that there is hope and we have, at the start, four honest
    politicians, we have four activations for this rule, all in conflict.
    They will fire in turn, corrupting each politician so that they are
    no longer honest. When all four politicians have been corrupted we
    have no politicians with the property <code class="code">honest == true</code>.
    Thus, the rule "We have an honest Politician" is no longer true and
    the object it logical inserted (due to the last execution of
    <code class="code">new Hope()</code>) is automatically retracted.</p><div class="example"><a id="d0e10210"/><p class="title"><b>Example 9.67. Honest Politician: Rule "Corrupt the Honest"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Corrupt the Honest"
    when
        politician : Politician( honest == true )   
        exists( Hope() )
    then
        System.out.println( "I'm an evil corporation and I have corrupted " + politician.getName() );
        modify ( politician ) { honest = false };
end</pre></div></div><br class="example-break"/><p>With the <code class="code">Hope</code> object being automatically retracted,
    via the truth maintenance system, the conditional element <code class="literal">not</code>
    applied to <code class="code">Hope</code> is no longer true so that the following
    rule will match and fire.</p><div class="example"><a id="d0e10226"/><p class="title"><b>Example 9.68. Honest Politician: Rule "Hope is Dead"</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Hope is Dead"
    when
        not( Hope() )
    then
        System.out.println( "We are all Doomed!!! Democracy is Dead" );
end</pre></div></div><br class="example-break"/><p>Let's take a look at the Audit trail for this application:</p><div class="figure"><a id="d0e10233"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/HonestPoliticianExample/honest_politician_audit.png" alt="Honest Politician Example Audit View"/></div></div><p class="title"><b>Figure 9.17. Honest Politician Example Audit View</b></p></div><br class="figure-break"/><p>The moment we insert the first politician we have two activations.
    The rule "We have an honest Politician" is activated only once for the first
    inserted politician because it uses an <code class="literal">exists</code> conditional
    element, which matches once for any number. The rule "Hope is Dead" is
    also activated at this stage, because we have not yet inserted the
    <code class="code">Hope</code> object. Rule "We have an honest Politician" fires first,
    as it has a higher salience than "Hope is Dead", which inserts the
    <code class="code">Hope</code> object. (That action is highlighted green.) The
    insertion of the <code class="code">Hope</code> object activates "Hope Lives" and
    de-activates "Hope is Dead"; it also activates "Corrupt the Honest"
    for each inserted honest politician. Rule "Hope Lives" executes,
    printing  "Hurrah!!! Democracy Lives". Then, for each politician, rule
    "Corrupt the Honest" fires, printing "I'm an evil corporation and I
    have corrupted X", where X is the name of the politician, and modifies
    the politician's honest value to false. When the last honest politician
    is corrupted, <code class="code">Hope</code> is automatically retracted, by the truth
    maintenance system, as shown by the blue highlighted area. The green
    highlighted area shows the origin of the currently selected blue
    highlighted area. Once the <code class="code">Hope</code> fact is retracted, "Hope is
    dead" activates and fires printing "We are all Doomed!!! Democracy is
    Dead".</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e10259"/>9.9. Sudoku Example</h2></div></div></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Name:</strong></span> Sudoku
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Main class:</strong></span> org.drools.examples.sudoku.SudokuExample
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Type:</strong></span> Java application
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Rules file:</strong></span> sudoku.drl, validate.drl
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Objective:</strong></span> Demonstrates the solving of logic problems, and complex pattern matching.
</pre><p>This example demonstrates how Drools can be used to find a solution
    in a large potential solution space based on a number of constraints. We
    use the popular puzzle of Sudoku. This example also shows how Drools can
    be integrated into a graphical interface and how callbacks can be used to
    interact with a running Drools rules engine in order to update the
    graphical interface based on changes in the Working Memory at
    runtime.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10280"/>9.9.1. Sudoku Overview</h3></div></div></div><p>Sudoku is a logic-based number placement puzzle. The objective is
      to fill a 9x9 grid so that each column, each row, and each of the nine
      3x3 zones contains the digits from 1 to 9, once, and only once.</p><p>The puzzle setter provides a partially completed grid and the
      puzzle solver's task is to complete the grid with these
      constraints.</p><p>The general strategy to solve the problem is to ensure that when
      you insert a new number it should be unique in its particular
      3x3 zone, row and column.</p><p>See <a class="link" href="http://en.wikipedia.org/wiki/Sudoku" target="">Wikipedia</a>
      for a more detailed description.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10294"/>9.9.2. Running the Example</h3></div></div></div><p>Download and install drools-examples as described above and then
      execute <code class="filename">java org.drools.examples.DroolsExamplesApp</code> and
      click on "SudokuExample".</p><p>The window contains an empty grid, but the program comes
       with a number of grids stored internally which can be loaded 
       and solved. Click on "File", then "Samples" and select "Simple"
       to load one of the examples. Note that all buttons are disabled
       until a grid is loaded. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Examples/SudokuExample/sudoku1.png"/></div></div><p>Loading the "Simple" example fills the grid according to the
      puzzle's initial state. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Examples/SudokuExample/sudoku2.png"/></div></div><p>Click on the "Solve" button and the Drools-based engine will fill
      out the remaining values, and the buttons are inactive once
      more.</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Examples/SudokuExample/sudoku3.png"/></div></div><p>Alternatively, you may click on the "Step" button to see the next
      digit found by the rule set. The Console window will display detailed
      information about the rules which are executing to solve the step
      in a human readable form. Some examples of these messages are
      presented below.</p><pre class="screen">
single 8 at [0,1]
column elimination due to [1,2]: remove 9 from [4,2]
hidden single 9 at [1,2]
row elimination due to [2,8]: remove 7 from [2,4]
remove 6 from [3,8] due to naked pair at [3,2] and [3,7]
hidden pair in row at [4,6] and [4,4]
</pre><p>Click on the "Dump" button to see the state of the grid, with
      cells showing either the established value or the remaining 
      possibilitiescandidates.</p><pre class="screen">
       Col: 0     Col: 1     Col: 2     Col: 3     Col: 4     Col: 5     Col: 6     Col: 7     Col: 8     
Row 0:   2 4  7 9   2 456        4567 9   23 56  9  --- 5 ---  --- 1 ---    3  67 9  --- 8 ---     4 67   
Row 1:  12    7 9  --- 8 ---  1    67 9   23  6  9  --- 4 ---   23  67    1 3  67 9    3  67 9  --- 5 --- 
Row 2:  1  4  7 9  1  456     --- 3 ---      56 89      5 78       5678   --- 2 ---     4 67 9  1  4 67   
Row 3:  1234       12345      1  45      12  5  8   --- 6 ---   2  5 78       5 78      45 7    --- 9 --- 
Row 4:  --- 6 ---  --- 7 ---      5      --- 4 ---   2  5  8   --- 9 ---      5  8   --- 1 ---  --- 3 --- 
Row 5:  --- 8 ---  12 45      1  45   9  12  5      --- 3 ---   2  5 7        567       4567     2 4 67   
Row 6:  1 3   7    1 3  6     --- 2 ---    3 56 8       5  8     3 56 8   --- 4 ---    3 567 9  1    678  
Row 7:  --- 5 ---  1 34 6     1  4 678     3  6 8   --- 9 ---    34 6 8   1 3  678   --- 2 ---  1    678  
Row 8:    34       --- 9 ---     4 6 8   --- 7 ---  --- 1 ---   23456 8     3 56 8     3 56          6 8  
</pre><p>Now, let us load a Sudoku grid that is deliberately invalid. Click
      on "File", "Samples" and "!DELIBERATELY BROKEN!". Note that this grid
      starts with some issues, for example the value 5 appears twice in the
      first row.</p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Examples/SudokuExample/sudoku4.png"/></div></div><p>A few simple rules perform a sanity check, right after loading
      a grid. In this case, the following messages are printed on
      standard output:</p><pre class="screen">
cell [0,8]: 5 has a duplicate in row 0
cell [0,0]: 5 has a duplicate in row 0
cell [6,0]: 8 has a duplicate in col 0
cell [4,0]: 8 has a duplicate in col 0
Validation complete.
</pre><p>Nevertheless, click on the "Solve" button to apply the solving
      rules to this invalid grid. This will not complete; some cells
      remain empty. </p><div class="screenshot"><div class="mediaobject"><img src="images/Chapter-Examples/SudokuExample/sudoku5.png"/></div></div><p>The solving functionality has been achieved by the use of
      rules that implement standard solving techniques. They are based
      on the sets of values that are still candidates for a cell. If,
      for instance, such a set contains a single value, then this is
      the value for the cell. A little less obvious is the single
      occurrence of a value in one of the groups of nine cells. The
      rules detecting these situations insert a fact of type Setting
      with the solution value for some specific cell. This fact causes the
      elimination of this value from all other cells in any of the
      groups the cell belongs to. Finally, it is retracted.</p><p>Other rules merely reduce the permissible values for some
      cells. Rules "naked pair", "hidden pair in row", "hidden pair in column"
      and "hidden pair in square" merely eliminate possibilities but
      do not establish solutions. More sophisticated eliminations are done by
      "X-wings in rows", "X-wings in columns", "intersection removal row" and
      "intersection removal column".</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10361"/>9.9.3. Java Source and Rules Overview</h3></div></div></div><p>The Java source code can be found in the
      /src/main/java/org/drools/examples/sudoku directory, with the two DRL
      files defining the rules located in the
      /src/main/rules/org/drools/examples/sudoku directory.</p><p>The package <code class="code">org.drools.examples.sudoku.swing</code>
      contains a set of classes which implement a framework for Sudoku
      puzzles. Note that this package does not have any dependencies on
      the Drools libraries. <code class="code">SudokuGridModel</code> defines an
      interface which can be implemented to store a Sudoku puzzle as a 9x9
      grid of <code class="code">Cell</code> objects. <code class="code">SudokuGridView</code> is
      a Swing component which can visualize any implementation of
      <code class="code">SudokuGridModel</code>. <code class="code">SudokuGridEvent</code> and
      <code class="code">SudokuGridListener</code> are used to
      communicate state changes between the model and the view: events are
      fired when a cell's value is resolved or changed. If you are familiar
      with the model-view-controller patterns in other Swing components such
      as <code class="code">JTable</code> then this pattern should be familiar.
      <code class="code">SudokuGridSamples</code> provides a number of partially filled
      Sudoku puzzles for demonstration purposes.</p><p>Package <code class="code">org.drools.examples.sudoku.rules</code> contains a
      utility class with a method for compiling DRL files.</p><p>The package <code class="code">org.drools.examples.sudoku</code> contains a
      set of classes implementing the elementary <code class="code">Cell</code> object
      and its various aggregations: the <code class="code">CellFile</code> subtypes
      <code class="code">CellRow</code> and <code class="code">CellCol</code> as well as
      <code class="code">CellSqr</code>, all of which are subtypes of
      <code class="code">CellGroup</code>. It's interesting to note that <code class="code">Cell</code>
      and <code class="code">CellGroup</code> are subclasses of <code class="code">SetOfNine</code>,
      which provides a property <code class="code">free</code> with the
      type <code class="code">Set&lt;Integer&gt;</code>. For a <code class="code">Cell</code> it
      represents the individual candidate set; for a <code class="code">CellGroup</code>
      the set is the union of all candidate sets of its cells, or, simply,
      the set of digits that still need to be allocated.</p><p>With 81 <code class="code">Cell</code> and 27 <code class="code">CellGroup</code> objects and
      the linkage provided by the <code class="code">Cell</code> properties 
      <code class="code">cellRow</code>, <code class="code">cellCol</code> and <code class="code">cellSqr</code>
      and the <code class="code">CellGroup</code> property <code class="code">cells</code>, a list of
      <code class="code">Cell</code> objects, it is possible to write rules that
      detect the specific sitations that permit the allocation of a
      value to a cell or the elimination of a value from some candidate 
      set.</p><p>An object of class <code class="code">Setting</code> is used for triggering
      the operations that accompany the allocation of a value: its removal
      from the candidata sets of sibling cells and associated cell groups.
      Moreover, the presence of a <code class="code">Setting</code> fact is used in
      all rules that should detect a new situation; this is to avoid
      reactions to inconsistent intermediary states.</p><p>An object of class <code class="code">Stepping</code> is used in a
      low priority rule to execute an emergency halt when a "Step"
      does not terminate regularly. This indicates that the puzzle
      cannot be solved by the program.</p><p>The class <code class="code">org.drools.examples.sudoku.SudokuExample</code>
      implements a Java application combining the components desribed.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10491"/>9.9.4. Sudoku Validator Rules (validate.drl)</h3></div></div></div><p>Validation rules detect duplicate numbers in cell groups.
      They are combined in an agenda group which enables us to activate
      them, explicitly, after loading a puzzle.</p><p>The three rules "duplicate in cell..." are very similar.
      The first pattern locates a cell with an allocated value. The second
      pattern pulls in any of the three cell groups the cell belongs to.
      The final pattern would find a cell (other than the first one) with
      the same value as the first cell and in the same row, column or
      square, respectively.</p><p>Rule "terminate group" fires last. It prints a message and
      calls halt.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10500"/>9.9.5. Sudoku Solving Rules (sudoku.drl)</h3></div></div></div><p>There are three types of rules in this file: one group
      handles the allocation of a number to a cell, another group
      detects feasible allocations, and the third group eliminates
      values from candidate sets.</p><p>Rules  "set a value", "eliminate a value from Cell" and
      "retract setting" depend on the presence of a <code class="code">Setting</code>
      object. The first rule handles the assignment to the cell and the
      operations for removing the value from the "free" sets of the 
      cell's three groups. Also, it decrements a counter that, when
      zero, returns control to the Java application that has called
      <code class="code">fireUntilHalt()</code>. The purpose of rule
      "eliminate a value from Cell" is to reduce the candidate lists
      of all cells that are related to the newly assigned cell. Finally,
      when all eliminations have been made, rule "retract setting"
      retracts the triggering <code class="code">Setting</code> fact.</p><p>There are just two rules that detect a situation where an
      allocation of a number to a cell is possible. Rule "single" fires
      for a <code class="code">Cell</code> with a candidate set containing a single
      number. Rule "hidden single" fires when there is no cell with a
      single candidate but when there is a cell containing a candidate but  
      this candidate is absent from all other cells in one of the three
      groups the cell belongs to. Both rules create and insert a
      <code class="code">Setting</code> fact.</p><p>Rules from the largest group of rules implement, singly or
      in groups of two or three, various solving techniques, as they are
      employed when solving Sudoku puzzles manually.</p><p>Rule "naked pair" detects identical candidate sets of size 2
      in two cells of a group; these two values may be removed from all
      other candidate sets of that group.</p><p>A similar idea motivates the three rules "hidden pair in...";
      here, the rules look for a subset of two numbers in exactly two cells
      of a group, with neither value occurring in any of the other cells of
      this group. This, then, means that all other candidates can be
      eliminated from the two cells harbouring the hidden pair.</p><p>A pair of rules deals with "X-wings" in rows and columns.
      When there are only two possible cells for a value in each of
      two different rows (or columns) and these candidates lie also
      in the same columns (or rows), then all other candidates for 
      this value in the columns (or rows) can be eliminated. If you
      follow the pattern sequence in one of these rules, you will see
      how the conditions that are conveniently expressed by words such as
      "same" or "only" result in patterns with suitable constraints
      or prefixed with "not".</p><p>The rule pair "intersection removal..." is based on the
      restricted occurrence of some number within one square, either
      in a single row or in a single column. This means that this number
      must be in one of those two or three cells of the row or column;
      hence it can be removed from the candidate sets of all other cells
      of the group. The pattern establishes the restricted occurrence
      and then fires for each cell outside the square and within the
      same cell file.</p><p>These rules are sufficient for many but certainly not for all
      Sudoku puzzles. To solve very difficult grids, the rule set would
      need to be extended with more complex rules. (Ultimately, there
      are puzzles that cannot be solved except by trial and error.)</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e10536"/>9.10. Number Guess</h2></div></div></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Name:</strong></span> Number Guess
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Main class:</strong></span> org.drools.examples.numberguess.NumberGuessExample
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Module:</strong></span> droolsjbpm-integration-examples (Note: this is in a different download, the droolsjbpm-integration download.)
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Type:</strong></span> Java application
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Rules file:</strong></span> NumberGuess.drl
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Objective:</strong></span> Demonstrate use of Rule Flow to organise Rules
</pre><p>The "Number Guess" example shows the use of Rule Flow, a way of controlling the order in which rules are fired.
  It uses widely understood workflow diagrams for defining the order in which groups of rules will be executed.</p><div class="example"><a id="d0e10560"/><p class="title"><b>Example 9.69. Creating the Number Guess RuleBase: NumberGuessExample.main() - part 1</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">final</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;kbuilder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KnowledgeBuilderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newKnowledgeBuilder</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;NumberGuess.drl&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ShoppingExample</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRL&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">kbuilder</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ResourceFactory</span><span class="java_separator">.</span><span class="java_plain">newClassPathResource</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;NumberGuess.rf&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ShoppingExample</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ResourceType</span><span class="java_separator">.</span><span class="java_plain">DRF&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBase</span><span class="java_plain">&nbsp;kbase&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">KnowledgeBaseFactory</span><span class="java_separator">.</span><span class="java_plain">newKnowledgeBase</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">kbase</span><span class="java_separator">.</span><span class="java_plain">addKnowledgePackages</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kbuilder</span><span class="java_separator">.</span><span class="java_plain">getKnowledgePackages</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/><p>The creation of the package and the loading of the rules (using the <code class="code">add()</code> method) is the same as
  the previous examples. There is an additional line to add the Rule Flow (<code class="filename">NumberGuess.rf</code>), which
  provides the option of specifying different rule flows for the same Knowledge Base. Otherwise, the Knowledge Base is
  created in the same manner as before.</p><div class="example"><a id="d0e10573"/><p class="title"><b>Example 9.70. Starting the RuleFlow: NumberGuessExample.main() - part 2</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">final</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">StatefulKnowledgeSession</span><!-- <br/> --><span class="java_plain">&nbsp;ksession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;kbase</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">newStatefulKnowledgeSession</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">KnowledgeRuntimeLogger</span><span class="java_plain">&nbsp;logger&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">KnowledgeRuntimeLoggerFactory</span><span class="java_separator">.</span><span class="java_plain">newFileLogger</span><span class="java_separator">(</span><span class="java_plain">ksession</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;log/numberguess&quot;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">GameRules</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">100</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">5</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">RandomNumber</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">insert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Game</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">startProcess</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Number&nbsp;Guess&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">fireAllRules</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">logger</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">ksession</span><span class="java_separator">.</span><span class="java_plain">dispose</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>Once we have a Knowledge Base, we can use it to obtain a Stateful Session. Into our session we insert our facts,
  i.e., standard Java objects. (For simplicity, in this sample, these classes are all contained within our
  <code class="filename">NumberGuessExample.java</code> file. Class <code class="code">GameRules</code> provides the maximum range and the
  number of guesses allowed. Class <code class="code">RandomNumber</code> automatically generates a number between 0 and 100 and
  makes it available to our rules, by insertion via the <code class="code">getValue()</code> method. Class <code class="code">Game</code> keeps
  track of the guesses we have made before, and their number.</p><p>Note that before we call the standard <code class="code">fireAllRules()</code> method, we also start the process that we
  loaded earlier, via the <code class="code">startProcess()</code> method. We'll learn where to obtain the parameter we pass ("Number
  Guess", i.e., the identifier of the rule flow) when we talk about the rule flow file and the graphical Rule Flow
  Editor below.</p><p>Before we finish the discussion of our Java code, we note that in some real-life application we would examine
  the final state of the objects. (Here, we could retrieve the number of guesses, to add it to a high score table.) For
  this example we are content to ensure that the Working Memory session is cleared by calling the <code class="code">dispose()</code>
  method.</p><div class="figure"><a id="d0e10608"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/NumberGuessExample/numberguess-ruleflow.png" alt="RuleFlow for the NumberGuess Example"/></div></div><p class="title"><b>Figure 9.18. RuleFlow for the NumberGuess Example</b></p></div><br class="figure-break"/><p>If you open the <code class="filename">NumberGuess.rf</code> file in the Drools IDE (provided you have the JBoss Rules
  extensions installed correctly in Eclipse) you should see the above diagram, similar to a standard flowchart. Its
  icons are similar (but not exactly the same) as in the JBoss jBPM workflow product. Should you wish to edit the
  diagram, a menu of available components should be available to the left of the diagram in the IDE, which is called the
  <span class="emphasis"><em>palette</em></span>. This diagram is saved in XML, an (almost) human readable format, using XStream.</p><p>If it is not already open, ensure that the Properties View is visible in the IDE. It can be opened by clicking
  "Window", then "Show View" and "Other", where you can select the "Properties" view. If you do this
  <span class="emphasis"><em>before</em></span> you select any item on the rule flow (or click on the blank space in the rule flow) you
  should be presented with the following set of properties.</p><div class="figure"><a id="d0e10627"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/NumberGuessExample/numberguess-ruleflow-properties.png" alt="Properties for the Number Guess Rule Flow"/></div></div><p class="title"><b>Figure 9.19. Properties for the Number Guess Rule Flow</b></p></div><br class="figure-break"/><p>Keep an eye on the Properties View as we progress through the example's rule flow, as it presents valuable
  information. In this case, it provides us with the identification of the Rule Flow Process that we used in our earlier
  code snippet, when we called <code class="code">session.startProcess()</code>.</p><p>In the "Number Guess" Rule Flow we encounter several node types, many of them identified by an icon.</p><div class="itemizedlist"><ul><li><p>The Start node (white arrow in a green circle) and the End node (red box) mark beginning and end of the
        rule flow.</p></li><li><p>A Rule Flow Group box (yellow, without an icon) represents a Rule Flow Groups defined in our rules (DRL)
        file that we will look at later. For example, when the flow reaches the Rule Flow Group "Too High", only those
        rules marked with an attribute of <code class="literal">ruleflow-group</code> <code class="code">"Too High"</code> can potentially
        fire.</p></li><li><p>Action nodes (yellow, cog-shaped icon) perform standard Java method calls. Most action nodes in this
        example call <code class="code">System.out.println()</code>, indicating the program's progress to the user.</p></li><li><p>Split and Join Nodes (blue ovals, no icon) such as "Guess Correct?" and "More guesses Join" mark places
        where the flow of control can split, according to various conditions, and rejoin, respectively</p></li><li><p>Arrows indicate the flow between the various nodes.</p></li></ul></div><p>The various nodes in combination with the rules make the Number Guess game work. For example, the "Guess" Rule
  Flow Group allows only the rule "Get user Guess" to fire, because only that rule has a matching attribute of
  <code class="literal">ruleflow-group</code> <code class="code">"Guess"</code>.</p><div class="example"><a id="d0e10674"/><p class="title"><b>Example 9.71. A Rule firing only at a specific point in the Rule Flow: NumberGuess.drl</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Get user Guess"
    ruleflow-group "Guess"
    no-loop
    when
        $r : RandomNumber()
        rules : GameRules( allowed : allowedGuesses )
        game : Game( guessCount &lt; allowed )
        not ( Guess() )
    then
        System.out.println( "You have " + ( rules.allowedGuesses - game.guessCount )
                            + " out of " + rules.allowedGuesses
                            + " guesses left.\nPlease enter your guess from 0 to "
                            + rules.maxRange );
        br = new BufferedReader( new InputStreamReader( System.in ) );
        i = br.readLine();        
        modify ( game ) { guessCount = game.guessCount + 1 }
        insert( new Guess( i ) );
end</pre></div></div><br class="example-break"/><p>The rest of this rule is fairly standard. The LHS section (after <code class="literal">when</code>) of the rule states
  that it will be activated for each <code class="code">RandomNumber</code> object inserted into the Working Memory where
  <code class="code">guessCount</code> is less than <code class="code">allowedGuesses</code> from the <code class="code">GameRules</code> object and where the
  user has not guessed the correct number.</p><p>The RHS section (or consequence, after <code class="literal">then</code>) prints a message to the user and then awaits
  user input from <code class="code">System.in</code>. After obtaining this input (the <code class="code">readLine()</code> method call blocks
  until the return key is pressed) it modifies the guess count and inserts the new guess, making both available to the
  Working Memory.</p><p>The rest of the rules file is fairly standard: the package declares the dialect as MVEL, and various Java
  classes are imported. In total, there are five rules in this file:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>Get User Guess, the Rule we examined above.</p></li><li><p>A Rule to record the highest guess.</p></li><li><p>A Rule to record the lowest guess.</p></li><li><p>A Rule to inspect the guess and retract it from memory if incorrect.</p></li><li><p>A Rule that notifies the user that all guesses have been used up.</p></li></ol></div><p>One point of integration between the standard Rules and the RuleFlow is via the
  <code class="literal">ruleflow-group</code> attribute on the rules, as dicussed above. A <span class="emphasis"><em>second point of integration
  between the rules (.drl) file and the Rules Flow .rf files</em></span> is that the Split Nodes (the blue ovals) can use
  values in the Working Memory (as updated by the rules) to decide which flow of action to take. To see how this works,
  click on the "Guess Correct Node"; then within the Properties View, open the Constraints Editor by clicking the button
  at the right that appears once you click on the "Constraints" property line. You should see something similar to the
  diagram below.</p><div class="figure"><a id="d0e10733"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/NumberGuessExample/numberguess-editconstraints.png" alt="Edit Constraints for the &#34;Guess Correct&#34; Node"/></div></div><p class="title"><b>Figure 9.20. Edit Constraints for the "Guess Correct" Node</b></p></div><br class="figure-break"/><p>Click on the "Edit" button beside "To node Too High" and you'll see a dialog like the one below. The values in
  the "Textual Editor" window follow the standard rule format for the LHS and can refer to objects in Working Memory.
  The consequence (RHS) is that the flow of control follows this node (i.e., "To node Too High") if the LHS expression
  evaluates to true.</p><div class="figure"><a id="d0e10741"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/NumberGuessExample/numberguess-constraint-toohigh.png" alt="Constraint Editor for the &#34;Guess Correct&#34; Node: value too high"/></div></div><p class="title"><b>Figure 9.21. Constraint Editor for the "Guess Correct" Node: value too high</b></p></div><br class="figure-break"/><p>Since the file <code class="filename">NumberGuess.java</code> contains a <code class="code">main()</code> method, it can be run as a
  standard Java application, either from the command line or via the IDE. A typical game might result in the interaction
  below. The numbers in bold are typed in by the user.</p><div class="example"><a id="d0e10755"/><p class="title"><b>Example 9.72. Example Console output where the Number Guess Example beat the human!</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">You have 5 out of 5 guesses left.
Please enter your guess from 0 to 100
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>50</strong></span>
Your guess was too high
You have 4 out of 5 guesses left.
Please enter your guess from 0 to 100
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>25</strong></span>
Your guess was too low
You have 3 out of 5 guesses left.
Please enter your guess from 0 to 100
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>37</strong></span>
Your guess was too low
You have 2 out of 5 guesses left.
Please enter your guess from 0 to 100
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>44</strong></span>
Your guess was too low
You have 1 out of 5 guesses left.
Please enter your guess from 0 to 100
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>47</strong></span>
Your guess was too low
You have no more guesses
The correct guess was 48 

</pre></div></div><br class="example-break"/><p>A summary of what is happening in this sample is:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li><p>The <code class="code">main()</code> method of <code class="filename">NumberGuessExample.java</code> loads a Rule Base, creates a
      Stateful Session and inserts <code class="code">Game</code>, <code class="code">GameRules</code> and <code class="code">RandomNumber</code> (containing
      the target number) objects into it. The method also sets the process flow we are going to use, and fires all
      rules. Control passes to the Rule Flow.</p></li><li><p>File <code class="filename">NumberGuess.rf</code>, the Rule Flow, begins at the "Start" node.</p></li><li><p>Control passes (via the "More guesses" join node) to the Guess node.</p></li><li><p>At the Guess node, the appropriate Rule Flow Group ("Get user Guess") is enabled. In this case the Rule
      "Guess" (in the <code class="filename">NumberGuess.drl</code> file) is triggered. This rule displays a message to the user,
      takes the response, and puts it into Working Memory. Flow passes to the next Rule Flow Node.</p></li><li><p>At the next node, "Guess Correct", constraints inspect the current session and decide which path to
      take.</p><p>If the guess in step 4 was too high or too low, flow proceeds along a path which has an action node with
      normal Java code printing a suitable message and a Rule Flow Group causing a highest guess or lowest guess rule to
      be triggered. Flow passes from these nodes to step 6.</p><p>If the guess in step 4 was right, we proceed along the path towards the end of the Rule Flow. Before we get
      there, an action node with normal Java code prints a statement "you guessed correctly". There is a join node here
      (just before the Rule Flow end) so that our no-more-guesses path (step 7) can also terminate the Rule Flow.</p></li><li><p>Control passes as per the Rule Flow via a join node, a guess incorrect Rule Flow Group (triggering a rule to
      retract a guess from Working Memory) onto the "More guesses" decision node.</p></li><li><p>The "More guesses" decision node (on the right hand side of the rule flow) uses constraints, again looking
      at values that the rules have put into the working memory, to decide if we have more guesses and if so, goto step
      3. If not, we proceed to the end of the rule flow, via a Rule Flow Group that triggers a rule stating "you have no
      more guesses".</p></li><li><p>The loop over steps 3 to 7 continues until the number is guessed correctly, or we run out of guesses.</p></li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e10827"/>9.11. Miss Manners and Benchmarking</h2></div></div></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Name:</strong></span> Miss Manners
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Main class:</strong></span> org.drools.benchmark.manners.MannersBenchmark
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Module:</strong></span> drools-examples
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Type:</strong></span> Java application
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Rules file:</strong></span> manners.drl
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Objective:</strong></span> Advanced walkthrough on the Manners benchmark, covers Depth conflict resolution in depth.</pre><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10849"/>9.11.1. Introduction</h3></div></div></div><p>Miss Manners is throwing a party and, being a good host, she wants
      to arrange good seating. Her initial design arranges everyone in 
      male-female pairs, but then she worries about people have things to talk
      about. What is a good host to do? She decides to note the hobby of
      each guest so she can then arrange guests not only pairing them according
      to alternating sex but also ensuring that a guest has someone with a
      common hobby, at least on one side.</p><div class="figure"><a id="d0e10854"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Examples/MannersExample/guests_at_table.png" align="middle" alt="Miss Manners' Guests"/></div></div><p class="title"><b>Figure 9.22. Miss Manners' Guests</b></p></div><br class="figure-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10860"/>9.11.1.1. BenchMarking</h4></div></div></div><p>Five benchmarks were established in the 1991 paper "Effects of
        Database Size on Rule System Performance: Five Case Studies" by 
        David Brant, Timothy Grose, Bernie Lofaso and Daniel P. Miranker:</p><div class="itemizedlist"><ul><li><p><span class="bold"><strong>Manners</strong></span> uses a 
            depth-first search approach to determine the
            seating arrangements alternating women and men and ensuring
            one common hobby for neighbors.</p></li><li><p><span class="bold"><strong>Waltz</strong></span> establishes
            a three-dimensional interpretation of a line drawing by
            line labeling by constraint propagation.</p></li><li><p><span class="bold"><strong>WaltzDB</strong></span> is a more
            general version of Waltz, supporting junctions of more
            than three lines and using a database.</p></li><li><p><span class="bold"><strong>ARP</strong></span> is a 
            route planner for a robotic air vehicle using the A*
            search algorithm to achieve minimal cost.</p></li><li><p><span class="bold"><strong>Weaver</strong></span> 
            VLSI router for channels and boxes using a black-board
            technique.</p></li></ul></div><p>Manners has become the de facto rule engine benchmark.
        Its behavior, however, is now well known and many engines
        optimize for this, thus negating its usefulness as a benchmark 
        which is why Waltz is becoming more favorable. These five
        benchmarks are also published at the University of Texas <a class="ulink" href="http://www.cs.utexas.edu/ftp/pub/ops5-benchmark-suite/">http://www.cs.utexas.edu/ftp/pub/ops5-benchmark-suite/</a>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10896"/>9.11.1.2. Miss Manners Execution Flow</h4></div></div></div><p>After the first seating arrangement has been assigned, a
        depth-first recursion occurs which repeatedly assigns correct
        seating arrangements until the last seat is assigned. Manners
        uses a <code class="code">Context</code> instance to control execution flow.
        The activity diagram is partitioned to show the relation of the
        rule execution to the current <code class="code">Context</code> state.</p><div class="figure"><a id="d0e10907"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Examples/MannersExample/manners_activity_diagram.png" align="middle" alt="Manners Activity Diagram"/></div></div><p class="title"><b>Figure 9.23. Manners Activity Diagram</b></p></div><br class="figure-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10913"/>9.11.1.3. The Data and Results</h4></div></div></div><p>Before going deeper into the rules, let's first take a look
        at the asserted data and the resulting seating arrangement. The
        data is a simple set of five guests who should be arranged so
        that sexes alternate and neighbors have a common hobby.</p><p><span class="bold"><strong>The Data</strong></span></p><p>The data is given in OPS5 syntax, with a parenthesized
        list of name and value pairs for each attribute. Each
        person has only one hobby.</p><div class="literallayout"><p>(guest (name n1) (sex m) (hobby  h1)  )<br/>
(guest (name n2) (sex f) (hobby  h1)  )<br/>
(guest (name n2) (sex f) (hobby  h3)  )<br/>
(guest (name n3) (sex m) (hobby  h3)  )<br/>
(guest (name n4) (sex m) (hobby  h1)  )<br/>
(guest (name n4) (sex f) (hobby  h2)  )<br/>
(guest (name n4) (sex f) (hobby  h3)  )<br/>
(guest (name n5) (sex f) (hobby  h2)  )<br/>
(guest (name n5) (sex f) (hobby  h1)  )<br/>
(last_seat (seat 5)  )</p></div><p><span class="bold"><strong>The Results</strong></span></p><p>Each line of the results list is printed per execution of the
        "Assign Seat" rule. They key bit to notice is that each line has
        a "pid" value one greater than the last. (The significance of this
        will be explained in the discussion of the rule "Assign Seating".)
        The "ls", "rs", "ln" and "rn" refer to the left and right
        seat and neighbor's name, respectively. The actual implementation
        uses longer attribute names (e.g., <code class="code">leftGuestName</code>,
        but here we'll stick to the notation from the original
        implementation.</p><div class="literallayout"><p>[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5] <br/>
[Seating id=2, pid=1, done=false, ls=1, ln=n5, rs=2, rn=n4] <br/>
[Seating id=3, pid=2, done=false, ls=2, ln=n4, rs=3, rn=n3] <br/>
[Seating id=4, pid=3, done=false, ls=3, rn=n3, rs=4, rn=n2] <br/>
[Seating id=5, pid=4, done=false, ls=4, ln=n2, rs=5, rn=n1]</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10935"/>9.11.2. Indepth Discussion</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10938"/>9.11.2.1. Cheating</h4></div></div></div><p>Manners has been designed to exercise cross product
        joins and Agenda activities. Many people not understanding this
        tweak the example to achieve better performance, making their
        port of the Manners benchmark pointless. Known cheats or
        porting errors for Miss Manners are:</p><div class="itemizedlist"><ul><li><p>Using arrays for a guests hobbies, instead of asserting each
            one as a single fact massively reduces the cross products.</p></li><li><p>Altering the sequence of data can also reduce the
            amount of matching, increasing execution speed.</p></li><li><p>It's possible to change the <code class="literal">not</code> Conditional
            Element so that the test algorithm only uses the
            "first-best-match", which is, basically, transforming
            the test algorithm to backward chaining. The results are only
            comparable to other backward chaining rule engines or ports of
            Manners.</p></li><li><p>Removing the context so the rule engine matches the guests
            and seats prematurely. A proper port will prevent facts from
            matching using the context start.</p></li><li><p>It's possible to prevent the rule engine from performing
            combinatorial pattern matching.</p></li><li><p>If no facts are retracted in the reasoning cycle, as a
            result of the <code class="literal">not</code> CE, the port is incorrect.</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10968"/>9.11.2.2. Conflict Resolution</h4></div></div></div><p>The Manners benchmark was written for OPS5 which has two conflict
        resolution strategies, LEX and MEA. LEX is a chain of several
        strategies including salience, recency and complexity. The recency
        part of the strategy drives the depth first (LIFO) firing order.
        The CLIPS  manual documents the Recency strategy as follows:</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>Every fact and instance is marked internally with a "time tag"
          to indicate its relative recency with respect to every other fact
          and instance in the system. The pattern entities associated with
          each rule activation are sorted in descending order for determining
          placement. An activation with a more recent pattern entity is
          placed before activations with less recent pattern entities. To
          determine the placement order of two activations, compare the sorted
          time tags of the two activations one by one starting with the
          largest time tags. The comparison should continue until one
          activation’s time tag is greater than the other activation’s
          corresponding time tag. The activation with the greater time tag is
          placed before the other activation on the agenda. If one activation
          has more pattern entities than the other activation and the compared
          time tags are all identical, then the activation with more time tags
          is placed before the other activation on the agenda.</p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">CLIPS Reference Manual</span></td></tr></table></div><p>However Jess and CLIPS both use the Depth strategy, which is
        simpler and lighter, which Drools also adopted. The CLIPS manual
        documents the Depth strategy as:</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>Newly activated rules are placed above all rules of the same
          salience. For example, given that fact-a activates rule-1 and rule-2
          and fact-b activates rule-3 and rule-4, then if fact-a is asserted
          before fact-b, rule-3 and rule-4 will be above rule-1 and rule-2 on
          the agenda. However, the position of rule-1 relative to rule-2 and
          rule-3 relative to rule-4 will be arbitrary.</p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">CLIPS Reference Manual</span></td></tr></table></div><p>The initial Drools implementation for the Depth strategy would
        not work for Manners without the use of salience on the "make_path"
        rule. The CLIPS support team had this to say:</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>The default conflict resolution strategy for CLIPS, Depth, is
          different than the default conflict resolution strategy used by
          OPS5. Therefore if you directly translate an OPS5 program to CLIPS,
          but use the default depth conflict resolution strategy, you're only
          likely to get the correct behavior by coincidence. The LEX and MEA
          conflict resolution strategies are provided in CLIPS to allow you to
          quickly convert and correctly run an OPS5 program in CLIPS.</p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">Clips Support Forum</span></td></tr></table></div><p>Investigation into the CLIPS code reveals there is undocumented
        functionality in the Depth strategy. There is an accumulated time tag
        used in this strategy; it's not an extensively fact by fact comparison
        as in the recency strategy, it simply adds the total of all the time
        tags for each activation and compares.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10994"/>9.11.2.3. Rule "assignFirstSeat"</h4></div></div></div><p>Once the context is changed to <code class="code">START_UP</code>,
        activations are created for all asserted guest. Because all
        activations are created as the result of a single Working Memory
        action, they all have the same Activation time tag. The last
        asserted <code class="code">Guest</code> object would have a higher fact
        time tag, and its Activation would fire because it has the highest
        accumulated fact time tag. The execution order in this rule has little
        importance, but has a big impact in the rule "Assign Seat". The
        activation fires and asserts the first <code class="code">Seating</code>
        arrangement and a <code class="code">Path</code>, and then sets the
        <code class="code">Context</code> attribute <code class="code">state</code> to create 
        an activation for rule <code class="code">findSeating</code>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule assignFirstSeat
    when
        context : Context( state == Context.START_UP )
        guest : Guest()
        count : Count()
    then
        String guestName = guest.getName();
        
        Seating seating =
          new Seating( count.getValue(), 1, true, 1, guestName, 1, guestName);
        insert( seating );
        
        Path path = new Path( count.getValue(), 1, guestName );
        insert( path );
        
        modify( count ) { setValue ( count.getValue() + 1 )  }

    System.out.println( "assign first seat :  " + seating + " : " + path );

        modify( context ) {
            setState( Context.ASSIGN_SEATS )
        } 
end</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11022"/>9.11.2.4. Rule "findSeating"</h4></div></div></div><p>This rule determines each of the <code class="code">Seating</code>
        arrangements. The rule creates cross product solutions for
        <span class="emphasis"><em>all</em></span> asserted <code class="code">Seating</code> arrangements
        against <span class="emphasis"><em>all</em></span> the asserted guests except 
        against itself or any already assigned chosen solutions.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule findSeating
   when 
       context : Context( state == Context.ASSIGN_SEATS )
       $s      : Seating( pathDone == true )
       $g1     : Guest( name == $s.rightGuestName )
       $g2     : Guest( sex != $g1.sex, hobby == $g1.hobby )

       count   : Count()

       not ( Path( id == $s.id, guestName == $g2.name) )
       not ( Chosen( id == $s.id, guestName == $g2.name, hobby == $g1.hobby) )
   then
       int rightSeat = $s.getRightSeat();
       int seatId = $s.getId();
       int countValue = count.getValue();
       
       Seating seating =
         new Seating( countValue, seatId, false, rightSeat,
                      $s.getRightGuestName(), rightSeat + 1, $g2.getName() );
       insert( seating );
                            
       Path path = new Path( countValue, rightSeat + 1, $g2.getName()  );
       insert( path );
       
       Chosen chosen = new Chosen( seatId, $g2.getName(), $g1.getHobby() );
       insert( chosen  );

       System.err.println( "find seating : " + seating + " : " + path +
                           " : " + chosen);

       modify( count ) {setValue(  countValue + 1 )}
       modify( context ) {setState( Context.MAKE_PATH )}
end</pre><p>However, as can be seen from the printed results shown earlier,
        it is essential that only the <code class="code">Seating</code> with the highest
        <code class="code">pid</code> cross product be chosen. How can this be possible
        if we have activations, of the same time tag, for nearly all
        existing <code class="code">Seating</code> and <code class="code">Guest</code> objects? For
        example, on the third iteration of <code class="code">findDeating</code> the
        produced activations will be as shown below. Remember, this is from
        a very small data set, and with larger data sets there would be many
        more possible activated <code class="code">Seating</code> solutions, with multiple
        solutions per <code class="code">pid</code>:</p><div class="literallayout"><p>=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:19:33]:[Seating id=3, pid=2, done=true, ls=2, ln=n4, rs=3, rn=n3] <br/>
[fid:4:4]:[Guest name=n3, sex=m, hobbies=h3] <br/>
[fid:3:3]:[Guest name=n2, sex=f, hobbies=h3]<br/>
<br/>
=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4] <br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1] <br/>
[fid:2:2]:[Guest name=n2, sex=f, hobbies=h1] <br/>
<br/>
=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5] <br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1] <br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]</p></div><p>The creation of all these redundant activations might seem
        pointless, but it must be remembered that Manners is not about good
        rule design; it's purposefully designed as a bad ruleset to fully
        stress-test the cross product matching process and the Agenda, which
        this clearly does. Notice that each activation has the same time tag
        of 35, as they were all activated by the change in the
        <code class="code">Context</code> object to <code class="code">ASSIGN_SEATS</code>. With OPS5
        and LEX it would correctly fire the activation with the
        <code class="code">Seating</code> asserted last. With Depth, the accumulated fact
        time tag ensures that the activation with the last asserted
        <code class="code">Seating</code> fires.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11080"/>9.11.2.5. Rules "makePath" and "pathDone"</h4></div></div></div><p>Rule <code class="code">makePath</code> must always fire before
        <code class="code">pathDone</code>. A <code class="code">Path</code> object is asserted for
        each <code class="code">Seating</code> arrangement, up to the last asserted 
        <code class="code">Seating</code>. Notice that the conditions in
        <code class="code">pathDone</code> are a subset of those in
        <code class="code">makePath</code> - so how do we ensure that <code class="code">makePath</code>
        fires first?</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule makePath
    when 
        Context( state == Context.MAKE_PATH )
        Seating( seatingId:id, seatingPid:pid, pathDone == false )
        Path( id == seatingPid, pathGuestName:guestName, pathSeat:seat )
        not Path( id == seatingId, guestName == pathGuestName )
    then
        insert( new Path( seatingId, pathSeat, pathGuestName ) );
end</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule pathDone
    when
        context : Context( state == Context.MAKE_PATH ) 
        seating : Seating( pathDone == false ) 
    then
        modify( seating ) {setPathDone( true )} 
        
    modify( context ) {setState( Context.CHECK_DONE)}
end</pre><div class="figure"><a id="d0e11113"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Chapter-Examples/MannersExample/make_path.png" align="middle" alt="Rete Diagram"/></div></div><p class="title"><b>Figure 9.24. Rete Diagram</b></p></div><br class="figure-break"/><p>Both rules end up on the Agenda in conflict and with identical
        activation time tags. However, the accumulate fact time tag is greater
        for "Make Path" so it gets priority.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11121"/>9.11.2.6. Rules "continue" and "areWeDone"</h4></div></div></div><p>Rule <code class="code">areWeDone</code> only activates when the last seat
        is assigned, at which point both rules will be activated. For the
        same reason that <code class="code">makePath</code> always wins over
        <code class="code">path Done</code>, <code class="code">areWeDone</code> will take
        priority over rule <code class="code">continue</code>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule areWeDone
    when
        context : Context( state == Context.CHECK_DONE ) 
        LastSeat( lastSeat: seat )
        Seating( rightSeat == lastSeat ) 
    then
        modify( context ) {setState(Context.PRINT_RESULTS )}
end
</pre><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule continue
    when
        context : Context( state == Context.CHECK_DONE ) 
    then
        modify( context ) {setState( Context.ASSIGN_SEATS )}
end
</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e11145"/>9.11.3. Output Summary</h3></div></div></div><div class="literallayout"><p><span class="bold"><strong>Assign First seat</strong></span><br/>
=&gt;[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
=&gt;[fid:14:14]:[Path id=1, seat=1, guest=n5]<br/>
<br/>
==&gt;[ActivationCreated(16): rule=findSeating<br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1]<br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]<br/>
<br/>
==&gt;[ActivationCreated(16): rule=findSeating<br/>
[fid:13:13]:[Seating id=1 , pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1]<br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1]*<br/>
<br/>
<span class="bold"><strong>Assign Seating</strong></span><br/>
=&gt;[fid:15:17] :[Seating id=2 , pid=1 , done=false, ls=1, lg=n5, rs=2, rn=n4]<br/>
=&gt;[fid:16:18]:[Path id=2, seat=2, guest=n4]<br/>
=&gt;[fid:17:19]:[Chosen id=1, name=n4, hobbies=h1]<br/>
<br/>
=&gt;[ActivationCreated(21): rule=makePath <br/>
[fid:15:17] : [Seating id=2, pid=1, done=false, ls=1, ln=n5, rs=2, rn=n4]<br/>
[fid:14:14] : [Path id=1, seat=1, guest=n5]*<br/>
<br/>
==&gt;[ActivationCreated(21): rule=pathDone<br/>
[Seating id=2, pid=1, done=false, ls=1, ln=n5, rs=2, rn=n4]*<br/>
<br/>
<span class="bold"><strong>Make Path</strong></span><br/>
=&gt;[fid:18:22:[Path id=2, seat=1, guest=n5]]<br/>
<br/>
<span class="bold"><strong>Path Done</strong></span><br/>
<br/>
<span class="bold"><strong>Continue Process</strong></span><br/>
=&gt;[ActivationCreated(25): rule=findSeating<br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4]<br/>
[fid:7:7]:[Guest name=n4, sex=f, hobbies=h3]<br/>
[fid:4:4] : [Guest name=n3, sex=m, hobbies=h3]*<br/>
<br/>
=&gt;[ActivationCreated(25): rule=findSeating<br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4]<br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1]<br/>
[fid:2:2]:[Guest name=n2, sex=f, hobbies=h1], [fid:12:20] : [Count value=3]<br/>
<br/>
=&gt;[ActivationCreated(25): rule=findSeating<br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1]<br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]<br/>
<br/>
<span class="bold"><strong>Assign Seating</strong></span><br/>
=&gt;[fid:19:26]:[Seating id=3, pid=2, done=false, ls=2, lnn4, rs=3, rn=n3]]<br/>
=&gt;[fid:20:27]:[Path id=3, seat=3, guest=n3]]<br/>
=&gt;[fid:21:28]:[Chosen id=2, name=n3, hobbies=h3}]<br/>
<br/>
=&gt;[ActivationCreated(30): rule=makePath<br/>
[fid:19:26]:[Seating id=3, pid=2, done=false, ls=2, ln=n4, rs=3, rn=n3]<br/>
[fid:18:22]:[Path id=2, seat=1, guest=n5]*<br/>
<br/>
=&gt;[ActivationCreated(30): rule=makePath <br/>
[fid:19:26]:[Seating id=3, pid=2, done=false, ls=2, ln=n4, rs=3, rn=n3]<br/>
[fid:16:18]:[Path id=2, seat=2, guest=n4]*<br/>
<br/>
=&gt;[ActivationCreated(30): rule=done <br/>
[fid:19:26]:[Seating id=3, pid=2, done=false, ls=2, ln=n4, rs=3, rn=n3]*<br/>
<br/>
<span class="bold"><strong>Make Path</strong></span><br/>
=&gt;[fid:22:31]:[Path id=3, seat=1, guest=n5]<br/>
<br/>
<span class="bold"><strong>Make Path </strong></span><br/>
=&gt;[fid:23:32] [Path id=3, seat=2, guest=n4]<br/>
<br/>
<span class="bold"><strong>Path Done</strong></span><br/>
<br/>
<span class="bold"><strong>Continue Processing</strong></span><br/>
=&gt;[ActivationCreated(35): rule=findSeating<br/>
[fid:19:33]:[Seating id=3, pid=2, done=true, ls=2, ln=n4, rs=3, rn=n3]<br/>
[fid:4:4]:[Guest name=n3, sex=m, hobbies=h3]<br/>
[fid:3:3]:[Guest name=n2, sex=f, hobbies=h3], [fid:12:29]*<br/>
<br/>
=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4] <br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1]<br/>
[fid:2:2]:[Guest name=n2, sex=f, hobbies=h1]<br/>
<br/>
=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5] <br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1], [fid:1:1] : [Guest name=n1, sex=m, hobbies=h1]<br/>
<br/>
<span class="bold"><strong>Assign Seating</strong></span><br/>
=&gt;[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2]]<br/>
=&gt;[fid:25:37]:[Path id=4, seat=4, guest=n2]]<br/>
=&gt;[fid:26:38]:[Chosen id=3, name=n2, hobbies=h3]<br/>
<br/>
==&gt;[ActivationCreated(40): rule=makePath <br/>
[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2]<br/>
[fid:23:32]:[Path id=3, seat=2, guest=n4]*<br/>
<br/>
==&gt;[ActivationCreated(40): rule=makePath <br/>
[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2] <br/>
[fid:20:27]:[Path id=3, seat=3, guest=n3]*<br/>
<br/>
=&gt;[ActivationCreated(40): rule=makePath <br/>
[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2]<br/>
[fid:22:31]:[Path id=3, seat=1, guest=n5]*<br/>
<br/>
=&gt;[ActivationCreated(40): rule=done <br/>
[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2]*<br/>
<br/>
<span class="bold"><strong>Make Path </strong></span><br/>
=&gt;fid:27:41:[Path id=4, seat=2, guest=n4]<br/>
<br/>
<span class="bold"><strong>Make Path</strong></span><br/>
=&gt;fid:28:42]:[Path id=4, seat=1, guest=n5]]<br/>
<br/>
<span class="bold"><strong>Make Path</strong></span><br/>
=&gt;fid:29:43]:[Path id=4, seat=3, guest=n3]]<br/>
<br/>
<span class="bold"><strong>Path Done</strong></span><br/>
<br/>
<span class="bold"><strong>Continue  Processing</strong></span><br/>
=&gt;[ActivationCreated(46): rule=findSeating <br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4] <br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1], [fid:2:2]<br/>
[Guest name=n2, sex=f, hobbies=h1]<br/>
<br/>
=&gt;[ActivationCreated(46): rule=findSeating <br/>
[fid:24:44]:[Seating id=4, pid=3, done=true, ls=3, ln=n3, rs=4, rn=n2]<br/>
[fid:2:2]:[Guest name=n2, sex=f, hobbies=h1]<br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]*<br/>
<br/>
=&gt;[ActivationCreated(46): rule=findSeating <br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1]<br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]<br/>
<br/>
<span class="bold"><strong>Assign Seating</strong></span><br/>
=&gt;[fid:30:47]:[Seating id=5, pid=4, done=false, ls=4, ln=n2, rs=5, rn=n1]<br/>
=&gt;[fid:31:48]:[Path id=5, seat=5, guest=n1]<br/>
=&gt;[fid:32:49]:[Chosen id=4, name=n1, hobbies=h1]<br/>
</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e11200"/>9.12. Conway's Game Of Life</h2></div></div></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""><span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Name:</strong></span> Conway's Game Of Life
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Main class:</strong></span> org.drools.examples.conway.ConwayAgendaGroupRun
            org.drools.examples.conway.ConwayRuleFlowGroupRun
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Module:</strong></span> droolsjbpm-integration-examples (Note: this is in a different download, the droolsjbpm-integration download.)
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Type:</strong></span> Java application
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Rules file:</strong></span> conway-ruleflow.drl conway-agendagroup.drl
<span xmlns="http://www.w3.org/1999/xhtml" class="bold"><strong>Objective:</strong></span> Demonstrates 'accumulate', 'collect' and 'from'</pre><p>Conway's Game Of Life, described in <a class="ulink" href="http://en.wikipedia.org/wiki/Conway's_Game_of_Life">http://en.wikipedia.org/wiki/Conway's_Game_of_Life</a> and in
    <a class="ulink" href="http://www.math.com/students/wonders/life/life.html">http://www.math.com/students/wonders/life/life.html</a>,
    is a famous cellular automaton conceived in the early 1970's by the
    mathematician John Conway. While the system is well known as "Conway's
    Game Of Life", it really isn't a game at all. Conway's system is more like
    a simulation of a form of life. Don't be intimidated. The system
    is terribly simple and terribly interesting. Math and Computer Science
    students alike have marvelled over Conway's system for more than 30 years
    now. The application
    presented here is a Swing-based implementation of Conway's Game of Life.
    The rules that govern the system are implemented as business rules using
    Drools. This document will explain the rules that drive the simulation and
    discuss the Drools parts of the implementation.</p><p>We'll first introduce the grid view, shown below, designed for the
    visualisation of the game, showing the "arena" where the life simuation
    takes place. Initially the grid is empty, meaning that there are no live
    cells in the system. Each cell is either alive or dead, with live cells
    showing a green ball. Preselected patterns of live cells can be
    chosen from the "Pattern" drop-down list. Alternatively, individual
    cells can be doubled-clicked to toggle them between live and dead. It's
    important to understand that each cell is related to its neighboring cells,
    which is fundamental for the game's rules. Neighbors include not only
    cells to the left, right, top and bottom but also cells that are connected
    diagonally, so that each cell has a total of 8 neighbors. Exceptions
    are the four corner cells which have only three neighbors, and the cells
    along the four border, with five neighbors each.</p><div class="figure"><a id="d0e11232"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/ConwaysGameOfLifeExample/conway1.png" alt="Conway's Game of Life: Starting a new game"/></div></div><p class="title"><b>Figure 9.25. Conway's Game of Life: Starting a new game</b></p></div><br class="figure-break"/><p>So what are the basic rules that govern this game? Its goal is to
    show the development of a population, generation by generation. Each
    generation results from the preceding one, based on the simultaneous
    evaluation of all cells. This is the simple set of rules that
    govern what the next generation will look like:</p><div class="itemizedlist"><ul><li><p>If a live cell has fewer than 2 live neighbors, it dies of
        loneliness.</p></li><li><p>If a live cell has more than 3 live neighbors, it dies from
        overcrowding.</p></li><li><p>If a dead cell has exactly 3 live neighbors, it comes to
        life.</p></li></ul></div><p>That is all there is to it. Any cell that doesn't meet any of those
    criteria is left as is for the next generation. With those simple rules in
    mind, go back and play with the system a little bit more and step through
    some generations, one at a time, and notice these rules taking their
    effect.</p><p>The screenshot below shows an example generation, with a number of
    live cells. Don't worry about matching the exact patterns represented in
    the screen shot. Just get some groups of cells added to the grid. Once you
    have groups of live cells in the grid, or select a pre-designed pattern,
    click the "Next Generation" button and notice what happens. Some of the
    live cells are killed (the green ball disappears) and some dead cells come
    to life (a green ball appears). Step through several generations and see
    if you notice any patterns. If you click on the "Start" button, the system
    will evolve itself so you don't need to click the "Next Generation" button
    over and over. Play with the system a little and then come back here for
    more details of how the application works.</p><div class="figure"><a id="d0e11254"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/ConwaysGameOfLifeExample/conway2.png" alt="Conway's Game of Life: A running game"/></div></div><p class="title"><b>Figure 9.26. Conway's Game of Life: A running game</b></p></div><br class="figure-break"/><p>Now lets delve into the code. As this is an advanced example we'll
    assume that by now you know your way around the Drools framework and are
    able to connect the presented highlight, so that we'll just focus at a
    high level overview. The example has two ways to execute, one way 
    uses Agenda Groups to manage execution flow, and the other one uses
    Rule Flow Groups to manage execution flow. These two versions are
    implemented in <code class="code">ConwayAgendaGroupRun</code> and
    <code class="code">ConwayRuleFlowGroupRun</code>, respectively. Here,
    we'll discuss the Rule Flow version, as it's what most people will
    use.</p><p>All the <code class="code">Cell</code> objects are inserted into the Session
    and the rules in the <code class="literal">ruleflow-group</code> "register neighbor" are
    allowed to execute by the Rule Flow process. This group of four rules
    creates <code class="code">Neighbor</code> relations between some cell and its
    northeastern, northern, northwestern and western neighbors. This
    relation is bidirectional, which takes care of the other four directions.
    Border cells don't need any special treatment - they simply won't be
    paired with neighboring cells where there isn't any. By
    the time all activations have fired for these rules, all cells are related
    to all their neighboring cells.</p><div class="example"><a id="d0e11279"/><p class="title"><b>Example 9.73. Conway's Game of Life: Register Cell Neighbour relations</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "register north east"
    ruleflow-group "register neighbor"
when
    $cell: Cell( $row : row, $col : col )            
    $northEast : Cell( row  == ($row - 1), col == ( $col + 1 ) )    
then                    
    insert( new Neighbor( $cell, $northEast ) );
    insert( new Neighbor( $northEast, $cell ) );        
end

rule "register north"
    ruleflow-group "register neighbor"  
when
    $cell: Cell( $row : row, $col : col )   
    $north : Cell( row  == ($row - 1), col == $col )    
then        
    insert( new Neighbor( $cell, $north ) );
    insert( new Neighbor( $north, $cell ) );        
end

rule "register north west"
    ruleflow-group "register neighbor"
when
    $cell: Cell( $row : row, $col : col )           
    $northWest : Cell( row  == ($row - 1), col == ( $col - 1 ) )                        
then        
    insert( new Neighbor( $cell, $northWest ) );
    insert( new Neighbor( $northWest, $cell ) );        
end

rule "register west"
    ruleflow-group "register neighbor"
when
    $cell: Cell( $row : row, $col : col )          
    $west : Cell( row  == $row, col == ( $col - 1 ) )                       
then        
    insert( new Neighbor( $cell, $west ) );
    insert( new Neighbor( $west, $cell ) );         
end</pre></div></div><br class="example-break"/><p>Once all the cells are inserted, some Java code applies the pattern
    to the grid, setting certain cells to Live. Then, when the user clicks
    "Start" or "Next Generation", it executes the "Generation" ruleflow. This
    ruleflow is responsible for the management of all changes of cells in each
    generation cycle.</p><div class="figure"><a id="d0e11286"/><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Examples/ConwaysGameOfLifeExample/conway_ruleflow_generation.png" alt="Conway's Game of Life: rule flow &#34;Generation&#34;"/></div></div><p class="title"><b>Figure 9.27. Conway's Game of Life: rule flow "Generation"</b></p></div><br class="figure-break"/><p>The rule flow process first enters the "evaluate" group, which means
    that any active rule in the group can fire. The rules in this group apply
    the Game-of-Life rules discussed in the beginning of the example,
    determining the cells to be killed and the ones to be given life. We use
    the "phase" attribute to drive the reasoning of the Cell by specific
    groups of rules; typically the phase is tied to a Rule Flow Group in the
    Rule Flow process definition. Notice that it doesn't actually change the
    state of any <code class="code">Cell</code> objectss at this point; this is because 
    it's evaluating the grid in turn and it must complete the full evaluation
    until those changes can be applied. To achieve this, it sets the cell to
    a "phase" which is either <code class="code">Phase.KILL</code> or
    <code class="code">Phase.BIRTH</code>, used later to control actions applied
    to the <code class="code">Cell</code> object.</p><div class="example"><a id="d0e11306"/><p class="title"><b>Example 9.74. Conway's Game of Life: Evaluate Cells with state changes</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Kill The Lonely"
    ruleflow-group "evaluate"
    no-loop
when
#   A live cell has fewer than 2 live neighbors
    theCell: Cell( liveNeighbors &lt; 2, cellState == CellState.LIVE,
                   phase == Phase.EVALUATE )
then
    modify( theCell ){
        setPhase( Phase.KILL );
    }
end

rule "Kill The Overcrowded"
    ruleflow-group "evaluate"
    no-loop
when
#   A live cell has more than 3 live neighbors
    theCell: Cell( liveNeighbors &gt; 3, cellState == CellState.LIVE,
                   phase == Phase.EVALUATE )
then
    modify( theCell ){
        setPhase( Phase.KILL );
    }
end

rule "Give Birth"
    ruleflow-group "evaluate"
    no-loop
when
#   A dead cell has 3 live neighbors
    theCell: Cell( liveNeighbors == 3, cellState == CellState.DEAD,
                   phase == Phase.EVALUATE )
then
    modify( theCell ){
        theCell.setPhase( Phase.BIRTH );
    }
end
</pre></div></div><br class="example-break"/><p>Once all <code class="code">Cell</code> objects in the grid have been evaluated,
    we first clear any calculation activations that occured from any previous
    data changes. This is done via the "reset calculate" rule, which clears
    any activations in the "calculate" group. We then enter a split in the
    rule flow which allows any activations in both the "kill" and the "birth"
    group to fire. These rules are responsible for applying the state
    change.</p><div class="example"><a id="d0e11316"/><p class="title"><b>Example 9.75. Conway's Game of Life: Apply the state changes</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "reset calculate"
    ruleflow-group "reset calculate"
when
then
    WorkingMemory wm = drools.getWorkingMemory();
    wm.clearRuleFlowGroup( "calculate" );
end

rule "kill"
    ruleflow-group "kill"
    no-loop
when
    theCell: Cell( phase == Phase.KILL )
then
    modify( theCell ){
        setCellState( CellState.DEAD ),
        setPhase( Phase.DONE );   
    }
end 
 
rule "birth"
    ruleflow-group "birth"
    no-loop
when
    theCell: Cell( phase == Phase.BIRTH )
then
    modify( theCell ){
        setCellState( CellState.LIVE ),
        setPhase( Phase.DONE );
    }
end </pre></div></div><br class="example-break"/><p>At this stage, a number of <code class="code">Cell</code> objects have been
    modified with the state changed to either <code class="code">LIVE</code> or
    <code class="code">DEAD</code>. Now we get to see the power of the
    <code class="code">Neighbor</code> facts defining the cell relations. When a cell
    becomes live or dead, we use the <code class="code">Neighbor</code> relation to
    iterate over all surrounding cells, increasing or decreasing the
    <code class="code">liveNeighbor</code> count. Any cell that has its count changed
    is also set to to the <code class="code">EVALUATE</code> phase, to make sure
    it is included in the reasoning during the evaluation stage of the
    Rule Flow Process. Notice that we don't have to do any iteration
    ourselves; simply by applying the relations in the rules we make
    the rule engine do all the hard work for us, with a minimal amount of
    code. Once the live count has been determined and set for all cells,
    the Rule Flow Process comes to and end. If the user has initially
    clicked the "Start" button, the engine will restart the rule flow;
    otherwise the user may request another generation.</p><div class="example"><a id="d0e11344"/><p class="title"><b>Example 9.76. Conway's Game of Life: Evaluate cells with state changes</b></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rule "Calculate Live"
    ruleflow-group "calculate"
    lock-on-active  
when
    theCell: Cell( cellState == CellState.LIVE )
    Neighbor( cell == theCell, $neighbor : neighbor ) 
then
    modify( $neighbor ){
        setLiveNeighbors( $neighbor.getLiveNeighbors() + 1 ),
        setPhase( Phase.EVALUATE );   
    }
end 

rule "Calculate Dead"
    ruleflow-group "calculate"
    lock-on-active  
when
    theCell: Cell( cellState == CellState.DEAD )
    Neighbor( cell == theCell, $neighbor : neighbor )
then
    modify( $neighbor ){
        setLiveNeighbors( $neighbor.getLiveNeighbors() - 1 ),
        setPhase( Phase.EVALUATE );
    }
end </pre></div></div><br class="example-break"/></div></div><div class="index"><div class="titlepage"><div><div><h2 class="title"><a id="d0e11349"/>Index</h2></div></div></div><div class="index"><div class="indexdiv"><h3>B</h3><dl><dt>BeanShell, <a class="indexterm" href="#d0e117">Why use a Rule Engine?</a></dt></dl></div><div class="indexdiv"><h3>C</h3><dl><dt>Collection, <a class="indexterm" href="#d0e4558">The operator contains</a>, <a class="indexterm" href="#d0e4582">The operator not contains</a></dt></dl></div><div class="indexdiv"><h3>D</h3><dl><dt>Domain Specific Languages, <a class="indexterm" href="#d0e6300">Domain Specific Languages</a></dt><dt>DSL, <a class="indexterm" href="#d0e6317">DSL Basics</a></dt></dl></div><div class="indexdiv"><h3>I</h3><dl><dt>Inference Engine, <a class="indexterm" href="#d0e29">Introduction and Background</a></dt></dl></div><div class="indexdiv"><h3>L</h3><dl><dt>Leaps, <a class="indexterm" href="#d0e29">Introduction and Background</a></dt><dt>Logical Object, <a class="indexterm" href="#d0e986">Truth Maintenance with  Logical Objects</a></dt></dl></div><div class="indexdiv"><h3>P</h3><dl><dt>Pattern Matching, <a class="indexterm" href="#d0e29">Introduction and Background</a></dt><dt>Predicate, <a class="indexterm" href="#d0e4723">Inline eval operator (deprecated)</a></dt><dt>Production Memory, <a class="indexterm" href="#d0e29">Introduction and Background</a></dt></dl></div><div class="indexdiv"><h3>R</h3><dl><dt>regular expression, <a class="indexterm" href="#d0e4509">The operator matches</a></dt><dt>Rete, <a class="indexterm" href="#d0e29">Introduction and Background</a></dt></dl></div><div class="indexdiv"><h3>W</h3><dl><dt>WorkingMemory, <a class="indexterm" href="#d0e29">Introduction and Background</a></dt></dl></div><div class="indexdiv"><h3>X</h3><dl><dt>XML, <a class="indexterm" href="#d0e6648">XML Rule Language</a></dt><dt>XML Rule, <a class="indexterm" href="#d0e6668">The XML format</a></dt></dl></div></div></div></div></body></html>